<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Account Settings - Crane Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/brand-framework.css?v=19">
    <link rel="stylesheet" href="css/unified-header.css">
    <link rel="icon" type="image/x-icon" href="images/logos/favicon.ico">
    <script src="js/notification-system.js" defer></script>
    <script src="js/component-loader.js" defer></script>
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0F0F0F;
            color: #FFFFFF;
            line-height: 1.6;
            overflow-x: hidden;
        }
        .main-content {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 32px;
        }
        .page-header { margin-bottom: 32px; }
        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #00FF85;
            margin-bottom: 8px;
        }
        .page-subtitle {
            font-size: 16px;
            color: #B0B0B0;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid #2A2A2A;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #B0B0B0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        .tab:hover { color: #FFFFFF; }
        .tab.active {
            color: #00FF85;
            border-bottom-color: #00FF85;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .settings-card {
            background: #1A1A1A;
            border: 1px solid #2A2A2A;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF !important;
            margin-bottom: 4px;
        }
        .card-subtitle {
            font-size: 14px;
            color: #B0B0B0 !important;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #FFFFFF !important;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            background: #0F0F0F;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #FFFFFF !important;
            font-size: 14px;
        }
        .form-input::placeholder { color: #808080 !important; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00FF85;
            color: #000000;
        }
        .btn-primary:hover { background: #00CC6A; }
        .btn-secondary {
            background: #2A2A2A;
            color: #00FF85;
            border: 1px solid #3A3A3A;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-success {
            background: rgba(0, 255, 133, 0.1);
            border: 1px solid #00FF85;
            color: #00FF85;
        }
        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #FF4444;
            color: #FF4444;
        }
        /* Modal Styles */
        .modal-overlay {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,0.85) !important;
            z-index: 10000 !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .modal-overlay.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .modal-content {
            background: #0A0A0A;
            border: 1px solid #2A2A2A;
            border-radius: 12px;
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
    </style>
    
    <!-- CRITICAL: Define openSubscriptionModal IMMEDIATELY in head -->
    <script>
        console.log('üöÄ [HEAD] Defining openSubscriptionModal');
        window.openSubscriptionModal = function() {
            console.log('üîì [HEAD] openSubscriptionModal CALLED');
            const modal = document.getElementById('subscriptionTierModal');
            console.log('üîç Modal element:', modal);
            if (!modal) {
                console.error('‚ùå Modal not found');
                alert('Modal not found. Please refresh.');
                return;
            }
            console.log('‚úÖ Modal found, adding show class');
            modal.classList.add('show');
            console.log('‚úÖ Modal classes:', modal.className);
            console.log('‚úÖ Modal computed display:', window.getComputedStyle(modal).display);
            if (typeof switchBilling === 'function') {
                switchBilling('monthly');
            }
        };
        window.closeSubscriptionModal = function() {
            const modal = document.getElementById('subscriptionTierModal');
            if (modal) {
                modal.classList.remove('show');
                console.log('‚úÖ Modal closed');
            }
        };
        console.log('‚úÖ [HEAD] Functions defined:', typeof window.openSubscriptionModal);
        
        // (Deprecated) Subscription modal test logs removed for production
    </script>
</head>
<body>
    <!-- Unified Header Component -->
    <div data-component="unified-header"></div>
    
    <!-- Unified Market Ticker -->
    <div data-component="unified-market-ticker"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Account Settings</h1>
            <p class="page-subtitle">Manage your account preferences and settings</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('profile', event)">Profile</button>
            <button class="tab" onclick="switchTab('email', event)">Email Settings</button>
            <button class="tab" onclick="switchTab('notifications', event)">Notifications</button>
            <button class="tab" onclick="switchTab('security', event)">Security</button>
            <button class="tab" onclick="switchTab('billing', event)">Billing History</button>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content active">
            <div class="settings-card">
                <h2 class="card-title">Personal Information</h2>
                <p class="card-subtitle">Update your personal details</p>
                <form id="profileForm" style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="fullName" placeholder="John Doe">
                        </div>
                        <div>
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="email" disabled>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-input" id="companyName" placeholder="Acme Corporation">
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="phone" placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="address" placeholder="123 Main St, City, State, ZIP">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- Subscription Tab (removed) -->

        <!-- Email Settings Tab -->
        <div id="emailTab" class="tab-content">
            <div class="settings-card">
                <h2 class="card-title">Email Preferences</h2>
                <p class="card-subtitle">Control which emails you receive</p>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #2A2A2A;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Marketing Emails</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Receive updates about new features and promotions</div>
                        </div>
                        <input type="checkbox" id="emailMarketing" style="width: 40px; height: 20px;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #2A2A2A;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Report Notifications</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Get notified when your reports are ready</div>
                        </div>
                        <input type="checkbox" id="emailReports" style="width: 40px; height: 20px;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Security Alerts</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Important security and account updates</div>
                        </div>
                        <input type="checkbox" id="emailSecurity" style="width: 40px; height: 20px;">
                    </div>
                    <button onclick="saveEmailSettings()" class="btn btn-primary" style="margin-top: 20px;">Save Preferences</button>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsTab" class="tab-content">
            <div class="settings-card">
                <h2 class="card-title">Notification Preferences</h2>
                <p class="card-subtitle">Manage your notification settings</p>
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #2A2A2A;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Browser Notifications</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Receive notifications in your browser</div>
                        </div>
                        <input type="checkbox" id="notifBrowser" style="width: 40px; height: 20px;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #2A2A2A;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Market Updates</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Get notified about market changes</div>
                        </div>
                        <input type="checkbox" id="notifMarket" style="width: 40px; height: 20px;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0;">
                        <div>
                            <div style="font-weight: 600; color: #FFFFFF; margin-bottom: 4px;">Price Alerts</div>
                            <div style="font-size: 13px; color: #B0B0B0;">Alerts when prices change significantly</div>
                        </div>
                        <input type="checkbox" id="notifPrice" style="width: 40px; height: 20px;">
                    </div>
                    <button onclick="saveNotificationSettings()" class="btn btn-primary" style="margin-top: 20px;">Save Preferences</button>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="securityTab" class="tab-content">
            <div class="settings-card">
                <h2 class="card-title">Change Password</h2>
                <p class="card-subtitle">Update your account password</p>
                <form id="passwordForm" style="margin-top: 20px;">
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm new password">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>
            <div class="settings-card" style="margin-top: 24px;">
                <h2 class="card-title">Delete Account</h2>
                <p class="card-subtitle">Permanently delete your account and all data</p>
                <button onclick="confirmDeleteAccount()" class="btn" style="background: #FF4444; color: #FFFFFF; margin-top: 20px;">Delete Account</button>
            </div>
        </div>

        <!-- Billing History Tab -->
        <div id="billingTab" class="tab-content">
            <div class="settings-card">
                <h2 class="card-title">Billing History</h2>
                <p class="card-subtitle">View and download your receipts</p>
                <div id="invoicesContainer" style="margin-top: 20px;">Loading...</div>
            </div>
        </div>
    </main>
    
    <!-- Unified Footer Component -->
    <div data-component="unified-footer"></div>
    
    <!-- Subscription Tier Modal -->
    <div id="subscriptionTierModal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeSubscriptionModal()" style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #B0B0B0; font-size: 32px; cursor: pointer; z-index: 1;">&times;</button>
            <div style="padding: 40px 20px;">
                <h2 style="font-size: 32px; font-weight: 700; color: #FFFFFF; margin-bottom: 12px; text-align: center;">UPGRADE YOUR PLAN</h2>
                <p style="color: #B0B0B0; text-align: center; margin-bottom: 32px;">Choose the plan that fits your needs</p>
                
                <div style="display: flex; justify-content: center; margin-bottom: 40px; gap: 0;">
                    <button id="monthlyToggle" onclick="switchBilling('monthly')" style="padding: 12px 32px; background: #00FF85; color: #000000; border: 2px solid #00FF85; border-radius: 8px 0 0 8px; font-weight: 700; cursor: pointer;">MONTHLY</button>
                    <button id="yearlyToggle" onclick="switchBilling('yearly')" style="padding: 12px 32px; background: #2A2A2A; color: #B0B0B0; border: 2px solid #3A3A3A; border-radius: 0 8px 8px 0; font-weight: 700; cursor: pointer;">YEARLY</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 1100px; margin: 0 auto;">
                    <div style="background: #1A1A1A; border: 2px solid #2A2A2A; border-radius: 8px; padding: 32px;">
                        <h3 style="font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 24px; text-align: center;">SPOT CHECK</h3>
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div id="spotCheckPrice" style="font-size: 48px; font-weight: 700; color: #00FF85;">$495</div>
                            <div id="spotCheckPeriod" style="color: #B0B0B0; margin-top: 8px;">PER MONTH</div>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 32px 0;">
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">1 valuation per month</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">PDF reports</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Email support</li>
                        </ul>
                        <button id="spotCheckButton" onclick="selectPlan('spot_check', currentBilling)" style="width: 100%; padding: 16px; background: transparent; color: #00FF85; border: 2px solid #00FF85; border-radius: 6px; font-weight: 700; cursor: pointer;">SELECT PLAN</button>
                    </div>
                    
                    <div style="background: #1A1A1A; border: 2px solid #00FF85; border-radius: 8px; padding: 32px; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2);">
                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #00FF85; color: #000000; padding: 6px 20px; border-radius: 4px; font-size: 11px; font-weight: 700;">MOST POPULAR</div>
                        <h3 style="font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 24px; text-align: center;">PROFESSIONAL</h3>
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div id="professionalPrice" style="font-size: 48px; font-weight: 700; color: #00FF85;">$995</div>
                            <div id="professionalPeriod" style="color: #B0B0B0; margin-top: 8px;">PER MONTH</div>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 32px 0;">
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">1 valuation per month</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">PDF reports</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Priority support</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Custom reports</li>
                        </ul>
                        <button id="professionalButton" onclick="selectPlan('professional', currentBilling)" style="width: 100%; padding: 16px; background: #00FF85; color: #000000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer;">SELECT PLAN</button>
                    </div>
                    
                    <div style="background: #1A1A1A; border: 2px solid #2A2A2A; border-radius: 8px; padding: 32px;">
                        <h3 style="font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 24px; text-align: center;">FLEET VALUATION</h3>
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div id="fleetPrice" style="font-size: 48px; font-weight: 700; color: #00FF85;">Starting at $1,495</div>
                            <div id="fleetPeriod" style="color: #B0B0B0; margin-top: 8px; font-size: 12px;">Pay-per-use ‚Ä¢ Tiered pricing</div>
                        </div>
                        <div style="background: rgba(0, 255, 133, 0.05); border: 1px solid rgba(0, 255, 133, 0.2); border-radius: 6px; padding: 12px; margin-bottom: 24px; font-size: 11px; color: #B0B0B0;">
                            <strong style="color: #00FF85;">Tiered Pricing:</strong><br>
                            1-5: $1,495 ($299/crane)<br>
                            6-10: $2,495 ($249/crane)<br>
                            11-25: $4,995 ($199/crane)<br>
                            26-50: $7,995 (~$159/crane)
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 32px 0;">
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">2-50 cranes supported</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Multi-unit PDF (one page per crane)</li>
                            <li style="color: #00FF85; margin-bottom: 16px; font-size: 14px; font-weight: 600;">‚òÖ CSV upload support</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Fleet total summary</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">Market overview</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">36-72 hour turnaround</li>
                            <li style="color: #E0E0E0; margin-bottom: 16px; font-size: 14px;">5 valuations per payment</li>
                        </ul>
                        <button id="fleetButton" onclick="selectPlan('fleet_valuation', currentBilling)" style="width: 100%; padding: 16px; background: transparent; color: #00FF85; border: 2px solid #00FF85; border-radius: 6px; font-weight: 700; cursor: pointer;">SELECT PLAN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="stripePaymentModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 20px 30px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: #FFFFFF; margin: 0;">Complete Payment</h2>
                <button onclick="closePaymentModal()" style="background: none; border: none; color: #fff; font-size: 32px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 30px;">
                <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #00ff88; margin: 0 0 15px 0;">Order Summary</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #888;">Plan:</span>
                        <span id="paymentPlanName" style="color: #fff; font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #888;">Billing:</span>
                        <span id="paymentBillingCycle" style="color: #fff; font-weight: bold;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #333; margin-top: 15px;">
                        <span style="color: #00ff88; font-size: 18px; font-weight: bold;">Total:</span>
                        <span id="paymentAmount" style="color: #00ff88; font-size: 24px; font-weight: bold;"></span>
                    </div>
                </div>
                <div id="payment-element" style="margin-bottom: 20px;"></div>
                <div id="payment-error" style="color: #ff4444; margin-top: 10px; display: none;"></div>
            </div>
            <div style="padding: 20px 30px; background: #0a0a0a; border-top: 1px solid #333;">
                <button id="submit-payment" onclick="handlePaymentSubmit()" style="width: 100%; padding: 15px; background: #00ff88; color: #000; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-bottom: 10px;">CONFIRM PAYMENT</button>
                <button onclick="closePaymentModal()" style="width: 100%; padding: 15px; background: #333; color: #fff; border: 1px solid #00ff88; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Payment Success Modal -->
    <div id="paymentSuccessModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div style="padding: 30px; text-align: center;">
                <div style="width: 80px; height: 80px; background: #00FF85; border-radius: 50%; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <h2 style="color: #FFFFFF; font-size: 28px; font-weight: 700; margin-bottom: 12px;">Payment Successful!</h2>
                <p style="color: #B0B0B0; font-size: 16px; margin-bottom: 32px;">Your subscription has been upgraded successfully.</p>
                <div id="receiptDetails" style="background: #0A0A0A; border: 1px solid #333; border-radius: 8px; padding: 24px; margin-bottom: 24px; text-align: left;"></div>
                <div id="receiptActions" style="display: flex; gap: 12px; margin-bottom: 16px;"></div>
                <button onclick="closePaymentSuccessModal()" style="width: 100%; padding: 16px; background: #00FF85; color: #000000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px;">CONTINUE</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://craneintelligence.tech/api/v1';
        let currentTab = 'profile';
        let currentBilling = 'monthly';
        
        function getAuthToken() {
            return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        }
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            currentTab = tabName;
            const tabEl = document.getElementById(tabName + 'Tab');
            if (tabEl) tabEl.classList.add('active');
            
            if (tabName === 'profile') loadProfile();
            else if (tabName === 'email') loadEmailSettings();
            else if (tabName === 'notifications') loadNotificationSettings();
            else if (tabName === 'billing') loadInvoices();
        }
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úó'}</span><span>${message}</span>`;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function loadProfile() {
            try {
                const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                if (userData.full_name) document.getElementById('fullName').value = userData.full_name;
                if (userData.email) document.getElementById('email').value = userData.email;
                if (userData.company_name) document.getElementById('companyName').value = userData.company_name;
                if (userData.phone) document.getElementById('phone').value = userData.phone;
                if (userData.address) document.getElementById('address').value = userData.address;
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        function loadEmailSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
                document.getElementById('emailMarketing').checked = settings.marketing !== false;
                document.getElementById('emailReports').checked = settings.reports !== false;
                document.getElementById('emailSecurity').checked = settings.security !== false;
            } catch (error) {
                console.error('Error loading email settings:', error);
            }
        }
        
        function loadNotificationSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
                document.getElementById('notifBrowser').checked = settings.browser === true;
                document.getElementById('notifMarket').checked = settings.market !== false;
                document.getElementById('notifPrice').checked = settings.price !== false;
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }
        
        // Subscription loading has been deprecated for this page (subscription tab removed)
        async function loadSubscription() {
            // No-op to avoid errors if called from older scripts
            return;
        }
        
        async function loadInvoices() {
            const container = document.getElementById('invoicesContainer');
            try {
                const token = getAuthToken();
                // Prefer user-specific FMV reports endpoint
                const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                const userId = userData.id || userData.user_id || null;
                
                let reports = [];
                if (userId) {
                    // Use /fmv-reports/user/{user_id} which accepts either numeric ID or email
                    const response = await fetch(`${API_BASE_URL}/fmv-reports/user/${encodeURIComponent(userId)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        container.innerHTML = `<div style="text-align: center; padding: 40px; color: #B0B0B0;">üì¶ No payment history yet</div>`;
                        return;
                    }
                    
                    const data = await response.json();
                    reports = data.reports || data || [];
                } else {
                    // Fallback: no user ID available
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #B0B0B0;">üì¶ No payment history yet</div>`;
                    return;
                }
                
                // Filter to only reports with payments
                const paidReports = reports.filter(r => (r.payment_intent_id || r.amount_paid) && r.amount_paid > 0);
                
                if (paidReports.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: #B0B0B0;">üì¶ No payment history yet</div>`;
                    return;
                }
                
                // Sort by date (most recent first)
                paidReports.sort((a, b) => {
                    const dateA = new Date(a.paid_at || a.submitted_at || a.created_at);
                    const dateB = new Date(b.paid_at || b.submitted_at || b.created_at);
                    return dateB - dateA;
                });
                
                let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;"><thead><tr style="border-bottom: 1px solid #2A2A2A;"><th style="padding: 12px; text-align: left; font-size: 12px; color: #B0B0B0;">Date</th><th style="padding: 12px; text-align: left; font-size: 12px; color: #B0B0B0;">Description</th><th style="padding: 12px; text-align: right; font-size: 12px; color: #B0B0B0;">Amount</th><th style="padding: 12px; text-align: center; font-size: 12px; color: #B0B0B0;">Receipt</th></tr></thead><tbody>';
                paidReports.forEach(report => {
                    const date = new Date(report.paid_at || report.submitted_at || report.created_at).toLocaleDateString();
                    const amount = parseFloat(report.amount_paid) || 0;
                    const reportType = (report.report_type || 'FMV Report').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const description = `FMV Report #${report.id} - ${reportType}`;
                    html += `<tr style="border-bottom: 1px solid #2A2A2A;">
                        <td style="padding: 12px; color: #FFFFFF;">${date}</td>
                        <td style="padding: 12px; color: #FFFFFF;">${description}</td>
                        <td style="padding: 12px; text-align: right; color: #FFFFFF;">$${amount.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="downloadReceiptPDF(${report.id})" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">üìÑ View Receipt</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading invoices:', error);
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #FF4444;">‚ùå Failed to load receipts</div>`;
            }
        }
        
        function saveEmailSettings() {
            const settings = {
                marketing: document.getElementById('emailMarketing').checked,
                reports: document.getElementById('emailReports').checked,
                security: document.getElementById('emailSecurity').checked
            };
            localStorage.setItem('emailSettings', JSON.stringify(settings));
            showAlert('Email preferences saved successfully', 'success');
        }
        
        function saveNotificationSettings() {
            const settings = {
                browser: document.getElementById('notifBrowser').checked,
                market: document.getElementById('notifMarket').checked,
                price: document.getElementById('notifPrice').checked
            };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            showAlert('Notification preferences saved successfully', 'success');
        }
        
        function switchBilling(type) {
            currentBilling = type;
            const monthlyBtn = document.getElementById('monthlyToggle');
            const yearlyBtn = document.getElementById('yearlyToggle');
            
            if (type === 'monthly') {
                monthlyBtn.style.background = '#00FF85';
                monthlyBtn.style.color = '#000000';
                yearlyBtn.style.background = '#2A2A2A';
                yearlyBtn.style.color = '#B0B0B0';
                document.getElementById('spotCheckPrice').textContent = '$495';
                document.getElementById('spotCheckPeriod').textContent = 'PER MONTH';
                document.getElementById('professionalPrice').textContent = '$995';
                document.getElementById('professionalPeriod').textContent = 'PER MONTH';
                document.getElementById('fleetPrice').textContent = 'Starting at $1,495';
                document.getElementById('fleetPeriod').textContent = 'Pay-per-use ‚Ä¢ Tiered pricing';
            } else {
                yearlyBtn.style.background = '#00FF85';
                yearlyBtn.style.color = '#000000';
                monthlyBtn.style.background = '#2A2A2A';
                monthlyBtn.style.color = '#B0B0B0';
                document.getElementById('spotCheckPrice').textContent = '$5,346';
                document.getElementById('spotCheckPeriod').textContent = 'PER YEAR';
                document.getElementById('professionalPrice').textContent = '$10,746';
                document.getElementById('professionalPeriod').textContent = 'PER YEAR';
                document.getElementById('fleetPrice').textContent = 'Starting at $1,495';
                document.getElementById('fleetPeriod').textContent = 'Pay-per-use ‚Ä¢ Tiered pricing';
            }
        }
        
        async function selectPlan(planType, billing) {
            console.log('üì¶ Selecting plan:', planType, 'billing:', billing);
            const pricing = {
                'spot_check': { monthly: 495, yearly: 5346 },
                'professional': { monthly: 995, yearly: 10746 },
                'fleet_valuation': { monthly: 1495, yearly: 1495 } // Pay-per-use, starting at $1,495
            };
            const amount = pricing[planType][billing];
            window.selectedPlanData = { plan: planType, billing: billing, amount: amount };
            
            const planNames = {
                'spot_check': 'Spot Check',
                'professional': 'Professional',
                'fleet_valuation': 'Fleet Valuation'
            };
            document.getElementById('paymentPlanName').textContent = planNames[planType] + ' Plan';
            document.getElementById('paymentBillingCycle').textContent = billing.charAt(0).toUpperCase() + billing.slice(1);
            document.getElementById('paymentAmount').textContent = `$${amount.toLocaleString()}`;
            
            closeSubscriptionModal();
            
            try {
                const token = getAuthToken();
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '/homepage.html';
                    return;
                }
                
                const amountInCents = amount * 100;
                console.log('üí≥ Creating payment intent for:', amountInCents, 'cents');
                const response = await fetch(`${API_BASE_URL}/payments/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ plan_id: planType, amount: amountInCents, billing_cycle: billing })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to create payment intent');
                }
                
                const data = await response.json();
                if (!data.client_secret) throw new Error('No client secret received');
                
                window.currentPaymentIntentId = data.payment_intent_id;
                window.selectedPlanId = planType;
                window.selectedBillingCycle = billing;
                
                if (!window.stripe) {
                    const configResponse = await fetch(`${API_BASE_URL}/config/public`);
                    const config = await configResponse.json();
                    window.stripe = Stripe(config.stripe_publishable_key);
                }
                
                const elements = window.stripe.elements({ clientSecret: data.client_secret });
                window.stripeElements = elements;
                
                // Clear any existing payment element
                const paymentElementContainer = document.getElementById('payment-element');
                paymentElementContainer.innerHTML = '';
                
                document.getElementById('stripePaymentModal').classList.add('show');
                
                setTimeout(() => {
                    const paymentElement = elements.create('payment');
                    paymentElement.mount('#payment-element');
                    console.log('‚úÖ Payment element mounted');
                }, 100);
            } catch (error) {
                console.error('‚ùå Payment initialization error:', error);
                alert('Failed to initialize payment: ' + error.message + '. Please try again.');
            }
        }
        
        function closePaymentModal() {
            document.getElementById('stripePaymentModal').classList.remove('show');
            if (window.stripeElements) window.stripeElements = null;
        }
        
        async function handlePaymentSubmit() {
            const submitBtn = document.getElementById('submit-payment');
            const errorDiv = document.getElementById('payment-error');
            submitBtn.disabled = true;
            submitBtn.textContent = 'PROCESSING...';
            errorDiv.style.display = 'none';
            
            try {
                const { error } = await window.stripe.confirmPayment({
                    elements: window.stripeElements,
                    redirect: 'if_required'
                });
                
                if (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'CONFIRM PAYMENT';
                } else {
                    const planName = document.getElementById('paymentPlanName').textContent;
                    const billingCycle = document.getElementById('paymentBillingCycle').textContent.toLowerCase();
                    const amount = document.getElementById('paymentAmount').textContent.replace('$', '').replace(/,/g, '');
                    
                    const confirmResponse = await fetch(`${API_BASE_URL}/payments/confirm-payment`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify({
                            payment_intent_id: window.currentPaymentIntentId,
                            plan_id: window.selectedPlanId,
                            billing_cycle: billingCycle
                        })
                    });
                    
                    if (!confirmResponse.ok) throw new Error('Failed to confirm payment');
                    
                    closePaymentModal();
                    const transactionId = window.currentPaymentIntentId || `pi_${Date.now()}`;
                    showPaymentSuccessModal(planName, amount, billingCycle, transactionId);
                    
                    setTimeout(() => {
                        loadSubscription();
                        loadInvoices();
                    }, 1000);
                }
            } catch (err) {
                console.error('Payment error:', err);
                errorDiv.textContent = 'An error occurred. Please try again.';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'CONFIRM PAYMENT';
            }
        }
        
        function showPaymentSuccessModal(planName, amount, billingCycle, transactionId) {
            const modal = document.getElementById('paymentSuccessModal');
            const receiptDetails = document.getElementById('receiptDetails');
            const receiptActions = document.getElementById('receiptActions');
            const receiptDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            receiptDetails.innerHTML = `
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #888; font-size: 14px;">Receipt Number:</span>
                        <span style="color: #FFF; font-size: 14px; font-family: monospace;">${transactionId.substring(0, 20)}...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #888; font-size: 14px;">Date:</span>
                        <span style="color: #FFF; font-size: 14px;">${receiptDate}</span>
                    </div>
                </div>
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                        <span style="color: #888; font-size: 14px;">Plan:</span>
                        <span style="color: #FFF; font-size: 14px; font-weight: 600;">${planName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888; font-size: 14px;">Billing Cycle:</span>
                        <span style="color: #FFF; font-size: 14px;">${billingCycle.charAt(0).toUpperCase() + billingCycle.slice(1)}</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #00FF85; font-size: 18px; font-weight: 700;">Total Paid:</span>
                    <span style="color: #00FF85; font-size: 24px; font-weight: 700;">$${parseFloat(amount).toFixed(2)}</span>
                </div>
            `;
            
            receiptActions.innerHTML = `
                <button onclick="downloadReceipt('${transactionId}', '${planName}', '${amount}', '${receiptDate}', '${billingCycle}')" style="flex: 1; background: #2A2A2A; color: #00FF85; border: 1px solid #00FF85; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">üìÑ Download PDF Receipt</button>
            `;
            
            modal.classList.add('show');
        }
        
        function closePaymentSuccessModal() {
            document.getElementById('paymentSuccessModal').classList.remove('show');
            loadSubscription();
            loadInvoices();
            setTimeout(() => switchTab('subscription'), 500);
        }
        
        async function downloadReceipt(transactionId, planName, amount, date, billingCycle) {
            try {
                const userEmail = localStorage.getItem('user_email') || JSON.parse(localStorage.getItem('user_data') || '{}').email;
                const response = await fetch('/api/v1/payments/generate-receipt-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        transaction_id: transactionId,
                        plan_name: planName,
                        amount: parseFloat(amount),
                        date: date,
                        billing_cycle: billingCycle,
                        customer_email: userEmail
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `crane-intelligence-receipt-${transactionId.substring(0, 10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('Receipt downloaded successfully', 'success');
                } else {
                    showAlert('Failed to generate receipt', 'error');
                }
            } catch (error) {
                console.error('Error downloading receipt:', error);
                showAlert('Failed to download receipt', 'error');
            }
        }
        
        async function downloadReceiptPDF(reportId) {
            // New function to download receipt PDF for a report ID
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/fmv-reports/${reportId}/receipt`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to download receipt: ${response.status}`);
                }
                
                // Get PDF blob
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Payment_Receipt_Report_${reportId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading receipt:', error);
                if (window.notificationSystem) {
                    window.notificationSystem.showError('Error', 'Failed to download receipt. Please try again.');
                } else {
                    alert('Failed to download receipt. Please try again.');
                }
            }
        }
        
        async function downloadReceiptPDF_old(transactionId, description, amount, date) {
            try {
                let planName = 'Subscription';
                if (description.includes('Fleet')) planName = 'Fleet Valuation Plan';
                else if (description.includes('Professional')) planName = 'Professional Plan';
                else if (description.includes('Spot')) planName = 'Spot Check Plan';
                
                const billingCycle = parseFloat(amount) >= 5000 ? 'yearly' : 'monthly';
                const userEmail = localStorage.getItem('user_email') || JSON.parse(localStorage.getItem('user_data') || '{}').email;
                
                const response = await fetch(`${API_BASE_URL}/payments/generate-receipt-pdf`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transaction_id: transactionId.startsWith('txn_') ? transactionId : (transactionId.startsWith('pi_') ? transactionId : `txn_${transactionId}`),
                        plan_name: planName,
                        amount: parseFloat(amount),
                        date: date,
                        billing_cycle: billingCycle,
                        customer_email: userEmail
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `crane-intelligence-receipt-${transactionId.substring(0, 15)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('Receipt downloaded successfully', 'success');
                } else {
                    showAlert('Failed to generate receipt', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Failed to download receipt', 'error');
            }
        }
        
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const userData = {
                full_name: document.getElementById('fullName').value,
                company_name: document.getElementById('companyName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };
            const currentData = JSON.parse(localStorage.getItem('user_data') || '{}');
            localStorage.setItem('user_data', JSON.stringify({...currentData, ...userData}));
            showAlert('Profile updated successfully', 'success');
        });
        
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                
                if (response.ok) {
                    showAlert('Password updated successfully', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to update password', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Failed to update password', 'error');
            }
        });
        
        function confirmDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    deleteAccount();
                }
            }
        }
        
        async function deleteAccount() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/delete-account`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                if (response.ok) {
                    showAlert('Account deleted successfully', 'success');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/homepage.html';
                    }, 2000);
                } else {
                    showAlert('Failed to delete account', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Failed to delete account', 'error');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/homepage.html';
                return;
            }
            loadProfile();
            loadEmailSettings();
            loadNotificationSettings();
            setTimeout(() => loadSubscription(), 500);
            setTimeout(() => loadInvoices(), 1000);
        });
        
        // Expose functions globally
        window.switchBilling = switchBilling;
        window.selectPlan = selectPlan;
        window.closeSubscriptionModal = closeSubscriptionModal;
        window.closePaymentModal = closePaymentModal;
        window.handlePaymentSubmit = handlePaymentSubmit;
        window.closePaymentSuccessModal = closePaymentSuccessModal;
        window.downloadReceipt = downloadReceipt;
        window.downloadReceiptPDF = downloadReceiptPDF;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Ensure body is visible immediately -->
    <style>
        body {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .main-content {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .container {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        .page-header {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    </style>
    <script>
    // LIGHTWEIGHT payment protection - no expensive prototype overrides
    // Global safeStorage wrapper for localStorage access (handles tracking prevention)
    // Silently handles tracking prevention - no console warnings (expected browser behavior)
    window.safeStorage = {
            getItem: function(key) {
                try {
                    return localStorage.getItem(key);
                } catch(e) { 
                    // Tracking prevention blocked access - this is expected browser behavior
                    // Silently return null to avoid console spam
                    return null;
                }
            },
            setItem: function(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch(e) { 
                    // Tracking prevention blocked access - this is expected browser behavior
                    // Silently fail to avoid console spam
                }
            },
            removeItem: function(key) {
                try {
                    localStorage.removeItem(key);
                } catch(e) { 
                    // Tracking prevention blocked access - this is expected browser behavior
                    // Silently fail to avoid console spam
                }
            }
        };
        
    // Global reference for backward compatibility (use var to avoid redeclaration)
    var safeStorage = window.safeStorage;
    
    // ========== UTILITY FUNCTIONS (Deduplication) ==========
    // Helper function to get auth token (consolidates multiple patterns)
    function getAuthToken() {
        return safeStorage.getItem('access_token') || 
               safeStorage.getItem('auth_token') || 
               safeStorage.getItem('crane_auth_token') || 
               null;
    }
    
    // Helper function to get user data (consolidates multiple patterns)
    function getUserData() {
        const userData = safeStorage.getItem('user_data');
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                return null;
            }
        }
        return null;
    }
    
    // Helper function to show notification (consolidates notification system calls)
    function showNotification(type, title, message) {
        if (window.notificationSystem) {
            if (type === 'success') {
                window.notificationSystem.showSuccess(title, message);
            } else if (type === 'error') {
                window.notificationSystem.showError(title, message);
            } else {
                window.notificationSystem.showInfo(title, message);
            }
        }
    }
    
    // Helper function to get form element value safely
    function getFormValue(id, defaultValue = '') {
        const el = document.getElementById(id);
        return el ? el.value : defaultValue;
    }
    
    // Helper function to get manufacturer value (handles "Other" option)
    function getManufacturerValue() {
        let manufacturer = getFormValue('manufacturer');
        if (manufacturer === 'Other') {
            manufacturer = getFormValue('manufacturerOther');
        }
        return manufacturer;
    }
    
    // Helper function to get model value (handles fallback)
    function getModelValue() {
        let model = getFormValue('model');
        if (!model) {
            model = getFormValue('fallbackModel');
        }
        return model;
    }
    
    // Helper function to create FormData for file uploads
    function createFileUploadFormData(files) {
        const formData = new FormData();
        if (Array.isArray(files)) {
            files.forEach(file => formData.append('files', file));
        } else {
            formData.append('file', files);
        }
        return formData;
    }
    
    // Helper function to make authenticated fetch request
    async function authenticatedFetch(url, options = {}) {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        return fetch(url, {
            ...options,
            headers
        });
    }
    
    (function() {
        'use strict';
        // CRITICAL: Reset all payment state on page load
        window.paymentCompleted = false;
        window._resultsBlocked = true;
        window.bypassSubscriptionCheck = false;
        window.lastPaymentCraneData = null;
        window.lastPaymentDetails = null;
        
        // Lightweight function to hide results
        function hideResults() {
            const rs = document.getElementById('valuationResultsSection');
            if (rs && !window.paymentCompleted) {
                rs.style.display = 'none';
                rs.style.visibility = 'hidden';
            }
        }
        
        // Ensure all modals are hidden on page load - IMMEDIATELY
        function hideAllModals() {
            const successModal = document.getElementById('successModal');
            const paymentModal = document.getElementById('stripePaymentModal');
            const paywallModal = document.getElementById('subscriptionPaywallModal');
            if (successModal) {
                successModal.style.display = 'none';
                successModal.style.visibility = 'hidden';
            }
            if (paymentModal) {
                paymentModal.style.display = 'none';
                paymentModal.style.visibility = 'hidden';
            }
            if (paywallModal) {
                paywallModal.style.display = 'none';
                paywallModal.style.visibility = 'hidden';
            }
        }
        
        // Hide modals IMMEDIATELY (don't wait for DOMContentLoaded)
        hideAllModals();
        
        // Also hide on DOM ready as backup
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                hideAllModals();
                setTimeout(hideResults, 100);
            });
        } else {
            hideAllModals();
            setTimeout(hideResults, 100);
        }
        
        // Also hide on window load as final backup
        window.addEventListener('load', function() {
            hideAllModals();
        });
    })();
    
    // Define modal functions early so they're available for onclick handlers
    window.closeStripeModal = function() {
        const modal = document.getElementById('stripePaymentModal');
        if (modal) {
            // Use setProperty with !important to override inline !important styles
            modal.style.setProperty('display', 'none', 'important');
            modal.style.setProperty('visibility', 'hidden', 'important');
            modal.setAttribute('data-force-hidden', 'true');
        }
        // Hide close button when modal is closed
        const closeButton = modal.querySelector('.ci-stripe-close');
        if (closeButton) {
            closeButton.style.setProperty('display', 'none', 'important');
            closeButton.style.setProperty('visibility', 'hidden', 'important');
            closeButton.style.setProperty('opacity', '0', 'important');
        }
        // Clean up payment element
        if (typeof paymentElement !== 'undefined' && paymentElement) {
            try {
                paymentElement.unmount();
            } catch(e) {
                console.warn('Error unmounting payment element:', e);
            }
            paymentElement = null;
        }
        if (typeof elements !== 'undefined') {
            elements = null;
        }
    };
    
    window.closeSuccessModal = function() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Get Your Professional FMV Report - Crane Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="images/logos/favicon.ico">
    <!-- Heavy libraries loaded asynchronously to prevent blocking -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <!-- XLSX library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Bloomberg Terminal Style Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <!-- Plotly loaded only when needed to prevent early errors -->
    <script>
        // Prevent Plotly from loading until actually needed
        window.Plotly = null;
        window.loadPlotly = function() {
            if (window.Plotly) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.plot.ly/plotly-2.24.1.min.js';
                script.onload = function() {
                    if (typeof Plotly !== 'undefined') {
                        window.Plotly = Plotly;
                        resolve();
                    } else {
                        reject(new Error('Plotly not available'));
                    }
                };
                script.onerror = function() {
                    console.warn('Plotly failed to load, charts will be disabled');
                    window.Plotly = null;
                    reject(new Error('Plotly load failed'));
                };
                document.head.appendChild(script);
            });
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" defer></script>
    <script src="/js/notification-system.js" defer></script>
    <script>
        // Helper function to show notifications with fallback to alert
        // This function is used throughout the page to replace alert() calls
        window.showNotification = function(type, title, message) {
            if (typeof notificationSystem !== 'undefined' && notificationSystem[`show${type.charAt(0).toUpperCase() + type.slice(1)}`]) {
                notificationSystem[`show${type.charAt(0).toUpperCase() + type.slice(1)}`](title, message);
            } else if (window.notificationSystem && window.notificationSystem[`show${type.charAt(0).toUpperCase() + type.slice(1)}`]) {
                window.notificationSystem[`show${type.charAt(0).toUpperCase() + type.slice(1)}`](title, message);
            } else {
                alert(message);
            }
        };
    </script>
    <style>
        /* ===== CRANE INTELLIGENCE - PROFESSIONAL DESIGN SYSTEM ===== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Brand Colors */
            --primary-black: #0F0F0F;
            --secondary-black: #1A1A1A;
            --tertiary-black: #121212;
            --accent-green: #00FF85;
            --accent-yellow: #FFD600;
            --accent-red: #FF4444;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --text-muted: #808080;
            --border-color: #333333;
            --border-light: #404040;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-condensed: 'Roboto Condensed', 'Inter', sans-serif;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;
            --space-4xl: 80px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.16);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.25);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.35s ease;
        }

        body {
            font-family: var(--font-primary);
            background: var(--primary-black);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex !important;
            flex-direction: column !important;
            min-height: 100vh !important;
            visibility: visible !important;
            opacity: 1 !important;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-content {
            flex: 1;
        }

        /* ===== HEADER - EXACT MATCH TO HOMEPAGE ===== */
        .header {
            background: #1A1A1A !important;
            border-bottom: 1px solid #404040 !important;
            padding: var(--space-md) 0 !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            backdrop-filter: none !important;
            overflow: visible !important;
        }

        .header-container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0 var(--space-xl) !important;
            display: grid !important;
            grid-template-columns: 1fr auto 1fr !important;
            align-items: center !important;
            height: 80px !important;
            overflow: visible !important;
        }

        .logo {
            display: flex !important;
            align-items: center !important;
            justify-self: start !important;
            grid-column: 1;
        }

        .logo-svg {
            height: 60px !important;
            width: auto !important;
            filter: brightness(1.2) contrast(1.2) !important;
        }

        .nav-menu {
            display: flex !important;
            align-items: center !important;
            gap: 40px !important;
            justify-self: center !important;
            grid-column: 2;
        }


        .nav-link {
            color: #FFFFFF !important;
            text-decoration: none !important;
            font-family: 'Inter', sans-serif !important;
            font-weight: 500 !important;
            font-size: 14px !important;
            letter-spacing: 0.5px !important;
            transition: color 0.3s ease !important;
        }

        .nav-link:hover {
            color: #00FF85 !important;
        }

        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-self: end;
            grid-column: 3;
            padding-right: 0;
            margin-right: 0;
        }

        .auth-buttons.hidden {
            display: none !important;
        }

        .user-profile {
            display: flex !important;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            justify-self: end;
            grid-column: 3;
            padding-right: 0;
            margin-right: 0;
            position: relative;
            z-index: 1000;
        }

        .user-profile.visible {
            display: flex !important;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00FF85, #00CC6A);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
            line-height: 1.2;
        }

        .user-role {
            font-size: 12px;
            color: #B0B0B0;
            line-height: 1.2;
        }

        .dropdown-arrow {
            color: #B0B0B0;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .user-profile:hover .dropdown-arrow {
            transform: rotate(180deg);
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            margin-top: 4px;
        }

        .user-dropdown.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #FFFFFF;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #404040;
            color: #00FF85;
        }

        .dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* ===== BLOOMBERG TERMINAL STYLE CHARTS ===== */
        .bloomberg-chart {
            background: #0F0F0F;
            border: 1px solid #333333;
            border-radius: 4px;
            margin: 16px 0;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333333;
        }

        .chart-title {
            color: #00FF85;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .chart-timeframe {
            color: #B0B0B0;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: #0F0F0F;
            border: 1px solid #333333;
            border-radius: 4px;
            overflow: hidden;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .chart-grid.full-width {
            grid-template-columns: 1fr;
        }

        .mini-chart {
            height: 120px;
            background: #0F0F0F;
            border: 1px solid #333333;
            border-radius: 4px;
            padding: 8px;
        }

        .chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: #B0B0B0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .price-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .price-up {
            color: #00FF85;
        }

        .price-down {
            color: #FF4444;
        }

        .price-neutral {
            color: #B0B0B0;
        }

        .market-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .market-data-item {
            background: #1A1A1A;
            border: 1px solid #333333;
            border-radius: 4px;
            padding: 12px;
            text-align: center;
        }

        .market-data-label {
            font-size: 12px;
            color: #B0B0B0;
            margin-bottom: 4px;
        }

        .market-data-value {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .market-data-change {
            font-size: 12px;
            margin-top: 4px;
        }

        /* ===== MARKET TICKER - EXACT MATCH TO HOMEPAGE ===== */
        .market-ticker {
            background: #1A1A1A !important;
            padding: 8px 0 !important;
            border-bottom: 1px solid #404040 !important;
            overflow: hidden !important;
            white-space: nowrap !important;
            display: block !important;
            height: auto !important;
        }

        .ticker-container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0 var(--space-xl) !important;
            overflow: hidden !important;
        }

        .ticker-content {
            display: flex !important;
            align-items: center !important;
            gap: 40px !important;
            animation: scrollHorizontal 30s linear infinite !important;
            white-space: nowrap !important;
        }

        @keyframes scrollHorizontal {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .ticker-symbol {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #FFD600;
            text-transform: uppercase;
        }

        .ticker-price {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .ticker-change {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 700;
        }

        .ticker-change.up {
            color: #00FF85;
        }

        .ticker-change.down {
            color: #FF4444;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            min-height: calc(100vh - 80px);
            padding: 40px 0;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-xl);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .page-header {
            text-align: center;
            margin-bottom: 60px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .page-title {
            font-size: 48px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #00FF85, #00CC6A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 20px;
            color: #B0B0B0;
            font-weight: 400;
        }

        /* ===== BLOOMBERG-STYLE FORM ===== */
        .report-form-container {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 40px;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #FFD600;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #FFD600;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: #FFD600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #FFFFFF;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #404040;
            border-radius: 8px;
            background: #2A2A2A;
            color: #FFFFFF;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: var(--font-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #FFD600;
            box-shadow: 0 0 0 3px rgba(255, 214, 0, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #FFD600;
        }

        .checkbox-item label {
            color: #FFFFFF;
            font-size: 14px;
            cursor: pointer;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-primary);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FFD600, #FFA500);
            color: #000000;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 214, 0, 0.3);
        }
        
        /* Fix button sizing for specific buttons */
        #toggleFallbackFormBtn {
            padding: 8px 16px !important;
            font-size: 14px !important;
            min-width: auto !important;
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            line-height: 1.4 !important;
            box-sizing: border-box !important;
        }
        
        /* Fix Remove button in file list */
        #fileListItems button {
            padding: 4px 10px !important;
            font-size: 12px !important;
            min-width: auto !important;
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            line-height: 1.4 !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }

        .btn-secondary {
            background: transparent;
            color: #FFFFFF;
            border: 1px solid #404040;
        }

        .btn-secondary:hover {
            background: #404040;
            border-color: #00FF85;
        }

        .btn-load-sample {
            background: linear-gradient(135deg, #FFD600, #FFA500);
            color: #000000;
        }

        .btn-load-sample:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 214, 0, 0.3);
        }

        /* ===== REPORT PREVIEW ===== */
        .report-preview {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 16px;
            padding: 40px;
            margin-top: 40px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .preview-title {
            font-size: 20px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .preview-actions {
            display: flex;
            gap: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .preview-content {
            background: #0F0F0F;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            min-height: 400px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: #B0B0B0;
            white-space: pre-wrap;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #404040;
            border-top: 4px solid #00FF85;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== FOOTER - EXACT MATCH TO HOMEPAGE ===== */
        .footer {
            background: #0F0F0F;
            border-top: 1px solid #333333;
            padding: 40px 0 20px;
            margin-top: auto;
            width: 100%;
        }

        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-xl);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 48px;
            margin-bottom: 32px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .footer-logo-svg {
            height: 50px !important;
            width: auto !important;
            filter: brightness(1.2) contrast(1.2) !important;
        }

        .footer-desc {
            font-size: 14px;
            color: #B0B0B0;
            line-height: 1.6;
            max-width: 300px;
        }

        .footer-title {
            font-size: 14px;
            font-weight: 600;
            color: #00FF85;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 8px;
        }

        .footer-links a {
            color: #B0B0B0;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #00FF85;
        }

        .footer-bottom {
            border-top: 1px solid #333333;
            padding-top: 20px;
            text-align: center;
            font-size: 11px;
            color: #666666;
        }

        /* ===== DIALOG BOXES ===== */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .dialog-overlay.show {
            display: flex;
        }

        .dialog-box {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .dialog-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .dialog-icon.success {
            color: #00FF85;
        }

        .dialog-icon.error {
            color: #FF4444;
        }

        .dialog-icon.info {
            color: #FFD600;
        }

        .dialog-title {
            font-size: 24px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 16px;
        }

        .dialog-message {
            font-size: 16px;
            color: #B0B0B0;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .dialog-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .dialog-btn-primary {
            background: linear-gradient(135deg, #00FF85, #00CC6A);
            color: #000000;
        }

        .dialog-btn-primary:hover {
            background: linear-gradient(135deg, #00CC6A, #00B359);
            transform: translateY(-2px);
        }

        .dialog-btn-secondary {
            background: transparent;
            color: #FFFFFF;
            border: 1px solid #404040;
        }

        .dialog-btn-secondary:hover {
            background: #404040;
            border-color: #00FF85;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .header-container {
                padding: 0 24px !important;
            }
            
            .container {
                padding: 0 24px;
            }
        }
        
        @media (max-width: 768px) {
            .header-container {
                padding: 0 16px !important;
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                height: 80px !important;
                gap: 16px !important;
            }
            
            .nav-menu {
                display: none !important;
            }
            
            .auth-buttons {
                display: none !important;
            }
            
            .user-profile {
                display: flex !important;
            }
            
            .user-info {
                display: none !important;
            }
            
            .dropdown-arrow {
                display: none !important;
            }
            
            .user-dropdown {
                right: 0 !important;
                left: auto !important;
                min-width: 180px !important;
            }
            
            .logo-svg {
                height: 50px !important;
            }
            
            
            .container {
                padding: 0 16px;
            }
            
            .page-title {
                font-size: 32px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .footer-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .market-ticker {
                height: 28px;
            }

            .ticker-item {
                min-width: 120px;
                padding: var(--space-xs) var(--space-sm);
            }

            .ticker-symbol {
                font-size: 9px;
            }

            .ticker-price {
                font-size: 10px;
            }

            .ticker-change {
                font-size: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .header-container {
                padding: 0 12px !important;
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                height: 80px !important;
                gap: 12px !important;
            }
            
            .nav-menu {
                display: none !important;
            }
            
            .auth-buttons {
                display: none !important;
            }
            
            .user-profile {
                display: flex !important;
                gap: 6px !important;
            }
            
            .user-info {
                display: none !important;
            }
            
            .dropdown-arrow {
                display: none !important;
            }
            
            .user-dropdown {
                right: 0 !important;
                left: auto !important;
                min-width: 180px !important;
            }
            
            .logo-svg {
                height: 45px !important;
            }
            
            .container {
                padding: 0 12px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .page-subtitle {
                font-size: 0.9rem;
            }
            
            .form-grid {
                gap: 16px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                font-size: 16px;
                padding: 12px 16px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
                padding: 14px;
                font-size: 14px;
                min-height: 44px;
            }
            
            .action-buttons {
                gap: 8px;
            }
        }

        /* Newsletter styling to match unified-footer component */
        .footer-newsletter-desc {
            font-size: 14px;
            color: #B0B0B0;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .newsletter {
            display: flex !important;
            flex-direction: row !important;
            gap: 8px !important;
            margin-top: 0 !important;
            align-items: center !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .newsletter input {
            flex: 1 1 auto !important;
            background: #2A2A2A !important;
            border: 1px solid #404040 !important;
            color: #FFFFFF !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            border-radius: 6px !important;
            box-sizing: border-box !important;
            min-width: 200px !important;
            height: 44px !important;
            line-height: 1.5 !important;
        }

        .newsletter input::placeholder {
            color: #CCCCCC !important;
        }

        .newsletter input:focus {
            outline: none !important;
            border-color: #00FF85 !important;
        }

        .newsletter button {
            background: #00FF85 !important;
            color: #FFFFFF !important;
            border: none !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            cursor: pointer !important;
            border-radius: 6px !important;
            transition: background 0.2s !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
            height: 44px !important;
            box-sizing: border-box !important;
            line-height: 1.5 !important;
            min-width: 100px !important;
            max-width: 120px !important;
        }

        .newsletter button:hover {
            background: #00CC6A !important;
        }

        @media (max-width: 768px) {
            .newsletter {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            .newsletter input,
            .newsletter button {
                width: 100% !important;
                height: 44px !important;
            }
        }
    
        /* Report Type Selection Styles */
        .report-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .report-type-card {
            background: #1E1E1E;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 30px;
            position: relative;
            transition: all 0.3s ease;
        }

        .report-type-card:hover {
            border-color: #00FF88;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .report-type-card.featured {
            border-color: #00FF88;
            background: linear-gradient(135deg, #1E1E1E 0%, #1A2A1E 100%);
        }

        .report-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: #00FF88;
            color: #000;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .report-type-header {
            margin-bottom: 25px;
        }

        .report-type-header h3 {
            font-size: 24px;
            color: #00FF88;
            margin-bottom: 10px;
        }

        .report-price {
            font-size: 36px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .report-features {
            list-style: none;
            padding: 0;
            margin: 25px 0;
        }

        .report-features li {
            padding: 12px 0;
            color: #B0B0B0;
            font-size: 15px;
            border-bottom: 1px solid #2A2A2A;
        }

        .report-features li:last-child {
            border-bottom: none;
        }

        .select-report-btn {
            width: 100%;
            padding: 15px;
            background: #FFD600;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .select-report-btn:hover {
            background: #FFC700;
            transform: scale(1.05);
        }

        .report-type-card.selected {
            border-color: #FFD600;
            box-shadow: 0 0 30px rgba(255, 214, 0, 0.3);
        }

        .report-type-card.selected .select-report-btn {
            background: #FFC700;
        }

        /* Stripe Payment Modal Overlay */
        .ci-stripe-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.85) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 10000 !important;
            backdrop-filter: blur(5px) !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .ci-stripe-container {
            background: #1A1A1A;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 50px rgba(0, 255, 136, 0.2);
            border: 1px solid #00FF88;
        }

        .ci-stripe-close {
            position: absolute !important;
            top: 15px !important;
            right: 15px !important;
            background: transparent !important;
            border: none !important;
            color: #00FF88 !important;
            font-size: 32px !important;
            cursor: pointer !important;
            z-index: 10001 !important;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 50% !important;
            transition: all 0.3s ease !important;
        }
        
        /* Hide close button when modal is hidden - use more specific selectors */
        #stripePaymentModal[style*="display: none"] .ci-stripe-close,
        #stripePaymentModal[data-force-hidden="true"] .ci-stripe-close,
        #stripePaymentModal[style*="visibility: hidden"] .ci-stripe-close {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Ensure close button is only visible when modal is visible */
        #stripePaymentModal:not([style*="display: none"]):not([data-force-hidden="true"]) .ci-stripe-close {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Additional safety: Hide button by default and only show when modal is explicitly shown */
        .ci-stripe-close {
            display: none !important;
        }
        
        #stripePaymentModal[style*="display: flex"] .ci-stripe-close,
        #stripePaymentModal[style*="display: block"] .ci-stripe-close {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .ci-stripe-close:hover {
            background: rgba(0, 255, 136, 0.1) !important;
            transform: rotate(90deg) !important;
        }

        .ci-stripe-header {
            padding: 30px;
            border-bottom: 1px solid #333;
        }

        .ci-stripe-header h2 {
            color: #00FF88;
            font-size: 24px;
            margin: 0 0 20px 0;
            font-weight: 600;
        }

        .ci-plan-summary {
            background: #2A2A2A;
            padding: 15px;
            border-radius: 8px;
        }

        .ci-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #E0E0E0;
            font-size: 14px;
        }

        .ci-summary-total {
            border-top: 1px solid #00FF88;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: 600;
            color: #00FF88;
        }

        .ci-stripe-body {
            padding: 30px;
        }

        .ci-payment-section {
            margin-bottom: 20px;
        }

        .ci-stripe-label {
            display: block;
            color: #00FF88;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .ci-payment-element {
            min-height: 100px;
            padding: 20px;
            background: #2A2A2A;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .ci-form-group {
            margin-bottom: 15px;
        }

        .ci-stripe-input {
            width: 100%;
            padding: 12px;
            background: #2A2A2A;
            border: 1px solid #444;
            border-radius: 4px;
            color: #E0E0E0;
            font-size: 14px;
        }

        .ci-stripe-input:focus {
            outline: none;
            border-color: #00FF88;
        }

        .ci-stripe-footer {
            padding: 20px 30px;
            border-top: 1px solid #333;
        }

        .ci-stripe-btn {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ci-stripe-btn-primary {
            background: #00FF88;
            color: #0A0A0A;
            border: none;
        }

        .ci-stripe-btn-primary:hover:not(:disabled) {
            background: #00DD77;
            transform: translateY(-2px);
        }

        .ci-stripe-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ci-stripe-btn-secondary {
            background: transparent;
            color: #E0E0E0;
            border: 1px solid #444;
        }

        .ci-stripe-btn-secondary:hover {
            border-color: #00FF88;
            color: #00FF88;
        }

        .ci-payment-errors {
            color: #FF4444;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Input field styles */
        .ci-input-group {
            margin-bottom: 15px;
        }
        
        .ci-input-field {
            width: 100%;
            padding: 12px;
            background: #2A2A2A !important;
            border: 1px solid #444;
            border-radius: 4px;
            color: #E0E0E0 !important;
            font-size: 14px;
        }
        
        .ci-input-field:focus {
            outline: none;
            border-color: #00FF88;
        }
        
        /* Button styles */
        .ci-btn-pay {
            width: 100%;
            padding: 18px;
            background: #00FF88;
            color: #0A0A0A;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        
        .ci-btn-pay:hover:not(:disabled) {
            background: #00DD77;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }
        
        .ci-btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ci-btn-cancel {
            flex: 1;
            padding: 15px;
            background: transparent;
            color: #E0E0E0;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ci-btn-cancel:hover {
            border-color: #00FF88;
            color: #00FF88;
        }
        
        .ci-security-badge {
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

    </style>
    <!-- Unified Header CSS -->
    <link rel="stylesheet" href="/css/unified-header.css">
    <link rel="stylesheet" href="css/responsive-global.css?v=1">
    <!-- Unified Authentication System -->
    <script src="/js/unified-auth.js" defer></script>
    <script src="/js/component-loader.js" defer></script>
    <script src="/js/user-profile-manager.js" defer></script>
    <script src="https://js.stripe.com/v3/" defer></script>

    <script>
    // Lightweight payment guard - minimal overhead
    (function() {
        window.paymentCompleted = false;
        window.canShowResults = function() {
            if (window.paymentCompleted) return true;
            try {
                const safeStorage = window.safeStorage || { getItem: () => null };
                const userData = safeStorage.getItem('user_data');
                if (userData) {
                    const user = JSON.parse(userData);
                    const tier = user.subscription_tier || user.subscriptionTier || 'free';
                    return tier && tier !== 'free' && tier !== 'FREE';
                }
            } catch(e) {}
            return false;
        };
    })();
    </script>
    
    <!-- Define switchValuationTab and related functions early so they're available for inline onclick handlers -->
    <script>
        // Define bulk processing access control function
        window.checkBulkProcessingAccess = function() {
            const bulkLockedState = document.getElementById('bulkLockedState');
            const bulkUnlockedState = document.getElementById('bulkUnlockedState');
            
            if (!bulkLockedState || !bulkUnlockedState) {
                console.warn(' Bulk processing elements not found');
                return;
            }
            
            // Always unlock bulk processing for all users
            console.log(' Unlocking bulk processing for all users');
            bulkLockedState.style.display = 'none';
            bulkUnlockedState.style.display = 'block';
        };
        
        // Define report type card update function
        window.updateReportTypeCardsForTab = function(isBulkTab) {
            const spotCheckCard = document.querySelector('.report-type-card[data-type="spot_check"]');
            const professionalCard = document.querySelector('.report-type-card[data-type="professional"]');
            const fleetCard = document.querySelector('.report-type-card[data-type="fleet_valuation"]');
            
            if (isBulkTab) {
                // Disable SPOT CHECK and PROFESSIONAL, enable only FLEET VALUATION
                if (spotCheckCard) {
                    spotCheckCard.style.opacity = '0.5';
                    spotCheckCard.style.pointerEvents = 'none';
                    spotCheckCard.style.cursor = 'not-allowed';
                    const spotCheckBtn = spotCheckCard.querySelector('.select-report-btn');
                    if (spotCheckBtn) {
                        spotCheckBtn.disabled = true;
                        spotCheckBtn.style.opacity = '0.5';
                        spotCheckBtn.style.cursor = 'not-allowed';
                    }
                }
                
                if (professionalCard) {
                    professionalCard.style.opacity = '0.5';
                    professionalCard.style.pointerEvents = 'none';
                    professionalCard.style.cursor = 'not-allowed';
                    const professionalBtn = professionalCard.querySelector('.select-report-btn');
                    if (professionalBtn) {
                        professionalBtn.disabled = true;
                        professionalBtn.style.opacity = '0.5';
                        professionalBtn.style.cursor = 'not-allowed';
                    }
                }
                
                if (fleetCard) {
                    fleetCard.style.opacity = '1';
                    fleetCard.style.pointerEvents = 'auto';
                    fleetCard.style.cursor = 'pointer';
                    const fleetBtn = fleetCard.querySelector('.select-report-btn');
                    if (fleetBtn) {
                        fleetBtn.disabled = false;
                        fleetBtn.style.opacity = '1';
                        fleetBtn.style.cursor = 'pointer';
                    }
                }
            } else {
                // Enable all report types for single valuation
                [spotCheckCard, professionalCard, fleetCard].forEach(card => {
                    if (card) {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                        card.style.cursor = 'pointer';
                        const btn = card.querySelector('.select-report-btn');
                        if (btn) {
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.cursor = 'pointer';
                        }
                    }
                });
            }
        };
        
        // Ensure function is available immediately - define it unconditionally
        window.switchValuationTab = function(tab, element) {
            // Set flag to prevent generateReport from running during tab switch
            window._isSwitchingTabs = true;
            
            // Update tab buttons (only within Equipment Information section)
            const equipmentSection = document.querySelector('.form-section');
            if (equipmentSection) {
                equipmentSection.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            }
            if (element) {
                element.classList.add('active');
            }
            
            // Update equipment form content (only affects Equipment Information section)
            const singleForm = document.getElementById('singleValuationEquipmentForm');
            const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
            
            // Remove required attributes from hidden form fields to prevent validation errors
            if (singleForm) {
                if (tab === 'single') {
                    singleForm.style.display = 'block';
                    // Restore required attributes
                    singleForm.querySelectorAll('[required]').forEach(field => {
                        if (!field.hasAttribute('data-was-required')) {
                            field.setAttribute('data-was-required', 'true');
                        }
                    });
                } else {
                    singleForm.style.display = 'none';
                    // Remove required attributes from hidden fields
                    singleForm.querySelectorAll('[required]').forEach(field => {
                        field.removeAttribute('required');
                    });
                }
            }
            if (bulkForm) {
                if (tab === 'bulk') {
                    bulkForm.style.display = 'block';
                    // Restore required attributes if they were saved
                    bulkForm.querySelectorAll('[data-was-required]').forEach(field => {
                        field.setAttribute('required', '');
                    });
                } else {
                    bulkForm.style.display = 'none';
                    // Remove required attributes from hidden fields
                    bulkForm.querySelectorAll('[required]').forEach(field => {
                        field.setAttribute('data-was-required', 'true');
                        field.removeAttribute('required');
                    });
                }
            }
            
            // Check bulk access when switching to bulk tab
            if (tab === 'bulk') {
                // First show the bulk form, then unlock it
                if (bulkForm) {
                    bulkForm.style.display = 'block';
                    console.log(' Bulk form displayed');
                }
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    if (typeof window.checkBulkProcessingAccess === 'function') {
                        window.checkBulkProcessingAccess();
                    } else {
                        console.error(' checkBulkProcessingAccess function not found');
                    }
                    // Update report type cards - disable SPOT CHECK and PROFESSIONAL, enable only FLEET VALUATION
                    if (typeof window.updateReportTypeCardsForTab === 'function') {
                        window.updateReportTypeCardsForTab(true);
                    } else {
                        console.error(' updateReportTypeCardsForTab function not found');
                    }
                }, 100);
            } else {
                // Enable all report types for single valuation
                if (typeof window.updateReportTypeCardsForTab === 'function') {
                    window.updateReportTypeCardsForTab(false);
                }
            }
            
            // Clear the tab switching flag after a short delay
            setTimeout(() => {
                window._isSwitchingTabs = false;
            }, 500);
            
            // Note: Valuation results section is always visible and not affected by this switch
        };
        
        // Define bulk processing file upload functions
        window.triggerBulkFileInput = function() {
            const fileInput = document.getElementById('bulkFileInput');
            if (fileInput) {
                fileInput.click();
            } else {
                console.error(' bulkFileInput element not found');
            }
        };
        
        window.downloadBulkTemplate = function() {
            const csvContent = "Manufacturer,Model,Year,Capacity (Tons),Operating Hours,Mileage,Crane Type,Boom Length (meters),Region,Jib Included,Jib Length (ft),Asking Price\nLiebherr,LTM 1500-8.1,2020,500,5000,25000,All-Terrain Crane,275,North America,No,0,3500000\nGrove,GMK6400,2019,400,6000,30000,All-Terrain Crane,197,Europe,Yes - Standard Jib,100,2800000\nTadano,ATF 220G-5,2021,220,3000,15000,All-Terrain Crane,197,Asia Pacific,No,0,1500000";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crane_valuation_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            if (window.notificationSystem) {
                window.notificationSystem.showSuccess('Template Downloaded', 'CSV template has been downloaded successfully.');
            }
        };
        
        // Note: handleBulkFileUpload is defined later in the file as it's async and depends on other functions
        // It will be available as window.handleBulkFileUpload when the page loads
    </script>
    
    </head>
<body>
    
    <!-- AUTHENTICATION CHECK - Restrict to logged-in users -->
    <!-- ============================================ -->
    <script>
        (function() {
            const safeStorage = window.safeStorage || { getItem: () => null };
            const token = safeStorage.getItem('access_token');
            const userData = safeStorage.getItem('user_data');
            
            if (!token || !userData) {
                console.log('  Access denied: User not authenticated');
                window.location.href = '/homepage.html';
            } else {
                try {
                    const user = JSON.parse(userData);
                } catch(e) {
                    console.log('  Could not parse user data');
                }
            }
        })();
    </script>
    
    <!-- Unified Header Component -->
    <div data-component="unified-header"></div>
    
    <!-- Unified Market Ticker Component -->
    <div data-component="unified-market-ticker"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Get Your Professional FMV Report</h1>
                <p class="page-subtitle">Professional crane valuation delivered within 24 hours</p>
            </div>

            <!-- Report Generation Form -->
            <div class="report-form-container">
                <form id="reportForm" novalidate>
                                        <!-- Equipment Information Section -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <h2 class="section-title" style="margin: 0;">Equipment Information</h2>
                            <!-- Tab Navigation (Single Valuation / Bulk Processing) - Only for Equipment Information -->
                            <div class="tab-navigation" style="display: flex; gap: 0;">
                                <button class="tab-btn active" id="singleValuationTab" onclick="switchValuationTab('single', this)" style="background: #2A2A2A; color: #FFFFFF; border: 1px solid #404040; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; font-family: 'Inter', sans-serif; font-weight: 500; border-radius: 8px 0 0 8px; font-size: 14px;">Single Valuation</button>
                                <button class="tab-btn" id="bulkProcessingTab" onclick="switchValuationTab('bulk', this)" style="background: #2A2A2A; color: #FFFFFF; border: 1px solid #404040; border-left: none; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; font-family: 'Inter', sans-serif; font-weight: 500; border-radius: 0 8px 8px 0; position: relative; font-size: 14px; white-space: nowrap !important; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;">
                                     Bulk Processing
                                </button>
                            </div>
                        </div>
                        
                        <!-- Single Valuation Equipment Form -->
                        <div id="singleValuationEquipmentForm" style="display: block;">
                        <div class="form-grid">
                            <!-- Row 1 - Crane Type first -->
                            <div class="form-group">
                                <label class="form-label">Crane Type *</label>
                                <select class="form-select" id="craneType" required>
                                    <option value="">Select Crane Type</option>
                                    <option value="Crawler Crane">Crawler Crane</option>
                                    <option value="All-Terrain Crane">All-Terrain Crane</option>
                                    <option value="Rough Terrain Crane">Rough Terrain Crane</option>
                                    <option value="Truck-Mounted Crane">Truck-Mounted Crane</option>
                                    <option value="Telescopic Crawler Crane">Telescopic Crawler Crane</option>
                                </select>
                            </div>
                            
                            <!-- Row 2 - Manufacturer with Other option -->
                            <div class="form-group">
                                <label class="form-label">Manufacturer *</label>
                                <select class="form-select" id="manufacturer" required>
                                    <option value="">Select Manufacturer</option>
                                    <option value="Liebherr">Liebherr (49 models)</option>
                                    <option value="Grove">Grove (25 models)</option>
                                    <option value="Manitowoc">Manitowoc (15 models)</option>
                                    <option value="Tadano">Tadano (15 models)</option>
                                    <option value="Sany">Sany (12 models)</option>
                                    <option value="Kobelco">Kobelco (30 models)</option>
                                    <option value="Link-Belt">Link-Belt (39 models)</option>
                                    <option value="Terex">Terex (3 models)</option>
                                    <option value="XCMG">XCMG (3 models)</option>
                                    <option value="Zoomlion">Zoomlion (2 models)</option>
                                    <option value="HSC">HSC (2 models)</option>
                                    <option value="Kato">Kato (3 models)</option>
                                    <option value="IHI">IHI (2 models)</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" class="form-input" id="manufacturerOther" placeholder="Enter manufacturer name" style="display: none; margin-top: 8px;">
                            </div>
                            
                            <!-- Row 3 - Model autocomplete -->
                            <div class="form-group">
                                <label class="form-label">Model *</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-input" id="model" placeholder="Type to search models..." autocomplete="off" required>
                                    <div id="modelSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: #1A1A1A; border: 1px solid #333; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                        <!-- Suggestions will be populated here -->
                                    </div>
                                </div>
                                <small style="color: #888; font-size: 0.85em; display: block; margin-top: 4px;">Start typing to see matching models</small>
                            </div>
                            
                            <!-- Fallback input section (shown when model not found) -->
                            <div id="fallbackInputSection" style="display: none; grid-column: 1 / -1; margin-top: 16px; padding: 16px; background: rgba(255, 214, 0, 0.05); border: 1px solid #FFD600; border-radius: 8px;">
                                <p style="color: #FFD600; font-weight: 600; margin-bottom: 12px;">Can't find your crane? Enter the details below:</p>
                                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div class="form-group">
                                        <label class="form-label">Manufacturer</label>
                                        <input type="text" class="form-input" id="fallbackInputManufacturer" placeholder="Enter manufacturer">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Model</label>
                                        <input type="text" class="form-input" id="fallbackInputModel" placeholder="Enter model">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 4 - Year, Capacity, Hours -->
                            <div class="form-group">
                                <label class="form-label">Year *</label>
                                <input type="number" class="form-input" id="year" placeholder="2023" min="1990" max="2025" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Capacity (Tons) *</label>
                                <input type="number" class="form-input" id="capacity" placeholder="500" min="1" max="2000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Operating Hours *</label>
                                <input type="number" class="form-input" id="operatingHours" placeholder="3700" min="0" required>
                            </div>
                            
                            <!-- Row 5 - Boom Length, Mileage, Region -->
                            <div class="form-group">
                                <label class="form-label">Boom Length (meters)</label>
                                <input type="number" class="form-input" id="boomLength" placeholder="60" step="0.1" min="0">
                                <small style="color: #888; font-size: 0.85em;">Typical: 20-80m for mobile cranes</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mileage</label>
                                <input type="number" class="form-input" id="mileage" placeholder="25000" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Region *</label>
                                <select class="form-select" id="region" required>
                                    <option value="">Select Region</option>
                                    <option value="North America">North America</option>
                                    <option value="Europe">Europe</option>
                                    <option value="Asia Pacific">Asia Pacific</option>
                                    <option value="Middle East">Middle East</option>
                                    <option value="Africa">Africa</option>
                                    <option value="South America">South America</option>
                                </select>
                            </div>
                            
                            <!-- Fleet Unit Count (shown only for Fleet Valuation) -->
                            <div class="form-group" id="fleetUnitCountGroup" style="display: none; grid-column: 1 / -1;">
                                <label class="form-label">Number of Cranes (1-50) *</label>
                                <input type="number" class="form-input" id="unitCount" placeholder="Enter number of cranes" min="1" max="50" value="1" onchange="updateFleetPricingFromInput()" oninput="updateFleetPricingFromInput()">
                                <small style="color: #888; font-size: 0.85em; display: block; margin-top: 4px;">
                                    <span id="fleetPricingInfo">Pricing: $1,495 for 1-5 cranes ($299/crane)</span>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Fallback Input Section -->
                        <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid #333;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <div>
                                    <h3 class="section-title" style="font-size: 18px; margin-bottom: 4px;">Can't find your crane?</h3>
                                    <p style="color: #888; font-size: 14px;">Enter the details below and our team will prepare a custom valuation</p>
                                </div>
                                <button type="button" id="toggleFallbackFormBtn" onclick="toggleFallbackForm()" style="background: #FFD600 !important; color: #000 !important; border: none !important; padding: 8px 16px !important; border-radius: 6px !important; font-weight: 600 !important; cursor: pointer !important; font-size: 14px !important; white-space: nowrap !important; box-sizing: border-box !important; min-width: auto !important; max-width: none !important; width: auto !important; height: auto !important; line-height: 1.4 !important;">
                                    Enter Details
                                </button>
                            </div>
                            
                            <!-- Expandable Fallback Form -->
                            <div id="fallbackFormSection" style="display: none; padding: 24px; background: rgba(255, 214, 0, 0.05); border: 1px solid #FFD600; border-radius: 8px;">
                                <form id="fallbackForm" novalidate>
                                    <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                        <!-- Basic Information -->
                                        <div class="form-group">
                                            <label class="form-label">Manufacturer *</label>
                                            <input type="text" class="form-input" id="fallbackManufacturer" placeholder="e.g., Liebherr, Grove, Manitowoc">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Model *</label>
                                            <input type="text" class="form-input" id="fallbackModel" placeholder="e.g., LTM 1120-4.1, GMK5250L">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Year *</label>
                                            <input type="number" class="form-input" id="fallbackYear" placeholder="e.g., 2020" min="1990" max="2025">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Serial Number</label>
                                            <input type="text" class="form-input" id="fallbackSerialNumber" placeholder="e.g., LTM1120-2020-001234">
                                        </div>
                                        
                                        <!-- Specifications -->
                                        <div class="form-group">
                                            <label class="form-label">Capacity (Tons) *</label>
                                            <input type="number" class="form-input" id="fallbackCapacity" placeholder="e.g., 120" min="1" max="2000">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Crane Type *</label>
                                            <select class="form-select" id="fallbackCraneType">
                                                <option value="">Select Crane Type</option>
                                                <option value="Crawler Crane">Crawler Crane</option>
                                                <option value="All-Terrain Crane">All-Terrain Crane</option>
                                                <option value="Rough Terrain Crane">Rough Terrain Crane</option>
                                                <option value="Truck-Mounted Crane">Truck-Mounted Crane</option>
                                                <option value="Telescopic Crawler Crane">Telescopic Crawler Crane</option>
                                                <option value="Gantry Crane">Gantry Crane</option>
                                                <option value="Tower Crane">Tower Crane</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Operating Hours *</label>
                                            <input type="number" class="form-input" id="fallbackOperatingHours" placeholder="e.g., 3,500" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Mileage</label>
                                            <input type="number" class="form-input" id="fallbackMileage" placeholder="e.g., 25,000" min="0">
                                        </div>
                                        
                                        <!-- Dimensions -->
                                        <div class="form-group">
                                            <label class="form-label">Boom Length (meters)</label>
                                            <input type="number" class="form-input" id="fallbackBoomLength" placeholder="e.g., 60" step="0.1" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Jib Length (meters)</label>
                                            <input type="number" class="form-input" id="fallbackJibLength" placeholder="e.g., 30" step="0.1" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Max Hook Height (meters)</label>
                                            <input type="number" class="form-input" id="fallbackMaxHookHeight" placeholder="e.g., 80" step="0.1" min="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Max Radius (meters)</label>
                                            <input type="number" class="form-input" id="fallbackMaxRadius" placeholder="e.g., 50" step="0.1" min="0">
                                        </div>
                                        
                                        <!-- Location & Condition -->
                                        <div class="form-group">
                                            <label class="form-label">Region *</label>
                                            <select class="form-select" id="fallbackRegion">
                                                <option value="">Select Region</option>
                                                <option value="North America">North America</option>
                                                <option value="Europe">Europe</option>
                                                <option value="Asia Pacific">Asia Pacific</option>
                                                <option value="Middle East">Middle East</option>
                                                <option value="Africa">Africa</option>
                                                <option value="South America">South America</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Condition *</label>
                                            <select class="form-select" id="fallbackCondition">
                                                <option value="">Select Condition</option>
                                                <option value="Excellent">Excellent - Like new, minimal wear</option>
                                                <option value="Very Good">Very Good - Well maintained, minor wear</option>
                                                <option value="Good">Good - Normal wear, fully operational</option>
                                                <option value="Fair">Fair - Some wear, may need minor repairs</option>
                                                <option value="Poor">Poor - Significant wear, needs repairs</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Additional Details -->
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Additional Specifications</label>
                                            <textarea class="form-input" id="fallbackAdditionalSpecs" rows="3" placeholder="e.g., Equipped with luffing jib, 4-axle configuration, air conditioning, GPS system, etc."></textarea>
                                        </div>
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Special Features or Modifications</label>
                                            <textarea class="form-input" id="fallbackSpecialFeatures" rows="2" placeholder="e.g., Custom boom extension, upgraded winch, additional counterweights, etc."></textarea>
                                        </div>
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Usage History</label>
                                            <textarea class="form-input" id="fallbackUsageHistory" rows="2" placeholder="e.g., Primarily used for construction projects, average 200 hours/year, stored indoors during off-season"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                                        <button type="button" onclick="saveManualEntry()" style="background: #FFD600; color: #000; border: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                            Save
                                        </button>
                                        <button type="button" onclick="toggleFallbackForm()" style="background: #2A2A2A; color: #FFF; border: 1px solid #444; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Service Records Upload Section -->
                        <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid #333;">
                            <h3 class="section-title" style="font-size: 18px; margin-bottom: 16px;">Service Records (Optional)</h3>
                            <div id="serviceRecordsUpload" style="border: 2px dashed #444; border-radius: 8px; padding: 24px; background: #1A1A1A; transition: all 0.3s ease;">
                                <div id="dropZone" style="text-align: center; cursor: pointer;">
                                    <div style="font-size: 48px; margin-bottom: 12px;"></div>
                                    <p style="color: #B0B0B0; margin-bottom: 8px; font-weight: 600;">Drag and drop service records here</p>
                                    <p style="color: #888; font-size: 14px; margin-bottom: 16px;">or click to browse</p>
                                    <input type="file" id="serviceRecordsInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                                    <button type="button" onclick="event.stopPropagation(); document.getElementById('serviceRecordsInput').click();" style="background: #FFD600; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">Select Files</button>
                                    <p style="color: #888; font-size: 12px; margin-top: 12px;">Accepted formats: PDF, JPG, PNG (max 20MB per file)</p>
                                </div>
                                <div id="fileList" style="margin-top: 20px; display: none;">
                                    <div style="color: #B0B0B0; font-weight: 600; margin-bottom: 12px;">Selected Files:</div>
                                    <div id="fileListItems"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Bulk Processing Equipment Form -->
                        <div id="bulkProcessingEquipmentForm" style="display: none;">
                            <div id="bulkLockedState" style="text-align: center; padding: 40px; background: #1A1A1A; border: 2px dashed #444; border-radius: 12px;">
                                <div style="font-size: 64px; margin-bottom: 20px;"></div>
                                <h3 style="color: #FF4444; font-size: 24px; font-weight: 700; margin-bottom: 12px;">Bulk Processing Locked</h3>
                                <p style="color: #B0B0B0; font-size: 16px; margin-bottom: 24px;">Bulk processing is available only for Fleet Valuation subscription tier.</p>
                                <button onclick="window.location.href='/report-generation.html'" style="background: #FFD600; color: #000; border: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                    Upgrade to Fleet Valuation
                                </button>
                            </div>
                            <div id="bulkUnlockedState" style="display: none;">
                                <div id="uploadArea" style="border: 2px dashed #FFD600; border-radius: 12px; padding: 40px; background: #1A1A1A; text-align: center; cursor: pointer; transition: all 0.3s ease;" onclick="if (!event.target.closest('button')) { window.triggerBulkFileInput(); }">
                                    <input type="file" id="bulkFileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="window.handleBulkFileUpload(event)">
                                    <div class="upload-icon" style="font-size: 64px; margin-bottom: 20px;"></div>
                                    <div class="upload-text" style="color: #FFD600; font-size: 18px; font-weight: 600; margin-bottom: 12px;">Click to upload or drag and drop</div>
                                    <div class="upload-subtext" style="color: #888; font-size: 14px; margin-bottom: 20px;">Supports .xlsx, .xls, and .csv files</div>
                                    <button type="button" onclick="event.stopPropagation(); window.downloadBulkTemplate();" style="background: #2A2A2A; color: #FFD600; border: 1px solid #FFD600; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 12px;">
                                         Download Template
                                    </button>
                                </div>
                                <div id="bulkResults" style="margin-top: 30px; display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Type Selection -->
                    <div class="form-section">
                        <h2 class="section-title">Select Report Type</h2>
                        <div class="report-type-grid" style="grid-template-columns: repeat(3, 1fr); gap: 24px;">
                            <!-- Spot Check Tier -->
                            <div class="report-type-card" data-type="spot_check" data-price="25000">
                                <div class="report-type-header">
                                    <h3>Spot Check  $250</h3>
                                    <div class="report-price">$250</div>
                                </div>
                                <ul class="report-features">
                                    <li> FMV range estimate</li>
                                    <li> Up to 5 cranes</li>
                                    <li> 23 comparables per crane</li>
                                    <li> 1-page summary per unit</li>
                                    <li> 24-hour turnaround</li>
                                    <li style="color:#FFB800;">Internal use only  Not a formal appraisal  No Deal/Wear scores or signature</li>
                                </ul>
                                <button class="select-report-btn" data-price="25000">Get Spot Check</button>
                            </div>
                            
                            <!-- Professional Tier -->
                            <div class="report-type-card featured" data-type="professional" data-price="99500">
                                <div class="report-badge">MOST POPULAR</div>
                                <div class="report-type-header">
                                    <h3>Professional - $995</h3>
                                    <div class="report-price">$995</div>
                                </div>
                                <ul class="report-features">
                                    <li> 1 crane</li>
                                    <li> 35 page PDF</li>
                                    <li> 5+ verified comps</li>
                                    <li> Deal & Wear Scores</li>
                                    <li> Regional commentary</li>
                                    <li> Signed by analyst</li>
                                    <li> 24-hour turnaround</li>
                                </ul>
                                <button class="select-report-btn" data-price="99500">Select Professional</button>
                            </div>
                            
                            <!-- Fleet Valuation Tier -->
                            <div class="report-type-card featured" data-type="fleet_valuation" data-price="149500">
                                <div class="report-badge">FLEET OPTION</div>
                                <div class="report-type-header">
                                    <h3>Fleet Valuation</h3>
                                    <div class="report-price">Starting at $1,495</div>
                                </div>
                                <ul class="report-features">
                                    <li> 250 cranes supported</li>
                                    <li> Multi-unit PDF (one page per crane)</li>
                                    <li> Fleet total summary</li>
                                    <li> CSV upload support</li>
                                    <li> Market overview</li>
                                    <li> 3672 hour turnaround</li>
                                </ul>
                                <div style="margin: 16px 0; padding: 12px; background: rgba(0, 255, 133, 0.05); border-radius: 6px; font-size: 12px; color: #B0B0B0;">
                                    <strong style="color: #00FF85;">Tiered Pricing:</strong><br>
                                    1-5: $1,495 ($299/crane)<br>
                                    6-10: $2,495 ($249/crane)<br>
                                    11-25: $4,995 ($199/crane)<br>
                                    26-50: $7,995 (~$159/crane)
                                </div>
                                <button class="select-report-btn" data-price="149500" data-fleet-tier="1-5">Select Fleet</button>
                            </div>
                        </div>
                    </div>

                    <!-- Report Options Section -->
                    <div class="form-section">
                        <h2 class="section-title">Report Options</h2>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeCharts" checked>
                                <label for="includeCharts">Include Charts & Visualizations</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeComparables" checked>
                                <label for="includeComparables">Include Comparable Sales</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeFinance" checked>
                                <label for="includeFinance">Include Finance Scenarios</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeMarket" checked>
                                <label for="includeMarket">Include Market Analysis</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="includeRisk" checked>
                                <label for="includeRisk">Include Risk Assessment</label>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" class="btn btn-load-sample" onclick="if(typeof window.loadSampleData==='function'){window.loadSampleData();}else{console.error('loadSampleData not available');}">
                            <span></span> Load Sample Data
                        </button>
                        <button type="button" class="btn btn-primary" id="purchaseReportBtn" disabled onclick="(function(){try{if(typeof window.purchaseReport==='function'){window.purchaseReport();}else if(typeof purchaseReport==='function'){purchaseReport();}else{console.error('purchaseReport not found');if(window.notificationSystem){window.notificationSystem.showError('Error','Purchase function not available. Please refresh the page.');}}}catch(e){console.error('Error calling purchaseReport:',e);if(window.notificationSystem){window.notificationSystem.showError('Error','Failed to initiate purchase. Please try again.');}}})();">
                            <span></span> Purchase Report
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <span></span> Clear Form
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                            <span></span> Back to Dashboard
                        </button>
                    </div>
                </form>
            </div>

    <!-- Valuation Results Section -->
    <div id="valuationResultsSection" style="display: none !important; margin-top: 20px; padding: 40px 20px 120px 20px; background: #0F0F0F; position: relative; margin-bottom: 60px;">
        
        <div style="max-width: 1400px; margin: 0 auto; position: relative;">
            <!-- Disclaimer Section (based on subscription plan) -->
            <div id="resultsDisclaimer" style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 24px; border-radius: 12px; border: 2px solid #00FF85; margin-bottom: 30px;">
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="font-size: 32px;"></div>
                    <div style="flex: 1;">
                        <h3 style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 12px; text-transform: uppercase;">Valuation Overview</h3>
                        <p id="disclaimerText" style="color: #B0B0B0; font-size: 14px; line-height: 1.6; margin: 0;">
                            Your report request has been submitted successfully. A detailed professional report will be manually prepared and sent to you via email within 24 hours.
                        </p>
                        <p style="color: #888; font-size: 12px; line-height: 1.6; margin-top: 12px; margin-bottom: 0; font-style: italic;">
                            <strong style="color: #FFB800;">Note:</strong> The final professional report will include comprehensive market analysis, comparable sales data, condition assessment, and detailed recommendations.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Valuation Results Content -->
            <div id="valuationResultsContent" style="display: block;">
                <h2 style="color: #00FF85; font-size: 28px; font-weight: 700; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 0.5px;">Crane Valuation Results</h2>
                
                <!-- Key Metrics Cards -->
            <div class="results-cards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px;">
                <div class="result-card" style="background: #1A1A1A; padding: 30px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                    <div class="result-value" id="resultsEstimatedValue" style="color: #00FF85; font-size: 36px; font-weight: 800; margin-bottom: 10px;">--</div>
                    <div class="result-label" style="color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">ESTIMATED VALUE</div>
                    <div class="result-sublabel" id="resultsValueDifference" style="color: #FF4444; font-size: 12px;">--</div>
                </div>
                <div class="result-card" style="background: #1A1A1A; padding: 30px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                    <div class="result-value" id="resultsConfidenceScore" style="color: #00FF88; font-size: 36px; font-weight: 800; margin-bottom: 10px;">--</div>
                    <div class="result-label" style="color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">CONFIDENCE SCORE</div>
                    <div class="result-sublabel" id="resultsConfidenceLevel" style="color: #888; font-size: 12px;">--</div>
                </div>
                <div class="result-card" style="background: #1A1A1A; padding: 30px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                    <div class="result-value" id="resultsDealGrade" style="color: #00FF88; font-size: 36px; font-weight: 800; margin-bottom: 10px;">--</div>
                    <div class="result-label" style="color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">DEAL GRADE</div>
                    <div class="result-sublabel" id="resultsDealRecommendation" style="color: #888; font-size: 12px;">--</div>
                </div>
            </div>
            
                <!-- Analysis Tabs -->
                <div class="analysis-tabs" style="display: flex; gap: 0; border-bottom: 2px solid #333333; margin-bottom: 30px;">
                    <button class="analysis-tab active" onclick="switchResultsTab('overview', this)" data-tab="overview" style="padding: 12px 24px; background: transparent; border: none; color: #00FF85; font-weight: 600; font-size: 14px; text-transform: uppercase; cursor: pointer; border-bottom: 2px solid #00FF85; transition: all 0.3s ease;"> EXECUTIVE SUMMARY</button>
                    <button class="analysis-tab" onclick="switchResultsTab('breakdown', this)" data-tab="breakdown" style="padding: 12px 24px; background: transparent; border: none; color: #B0B0B0; font-weight: 600; font-size: 14px; text-transform: uppercase; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease;"> FINANCIAL</button>
                    <button class="analysis-tab" onclick="switchResultsTab('rental', this)" data-tab="rental" style="padding: 12px 24px; background: transparent; border: none; color: #B0B0B0; font-weight: 600; font-size: 14px; text-transform: uppercase; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease;"> RENTAL vs PURCHASE</button>
                    <button class="analysis-tab" onclick="switchResultsTab('comparables', this)" data-tab="comparables" style="padding: 12px 24px; background: transparent; border: none; color: #B0B0B0; font-weight: 600; font-size: 14px; text-transform: uppercase; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease;"> COMPARISON</button>
                    <button class="analysis-tab" onclick="switchResultsTab('risk', this)" data-tab="risk" style="padding: 12px 24px; background: transparent; border: none; color: #B0B0B0; font-weight: 600; font-size: 14px; text-transform: uppercase; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease;"> RISK & RESALE</button>
                </div>
            
            <!-- Tab Content -->
            <div id="resultsTabContent" style="filter: blur(0px); transition: filter 0.3s ease; padding-bottom: 60px; min-height: 500px;">
                <div class="tab-content active" id="overview-tab" style="display: block; padding-bottom: 40px;">
                    <div id="overviewContent">
                        <!-- Valuation Trend Chart -->
                        <div class="chart-container" style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                            <div class="chart-title" style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase;">VALUATION TREND ANALYSIS</div>
                            <canvas id="resultsTrendChart" style="max-height: 400px;"></canvas>
                        </div>
                        
                        <!-- Metrics Grid -->
                        <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                            <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                <div class="metric-value" id="resultsAgeFactor" style="color: #00FF88; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">AGE FACTOR</div>
                            </div>
                            <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                <div class="metric-value" id="resultsCondition" style="color: #00FF88; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">CONDITION</div>
                            </div>
                            <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                <div class="metric-value" id="resultsMarketDemand" style="color: #00FF88; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">MARKET DEMAND</div>
                            </div>
                            <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                <div class="metric-value" id="resultsRiskScore" style="color: #00FF88; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">RISK SCORE</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="breakdown-tab" style="display: none; min-height: 400px; padding-bottom: 40px;">
                    <div id="breakdownContent" style="padding: 20px 0;">
                        <div class="chart-container" style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                            <div class="chart-title" style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase;">VALUATION COST BREAKDOWN</div>
                            <div style="background: #1A1A1A; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #00FF88; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Base Value Calculation</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Capacity Base Price</div>
                                    <div style="text-align: right; color: #00FF88; font-weight: 600;" id="breakdownCapacityBase">--</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Manufacturer Premium</div>
                                    <div style="text-align: right; color: #00FF88; font-weight: 600;" id="breakdownManufacturerPremium">--</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Model Premium</div>
                                    <div style="text-align: right; color: #00FF88; font-weight: 600;" id="breakdownModelPremium">--</div>
                                </div>
                                <div style="border-top: 2px solid #00FF88; padding-top: 15px; margin-top: 15px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div style="color: #FFFFFF; font-weight: 600;">Subtotal (Base Value)</div>
                                        <div style="text-align: right; color: #00FF88; font-size: 1.2rem; font-weight: 700;" id="breakdownSubtotal">--</div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #1A1A1A; padding: 20px; border-radius: 8px;">
                                <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Adjustments</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Age Depreciation</div>
                                    <div style="text-align: right; color: #FFB800; font-weight: 600;" id="breakdownAgeDepreciation">--</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Operating Hours Adjustment</div>
                                    <div style="text-align: right; color: #FF4444; font-weight: 600;" id="breakdownHoursAdj">--</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="color: #B0B0B0;">Regional Factor</div>
                                    <div style="text-align: right; color: #00FF88; font-weight: 600;" id="breakdownRegionalFactor">--</div>
                                </div>
                                <div style="border-top: 2px solid #FFB800; padding-top: 15px; margin-top: 15px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div style="color: #FFFFFF; font-weight: 600;">Total Adjustments</div>
                                        <div style="text-align: right; color: #FFB800; font-size: 1.2rem; font-weight: 700;" id="breakdownTotalAdjustments">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="rental-tab" style="display: none; min-height: 400px; padding-bottom: 40px;">
                    <div id="rentalContent" style="padding: 20px 0;">
                        <div class="chart-container" style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                            <div class="chart-title" style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase;">RENTAL VS PURCHASE ANALYSIS</div>
                            <div style="background: #1A1A1A; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="color: #00FF88; margin-bottom: 1rem; font-size: 1.1rem;">RENTAL RATES</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                                    <div style="background: #0F0F0F; padding: 20px; border-radius: 8px; border: 1px solid #404040;">
                                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Bare Rental</div>
                                        <div style="font-size: 2rem; font-weight: 800; color: #00FF88; margin-bottom: 0.25rem;" id="rentalBareMonthly">--</div>
                                        <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    </div>
                                    <div style="background: #0F0F0F; padding: 20px; border-radius: 8px; border: 1px solid #404040;">
                                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Operated Rental</div>
                                        <div style="font-size: 2rem; font-weight: 800; color: #FFB800; margin-bottom: 0.25rem;" id="rentalOperatedMonthly">--</div>
                                        <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #1A1A1A; padding: 20px; border-radius: 8px;">
                                <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem;">5-YEAR COST COMPARISON</h4>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid #404040;">
                                                <th style="padding: 12px; text-align: left; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Scenario</th>
                                                <th style="padding: 12px; text-align: right; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Initial Cost</th>
                                                <th style="padding: 12px; text-align: right; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">5-Year Operating</th>
                                                <th style="padding: 12px; text-align: right; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">5-Year Total</th>
                                                <th style="padding: 12px; text-align: center; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Recommendation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rentalVsPurchaseBody">
                                            <tr style="border-bottom: 1px solid #333;">
                                                <td style="padding: 12px; color: #FFFFFF;">Purchase</td>
                                                <td style="padding: 12px; text-align: right; color: #00FF88;" id="purchaseInitialCost">--</td>
                                                <td style="padding: 12px; text-align: right; color: #00FF88;" id="purchaseOperatingCost">--</td>
                                                <td style="padding: 12px; text-align: right; color: #00FF88; font-weight: 600;" id="purchaseTotalCost">--</td>
                                                <td style="padding: 12px; text-align: center; color: #00FF88;">Long-term investment</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid #333;">
                                                <td style="padding: 12px; color: #FFFFFF;">Bare Rental (5yr)</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800;">$0</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800;" id="rentalBare5Year">--</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800; font-weight: 600;" id="rentalBareTotal">--</td>
                                                <td style="padding: 12px; text-align: center; color: #FFB800;">Flexible option</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 12px; color: #FFFFFF;">Operated Rental (5yr)</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800;">$0</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800;" id="rentalOperated5Year">--</td>
                                                <td style="padding: 12px; text-align: right; color: #FFB800; font-weight: 600;" id="rentalOperatedTotal">--</td>
                                                <td style="padding: 12px; text-align: center; color: #FFB800;">Full service</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="comparables-tab" style="display: none; min-height: 400px; padding-bottom: 40px;">
                    <div id="comparablesContent" style="padding: 20px 0;">
                        <div class="chart-container" style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                            <div class="chart-title" style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase;">COMPARABLE SALES DATA</div>
                            <div style="background: #1A1A1A; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00FF88;">
                                <p style="color: #888; font-size: 0.9rem; margin: 0;">
                                    <strong style="color: #00FF88;">Note:</strong> Comparables are filtered by crane class and capacity range (30%) to ensure accuracy and relevance.
                                </p>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #404040;">
                                            <th style="padding: 12px; text-align: left; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Equipment</th>
                                            <th style="padding: 12px; text-align: left; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Type</th>
                                            <th style="padding: 12px; text-align: center; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Year</th>
                                            <th style="padding: 12px; text-align: center; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Capacity</th>
                                            <th style="padding: 12px; text-align: center; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Hours</th>
                                            <th style="padding: 12px; text-align: right; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Sale Price</th>
                                            <th style="padding: 12px; text-align: right; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Price/Ton</th>
                                            <th style="padding: 12px; text-align: center; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.85rem;">Location</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparablesTableBody">
                                        <tr style="border-bottom: 1px solid #333;">
                                            <td colspan="8" style="padding: 40px; text-align: center; color: #888; font-size: 14px;">Loading comparable sales data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="risk-tab" style="display: none; min-height: 400px; padding-bottom: 40px;">
                    <div id="riskContent" style="padding: 20px 0;">
                        <div class="chart-container" style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                            <div class="chart-title" style="color: #00FF85; font-size: 18px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase;">RISK & RESALE ANALYSIS</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                                <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                    <div class="metric-value" id="riskMarketRisk" style="color: #FF4444; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                    <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">MARKET RISK</div>
                                </div>
                                <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                    <div class="metric-value" id="riskConditionRisk" style="color: #FFB800; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                    <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">CONDITION RISK</div>
                                </div>
                                <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                    <div class="metric-value" id="riskAgeRisk" style="color: #FFB800; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                    <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">AGE RISK</div>
                                </div>
                                <div class="metric-card" style="background: #1A1A1A; padding: 20px; border-radius: 12px; border: 1px solid #333333; text-align: center;">
                                    <div class="metric-value" id="riskLocationRisk" style="color: #00FF88; font-size: 32px; font-weight: 800; margin-bottom: 10px;">--</div>
                                    <div class="metric-label" style="color: #888; font-size: 12px; text-transform: uppercase;">LOCATION RISK</div>
                                </div>
                            </div>
                            <div class="metric-card" style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 40px; border-radius: 12px; border: 2px solid #00FF88; text-align: center; margin-top: 20px;">
                                <div class="metric-value" id="riskOverallRisk" style="color: #00FF88; font-size: 48px; font-weight: 800; margin-bottom: 10px;">--</div>
                                <div class="metric-label" style="color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">OVERALL RISK SCORE</div>
                            </div>
                            <div style="background: #1A1A1A; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 4px solid #00FF88;">
                                <h4 style="color: #00FF88; margin-bottom: 15px; font-size: 1.1rem;">RESALE VALUE PROJECTION</h4>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                    <div>
                                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">1 Year</div>
                                        <div style="color: #00FF88; font-size: 1.5rem; font-weight: 700;" id="resale1Year">--</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">3 Years</div>
                                        <div style="color: #FFB800; font-size: 1.5rem; font-weight: 700;" id="resale3Years">--</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">5 Years</div>
                                        <div style="color: #FF4444; font-size: 1.5rem; font-weight: 700;" id="resale5Years">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Subscription Paywall Modal -->
    <div id="subscriptionPaywallModal" style="display: none !important; visibility: hidden !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center;" data-force-hidden="true">
        <div style="background: #0A0A0A; border: 2px solid #00FF85; border-radius: 12px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative;">
            <button onclick="closeSubscriptionPaywall()" style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #B0B0B0; font-size: 32px; cursor: pointer; z-index: 1; line-height: 1;">&times;</button>
            
            <div style="padding: 40px 30px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 20px;"></div>
                <h2 style="font-size: 32px; font-weight: 700; color: #00FF85; margin-bottom: 16px; text-transform: uppercase;">SUBSCRIPTION REQUIRED</h2>
                <p id="paywallMessage" style="color: #B0B0B0; font-size: 18px; line-height: 1.6; margin-bottom: 40px;">
                    You need an active subscription to access FMV reports. Choose a plan below to get started.
                </p>
                
                <!-- Subscription Plans -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Spot Check Plan -->
                    <div style="background: #1A1A1A; border: 2px solid #2A2A2A; border-radius: 8px; padding: 24px; position: relative;">
                        <h3 style="font-size: 18px; font-weight: 700; color: #FFFFFF; margin-bottom: 16px;">SPOT CHECK</h3>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 36px; font-weight: 700; color: #00FF85; line-height: 1;">$495</div>
                            <div style="color: #B0B0B0; margin-top: 8px; font-size: 12px;">Pay-per-use</div>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; text-align: left;">
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> 1 crane per valuation</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> PDF reports</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Email support</li>
                        </ul>
                        <button onclick="selectPaywallPlan('spot_check')" style="width: 100%; padding: 14px; background: transparent; color: #00FF85; border: 2px solid #00FF85; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            SELECT PLAN
                        </button>
                    </div>
                    
                    <!-- Professional Plan -->
                    <div style="background: #1A1A1A; border: 2px solid #00FF85; border-radius: 8px; padding: 24px; position: relative; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2);">
                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #00FF85; color: #000000; padding: 6px 16px; border-radius: 4px; font-size: 11px; font-weight: 700;">MOST POPULAR</div>
                        <h3 style="font-size: 18px; font-weight: 700; color: #FFFFFF; margin-bottom: 16px;">PROFESSIONAL</h3>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 36px; font-weight: 700; color: #00FF85; line-height: 1;">$995</div>
                            <div style="color: #B0B0B0; margin-top: 8px; font-size: 12px;">Pay-per-use</div>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; text-align: left;">
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> 1 crane per valuation</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> PDF reports</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Priority support</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Custom reports</li>
                        </ul>
                        <button onclick="selectPaywallPlan('professional')" style="width: 100%; padding: 14px; background: #00FF85; color: #000000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            SELECT PLAN
                        </button>
                    </div>
                    
                    <!-- Fleet Valuation Plan -->
                    <div style="background: #1A1A1A; border: 2px solid #2A2A2A; border-radius: 8px; padding: 24px; position: relative;">
                        <h3 style="font-size: 18px; font-weight: 700; color: #FFFFFF; margin-bottom: 16px;">FLEET VALUATION</h3>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 36px; font-weight: 700; color: #00FF85; line-height: 1;">Starting at $1,495</div>
                            <div style="color: #B0B0B0; margin-top: 8px; font-size: 12px;">Pay-per-use  Tiered pricing</div>
                        </div>
                        <div style="background: rgba(0, 255, 133, 0.05); border: 1px solid rgba(0, 255, 133, 0.2); border-radius: 6px; padding: 10px; margin-bottom: 16px; font-size: 10px; color: #B0B0B0; text-align: left;">
                            <strong style="color: #00FF85;">Tiered Pricing:</strong><br>
                            1-5: $1,495 ($299/crane)<br>
                            6-10: $2,495 ($249/crane)<br>
                            11-25: $4,995 ($199/crane)<br>
                            26-50: $7,995 (~$159/crane)
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; text-align: left;">
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> 2-50 cranes supported</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Multi-unit PDF (one page per crane)</li>
                            <li style="color: #00FF85; margin-bottom: 12px; font-size: 13px; font-weight: 600;"> CSV upload support</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Fleet total summary</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> Market overview</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> 36-72 hour turnaround</li>
                            <li style="color: #E0E0E0; margin-bottom: 12px; font-size: 13px;"> 5 valuations per payment</li>
                        </ul>
                        <button onclick="selectPaywallPlan('fleet_valuation')" style="width: 100%; padding: 14px; background: transparent; color: #00FF85; border: 2px solid #00FF85; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            SELECT PLAN
                        </button>
                    </div>
                </div>
                
                <p style="text-align: center; color: #888; margin-top: 30px; font-size: 13px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Secure payment processing  Cancel anytime
                </p>
                
                <!-- Continue with Payment Option -->
                <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #333;">
                    <p style="color: #B0B0B0; font-size: 14px; margin-bottom: 20px;">
                        Or purchase this report directly. Your subscription will be automatically upgraded upon payment.
                    </p>
                    <button onclick="proceedWithPayment()" style="width: 100%; padding: 16px; background: #00FF85; color: #000000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                         Continue with Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Generating your professional report...</p>
            </div>

            <!-- Report Preview -->
            <div class="report-preview" id="reportPreview" style="display: none;">
                <div class="preview-header">
                    <h3 class="preview-title">Bloomberg Terminal Report</h3>
                    <div class="preview-actions">
                        <button class="btn btn-primary btn-small" onclick="downloadReport()">
                            <span></span> Download PDF
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="shareReport()">
                            <span></span> Share
                        </button>
                    </div>
                </div>
                
                <!-- Bloomberg Terminal Style Report Content -->
                <div class="bloomberg-report" id="bloombergReport">
                    <!-- Market Overview Charts -->
                    <div class="bloomberg-chart">
                        <div class="chart-header">
                            <span class="chart-title">EQUIPMENT VALUATION TREND</span>
                            <span class="chart-timeframe">LIVE DATA</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="valuationTrendChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #00FF85;"></div>
                                <span>Current Valuation</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FFD600;"></div>
                                <span>Market Average</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #FF4444;"></div>
                                <span>Risk Threshold</span>
                            </div>
                        </div>
                    </div>

                    <!-- Market Data Grid -->
                    <div class="market-data-grid">
                        <div class="market-data-item">
                            <div class="market-data-label">Current Value</div>
                            <div class="market-data-value price-up">$2,100,000</div>
                            <div class="market-data-change price-up">+5.2%</div>
                        </div>
                        <div class="market-data-item">
                            <div class="market-data-label">Market Cap</div>
                            <div class="market-data-value">$2,850,000</div>
                            <div class="market-data-change price-up">+2.1%</div>
                        </div>
                        <div class="market-data-item">
                            <div class="market-data-label">Volume</div>
                            <div class="market-data-value">847</div>
                            <div class="market-data-change price-neutral">0.0%</div>
                        </div>
                        <div class="market-data-item">
                            <div class="market-data-label">Risk Score</div>
                            <div class="market-data-value price-down">Low</div>
                            <div class="market-data-change price-up">-12.5%</div>
                        </div>
                    </div>

                    <!-- Comparative Analysis Charts -->
                    <div class="chart-grid">
                        <div class="bloomberg-chart">
                            <div class="chart-header">
                                <span class="chart-title">PRICE COMPARISON</span>
                                <span class="chart-timeframe">6M</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="priceComparisonChart"></canvas>
                            </div>
                        </div>
                        <div class="bloomberg-chart">
                            <div class="chart-header">
                                <span class="chart-title">MARKET ACTIVITY</span>
                                <span class="chart-timeframe">30D</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="marketActivityChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Analysis Chart -->
                    <div class="bloomberg-chart">
                        <div class="chart-header">
                            <span class="chart-title">RISK ASSESSMENT MATRIX</span>
                            <span class="chart-timeframe">REAL-TIME</span>
                        </div>
                        <div class="chart-container">
                            <div id="riskMatrixChart"></div>
                        </div>
                    </div>

                    <!-- Mini Charts Grid -->
                    <div class="chart-grid">
                        <div class="mini-chart">
                            <div class="chart-title">DEPRECIATION CURVE</div>
                            <canvas id="depreciationChart"></canvas>
                        </div>
                        <div class="mini-chart">
                            <div class="chart-title">UTILIZATION RATE</div>
                            <canvas id="utilizationChart"></canvas>
                        </div>
                        <div class="mini-chart">
                            <div class="chart-title">MAINTENANCE COST</div>
                            <canvas id="maintenanceChart"></canvas>
                        </div>
                        <div class="mini-chart">
                            <div class="chart-title">RESALE VALUE</div>
                            <canvas id="resaleChart"></canvas>
                        </div>
                    </div>

                    <!-- Financial Scenarios Chart -->
                    <div class="bloomberg-chart">
                        <div class="chart-header">
                            <span class="chart-title">FINANCING SCENARIOS</span>
                            <span class="chart-timeframe">PROJECTED</span>
                        </div>
                        <div class="chart-container">
                            <div id="financingScenariosChart"></div>
                        </div>
                    </div>

                    <!-- Raw Data Display -->
                    <div class="preview-content" id="previewContent" style="display: none;">
                        <!-- Raw JSON data will be displayed here for debugging -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals - Fixed Position Overlays (Before Footer) -->
    <style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    </style>

    <!-- Stripe Payment Modal -->
    <div id="stripePaymentModal" class="ci-stripe-modal" style="display: none !important; visibility: hidden !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; backdrop-filter: blur(5px);" data-force-hidden="true">
        <div class="ci-stripe-container" style="background: #1A1A1A; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 50px rgba(0, 255, 136, 0.2); border: 1px solid #00FF88; margin: auto; top: 50%; transform: translateY(-50%);">
            <button class="ci-stripe-close" onclick="closeStripeModal()" aria-label="Close" style="position: absolute !important; top: 15px !important; right: 15px !important; background: transparent !important; border: none !important; color: #00FF88 !important; font-size: 32px !important; cursor: pointer !important; z-index: 10001 !important; width: 40px !important; height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important;">&times;</button>
            
            <div class="ci-stripe-header" style="padding: 30px; border-bottom: 1px solid #333;">
                <h2 style="color: #00FF88; font-size: 24px; margin: 0 0 20px 0; font-weight: 600;">COMPLETE PURCHASE</h2>
                <div class="ci-plan-summary" style="background: #2A2A2A; padding: 15px; border-radius: 8px;">
                    <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                        <span>Report Type</span>
                        <span id="selectedReportName"></span>
                                </div>
                    <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                        <span>Crane</span>
                        <span id="selectedCraneInfo"></span>
                            </div>
                    <div class="ci-summary-row ci-summary-total" style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 1px solid #00FF88; margin-top: 10px; padding-top: 15px; font-size: 18px; font-weight: 600; color: #00FF88;">
                        <span>Total</span>
                        <span id="selectedReportPrice"></span>
                        </div>
                    </div>
                </div>
            
            <div class="ci-stripe-body" style="padding: 30px;">
                <div class="ci-payment-section" style="margin-bottom: 20px;">
                    <label class="ci-stripe-label" style="display: block; color: #00FF88; font-size: 12px; font-weight: 600; margin-bottom: 10px;">PAYMENT METHOD</label>
                    <div id="payment-element" class="ci-payment-element" style="min-height: 100px; padding: 20px; background: #2A2A2A; border-radius: 4px; margin-bottom: 15px;">
                        <div id="payment-loading" style="text-align: center; color: #00FF88;">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00FF88" stroke-width="2" style="animation: spin 1s linear infinite;">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            <p style="margin-top: 10px; font-size: 14px;">Loading payment methods...</p>
                                </div>
                                </div>
                    <div id="payment-errors" class="ci-payment-errors" style="color: #FF4444; font-size: 14px; margin-top: 10px;"></div>
                                </div>
                
                <div class="ci-input-group" style="margin-bottom: 20px;">
                    <label class="ci-stripe-label" style="display: block; color: #00FF88; font-size: 12px; font-weight: 600; margin-bottom: 10px;">CARDHOLDER NAME</label>
                    <input type="text" id="cardholderName" class="ci-input-field" placeholder="John Doe" required style="width: 100%; padding: 12px; background: #2A2A2A; border: 1px solid #404040; border-radius: 6px; color: #FFFFFF; font-size: 14px;">
                                </div>
                
                <div class="ci-input-group" style="margin-bottom: 20px;">
                    <label class="ci-stripe-label" style="display: block; color: #00FF88; font-size: 12px; font-weight: 600; margin-bottom: 10px;">EMAIL FOR RECEIPT</label>
                    <input type="email" id="receiptEmail" class="ci-input-field" placeholder="john@company.com" required style="width: 100%; padding: 12px; background: #2A2A2A; border: 1px solid #404040; border-radius: 6px; color: #FFFFFF; font-size: 14px;">
                            </div>
                            </div>
            
            <div class="ci-stripe-footer" style="padding: 30px; border-top: 1px solid #333;">
                <button id="submitPayment" class="ci-btn-pay" style="width: 100%; padding: 16px; background: #00FF88; color: #000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    PROCESS PAYMENT
                </button>
                <p class="ci-security-badge" style="text-align: center; color: #888; font-size: 12px; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                    </svg>
                    Powered by Stripe  PCI DSS Level 1 Certified
                </p>
                                    </div>
                                    </div>
                                    </div>

    <!-- Success Modal -->
    <div id="successModal" class="ci-stripe-modal" style="display: none !important; visibility: hidden !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10001; backdrop-filter: blur(5px);" data-force-hidden="true">
        <div class="ci-stripe-container" style="background: #1A1A1A; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 10px 50px rgba(0, 255, 136, 0.2); border: 1px solid #00FF88; margin: auto; top: 50%; transform: translateY(-50%);">
            <button class="ci-stripe-close" onclick="closeSuccessModal()" aria-label="Close" style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #00FF88; font-size: 32px; cursor: pointer; z-index: 10002; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">&times;</button>
            
            <div class="ci-stripe-header" style="padding: 30px; border-bottom: 1px solid #333; text-align: center;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #00FF88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #000;"></div>
                <h2 style="color: #00FF88; margin-bottom: 10px; font-size: 24px; font-weight: 600;">PAYMENT SUCCESSFUL!</h2>
                <p style="color: #888; font-size: 14px;">Your FMV report request has been received</p>
                                </div>
            
            <div class="ci-plan-summary" style="padding: 30px; background: #2A2A2A; margin: 0;">
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                    <span>Transaction ID</span>
                    <span id="success-transaction-id">-</span>
                            </div>
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                    <span>Payment Intent</span>
                    <span id="success-payment-intent">-</span>
                        </div>
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                    <span>Report Type</span>
                    <span id="success-report-type">-</span>
                    </div>
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                    <span>Crane Model</span>
                    <span id="success-crane-model">-</span>
                </div>
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; color: #E0E0E0; font-size: 14px;">
                    <span>Payment Date</span>
                    <span id="success-payment-date">-</span>
                </div>
                <div class="ci-summary-row" style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 20px; padding-top: 20px; border-top: 2px solid #00FF88;">
                    <span style="color: #00FF88; font-size: 18px; font-weight: 600;">Amount Paid</span>
                    <span style="color: #00FF88; font-size: 24px; font-weight: 600;" id="success-amount">-</span>
                </div>
            </div>
            
            <div style="padding: 30px; background: rgba(0, 255, 136, 0.1); border: 1px solid #00FF88; border-radius: 8px; margin: 30px;">
                <h3 style="color: #00FF88; margin-bottom: 10px; font-size: 16px;"> What's Next?</h3>
                <p style="color: #ccc; line-height: 1.6; font-size: 14px; margin: 0;">
                    A receipt has been sent to your email address. Our team will begin working on your FMV report immediately. 
                    You can expect to receive your comprehensive report within <strong>24 hours</strong>.
                </p>
            </div>
            
            <div style="padding: 30px; background: rgba(0, 255, 136, 0.1); border: 1px solid #00FF88; border-radius: 8px; margin: 0 30px 30px 30px;">
                <h3 style="color: #00FF88; margin-bottom: 10px; font-size: 16px;"> Track Your Report</h3>
                <p style="color: #ccc; line-height: 1.6; font-size: 14px; margin: 0;">
                    You can track the status of your report request in your dashboard. We'll notify you via email when your report is ready for download.
                </p>
            </div>
            
            <div class="ci-stripe-footer" style="padding: 30px; border-top: 1px solid #333; display: flex; gap: 15px; flex-direction: column;">
                <button onclick="viewValuationResults()" class="ci-btn-pay" style="width: 100%; padding: 16px; background: #00FF88; color: #000; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px;">
                     VIEW RESULTS
                </button>
                <div style="display: flex; gap: 15px;">
                    <button onclick="window.location.href='/dashboard.html'" class="ci-btn-pay" style="flex: 1; padding: 16px; background: transparent; color: #00FF88; border: 2px solid #00FF88; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px;">
                         GO TO DASHBOARD
                    </button>
                    <button onclick="closeSuccessModal(); window.location.reload();" class="ci-btn-pay" style="flex: 1; padding: 16px; background: transparent; color: #00FF88; border: 2px solid #00FF88; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 16px;">
                         ORDER ANOTHER REPORT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div>
                    <div class="footer-brand">
                        <img src="images/logos/crane-intelligence-logo-white.svg" alt="Crane Intelligence" class="footer-logo-svg">
                    </div>
                    <p class="footer-desc">Professional crane valuation, market analysis, and fleet optimization platform. Get accurate crane valuations with our advanced multi-factor analysis engine.</p>
                </div>

                <div>
                    <h4 class="footer-title">Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="about-us.html" target="_blank">About Us</a></li>
                        <li><a href="contact.html" target="_blank">Contact</a></li>
                        <li><a href="blog.html" target="_blank">Blog</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="footer-title">Legal & Support</h4>
                    <ul class="footer-links">
                        <li><a href="privacy-policy.html" target="_blank">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html" target="_blank">Terms of Service</a></li>
                        <li><a href="cookie-policy.html" target="_blank">Cookie Policy</a></li>
                        <li><a href="security.html" target="_blank">Security</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="footer-title">Stay Updated</h4>
                    <p class="footer-newsletter-desc">Get the latest insights and market analysis delivered to your inbox</p>
                    <div class="newsletter">
                        <input type="email" placeholder="Enter your email" id="footerNewsletterEmail">
                        <button onclick="handleNewsletterSubscribe()">SUBSCRIBE</button>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2024 Crane Intelligence Platform. All rights reserved. | Professional Crane Valuation & Market Analysis</p>
            </div>
        </div>
    </footer>

    <!-- Dialog Boxes -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog-box">
            <div class="dialog-icon" id="dialogIcon"></div>
            <div class="dialog-title" id="dialogTitle">Title</div>
            <div class="dialog-message" id="dialogMessage">Message</div>
            <div class="dialog-buttons">
                <button class="dialog-btn dialog-btn-primary" id="dialogOkBtn" onclick="closeDialog()">OK</button>
                <button class="dialog-btn dialog-btn-secondary" id="dialogCancelBtn" onclick="closeDialog()" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Authentication functions handled by unified-auth.js

        // User dropdown functionality - DELEGATED TO UNIFIED HEADER
        // The unified-header.html component handles all dropdown logic via portal solution
        // No local handlers needed - they conflict with the centralized solution

        // Ensure safeStorage is available in this scope (use var to avoid redeclaration)
        var safeStorage = window.safeStorage || {
            getItem: () => null,
            setItem: () => {},
            removeItem: () => {}
        };

        function logout() {
            safeStorage.removeItem('access_token');
            safeStorage.removeItem('refresh_token');
            safeStorage.removeItem('user_data');
            window.location.href = 'homepage.html';
        }

        function checkAuthStatus() {
            const accessToken = safeStorage.getItem('access_token');
            const userData = safeStorage.getItem('user_data');
            
            if (accessToken && userData) {
                try {
                    const user = JSON.parse(userData);
                    } catch (e) {
                    console.error('Error parsing user data:', e);
                    }
            } else {
                }
        }

        // Dialog functions
        function showDialog(title, message, type = 'info', showCancel = false) {
            const overlay = document.getElementById('dialogOverlay');
            const icon = document.getElementById('dialogIcon');
            const titleEl = document.getElementById('dialogTitle');
            const messageEl = document.getElementById('dialogMessage');
            const cancelBtn = document.getElementById('dialogCancelBtn');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set icon and color based on type
            if (type === 'success') {
                icon.textContent = '';
                icon.className = 'dialog-icon success';
            } else if (type === 'error') {
                icon.textContent = '';
                icon.className = 'dialog-icon error';
            } else {
                icon.textContent = '';
                icon.className = 'dialog-icon info';
            }
            
            // Show/hide cancel button
            cancelBtn.style.display = showCancel ? 'block' : 'none';
            
            overlay.classList.add('show');
        }

        function closeDialog() {
            const overlay = document.getElementById('dialogOverlay');
            overlay.classList.remove('show');
        }

        // Report generation functions
        // Note: loadSampleData is defined globally below - no local function needed
        // The onclick handler will call window.loadSampleData directly

        function clearForm() {
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.reset();
            }
            const reportPreview = document.getElementById('reportPreview');
            if (reportPreview) {
                reportPreview.style.display = 'none';
            }
        }

        async function generateReport() {
            // Ensure safeStorage is available
            const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
            
            // Prevent generateReport from running when just switching tabs
            // Only allow it to run when explicitly called (not from tab switching)
            if (window._isSwitchingTabs) {
                console.log(' generateReport called during tab switch - skipping');
                return;
            }
            
            // Check if we're in bulk processing mode - if so, don't show irrelevant dialogs
            const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
            const isBulkMode = bulkForm && bulkForm.style.display !== 'none';
            if (isBulkMode) {
                console.log(' generateReport called in bulk mode - skipping single report generation');
                return;
            }
            
            const form = document.getElementById('reportForm');
            if (!form) {
                console.error('[REPORT-GENERATION] Report form not found');
                return;
            }
            const formData = new FormData(form);
            
            // Get selected sections
            const sections = [];
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                sections.push(checkbox.id);
            });

            // Safely get form field values with null checks
            const getFieldValue = (id, defaultValue = '') => {
                const element = document.getElementById(id);
                return element ? (element.value || defaultValue) : defaultValue;
            };
            
            const getFieldNumber = (id, defaultValue = 0) => {
                const element = document.getElementById(id);
                return element ? (parseFloat(element.value) || defaultValue) : defaultValue;
            };
            
            const getFieldChecked = (id, defaultValue = false) => {
                const element = document.getElementById(id);
                return element ? (element.checked || defaultValue) : defaultValue;
            };
            
            const reportData = {
                template: "bloomberg_valuation",
                valuation_data: {
                    manufacturer: getFieldValue('manufacturer'),
                    model: getFieldValue('model'),
                    year: parseInt(getFieldValue('year')) || new Date().getFullYear(),
                    capacity_tons: getFieldNumber('capacity'),
                    hours: parseInt(getFieldValue('operatingHours')) || 0,
                    region: getFieldValue('region'),
                    estimated_value: getFieldNumber('estimatedValue'),
                    confidence_score: 0.85,
                    age_factor: getFieldNumber('ageFactor', 0.88),
                    condition_score: getFieldNumber('conditionScore', 0.85),
                    market_demand: "High",
                    risk_score: "Low"
                },
                include_charts: getFieldChecked('includeCharts'),
                include_comps: getFieldChecked('includeComparables'),
                include_finance_scenarios: getFieldChecked('includeFinance'),
                include_market_analysis: getFieldChecked('includeMarket'),
                include_risk_assessment: getFieldChecked('includeRisk')
            };

            // Show loading (with null checks)
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.classList.add('show');
            }
            const previewEl = document.getElementById('reportPreview');
            if (previewEl) {
                previewEl.style.display = 'none';
            }

            try {
                const accessToken = safeStorage.getItem('access_token');
                const userData = safeStorage.getItem('user_data');
                
                console.log('Auth Debug:', {
                    accessToken: accessToken ? 'Present' : 'Missing',
                    userData: userData ? 'Present' : 'Missing',
                    tokenLength: accessToken ? accessToken.length : 0
                });
                
                if (!accessToken) {
                    showDialog(
                        'Authentication Required', 
                        'Please login to generate reports. You will be redirected to the login page.',
                        'error'
                    );
                    setTimeout(() => {
                        window.location.href = 'homepage.html';
                    }, 2000);
                    return;
                }

                // Try to connect to backend first, fallback to mock if unavailable
                let useMockResponse = true;
                
                try {
                    // Test backend connection
                    const testResponse = await fetch('http://localhost:8003/api/v1/reports/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(reportData),
                        signal: AbortSignal.timeout(5000) // 5 second timeout
                    });
                    
                    if (testResponse.ok) {
                        const result = await testResponse.json();
                        if (result.success) {
                            // Display preview
                            document.getElementById('previewContent').textContent = JSON.stringify(result, null, 2);
                            document.getElementById('reportPreview').style.display = 'block';
                            
                            // Initialize Bloomberg terminal charts
                            initializeChartsOnReportGeneration();
                            
                            // Show success dialog
                            showDialog(
                                'Report Generated Successfully!', 
                                `Your Bloomberg-style report has been generated with ID: ${result.report_id}`,
                                'success'
                            );
                            return;
                        }
                    }
                } catch (error) {
                    console.log('Backend not available, using mock response:', error.message);
                    useMockResponse = true;
                }

                // Use mock response if backend is unavailable
                if (useMockResponse) {
                    console.log('Using mock response for demo purposes');
                    // Show info dialog about using mock data
                    showDialog(
                        'Demo Mode', 
                        'Backend server is not available. Using demo data for report generation.',
                        'info'
                    );
                }

                // Mock response for demo purposes
                const mockResult = {
                    success: true,
                    report_id: `report_${Date.now()}`,
                    report_url: `/reports/report_${Date.now()}`,
                    generated_at: new Date().toISOString(),
                    message: "Report generated successfully",
                    pdf_url: `/api/v1/reports/download/report_${Date.now()}`,
                    data: {
                        report_id: `report_${Date.now()}`,
                        generated_at: new Date().toISOString(),
                        template: reportData.template,
                        valuation_data: reportData.valuation_data,
                        options: {
                            include_charts: reportData.include_charts,
                            include_comps: reportData.include_comps,
                            include_finance_scenarios: reportData.include_finance_scenarios,
                            include_market_analysis: reportData.include_market_analysis,
                            include_risk_assessment: reportData.include_risk_assessment
                        },
                        kpi_metrics: {
                            estimated_value: reportData.valuation_data.estimated_value,
                            value_per_ton: reportData.valuation_data.estimated_value / reportData.valuation_data.capacity_tons,
                            age_factor: reportData.valuation_data.age_factor,
                            condition_score: reportData.valuation_data.condition_score,
                            confidence_score: reportData.valuation_data.confidence_score
                        },
                        comparable_sales: [
                            {
                                manufacturer: reportData.valuation_data.manufacturer,
                                model: `${reportData.valuation_data.model} (Similar)`,
                                year: reportData.valuation_data.year - 1,
                                price: reportData.valuation_data.estimated_value * 0.95,
                                location: reportData.valuation_data.region
                            },
                            {
                                manufacturer: reportData.valuation_data.manufacturer,
                                model: `${reportData.valuation_data.model} (Newer)`,
                                year: reportData.valuation_data.year + 1,
                                price: reportData.valuation_data.estimated_value * 1.15,
                                location: reportData.valuation_data.region
                            }
                        ],
                        finance_scenarios: [
                            {
                                scenario: "Conservative",
                                monthly_payment: reportData.valuation_data.estimated_value * 0.008,
                                total_cost_5yr: reportData.valuation_data.estimated_value * 1.48,
                                roi: 12.5
                            },
                            {
                                scenario: "Moderate",
                                monthly_payment: reportData.valuation_data.estimated_value * 0.012,
                                total_cost_5yr: reportData.valuation_data.estimated_value * 1.72,
                                roi: 18.3
                            },
                            {
                                scenario: "Aggressive",
                                monthly_payment: reportData.valuation_data.estimated_value * 0.018,
                                total_cost_5yr: reportData.valuation_data.estimated_value * 2.08,
                                roi: 25.7
                            }
                        ],
                        market_analysis: {
                            demand_level: "High",
                            market_trend: "Growing",
                            regional_factors: `Strong demand in ${reportData.valuation_data.region}`,
                            price_trend: "Stable to increasing"
                        },
                        risk_assessment: {
                            overall_risk: "Low",
                            market_risk: "Low",
                            operational_risk: "Medium",
                            financial_risk: "Low"
                        }
                    }
                };
                
                // Display preview
                document.getElementById('previewContent').textContent = JSON.stringify(mockResult, null, 2);
                document.getElementById('reportPreview').style.display = 'block';
                
                // Initialize Bloomberg terminal charts
                initializeChartsOnReportGeneration();
                
                // Show success dialog
                showDialog(
                    'Report Generated Successfully!', 
                    `Your Bloomberg-style report has been generated with ID: ${mockResult.report_id}`,
                    'success'
                );
                
            } catch (error) {
                console.error('Error generating report:', error);
                showDialog(
                    'Report Generation Failed', 
                    error.message || 'An unexpected error occurred while generating the report.',
                    'error'
                );
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        function downloadReport() {
            const reportContent = document.getElementById('previewContent').textContent;
            if (reportContent && reportContent.includes('report_id')) {
                try {
                    const reportData = JSON.parse(reportContent);
                    
                    // Show loading dialog
                    showDialog(
                        'Generating PDF', 
                        'Please wait while we generate your PDF report...',
                        'info'
                    );
                    
                    // Generate PDF from report data
                    generatePDFReport(reportData);
                    
                } catch (error) {
                    console.error('Error parsing report data:', error);
                    showDialog(
                        'Report Download', 
                        'No report data available for download.',
                        'info'
                    );
                }
            } else {
                showDialog(
                    'Report Download', 
                    'Please generate a report first.',
                    'info'
                );
            }
        }

        // Function to capture charts as images
        async function captureChartsForPDF() {
            const charts = {};
            
            try {
                // Capture main charts
                const chartElements = [
                    'valuationTrendChart',
                    'priceComparisonChart', 
                    'marketActivityChart',
                    'riskMatrixChart',
                    'financingScenariosChart'
                ];
                
                for (const chartId of chartElements) {
                    const element = document.getElementById(chartId);
                    if (element) {
                        console.log(`Capturing chart: ${chartId}`);
                        const canvas = await html2canvas(element, {
                            backgroundColor: '#0F0F0F',
                            scale: 2,
                            useCORS: true,
                            allowTaint: true
                        });
                        charts[chartId] = canvas.toDataURL('image/png');
                    }
                }
                
                // Capture mini charts
                const miniChartElements = [
                    'depreciationChart',
                    'utilizationChart',
                    'maintenanceChart',
                    'resaleChart'
                ];
                
                for (const chartId of miniChartElements) {
                    const element = document.getElementById(chartId);
                    if (element) {
                        console.log(`Capturing mini chart: ${chartId}`);
                        const canvas = await html2canvas(element, {
                            backgroundColor: '#0F0F0F',
                            scale: 2,
                            useCORS: true,
                            allowTaint: true
                        });
                        charts[chartId] = canvas.toDataURL('image/png');
                    }
                }
                
                console.log('All charts captured successfully');
                return charts;
            } catch (error) {
                console.error('Error capturing charts:', error);
                return {};
            }
        }

        async function generatePDFReport(reportData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Capture charts first
                console.log('Capturing Bloomberg terminal charts...');
                const chartImages = await captureChartsForPDF();
                
                // Set up colors
                const primaryColor = '#00FF85';
                const darkColor = '#1A1A1A';
                const textColor = '#333333';
                const lightGray = '#666666';
                
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Header
                doc.setFillColor(26, 26, 26);
                doc.rect(0, 0, pageWidth, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('CRANE INTELLIGENCE', margin, 20);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text('Valuation Report', margin, 28);
                
                yPosition = 45;
                
                // Report ID and Date
                doc.setTextColor(textColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Report ID: ${reportData.data.report_id}`, margin, yPosition);
                doc.text(`Generated: ${new Date(reportData.data.generated_at).toLocaleDateString()}`, pageWidth - margin - 50, yPosition);
                yPosition += 15;
                
                // Line separator
                doc.setDrawColor(0, 255, 133);
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 10;
                
                // Crane Specifications Section
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(0, 255, 133);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Crane Specifications', margin + 5, yPosition + 6);
                yPosition += 15;
                
                doc.setTextColor(textColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const specs = reportData.data.valuation_data;
                doc.text(`Capacity: ${specs.capacity_tons} tons`, margin, yPosition);
                doc.text(`Operating Hours: ${specs.hours.toLocaleString()} hours`, margin + 70, yPosition);
                yPosition += 6;
                doc.text(`Region: ${specs.region}`, margin, yPosition);
                doc.text(`Condition Score: ${specs.condition_score}`, margin + 70, yPosition);
                yPosition += 15;
                
                // Valuation Analysis Section
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(0, 255, 133);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Valuation Analysis', margin + 5, yPosition + 6);
                yPosition += 15;
                
                doc.setTextColor(textColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const valuation = reportData.data.kpi_metrics;
                doc.text(`Estimated Value: $${valuation.estimated_value.toLocaleString()}`, margin, yPosition);
                doc.text(`Value per Ton: $${valuation.value_per_ton.toLocaleString()}`, margin + 70, yPosition);
                yPosition += 6;
                doc.text(`Age Factor: ${(valuation.age_factor * 100).toFixed(1)}%`, margin, yPosition);
                doc.text(`Confidence Score: ${(valuation.confidence_score * 100).toFixed(1)}%`, margin + 70, yPosition);
                yPosition += 15;
                
                // Risk Assessment Section
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(0, 255, 133);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Risk Assessment', margin + 5, yPosition + 6);
                yPosition += 15;
                
                doc.setTextColor(textColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const risk = reportData.data.risk_assessment;
                doc.text(`Overall Risk: ${risk.overall_risk}`, margin, yPosition);
                doc.text(`Market Risk: ${risk.market_risk}`, margin + 70, yPosition);
                yPosition += 6;
                doc.text(`Operational Risk: ${risk.operational_risk}`, margin, yPosition);
                doc.text(`Financial Risk: ${risk.financial_risk}`, margin + 70, yPosition);
                yPosition += 15;
                
                // Market Analysis Section
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 8, 'F');
                doc.setTextColor(0, 255, 133);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Market Analysis', margin + 5, yPosition + 6);
                yPosition += 15;
                
                doc.setTextColor(textColor);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const market = reportData.data.market_analysis;
                doc.text(`Demand Level: ${market.demand_level}`, margin, yPosition);
                doc.text(`Market Trend: ${market.market_trend}`, margin + 70, yPosition);
                yPosition += 6;
                doc.text(`Regional Factors: ${market.regional_factors}`, margin, yPosition);
                yPosition += 6;
                doc.text(`Price Trend: ${market.price_trend}`, margin, yPosition);
                yPosition += 20;
                
                // Bloomberg Terminal Charts Section
                if (Object.keys(chartImages).length > 0) {
                    // New page for charts
                    doc.addPage();
                    yPosition = 20;
                    
                    // Charts Section Header
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPosition, contentWidth, 8, 'F');
                    doc.setTextColor(0, 255, 133);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Bloomberg Terminal Charts & Analytics', margin + 5, yPosition + 6);
                    yPosition += 15;
                    
                    // Main Valuation Trend Chart
                    if (chartImages.valuationTrendChart) {
                        doc.setFontSize(12);
                        doc.setTextColor(textColor);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Equipment Valuation Trend', margin, yPosition);
                        yPosition += 8;
                        
                        const imgWidth = contentWidth;
                        const imgHeight = 60;
                        doc.addImage(chartImages.valuationTrendChart, 'PNG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                    
                    // Price Comparison and Market Activity Charts (side by side)
                    if (chartImages.priceComparisonChart || chartImages.marketActivityChart) {
                        const chartWidth = (contentWidth - 10) / 2;
                        const chartHeight = 50;
                        
                        if (chartImages.priceComparisonChart) {
                            doc.setFontSize(10);
                            doc.setTextColor(textColor);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Price Comparison', margin, yPosition);
                            yPosition += 5;
                            doc.addImage(chartImages.priceComparisonChart, 'PNG', margin, yPosition, chartWidth, chartHeight);
                        }
                        
                        if (chartImages.marketActivityChart) {
                            doc.setFontSize(10);
                            doc.setTextColor(textColor);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Market Activity', margin + chartWidth + 10, yPosition - 5);
                            doc.addImage(chartImages.marketActivityChart, 'PNG', margin + chartWidth + 10, yPosition, chartWidth, chartHeight);
                        }
                        
                        yPosition += chartHeight + 15;
                    }
                    
                    // Risk Matrix Chart
                    if (chartImages.riskMatrixChart) {
                        doc.setFontSize(12);
                        doc.setTextColor(textColor);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Risk Assessment Matrix', margin, yPosition);
                        yPosition += 8;
                        
                        const imgWidth = contentWidth;
                        const imgHeight = 60;
                        doc.addImage(chartImages.riskMatrixChart, 'PNG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                    
                    // Mini Charts Grid
                    const miniCharts = [
                        { id: 'depreciationChart', title: 'Depreciation Curve' },
                        { id: 'utilizationChart', title: 'Utilization Rate' },
                        { id: 'maintenanceChart', title: 'Maintenance Cost' },
                        { id: 'resaleChart', title: 'Resale Value' }
                    ];
                    
                    const miniChartWidth = (contentWidth - 15) / 2;
                    const miniChartHeight = 40;
                    let miniChartRow = 0;
                    
                    for (const chart of miniCharts) {
                        if (chartImages[chart.id]) {
                            const xPos = margin + (miniChartRow % 2) * (miniChartWidth + 10);
                            const yPos = yPosition + Math.floor(miniChartRow / 2) * (miniChartHeight + 20);
                            
                            doc.setFontSize(9);
                            doc.setTextColor(textColor);
                            doc.setFont('helvetica', 'bold');
                            doc.text(chart.title, xPos, yPos);
                            
                            doc.addImage(chartImages[chart.id], 'PNG', xPos, yPos + 3, miniChartWidth, miniChartHeight);
                            
                            miniChartRow++;
                        }
                    }
                    
                    yPosition += Math.ceil(miniCharts.length / 2) * (miniChartHeight + 20) + 10;
                    
                    // Financing Scenarios Chart
                    if (chartImages.financingScenariosChart) {
                        doc.setFontSize(12);
                        doc.setTextColor(textColor);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Financing Scenarios Comparison', margin, yPosition);
                        yPosition += 8;
                        
                        const imgWidth = contentWidth;
                        const imgHeight = 50;
                        doc.addImage(chartImages.financingScenariosChart, 'PNG', margin, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 10;
                    }
                }
                
                // Footer
                yPosition = doc.internal.pageSize.getHeight() - 20;
                doc.setTextColor(lightGray);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('This report was generated by Crane Intelligence Platform', margin, yPosition);
                doc.text('For questions or support: support@craneintelligence.com', margin, yPosition + 5);
                
                // Download the PDF
                const fileName = `crane_report_${reportData.data.report_id}.pdf`;
                doc.save(fileName);
                
                // Close loading dialog and show success
                setTimeout(() => {
                    showDialog(
                        'Report Downloaded', 
                        'Your PDF report has been downloaded successfully!',
                        'success'
                    );
                }, 500);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showDialog(
                    'PDF Generation Error', 
                    'Failed to generate PDF. Please try again.',
                    'error'
                );
            }
        }

        function shareReport() {
            // Placeholder for sharing functionality
            showDialog(
                'Share Report', 
                'Share functionality will be implemented in a future update',
                'info'
            );
        }

        // Check authentication status on page load
        // Lightweight initialization
        function initializePage() {
            // Authentication is handled at the top of the page
            // If we reach here, user is authenticated
            try {
                checkAuthStatus();
            } catch (e) {
                console.warn('[REPORT-GENERATION] Auth check failed:', e);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // Form submission - with null check
        const reportForm = document.getElementById('reportForm');
        if (reportForm) {
            reportForm.addEventListener('submit', function(e) {
                e.preventDefault();
                generateReport();
            });
        } else {
            console.warn('[REPORT-GENERATION] Report form not found, will retry...');
            // Retry after a short delay
            setTimeout(() => {
                const retryForm = document.getElementById('reportForm');
                if (retryForm) {
                    retryForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        generateReport();
                    });
                }
            }, 500);
        }

        // ===== BLOOMBERG TERMINAL CHART FUNCTIONS =====
        
        // Initialize all Bloomberg terminal charts
        function initializeBloombergCharts() {
            console.log('Starting Bloomberg chart initialization...');
            
            // Check if libraries are loaded
            if (!checkChartLibraries()) {
                console.error('Chart libraries not loaded, retrying in 2 seconds...');
                setTimeout(() => {
                    initializeBloombergCharts();
                }, 2000);
                return;
            }
            
            try {
                console.log('Creating valuation trend chart...');
                createValuationTrendChart();
                
                console.log('Creating price comparison chart...');
                createPriceComparisonChart();
                
                console.log('Creating market activity chart...');
                createMarketActivityChart();
                
                console.log('Creating risk matrix chart...');
                createRiskMatrixChart();
                
                console.log('Creating mini charts...');
                createDepreciationChart();
                createUtilizationChart();
                createMaintenanceChart();
                createResaleChart();
                
                console.log('Creating financing scenarios chart...');
                createFinancingScenariosChart();
                
                console.log('All Bloomberg charts initialized successfully!');
            } catch (error) {
                console.error('Error initializing Bloomberg charts:', error);
            }
        }

        // Main valuation trend chart
        function createValuationTrendChart() {
            const ctx = document.getElementById('valuationTrendChart');
            if (!ctx) {
                console.error('valuationTrendChart canvas element not found');
                return;
            }

            console.log('Creating valuation trend chart with context:', ctx);
            
            try {
                new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Current Valuation',
                        data: [1800000, 1850000, 1920000, 1980000, 2050000, 2100000, 2080000, 2120000, 2149900, 2100000, 2180000, 2200000],
                        borderColor: '#00FF85',
                        backgroundColor: 'rgba(0, 255, 133, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Market Average',
                        data: [1750000, 1780000, 1820000, 1850000, 1880000, 1900000, 1920000, 1950000, 1980000, 2000000, 2020000, 2050000],
                        borderColor: '#FFD600',
                        backgroundColor: 'rgba(255, 214, 0, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Risk Threshold',
                        data: [1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000, 1600000],
                        borderColor: '#FF4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#B0B0B0',
                                font: {
                                    family: 'JetBrains Mono'
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#B0B0B0',
                                font: {
                                    family: 'JetBrains Mono'
                                },
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 3,
                            hoverRadius: 6
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Error creating valuation trend chart:', error);
            }
        }

        // Price comparison chart
        function createPriceComparisonChart() {
            const ctx = document.getElementById('priceComparisonChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Grove GMK5250L', 'Liebherr LTM 1300', 'Terex AC 500-2', 'Manitowoc 2250', 'Kato NK-500E'],
                    datasets: [{
                        label: 'Price ($)',
                        data: [2100000, 1950000, 2200000, 1850000, 2050000],
                        backgroundColor: [
                            '#00FF85',
                            '#FFD600',
                            '#FF4444',
                            '#00CC6A',
                            '#FF6B35'
                        ],
                        borderColor: '#333333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#B0B0B0',
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 10
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#B0B0B0',
                                font: {
                                    family: 'JetBrains Mono'
                                },
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Market activity chart
        function createMarketActivityChart() {
            const ctx = document.getElementById('marketActivityChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Active Listings', 'Recent Sales', 'Auction Results', 'Pending Deals'],
                    datasets: [{
                        data: [35, 28, 22, 15],
                        backgroundColor: [
                            '#00FF85',
                            '#FFD600',
                            '#FF4444',
                            '#00CC6A'
                        ],
                        borderColor: '#0F0F0F',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#B0B0B0',
                                font: {
                                    family: 'JetBrains Mono',
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        // Risk matrix chart using Plotly
        function createRiskMatrixChart() {
            const data = [{
                x: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                y: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                z: [
                    [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
                    [0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1],
                    [0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2],
                    [0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3],
                    [0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4],
                    [0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5],
                    [0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6],
                    [0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7],
                    [0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8],
                    [1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]
                ],
                type: 'heatmap',
                colorscale: [
                    [0, '#00FF85'],
                    [0.5, '#FFD600'],
                    [1, '#FF4444']
                ]
            }];

            const layout = {
                title: {
                    text: 'Risk vs Return Matrix',
                    font: { color: '#00FF85', size: 14 }
                },
                xaxis: {
                    title: 'Risk Level',
                    color: '#B0B0B0',
                    gridcolor: '#333333'
                },
                yaxis: {
                    title: 'Return Potential',
                    color: '#B0B0B0',
                    gridcolor: '#333333'
                },
                plot_bgcolor: '#0F0F0F',
                paper_bgcolor: '#0F0F0F',
                font: { family: 'JetBrains Mono', color: '#B0B0B0' }
            };

            // Load Plotly only when needed
            if (typeof window.loadPlotly === 'function') {
                window.loadPlotly().then(() => {
                    try {
                        const chartElement = document.getElementById('riskMatrixChart');
                        if (chartElement && window.Plotly) {
                            window.Plotly.newPlot('riskMatrixChart', data, layout, {responsive: true});
                        }
                    } catch (e) {
                        console.warn('Failed to render risk matrix chart:', e);
                    }
                }).catch(() => {
                    console.warn('Plotly not available, skipping risk matrix chart');
                });
            }
        }

        // Mini charts
        function createDepreciationChart() {
            const ctx = document.getElementById('depreciationChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        data: [100, 95, 88, 80, 70, 60, 50, 40, 30, 25, 20],
                        borderColor: '#00FF85',
                        backgroundColor: 'rgba(0, 255, 133, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        },
                        y: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        }
                    }
                }
            });
        }

        function createUtilizationChart() {
            const ctx = document.getElementById('utilizationChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [{
                        data: [85, 92, 78, 88],
                        backgroundColor: '#FFD600',
                        borderColor: '#333333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        },
                        y: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        }
                    }
                }
            });
        }

        function createMaintenanceChart() {
            const ctx = document.getElementById('maintenanceChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        data: [14990, 18000, 12000, 22000, 19000, 16000],
                        borderColor: '#FF4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        },
                        y: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        }
                    }
                }
            });
        }

        function createResaleChart() {
            const ctx = document.getElementById('resaleChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1Y', '2Y', '3Y', '4Y', '5Y'],
                    datasets: [{
                        data: [95, 88, 80, 70, 60],
                        backgroundColor: '#00CC6A',
                        borderColor: '#333333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        },
                        y: {
                            grid: { color: '#333333' },
                            ticks: { color: '#B0B0B0', font: { family: 'JetBrains Mono', size: 8 } }
                        }
                    }
                }
            });
        }

        // Financing scenarios chart
        function createFinancingScenariosChart() {
            const data = [{
                x: ['Cash Purchase', 'Bank Loan 5%', 'Lease 3Y', 'Lease 5Y', 'Rent-to-Own'],
                y: [2100000, 2200000, 1950000, 2050000, 2300000],
                type: 'bar',
                marker: {
                    color: ['#00FF85', '#FFD600', '#FF4444', '#00CC6A', '#FF6B35']
                }
            }];

            const layout = {
                title: {
                    text: 'Financing Options Comparison',
                    font: { color: '#00FF85', size: 14 }
                },
                xaxis: {
                    title: 'Financing Option',
                    color: '#B0B0B0',
                    gridcolor: '#333333'
                },
                yaxis: {
                    title: 'Total Cost ($)',
                    color: '#B0B0B0',
                    gridcolor: '#333333'
                },
                plot_bgcolor: '#0F0F0F',
                paper_bgcolor: '#0F0F0F',
                font: { family: 'JetBrains Mono', color: '#B0B0B0' }
            };

            // Load Plotly only when needed
            if (typeof window.loadPlotly === 'function') {
                window.loadPlotly().then(() => {
                    try {
                        const chartElement = document.getElementById('financingScenariosChart');
                        if (chartElement && window.Plotly) {
                            window.Plotly.newPlot('financingScenariosChart', data, layout, {responsive: true});
                        }
                    } catch (e) {
                        console.warn('Failed to render financing scenarios chart:', e);
                    }
                }).catch(() => {
                    console.warn('Plotly not available, skipping financing scenarios chart');
                });
            }
        }

        // Initialize charts when report is generated
        function initializeChartsOnReportGeneration() {
            // Wait for DOM to be ready and libraries to load
            setTimeout(() => {
                console.log('Initializing Bloomberg charts...');
                if (checkChartLibraries()) {
                    initializeBloombergCharts();
                } else {
                    console.log('Chart libraries not ready, retrying...');
                    setTimeout(() => {
                        initializeChartsOnReportGeneration();
                    }, 1000);
                }
            }, 1000);
        }

        // Check if chart libraries are loaded
        function checkChartLibraries() {
            const chartJsLoaded = typeof Chart !== 'undefined';
            const plotlyLoaded = typeof window.Plotly !== 'undefined' && window.Plotly !== null;
            const d3Loaded = typeof d3 !== 'undefined';
            
            console.log('Chart libraries status:', {
                ChartJS: chartJsLoaded,
                Plotly: plotlyLoaded,
                D3: d3Loaded
            });
            
            return chartJsLoaded && plotlyLoaded;
        }
    </script>
    <script src="/js/auto-init-auth.js"></script>

    <script>
    // Early initialization of loadSampleData to prevent "not available" errors
    // Full implementation will be defined later in the script
    if (!window.loadSampleData) {
        let loadSampleDataCheckInterval = null;
        const stubFunction = function() {
            if (loadSampleDataCheckInterval) {
                // Already waiting, don't create another interval
                return;
            }
            console.warn(' loadSampleData called before full initialization - waiting...');
            // Wait for the full function to load
            let attempts = 0;
            const maxAttempts = 20;
            loadSampleDataCheckInterval = setInterval(() => {
                attempts++;
                // Check if the function has been replaced with the real implementation
                // The real function will be much longer than this stub (stub is ~600 chars)
                const currentFunc = window.loadSampleData;
                const funcString = currentFunc.toString();
                // Real function will be > 2000 characters and won't be this stub
                if (funcString.length > 2000 && currentFunc !== stubFunction) {
                    clearInterval(loadSampleDataCheckInterval);
                    loadSampleDataCheckInterval = null;
                    currentFunc();
                    return;
                }
                if (attempts >= maxAttempts) {
                    clearInterval(loadSampleDataCheckInterval);
                    loadSampleDataCheckInterval = null;
                    if (window.notificationSystem) {
                        window.notificationSystem.showError('Error', 'Please wait for the page to fully load.');
                    }
                }
            }, 100);
        };
        window.loadSampleData = stubFunction;
    }
    let selectedReportType = ''; // Start with no selection - user must choose
    let selectedPrice = 0;
    let selectedReportName = '';
    let fleetUnitCount = 1;
    let fleetPricingTier = '1-5';
    
    // Initialize window variables for global access (used by purchaseReport validation)
    window.selectedReportType = '';
    window.selectedPrice = 0;
    window.selectedReportName = '';
    
    // Calculate Fleet Valuation price based on unit count
    function calculateFleetPrice(unitCount) {
        if (unitCount <= 0 || unitCount > 50) {
            return { price: 0, tier: '1-5', perCrane: 0 };
        }
        
        let price, tier, perCrane;
        if (unitCount <= 5) {
            price = 1495.00;
            tier = '1-5';
            perCrane = 299;
        } else if (unitCount <= 10) {
            price = 2495.00;
            tier = '6-10';
            perCrane = 249;
        } else if (unitCount <= 25) {
            price = 4995.00;
            tier = '11-25';
            perCrane = 199;
        } else { // 26-50
            price = 7995.00;
            tier = '26-50';
            perCrane = Math.round(7995 / unitCount);
        }
        
        return { price, tier, perCrane };
    }
    
    // Update Fleet Valuation pricing display
    function updateFleetPricing(unitCount) {
        if (selectedReportType !== 'fleet_valuation') return;
        
        fleetUnitCount = unitCount || 1;
        const pricing = calculateFleetPrice(fleetUnitCount);
        fleetPricingTier = pricing.tier;
        selectedPrice = Math.round(pricing.price * 100); // Convert to cents
        
        // Update price display in the card
        const fleetCard = document.querySelector('[data-type="fleet_valuation"]');
        if (fleetCard) {
            const priceElement = fleetCard.querySelector('.report-price');
            if (priceElement) {
                priceElement.textContent = `$${pricing.price.toLocaleString()}`;
            }
            
            // Update tier info
            const tierInfo = fleetCard.querySelector('.tier-info') || document.createElement('div');
            tierInfo.className = 'tier-info';
            tierInfo.style.cssText = 'margin: 8px 0; padding: 8px; background: rgba(0, 255, 133, 0.1); border-radius: 4px; font-size: 11px; color: #00FF85;';
            tierInfo.innerHTML = `${fleetUnitCount} crane${fleetUnitCount > 1 ? 's' : ''}  $${pricing.perCrane}/crane  Tier: ${pricing.tier}`;
            
            if (!fleetCard.querySelector('.tier-info')) {
                const priceContainer = fleetCard.querySelector('.report-type-header');
                if (priceContainer) {
                    priceContainer.appendChild(tierInfo);
                }
            } else {
                fleetCard.querySelector('.tier-info').innerHTML = tierInfo.innerHTML;
            }
        }
        
        // Update pricing info text
        const pricingInfo = document.getElementById('fleetPricingInfo');
        if (pricingInfo) {
            pricingInfo.textContent = `Pricing: $${pricing.price.toLocaleString()} for ${fleetUnitCount} crane${fleetUnitCount > 1 ? 's' : ''} ($${pricing.perCrane}/crane)  Tier: ${pricing.tier}`;
        }
        
        // Update purchase button
        const purchaseBtn = document.getElementById('purchaseReportBtn');
        if (purchaseBtn) {
            const priceDisplay = (selectedPrice / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            purchaseBtn.textContent = ` Purchase Fleet Valuation - ${priceDisplay}`;
        }
    }
    
    // Update pricing from input field
    function updateFleetPricingFromInput() {
        const unitCountInput = document.getElementById('unitCount');
        if (unitCountInput && selectedReportType === 'fleet_valuation') {
            const unitCount = parseInt(unitCountInput.value) || 1;
            if (unitCount >= 1 && unitCount <= 50) {
                updateFleetPricing(unitCount);
            }
        }
    }

    // Report type selection
    document.addEventListener('DOMContentLoaded', function() {
        const reportCards = document.querySelectorAll('.report-type-card');
        const selectBtns = document.querySelectorAll('.select-report-btn');
        const purchaseBtn = document.getElementById('purchaseReportBtn');

        if (selectBtns.length > 0) {
            selectBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const card = this.closest('.report-type-card');
                    const type = card.dataset.type;
                    const price = parseInt(this.dataset.price);

                    // Remove selected class from all cards
                    reportCards.forEach(c => c.classList.remove('selected'));
                    
                    // Add selected class to clicked card
                    card.classList.add('selected');

                    // Update selected values (both local and window for global access)
                    selectedReportType = type;
                    window.selectedReportType = type; // Set on window for purchaseReport validation
                    selectedPrice = price;
                    window.selectedPrice = price; // Set on window for purchaseReport validation
                    
                    // Set report name
                    const reportNames = {
                        'spot_check': 'Spot Check',
                        'professional': 'Professional',
                        'fleet_valuation': 'Fleet Valuation'
                    };
                    selectedReportName = reportNames[type] || type;
                    window.selectedReportName = selectedReportName; // Set on window for purchaseReport validation
                    
                    
                    // Show/hide Fleet unit count field
                    const fleetUnitCountGroup = document.getElementById('fleetUnitCountGroup');
                    if (fleetUnitCountGroup) {
                        if (type === 'fleet_valuation') {
                            fleetUnitCountGroup.style.display = 'block';
                            // Initialize pricing for default unit count
                            const unitCountInput = document.getElementById('unitCount');
                            if (unitCountInput) {
                                const unitCount = parseInt(unitCountInput.value) || 1;
                                updateFleetPricing(unitCount);
                            }
                        } else {
                            fleetUnitCountGroup.style.display = 'none';
                        }
                    }

                    // Update purchase button with price (only after selection in single valuation)
                    if (purchaseBtn) {
                        // Enable the button now that a report type is selected
                        purchaseBtn.disabled = false;
                        purchaseBtn.style.opacity = '1';
                        purchaseBtn.style.cursor = 'pointer';
                        
                        // Check if we're in bulk processing mode
                        const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
                        const isBulkMode = bulkForm && bulkForm.style.display !== 'none' && document.getElementById('bulkUnlockedState') && document.getElementById('bulkUnlockedState').style.display !== 'none';
                        
                        if (!isBulkMode) {
                            // Single valuation mode - show price only after selection
                            const priceDisplay = (price / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
                            purchaseBtn.innerHTML = `<span></span> Purchase ${selectedReportName} Report - ${priceDisplay}`;
                        } else {
                            // Bulk mode - price will be updated by updateFleetValuationPrice
                            purchaseBtn.innerHTML = `<span></span> Purchase Report`;
                        }
                    }
                });
            });

            // Don't auto-select in single valuation mode - let user choose first
            // Only show price after user selects a report type
            // Check if we're in bulk mode - if so, don't auto-select
            const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
            const isBulkMode = bulkForm && bulkForm.style.display !== 'none' && document.getElementById('bulkUnlockedState') && document.getElementById('bulkUnlockedState').style.display !== 'none';
            
            if (!isBulkMode && reportCards.length > 0) {
                // Single valuation mode - don't auto-select, keep button disabled
                const purchaseBtn = document.getElementById('purchaseReportBtn');
                if (purchaseBtn) {
                    purchaseBtn.disabled = true;
                    purchaseBtn.style.opacity = '0.5';
                    purchaseBtn.style.cursor = 'not-allowed';
                    purchaseBtn.innerHTML = `<span></span> Purchase Report`;
                }
            }
        }
    });

    // purchaseReport will be handled by window.purchaseReport below
    </script>

    <script>
// ============================================================================
// CRANE DATABASE - Manufacturer Models and Specifications
// ============================================================================

// Initialize window objects
window.manufacturerModels = window.manufacturerModels || {};
window.craneDatabase = window.craneDatabase || {};

// Liebherr Models and Database
window.manufacturerModels['Liebherr'] = ["LTM 1025", "LTM 1030-2.1", "LTM 1040-2.1", "LTM 1050-3.1", "LTM 1060-3.1", "LTM 1070-4.2", "LTM 1080-2", "LTM 1090-4.2", "LTM 1100-5.2", "LTM 1110-5.1", "LTM 1120-4.1", "LTM 1130-5.1", "LTM 1160-5.2", "LTM 1200-5.1", "LTM 1220-5.2", "LTM 1230-5.1", "LTM 1250-6.1", "LTM 1300-6.2", "LTM 1350-6.1", "LTM 1400-7.1", "LTM 1450-8.1", "LTM 1499-8.1", "LTM 1650-8.1", "LTM 1750-9.1", "LTM 11200-9.1", "LTC 1045-3.1", "LTC 1050-3.1", "LRT 1090-2.1", "LRT 1100-2.1", "LTR 1040", "LTR 1060", "LTR 1100", "LTR 1220", "LR 1100", "LR 1160", "LR 1200", "LR 1250", "LR 1280", "LR 1300.1 SX", "LR 1350/1", "LR 1400/2", "LR 1499", "LR 1600/2", "LR 1700-1.0", "LR 1750/2", "LR 1800-1.0", "LR 11350", "LR 13000", "LG 1750"];
window.craneDatabase['Liebherr'] = [{"model": "LTM 1025", "capacity": 25, "type": "All-Terrain Crane", "boomLength": 30}, {"model": "LTM 1030-2.1", "capacity": 30, "type": "All-Terrain Crane", "boomLength": 35}, {"model": "LTM 1040-2.1", "capacity": 40, "type": "All-Terrain Crane", "boomLength": 35}, {"model": "LTM 1050-3.1", "capacity": 50, "type": "All-Terrain Crane", "boomLength": 40}, {"model": "LTM 1060-3.1", "capacity": 60, "type": "All-Terrain Crane", "boomLength": 48}, {"model": "LTM 1070-4.2", "capacity": 70, "type": "All-Terrain Crane", "boomLength": 50}, {"model": "LTM 1080-2", "capacity": 80, "type": "All-Terrain Crane", "boomLength": 50}, {"model": "LTM 1090-4.2", "capacity": 90, "type": "All-Terrain Crane", "boomLength": 52}, {"model": "LTM 1100-5.2", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 52}, {"model": "LTM 1110-5.1", "capacity": 110, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1120-4.1", "capacity": 120, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1130-5.1", "capacity": 130, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1160-5.2", "capacity": 160, "type": "All-Terrain Crane", "boomLength": 62}, {"model": "LTM 1200-5.1", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 72}, {"model": "LTM 1220-5.2", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1230-5.1", "capacity": 230, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1250-6.1", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 72}, {"model": "LTM 1300-6.2", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1350-6.1", "capacity": 350, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1400-7.1", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1450-8.1", "capacity": 450, "type": "All-Terrain Crane", "boomLength": 85}, {"model": "LTM 1499-8.1", "capacity": 500, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1650-8.1", "capacity": 650, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTM 1750-9.1", "capacity": 750, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTM 11200-9.1", "capacity": 1200, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTC 1045-3.1", "capacity": 45, "type": "City Crane", "boomLength": 36}, {"model": "LTC 1050-3.1", "capacity": 50, "type": "City Crane", "boomLength": 30}, {"model": "LRT 1090-2.1", "capacity": 90, "type": "Rough Terrain Crane", "boomLength": 50}, {"model": "LRT 1100-2.1", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 52}, {"model": "LTR 1040", "capacity": 40, "type": "Telescopic Crawler Crane", "boomLength": 40}, {"model": "LTR 1060", "capacity": 60, "type": "Telescopic Crawler Crane", "boomLength": 48}, {"model": "LTR 1100", "capacity": 100, "type": "Telescopic Crawler Crane", "boomLength": 52}, {"model": "LTR 1220", "capacity": 220, "type": "Telescopic Crawler Crane", "boomLength": 60}, {"model": "LR 1100", "capacity": 100, "type": "Crawler Crane", "boomLength": 78}, {"model": "LR 1160", "capacity": 160, "type": "Crawler Crane", "boomLength": 81}, {"model": "LR 1200", "capacity": 200, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1250", "capacity": 250, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1280", "capacity": 280, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1300.1 SX", "capacity": 300, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1350/1", "capacity": 350, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1400/2", "capacity": 400, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1499", "capacity": 500, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1600/2", "capacity": 600, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1700-1.0", "capacity": 700, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1750/2", "capacity": 750, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1800-1.0", "capacity": 800, "type": "Crawler Crane", "boomLength": 168}, {"model": "LR 11350", "capacity": 1350, "type": "Crawler Crane", "boomLength": 198}, {"model": "LR 13000", "capacity": 3000, "type": "Crawler Crane", "boomLength": 246}, {"model": "LG 1750", "capacity": 750, "type": "Gantry Crane", "boomLength": 120}];

// Grove Models and Database
window.manufacturerModels['Grove'] = ["GMK5250L", "GMK5150L", "GMK5200", "GMK6300L", "GMK6400", "GMK7450", "RT540E", "RT550E", "RT555E", "RT560E", "RT765E-2", "RT770E", "RT775E", "RT780E", "RT890E", "RT9130E-2", "GRT8100", "GRT8120", "GRT655", "GRT880", "GMK3050-2", "GMK3060", "GMK4080-1", "GMK4100L-1", "GMK5130-2"];
window.craneDatabase['Grove'] = [{"model": "GMK5250L", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 200}, {"model": "GMK5150L", "capacity": 150, "type": "All-Terrain Crane", "boomLength": 180}, {"model": "GMK5200", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 190}, {"model": "GMK6300L", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 220}, {"model": "GMK6400", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 240}, {"model": "GMK7450", "capacity": 450, "type": "All-Terrain Crane", "boomLength": 260}, {"model": "RT540E", "capacity": 40, "type": "Rough Terrain Crane", "boomLength": 110}, {"model": "RT550E", "capacity": 50, "type": "Rough Terrain Crane", "boomLength": 120}, {"model": "RT555E", "capacity": 55, "type": "Rough Terrain Crane", "boomLength": 125}, {"model": "RT560E", "capacity": 60, "type": "Rough Terrain Crane", "boomLength": 130}, {"model": "RT765E-2", "capacity": 65, "type": "Rough Terrain Crane", "boomLength": 135}, {"model": "RT770E", "capacity": 70, "type": "Rough Terrain Crane", "boomLength": 140}, {"model": "RT775E", "capacity": 75, "type": "Rough Terrain Crane", "boomLength": 145}, {"model": "RT780E", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 150}, {"model": "RT890E", "capacity": 90, "type": "Rough Terrain Crane", "boomLength": 155}, {"model": "RT9130E-2", "capacity": 130, "type": "Rough Terrain Crane", "boomLength": 175}, {"model": "GRT8100", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 160}, {"model": "GRT8120", "capacity": 120, "type": "Rough Terrain Crane", "boomLength": 170}, {"model": "GRT655", "capacity": 55, "type": "Rough Terrain Crane", "boomLength": 125}, {"model": "GRT880", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 150}, {"model": "GMK3050-2", "capacity": 50, "type": "All-Terrain Crane", "boomLength": 130}, {"model": "GMK3060", "capacity": 60, "type": "All-Terrain Crane", "boomLength": 140}, {"model": "GMK4080-1", "capacity": 80, "type": "All-Terrain Crane", "boomLength": 150}, {"model": "GMK4100L-1", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 160}, {"model": "GMK5130-2", "capacity": 130, "type": "All-Terrain Crane", "boomLength": 170}];

// Tadano, Manitowoc, Sany, Kobelco, Link-Belt, Terex, Zoomlion models
window.manufacturerModels['Tadano'] = ["GR-550XL", "GR-1000XLL", "TR-250M", "AR-2000M", "GR-750XL", "ATF 110G-5", "TR-500XL", "GR-1600XL", "GR-300EX", "ATF 400G-6", "TR-800M", "GR-1000XL", "AR-5500M", "GR-350XL", "GR-500EX"];
window.craneDatabase['Tadano'] = [{"model": "ATF 400G-6", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "ATF 220G-5", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "ATF 110G-5", "capacity": 120, "type": "All-Terrain Crane", "boomLength": 171}, {"model": "GR-1000XL", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 154}];

window.manufacturerModels['Manitowoc'] = ["18000", "MLC300", "MLC650", "MLC100-1", "MLC165", "999", "2250", "4100W", "4600S", "16000", "21000", "31000", "MLC100", "MLC150", "MLC200"];
window.craneDatabase['Manitowoc'] = [{"model": "18000", "capacity": 550, "type": "Crawler Crane", "boomLength": 320}, {"model": "MLC300", "capacity": 300, "type": "Crawler Crane", "boomLength": 220}, {"model": "MLC650", "capacity": 650, "type": "Crawler Crane", "boomLength": 350}];

window.manufacturerModels['Sany'] = ["SCC8500", "SCC4000E", "SCC6500A", "SCC1000A", "SCC2500A", "SAC1800", "SAC2200", "SAC3000", "SAC4000", "STC250", "STC500", "STC750"];
window.craneDatabase['Sany'] = [{"model": "SCC8500", "capacity": 850, "type": "Crawler Crane", "boomLength": 440}, {"model": "SAC3000", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 230}];

window.manufacturerModels['Kobelco'] = ["CK1600G", "CKE1350G", "BMS800", "CK2500", "CK2750G-2", "CK1100G", "CK1600", "CKE2500G-2", "CKE4000", "CK800"];
window.craneDatabase['Kobelco'] = [{"model": "CK1600G", "capacity": 160, "type": "Crawler Crane", "boomLength": 250}, {"model": "CKE4000", "capacity": 400, "type": "Crawler Crane", "boomLength": 344}];

window.manufacturerModels['Link-Belt'] = ["HTC-8675", "HTC-86100", "HTC-3140", "HTC-86110", "HTC-86155", "RTC-80100", "RTC-80130", "RTC-8090", "ATC-3210", "ATC-3275"];
window.craneDatabase['Link-Belt'] = [{"model": "HTC-8675", "capacity": 75, "type": "Truck Crane", "boomLength": 127}, {"model": "ATC-3275", "capacity": 275, "type": "All Terrain", "boomLength": 223}];

window.manufacturerModels['Terex'] = ["AC 100/4L", "Demag AC 100-4L", "AC 250-1"];
window.craneDatabase['Terex'] = [{"model": "AC 100/4L", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 140}];

window.manufacturerModels['XCMG'] = ["XGC88000", "XGC55000", "XGC28000"];
window.craneDatabase['XCMG'] = [{"model": "XGC88000", "capacity": 4000, "type": "Crawler Crane", "boomLength": 450}];

window.manufacturerModels['Zoomlion'] = ["QY70V", "QY100V"];
window.craneDatabase['Zoomlion'] = [{"model": "QY70V", "capacity": 70, "type": "All-Terrain Crane", "boomLength": 128}];

window.manufacturerModels['HSC'] = ["HSC 60", "HSC 120"];
window.craneDatabase['HSC'] = [{"model": "HSC 60", "capacity": 60, "type": "Crawler Crane", "boomLength": 150}];

window.manufacturerModels['Kato'] = ["NK-500E-V", "NK-750E", "NK-1000"];
window.craneDatabase['Kato'] = [{"model": "NK-500E-V", "capacity": 50, "type": "Rough Terrain Crane", "boomLength": 120}];

window.manufacturerModels['IHI'] = ["CCH500-3", "CCH800-5"];
window.craneDatabase['IHI'] = [{"model": "CCH500-3", "capacity": 50, "type": "Crawler Crane", "boomLength": 140}];


// ============================================================================
// MANUFACTURER  MODEL CASCADE LOGIC (Updated for autocomplete)
// ============================================================================

// Handle "Other" manufacturer option
document.addEventListener('DOMContentLoaded', function() {
    const manufacturerSelect = document.getElementById('manufacturer');
    const manufacturerOtherInput = document.getElementById('manufacturerOther');
    
    if (manufacturerSelect && manufacturerOtherInput) {
        manufacturerSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                manufacturerOtherInput.style.display = 'block';
                manufacturerOtherInput.required = true;
            } else {
                manufacturerOtherInput.style.display = 'none';
                manufacturerOtherInput.required = false;
                manufacturerOtherInput.value = '';
            }
        });
    }
});

// Model autocomplete functionality
let modelAutocompleteTimeout;
let currentSuggestions = [];
let selectedSuggestionIndex = -1;

function setupModelAutocomplete() {
    const modelInput = document.getElementById('model');
    const suggestionsDiv = document.getElementById('modelSuggestions');
    const manufacturerSelect = document.getElementById('manufacturer');
    const fallbackSection = document.getElementById('fallbackInputSection');
    
    if (!modelInput || !suggestionsDiv) return;
    
    // Get manufacturer value (from select or "Other" input)
    function getManufacturerValue() {
        const manufacturer = manufacturerSelect?.value || '';
        if (manufacturer === 'Other') {
            return document.getElementById('manufacturerOther')?.value || '';
        }
        return manufacturer;
    }
    
    // Show/hide suggestions
    function showSuggestions(suggestions) {
        if (suggestions.length === 0) {
            suggestionsDiv.style.display = 'none';
            // Show fallback section if no suggestions and user has typed something
            if (modelInput.value.length > 0 && getManufacturerValue()) {
                fallbackSection.style.display = 'block';
            } else {
                fallbackSection.style.display = 'none';
            }
            return;
        }
        
        currentSuggestions = suggestions;
        selectedSuggestionIndex = -1;
        suggestionsDiv.innerHTML = '';
        
        suggestions.forEach((model, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.style.cssText = 'padding: 10px 16px; cursor: pointer; color: #B0B0B0; border-bottom: 1px solid #333; transition: background 0.2s;';
            item.textContent = model;
            item.dataset.index = index;
            
            item.addEventListener('mouseenter', function() {
                this.style.background = '#2A2A2A';
                this.style.color = '#00FF85';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
                this.style.color = '#B0B0B0';
            });
            
            item.addEventListener('click', function() {
                selectModel(model);
            });
            
            suggestionsDiv.appendChild(item);
        });
        
        suggestionsDiv.style.display = 'block';
        fallbackSection.style.display = 'none';
    }
    
    // Select a model
    function selectModel(model) {
        modelInput.value = model;
        suggestionsDiv.style.display = 'none';
        fallbackSection.style.display = 'none';
        
        // Auto-fill specs if available
        const manufacturer = getManufacturerValue();
        if (manufacturer) {
            autofillCraneSpecs(manufacturer, model);
        }
    }
    
    // Filter models based on input
    function filterModels(query) {
        const manufacturer = getManufacturerValue();
        if (!manufacturer || !window.manufacturerModels[manufacturer]) {
            return [];
        }
        
        const models = window.manufacturerModels[manufacturer];
        const lowerQuery = query.toLowerCase();
        
        return models.filter(model => 
            model.toLowerCase().includes(lowerQuery)
        ).slice(0, 10); // Limit to 10 suggestions
    }
    
    // Handle input
    modelInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(modelAutocompleteTimeout);
        
        if (query.length === 0) {
            suggestionsDiv.style.display = 'none';
            fallbackSection.style.display = 'none';
            return;
        }
        
        modelAutocompleteTimeout = setTimeout(() => {
            const suggestions = filterModels(query);
            showSuggestions(suggestions);
        }, 200);
    });
    
    // Handle keyboard navigation
    modelInput.addEventListener('keydown', function(e) {
        if (suggestionsDiv.style.display === 'none') return;
        
        const items = suggestionsDiv.querySelectorAll('.suggestion-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
            e.preventDefault();
            if (items[selectedSuggestionIndex]) {
                selectModel(items[selectedSuggestionIndex].textContent);
            }
        } else if (e.key === 'Escape') {
            suggestionsDiv.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedSuggestionIndex) {
                item.style.background = '#2A2A2A';
                item.style.color = '#00FF85';
            } else {
                item.style.background = 'transparent';
                item.style.color = '#B0B0B0';
            }
        });
    }
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!modelInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
    
    // Update suggestions when manufacturer changes
    if (manufacturerSelect) {
        manufacturerSelect.addEventListener('change', function() {
            modelInput.value = '';
            suggestionsDiv.style.display = 'none';
            fallbackSection.style.display = 'none';
        });
    }
}

// Initialize autocomplete when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupModelAutocomplete);
} else {
    setupModelAutocomplete();
}

// Legacy function for backward compatibility (if still used elsewhere)
function updateModelOptions(manufacturer) {
    // This function is now replaced by autocomplete, but kept for compatibility
    const modelInput = document.getElementById('model');
    if (modelInput && modelInput.tagName === 'SELECT') {
        // Only run if model is still a select (shouldn't happen now)
        const modelSelect = modelInput;
        if (!manufacturer || manufacturer === '') {
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            return;
        }
        
        const models = window.manufacturerModels[manufacturer];
        
        if (models && models.length > 0) {
            let options = '<option value="">Select Model</option>';
            models.forEach(model => {
                options += `<option value="${model}">${model}</option>`;
            });
            modelSelect.innerHTML = options;
        } else {
            modelSelect.innerHTML = '<option value="">No models available</option>';
        }
    }
}

// ============================================================================
// FALLBACK FORM FUNCTIONS
// ============================================================================

// Make functions globally accessible
window.toggleFallbackForm = function() {
    const formSection = document.getElementById('fallbackFormSection');
    const toggleBtn = document.getElementById('toggleFallbackFormBtn');
    
    if (!formSection || !toggleBtn) {
        console.error('Fallback form elements not found');
        return;
    }
    
    if (formSection.style.display === 'none' || !formSection.style.display) {
        formSection.style.display = 'block';
        toggleBtn.textContent = 'Hide Details';
        formSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Make Equipment Information fields optional when manual entry is used
        const equipmentFields = ['craneType', 'manufacturer', 'model', 'year', 'capacity', 'operatingHours', 'region'];
        equipmentFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                // Store original required state
                if (field.hasAttribute('required')) {
                    field.setAttribute('data-was-required', 'true');
                    field.removeAttribute('required');
                }
            }
        });
    } else {
        formSection.style.display = 'none';
        toggleBtn.textContent = 'Enter Details';
        
        // Restore required attributes if they were saved
        const equipmentFields = ['craneType', 'manufacturer', 'model', 'year', 'capacity', 'operatingHours', 'region'];
        equipmentFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && field.hasAttribute('data-was-required')) {
                field.setAttribute('required', '');
                field.removeAttribute('data-was-required');
            }
        });
    }
};

// Save manual entry as DRAFT FMV report
window.saveManualEntry = async function() {
    try {
        // Check if fallback form section is visible
        const fallbackFormSection = document.getElementById('fallbackFormSection');
        if (!fallbackFormSection || fallbackFormSection.style.display === 'none') {
            console.error(' Fallback form section is not visible');
            if (typeof notificationSystem !== 'undefined' && notificationSystem.showError) {
                notificationSystem.showError('Form Error', 'Please open the manual entry form first by clicking "Enter Details"');
            } else if (window.notificationSystem && window.notificationSystem.showError) {
                window.notificationSystem.showError('Form Error', 'Please open the manual entry form first by clicking "Enter Details"');
            } else {
                alert('Please open the manual entry form first by clicking "Enter Details"');
            }
            return;
        }
        
        // Get form values - handle empty strings and null values properly
        // Ensure we're reading from the correct form section (fallbackFormSection, not fallbackInputSection)
        const fallbackForm = document.getElementById('fallbackFormSection');
        const getFormElementValue = (id) => {
            // First try to get from fallbackFormSection (the main manual entry form)
            if (fallbackForm) {
                const el = fallbackForm.querySelector(`#${id}`);
                if (el) {
                    return (el.value || '').trim();
                }
            }
            // Fallback to document.getElementById
            const el = document.getElementById(id);
            if (!el) {
                console.warn(` Element with id "${id}" not found`);
                return '';
            }
            return (el.value || '').trim();
        };
        
        const getElementValue = (id) => {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(` Element with id "${id}" not found`);
                return '';
            }
            return (el.value || '').trim();
        };
        
        const getElementNumber = (id, allowZero = false) => {
            // Try to get from fallbackFormSection first
            if (fallbackForm) {
                const el = fallbackForm.querySelector(`#${id}`);
                if (el) {
                    if (!el.value || el.value.trim() === '') return null;
                    const num = parseFloat(el.value);
                    return isNaN(num) ? null : (allowZero || num > 0 ? num : null);
                }
            }
            // Fallback to document.getElementById
            const el = document.getElementById(id);
            if (!el || !el.value || el.value.trim() === '') return null;
            const num = parseFloat(el.value);
            return isNaN(num) ? null : (allowZero || num > 0 ? num : null);
        };
        
        const getElementInt = (id, allowZero = false) => {
            // Try to get from fallbackFormSection first
            if (fallbackForm) {
                const el = fallbackForm.querySelector(`#${id}`);
                if (el) {
                    if (!el.value || el.value.trim() === '') return null;
                    const num = parseInt(el.value, 10);
                    return isNaN(num) ? null : (allowZero || num > 0 ? num : null);
                }
            }
            // Fallback to document.getElementById
            const el = document.getElementById(id);
            if (!el || !el.value || el.value.trim() === '') return null;
            const num = parseInt(el.value, 10);
            return isNaN(num) ? null : (allowZero || num > 0 ? num : null);
        };
        
        const manualEntryData = {
            manufacturer: getFormElementValue('fallbackManufacturer'),
            model: getFormElementValue('fallbackModel'),
            year: getElementInt('fallbackYear'),
            serial_number: getFormElementValue('fallbackSerialNumber') || null,
            capacity: getElementNumber('fallbackCapacity'),
            craneType: getFormElementValue('fallbackCraneType'),
            operatingHours: getElementInt('fallbackOperatingHours', true), // Allow 0 for operating hours
            mileage: getElementInt('fallbackMileage', true) || null,
            boomLength: getElementNumber('fallbackBoomLength') || null,
            jibLength: getElementNumber('fallbackJibLength') || null,
            maxHookHeight: getElementNumber('fallbackMaxHookHeight') || null,
            maxRadius: getElementNumber('fallbackMaxRadius') || null,
            region: getFormElementValue('fallbackRegion'),
            condition: getFormElementValue('fallbackCondition'),
            additionalSpecs: getFormElementValue('fallbackAdditionalSpecs') || null,
            specialFeatures: getFormElementValue('fallbackSpecialFeatures') || null,
            usageHistory: getFormElementValue('fallbackUsageHistory') || null
        };
        
        // Debug: Check which form section is visible and get values from correct section
        // Note: fallbackForm is already declared above, reuse it
        const fallbackInputSection = document.getElementById('fallbackInputSection');
        if (fallbackFormSection) {
            // Get form element values from fallbackFormSection
            const fallbackManufacturer = fallbackFormSection.querySelector('#fallbackManufacturer')?.value;
            const fallbackModel = fallbackFormSection.querySelector('#fallbackModel')?.value;
            const fallbackYear = fallbackFormSection.querySelector('#fallbackYear')?.value;
            const fallbackCapacity = fallbackFormSection.querySelector('#fallbackCapacity')?.value;
            const fallbackCraneType = fallbackFormSection.querySelector('#fallbackCraneType')?.value;
            const fallbackOperatingHours = fallbackFormSection.querySelector('#fallbackOperatingHours')?.value;
            const fallbackRegion = fallbackFormSection.querySelector('#fallbackRegion')?.value;
            const fallbackCondition = fallbackFormSection.querySelector('#fallbackCondition')?.value;
        }
        
        // Validate required fields - check for empty strings, NaN, null, undefined, or 0 for numeric fields
        const missingFields = [];
        if (!manualEntryData.manufacturer || manualEntryData.manufacturer === '') {
            missingFields.push('Manufacturer');
        }
        if (!manualEntryData.model || manualEntryData.model === '') {
            missingFields.push('Model');
        }
        if (manualEntryData.year === null || manualEntryData.year === undefined || isNaN(manualEntryData.year) || manualEntryData.year <= 0) {
            missingFields.push('Year');
        }
        if (manualEntryData.capacity === null || manualEntryData.capacity === undefined || isNaN(manualEntryData.capacity) || manualEntryData.capacity <= 0) {
            missingFields.push('Capacity');
        }
        if (!manualEntryData.craneType || manualEntryData.craneType === '' || manualEntryData.craneType === 'Select Crane Type') {
            missingFields.push('Crane Type');
        }
        if (manualEntryData.operatingHours === null || manualEntryData.operatingHours === undefined || isNaN(manualEntryData.operatingHours) || manualEntryData.operatingHours < 0) {
            missingFields.push('Operating Hours');
        }
        if (!manualEntryData.region || manualEntryData.region === '' || manualEntryData.region === 'Select Region') {
            missingFields.push('Region');
        }
        if (!manualEntryData.condition || manualEntryData.condition === '' || manualEntryData.condition === 'Select Condition') {
            missingFields.push('Condition');
        }
        
        if (missingFields.length > 0) {
            const errorMessage = `Please fill in the following required fields: ${missingFields.join(', ')}`;
            console.error(' Validation failed. Missing fields:', missingFields);
            console.error('Form data:', manualEntryData);
            if (typeof notificationSystem !== 'undefined' && notificationSystem.showError) {
                notificationSystem.showError('Validation Error', errorMessage);
            } else if (window.notificationSystem && window.notificationSystem.showError) {
                window.notificationSystem.showError('Validation Error', errorMessage);
            } else {
                alert(errorMessage);
            }
            return;
        }
        
        console.log(' All required fields validated successfully');
        
        // Get user info - ensure safeStorage is available
        const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
        const token = getAuthToken();
        let userEmail = null;
        let userId = null;
        
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                userEmail = payload.email;
                userId = payload.sub ? parseInt(payload.sub) : null;
            } catch (e) {
                console.error('Error decoding token:', e);
            }
        }
        
        // If no email from token, try to get from user_data
        if (!userEmail) {
            const userData = safeStorage.getItem('user_data');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userEmail = user.email;
                    userId = user.id || userId;
                } catch (e) {
                    console.error('Error parsing user_data:', e);
                }
            }
        }
        
        if (!userEmail) {
            if (typeof notificationSystem !== 'undefined' && notificationSystem.showError) {
                notificationSystem.showError('Authentication Required', 'Please log in to save your manual entry.');
            } else if (window.notificationSystem && window.notificationSystem.showError) {
                window.notificationSystem.showError('Authentication Required', 'Please log in to save your manual entry.');
            } else {
                alert('Please log in to save your manual entry.');
            }
            return;
        }
        
        // Upload service record files if any
        let serviceRecordFileUrls = [];
        if (window.serviceRecordFiles && window.serviceRecordFiles.length > 0) {
            if (window.notificationSystem) {
                window.notificationSystem.showInfo('Uploading Files', `Uploading ${window.serviceRecordFiles.length} file(s)...`);
            }
            
            const formData = new FormData();
            window.serviceRecordFiles.forEach((file, index) => {
                formData.append(`files`, file);
            });
            
            try {
                const uploadResponse = await fetch('/api/v1/fmv-reports/upload-service-records', {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    serviceRecordFileUrls = uploadResult.files || [];
                } else {
                    console.warn(' File upload failed, continuing without files');
                }
            } catch (uploadError) {
                console.error('Error uploading files:', uploadError);
                // Continue without files
            }
        }
        
        // Show loading
        if (window.notificationSystem) {
            window.notificationSystem.showInfo('Saving Entry', 'Please wait while we save your manual entry...');
        }
        
        // Prepare crane_details JSON with all manual entry data
        // Include ALL fields in both camelCase and snake_case for maximum compatibility
        const craneDetails = {
            manufacturer: manualEntryData.manufacturer,
            model: manualEntryData.model,
            year: manualEntryData.year,
            capacity: manualEntryData.capacity,
            capacity_tons: manualEntryData.capacity,
            operatingHours: manualEntryData.operatingHours,
            operating_hours: manualEntryData.operatingHours, // Include both formats
            region: manualEntryData.region,
            craneType: manualEntryData.craneType,
            crane_type: manualEntryData.craneType, // Include both formats
            // Manual entry specific fields - include all in both formats
            serial_number: manualEntryData.serial_number,
            serialNumber: manualEntryData.serial_number, // Include both formats
            mileage: manualEntryData.mileage,
            boomLength: manualEntryData.boomLength,
            boom_length: manualEntryData.boomLength, // Include both formats
            jibLength: manualEntryData.jibLength,
            jib_length: manualEntryData.jibLength, // Include both formats
            maxHookHeight: manualEntryData.maxHookHeight,
            max_hook_height: manualEntryData.maxHookHeight, // Include both formats
            maxRadius: manualEntryData.maxRadius,
            max_radius: manualEntryData.maxRadius, // Include both formats
            condition: manualEntryData.condition,
            additionalSpecs: manualEntryData.additionalSpecs,
            additional_specs: manualEntryData.additionalSpecs, // Include both formats
            specialFeatures: manualEntryData.specialFeatures,
            special_features: manualEntryData.specialFeatures, // Include both formats
            usageHistory: manualEntryData.usageHistory,
            usage_history: manualEntryData.usageHistory, // Include both formats
            is_manual_entry: true // Flag to identify manual entries
        };
        
        // Create DRAFT FMV report with manual entry data
        const reportData = {
            report_type: 'professional', // Default to professional for manual entries
            crane_details: craneDetails,
            service_record_files: serviceRecordFileUrls.length > 0 ? serviceRecordFileUrls : null,
            metadata: {
                user_email: userEmail,
                is_manual_entry: true,
                manual_entry_timestamp: new Date().toISOString()
            }
        };
        
        // Submit to backend to create DRAFT report
        const response = await fetch('/api/v1/fmv-reports/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify(reportData)
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Failed to save manual entry' }));
            throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Store draft report ID to prevent duplicates when proceeding to purchase
        if (result.id) {
            window.currentDraftReportId = result.id;
            // Store manual entry data for use in purchase flow
            window.manualEntryData = manualEntryData;
            // Store service record URLs for use in purchase flow
            window.manualEntryServiceRecordUrls = serviceRecordFileUrls;
        }
        
        // Show preview of saved entry
        showManualEntryPreview(result, manualEntryData, serviceRecordFileUrls);
        
        // Show success message
        if (window.notificationSystem) {
            window.notificationSystem.showSuccess(
                'Entry Saved Successfully',
                'Your manual entry has been saved as a DRAFT report. You can preview it below and proceed to purchase when ready.'
            );
        }
        
        // Scroll to preview
        setTimeout(() => {
            const previewSection = document.getElementById('manualEntryPreview');
            if (previewSection) {
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 500);
        
    } catch (error) {
        console.error('Error saving manual entry:', error);
        if (typeof notificationSystem !== 'undefined' && notificationSystem.showError) {
            notificationSystem.showError('Save Failed', error.message || 'Failed to save manual entry. Please try again.');
        } else if (window.notificationSystem && window.notificationSystem.showError) {
            window.notificationSystem.showError('Save Failed', error.message || 'Failed to save manual entry. Please try again.');
        } else {
            alert('Failed to save manual entry: ' + error.message);
        }
    }
};

// Show preview of saved manual entry
window.showManualEntryPreview = function(report, manualEntryData, serviceRecordFileUrls) {
    const previewHTML = `
        <div id="manualEntryPreview" style="margin-top: 32px; padding: 24px; background: rgba(255, 214, 0, 0.1); border: 2px solid #FFD600; border-radius: 8px;">
            <h3 style="color: #FFD600; font-size: 20px; font-weight: 700; margin-bottom: 20px;"> Saved Entry Preview</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                <div><strong style="color: #B0B0B0;">Report ID:</strong> <span style="color: #FFF;">#${report.id}</span></div>
                <div><strong style="color: #B0B0B0;">Status:</strong> <span style="color: #FFD600;">DRAFT</span></div>
                <div><strong style="color: #B0B0B0;">Manufacturer:</strong> <span style="color: #FFF;">${manualEntryData.manufacturer}</span></div>
                <div><strong style="color: #B0B0B0;">Model:</strong> <span style="color: #FFF;">${manualEntryData.model}</span></div>
                <div><strong style="color: #B0B0B0;">Year:</strong> <span style="color: #FFF;">${manualEntryData.year}</span></div>
                <div><strong style="color: #B0B0B0;">Capacity:</strong> <span style="color: #FFF;">${manualEntryData.capacity} tons</span></div>
                <div><strong style="color: #B0B0B0;">Crane Type:</strong> <span style="color: #FFF;">${manualEntryData.craneType}</span></div>
                <div><strong style="color: #B0B0B0;">Operating Hours:</strong> <span style="color: #FFF;">${manualEntryData.operatingHours.toLocaleString()}</span></div>
                <div><strong style="color: #B0B0B0;">Region:</strong> <span style="color: #FFF;">${manualEntryData.region}</span></div>
                <div><strong style="color: #B0B0B0;">Condition:</strong> <span style="color: #FFF;">${manualEntryData.condition}</span></div>
                ${manualEntryData.serial_number ? `<div><strong style="color: #B0B0B0;">Serial Number:</strong> <span style="color: #FFF;">${manualEntryData.serial_number}</span></div>` : ''}
                ${manualEntryData.mileage ? `<div><strong style="color: #B0B0B0;">Mileage:</strong> <span style="color: #FFF;">${manualEntryData.mileage.toLocaleString()}</span></div>` : ''}
                ${manualEntryData.boomLength ? `<div><strong style="color: #B0B0B0;">Boom Length:</strong> <span style="color: #FFF;">${manualEntryData.boomLength}m</span></div>` : ''}
                ${manualEntryData.jibLength ? `<div><strong style="color: #B0B0B0;">Jib Length:</strong> <span style="color: #FFF;">${manualEntryData.jibLength}m</span></div>` : ''}
                ${manualEntryData.maxHookHeight ? `<div><strong style="color: #B0B0B0;">Max Hook Height:</strong> <span style="color: #FFF;">${manualEntryData.maxHookHeight}m</span></div>` : ''}
                ${manualEntryData.maxRadius ? `<div><strong style="color: #B0B0B0;">Max Radius:</strong> <span style="color: #FFF;">${manualEntryData.maxRadius}m</span></div>` : ''}
            </div>
            ${manualEntryData.additionalSpecs ? `<div style="margin-top: 16px;"><strong style="color: #B0B0B0;">Additional Specifications:</strong><p style="color: #FFF; margin-top: 8px;">${manualEntryData.additionalSpecs}</p></div>` : ''}
            ${manualEntryData.specialFeatures ? `<div style="margin-top: 16px;"><strong style="color: #B0B0B0;">Special Features:</strong><p style="color: #FFF; margin-top: 8px;">${manualEntryData.specialFeatures}</p></div>` : ''}
            ${manualEntryData.usageHistory ? `<div style="margin-top: 16px;"><strong style="color: #B0B0B0;">Usage History:</strong><p style="color: #FFF; margin-top: 8px;">${manualEntryData.usageHistory}</p></div>` : ''}
            ${serviceRecordFileUrls.length > 0 ? `
                <div style="margin-top: 16px;">
                    <strong style="color: #B0B0B0;">Uploaded Documents (${serviceRecordFileUrls.length}):</strong>
                    <ul style="color: #FFF; margin-top: 8px; padding-left: 20px;">
                        ${serviceRecordFileUrls.map(f => `<li>${typeof f === 'string' ? f : (f.name || f.url || f)}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button onclick="proceedToPurchase(${report.id})" style="background: #FFD600; color: #000; border: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                     Proceed to Purchase
                </button>
                <button onclick="editManualEntry()" style="background: #2A2A2A; color: #FFF; border: 1px solid #444; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                     Edit Entry
                </button>
            </div>
        </div>
    `;
    
    // Remove existing preview if any
    const existingPreview = document.getElementById('manualEntryPreview');
    if (existingPreview) {
        existingPreview.remove();
    }
    
    // Insert preview after the fallback form
    const fallbackFormSection = document.getElementById('fallbackFormSection');
    if (fallbackFormSection) {
        fallbackFormSection.insertAdjacentHTML('afterend', previewHTML);
    }
};

// Proceed to purchase for saved manual entry
window.proceedToPurchase = function(reportId) {
    // Set the report ID to prevent duplicate creation
    window.currentDraftReportId = reportId;
    
    // Get selected report type
    const selectedReportCard = document.querySelector('.report-type-card.selected');
    if (!selectedReportCard) {
        if (window.notificationSystem) {
            window.notificationSystem.showError('Report Type Required', 'Please select a report type first.');
        }
        return;
    }
    
    // Open payment modal directly (skip DRAFT creation since it already exists)
    // The payment flow will use window.currentDraftReportId
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        paymentModal.style.display = 'flex';
    }
    
    // Trigger purchase flow which will use existing DRAFT
    const purchaseBtn = document.querySelector('[onclick*="purchaseReport"]');
    if (purchaseBtn) {
        purchaseBtn.click();
    } else if (typeof window.purchaseReport === 'function') {
        window.purchaseReport(true); // Pass bypassCheck=true to skip DRAFT creation
    }
};

// Edit manual entry
window.editManualEntry = function() {
    // Remove preview
    const preview = document.getElementById('manualEntryPreview');
    if (preview) {
        preview.remove();
    }
    // Show form again
    const fallbackFormSection = document.getElementById('fallbackFormSection');
    if (fallbackFormSection) {
        fallbackFormSection.style.display = 'block';
    }
};

// Legacy function for backward compatibility
window.submitFallbackRequest = window.saveManualEntry;

// ============================================================================
// SERVICE RECORDS FILE UPLOAD
// ============================================================================

// Global variable to store service record files
window.serviceRecordFiles = [];

function setupServiceRecordsUpload() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('serviceRecordsInput');
    const fileList = document.getElementById('fileList');
    const fileListItems = document.getElementById('fileListItems');
    const uploadContainer = document.getElementById('serviceRecordsUpload');
    
    if (!dropZone || !fileInput) return;
    
    // File validation
    function validateFile(file) {
        const maxSize = 20 * 1024 * 1024; // 20MB
        const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];
        
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            return { valid: false, error: 'Invalid file type. Only PDF, JPG, and PNG files are allowed.' };
        }
        
        if (file.size > maxSize) {
            return { valid: false, error: `File size exceeds 20MB limit. ${file.name} is ${(file.size / 1024 / 1024).toFixed(2)}MB` };
        }
        
        return { valid: true };
    }
    
    // Add files to list
    function addFiles(files) {
        // Ensure files is an array
        const filesArray = Array.isArray(files) ? files : Array.from(files || []);
        
        filesArray.forEach(file => {
            // Ensure file is a File object
            if (!(file instanceof File)) {
                console.error('Invalid file object:', file);
                return;
            }
            
            // Log file info for debugging
            console.log(' Adding file:', file.name, 'Size:', file.size, 'bytes');
            
            const validation = validateFile(file);
            
            if (!validation.valid) {
                if (window.notificationSystem) {
                    window.notificationSystem.showError('File Upload Error', validation.error);
                } else {
                    showNotification('error', 'File Upload Error', validation.error);
                }
                return;
            }
            
            // Check if file already exists
            const existingFile = window.serviceRecordFiles.find(f => {
                return f.name === file.name && f.size === file.size;
            });
            
            if (existingFile) {
                if (window.notificationSystem) {
                    window.notificationSystem.showInfo('File Already Added', `${file.name} is already in the list.`);
                }
                return;
            }
            
            // File is valid and new - add it
            window.serviceRecordFiles.push(file);
            updateFileList();
        });
    }
    
    // Update file list display
    function updateFileList() {
        if (window.serviceRecordFiles.length === 0) {
            fileList.style.display = 'none';
            return;
        }
        
        fileList.style.display = 'block';
        fileListItems.innerHTML = '';
        
        window.serviceRecordFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #2A2A2A; border-radius: 6px; margin-bottom: 8px;';
            
            const fileInfo = document.createElement('div');
            fileInfo.style.cssText = 'display: flex; align-items: center; gap: 12px; flex: 1;';
            
            const fileIcon = document.createElement('span');
            fileIcon.style.cssText = 'font-size: 24px;';
            if (file.type === 'application/pdf') {
                fileIcon.textContent = '';
            } else {
                fileIcon.textContent = '';
            }
            
            const fileName = document.createElement('span');
            fileName.style.cssText = 'color: #B0B0B0; font-size: 14px;';
            fileName.textContent = file.name;
            
            const fileSize = document.createElement('span');
            fileSize.style.cssText = 'color: #888; font-size: 12px;';
            // Ensure file.size is a number - File objects always have size property
            let sizeInMB = '0.00';
            if (file && typeof file.size === 'number' && file.size > 0) {
                sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            } else if (file && file.size === 0) {
                sizeInMB = '0.00';
            } else {
                // If size is not available, try to get it
                console.warn('File size not available for:', file.name, file);
                sizeInMB = 'Unknown';
            }
            fileSize.textContent = `(${sizeInMB} MB)`;
            
            fileInfo.appendChild(fileIcon);
            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileSize);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.style.cssText = 'background: #FF4444 !important; color: white !important; border: none !important; padding: 4px 10px !important; border-radius: 4px !important; cursor: pointer !important; font-size: 12px !important; font-weight: 500 !important; white-space: nowrap !important; box-sizing: border-box !important; flex-shrink: 0 !important; min-width: auto !important; max-width: none !important; width: auto !important; height: auto !important; line-height: 1.4 !important; margin: 0 !important;';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', () => {
                window.serviceRecordFiles.splice(index, 1);
                updateFileList();
            });
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            fileListItems.appendChild(fileItem);
        });
    }
    
    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadContainer.style.borderColor = '#00FF85';
        uploadContainer.style.background = 'rgba(0, 255, 133, 0.1)';
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadContainer.style.borderColor = '#444';
        uploadContainer.style.background = '#1A1A1A';
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadContainer.style.borderColor = '#444';
        uploadContainer.style.background = '#1A1A1A';
        
        const files = e.dataTransfer.files;
        if (files && files.length > 0) {
            // Convert FileList to Array to ensure proper handling
            const filesArray = Array.from(files);
            addFiles(filesArray);
        }
    });
    
    // Click to browse - but not if clicking on the button
    dropZone.addEventListener('click', (e) => {
        // Don't trigger if clicking on the button or its children
        if (e.target.closest('button') || e.target.tagName === 'BUTTON') {
            e.stopPropagation();
            return;
        }
        // Only trigger if clicking directly on the dropZone or its text elements
        if (e.target === dropZone || e.target.closest('#dropZone')) {
            fileInput.click();
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
            // Convert FileList to Array to ensure proper handling
            const filesArray = Array.from(e.target.files);
            addFiles(filesArray);
            // Reset input to allow selecting same file again
            e.target.value = '';
        }
    });
}

// Initialize file upload when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupServiceRecordsUpload);
} else {
    setupServiceRecordsUpload();
}

// ============================================================================
// AUTO-FILL CRANE SPECIFICATIONS
// ============================================================================

function autofillCraneSpecs(manufacturer, model) {
    if (!manufacturer || !model) return;
    
    const specs = getCraneSpecifications(manufacturer, model);
    
    if (specs) {
        // Fill capacity
        const capacityInput = document.getElementById('capacity');
        if (capacityInput && specs.capacity) {
            capacityInput.value = specs.capacity;
            capacityInput.style.borderColor = '#00FF88';
            setTimeout(() => { capacityInput.style.borderColor = ''; }, 2000);
        }
        
        // Fill crane type
        const craneTypeSelect = document.getElementById('craneType');
        if (craneTypeSelect && specs.type) {
            craneTypeSelect.value = specs.type;
            craneTypeSelect.style.borderColor = '#00FF88';
            setTimeout(() => { craneTypeSelect.style.borderColor = ''; }, 2000);
        }
        
        // Fill boom length
        const boomLengthInput = document.getElementById('boomLength');
        if (boomLengthInput && specs.boomLength) {
            boomLengthInput.value = specs.boomLength;
            boomLengthInput.style.borderColor = '#00FF88';
            setTimeout(() => { boomLengthInput.style.borderColor = ''; }, 2000);
        }
        
    }
}

function getCraneSpecifications(manufacturer, model) {
    const manufacturerSpecs = window.craneDatabase[manufacturer];
    if (!manufacturerSpecs) return null;
    
    return manufacturerSpecs.find(spec => spec.model === model);
}

// ============================================================================
// LOAD SAMPLE DATA
// ============================================================================

// Make loadSampleData globally available
window.loadSampleData = function loadSampleData() {
    // Sample data
    const manufacturerEl = document.getElementById('manufacturer');
    if (manufacturerEl) {
        manufacturerEl.value = 'Liebherr';
        updateModelOptions('Liebherr');
    }
    
    setTimeout(() => {
        const modelEl = document.getElementById('model');
        const yearEl = document.getElementById('year');
        const capacityEl = document.getElementById('capacity');
        const operatingHoursEl = document.getElementById('operatingHours');
        const mileageEl = document.getElementById('mileage');
        const craneTypeEl = document.getElementById('craneType');
        const boomLengthEl = document.getElementById('boomLength');
        const regionEl = document.getElementById('region');
        
        if (modelEl) modelEl.value = 'LTM 1499-8.1';
        if (yearEl) yearEl.value = '2020';
        if (capacityEl) capacityEl.value = '500';
        if (operatingHoursEl) operatingHoursEl.value = '5000';
        if (mileageEl) mileageEl.value = '25000';
        if (craneTypeEl) craneTypeEl.value = 'All-Terrain Crane';
        if (boomLengthEl) boomLengthEl.value = '84';
        if (regionEl) regionEl.value = 'North America';
        // Removed fields: jibIncluded, jibLength, askingPrice
        
        if (window.notificationSystem) {
            window.notificationSystem.showSuccess('Sample Data Loaded', 'Sample crane data has been populated in the form.');
        }
    }, 100);
}

// ============================================================================
// CLEAR FORM
// ============================================================================

function clearForm() {
    const reportForm = document.getElementById('reportForm');
    if (reportForm) {
        reportForm.reset();
    }
    const modelSelect = document.getElementById('model');
    if (modelSelect) {
        modelSelect.innerHTML = '<option value="">Select Model</option>';
    }
}

// ============================================================================
// PURCHASE REPORT
// ============================================================================

// Global purchaseReport function - will be set by the main implementation below
// This placeholder ensures the function exists for onclick handlers
// Initialize purchaseReport early to prevent "not found" errors
// This will be replaced by the full implementation later
if (!window.purchaseReport) {
    window.purchaseReport = async function() {
        console.warn(' purchaseReport called before full initialization - waiting...');
        // Wait a bit for the full function to load
        let attempts = 0;
        const maxAttempts = 10;
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 100));
            // Check if the real function is now available (it will have more code)
            if (window.purchaseReport && window.purchaseReport.toString().length > 200) {
                return window.purchaseReport();
            }
            attempts++;
        }
        // If still not available, show error
        if (window.notificationSystem) {
            window.notificationSystem.showError('Error', 'Please wait for the page to fully load.');
        } else {
            alert('Please wait for the page to fully load before purchasing a report.');
        }
    };
}

// Also create a simple wrapper function for onclick handlers
// Local purchaseReport wrapper - delegates to window.purchaseReport
function purchaseReport() {
    // Call the window.purchaseReport function if it exists (main implementation)
    if (typeof window.purchaseReport === 'function') {
        return window.purchaseReport();
    } else {
        console.error('window.purchaseReport not available yet');
        showNotification('error', 'Purchase Error', 'Purchase function not ready. Please wait for the page to fully load.');
        return;
    }
    
    // Fallback: Basic validation
    const manufacturer = document.getElementById('manufacturer')?.value;
    const model = document.getElementById('model')?.value;
    const year = document.getElementById('year')?.value;
    const capacity = document.getElementById('capacity')?.value;
    
    if (!manufacturer || !model || !year || !capacity) {
        showNotification('error', 'Validation Error', 'Please fill in all required fields (marked with *)');
        return;
    }
    
    console.log('Purchase initiated (fallback):', {manufacturer, model, year, capacity});
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

function getUserId() {
    // Try to get from unified auth
    if (window.unifiedAuth && window.unifiedAuth.user && window.unifiedAuth.user.id) {
        return window.unifiedAuth.user.id;
    }
    
    // Try user_data (main auth system)
    const user = getUserData();
    if (user && user.id) {
        return user.id;
    }
    
    // Try to decode JWT token to get user ID
    const token = getAuthToken();
    if (token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.sub) return parseInt(payload.sub);
        } catch (e) {
            console.error('Error decoding token:', e);
        }
    }
    
    return null;
}

function getUserEmail() {
    // Try to get from unified auth
    if (window.unifiedAuth && window.unifiedAuth.user && window.unifiedAuth.user.email) {
        return window.unifiedAuth.user.email;
    }
    
    // Try user_data (main auth system)
    const user = getUserData();
    if (user && user.email) {
        return user.email;
    }
    
    // Fallback to currentUser
    const currentUser = safeStorage.getItem('currentUser');
    if (currentUser) {
        try {
            const user = JSON.parse(currentUser);
            if (user.email) return user.email;
        } catch (e) {
            console.error('Error parsing currentUser:', e);
        }
    }
    
    return null;
}

// Refresh user data from backend after subscription upgrade
async function refreshUserData() {
    try {
        const token = getAuthToken();
        if (!token) {
            console.warn('No auth token found, cannot refresh user data');
            return;
        }
        
        // Fetch updated user profile
        const response = await fetch('/api/v1/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const userData = await response.json();
            // Update localStorage with fresh user data
            if (userData.data && userData.data.user) {
                const user = userData.data.user;
                safeStorage.setItem('user_data', JSON.stringify(user));
                
                // Update unified auth if available
                if (window.unifiedAuth && window.unifiedAuth.updateUserData) {
                    window.unifiedAuth.updateUserData(user);
                }
                
                // Update profile display
                if (window.unifiedAuth && window.unifiedAuth.updateUserProfileDisplay) {
                    window.unifiedAuth.updateUserProfileDisplay();
                }
                
                // Trigger custom event for other components to refresh
                window.dispatchEvent(new CustomEvent('userDataUpdated', { detail: user }));
            }
        } else {
            console.warn('Failed to refresh user data:', response.status);
        }
    } catch (error) {
        console.error('Error refreshing user data:', error);
    }
}

// ============================================================================
// REPORT TYPE SELECTION
// ============================================================================

function setupReportTypeSelection() {
    const reportCards = document.querySelectorAll('.report-type-card');
    const purchaseBtn = document.getElementById('purchaseReportBtn');
    
    reportCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            reportCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update purchase button
            const reportType = this.dataset.type;
            const price = this.querySelector('.select-report-btn').dataset.price;
            
            if (reportType === 'enhanced') {
                purchaseBtn.textContent = ` Purchase Enhanced Report - $${(price / 100).toLocaleString()}`;
            } else {
                purchaseBtn.textContent = ` Purchase Report - $${(price / 100).toLocaleString()}`;
            }
            
            console.log(`Selected ${reportType} report ($${price})`);
        });
    });
}

// ============================================================================
// RETRY FAILED PAYMENT MARKINGS
// ============================================================================

async function retryFailedPaymentMarkings() {
    const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
    
    try {
        const failedPaymentsStr = safeStorage.getItem('failed_payment_intents');
        if (!failedPaymentsStr) {
            return; // No failed payments to retry
        }
        
        const failedPayments = JSON.parse(failedPaymentsStr);
        if (!Array.isArray(failedPayments) || failedPayments.length === 0) {
            return; // Empty or invalid array
        }
        
        console.log(` Retrying ${failedPayments.length} failed payment markings...`);
        
        const token = getAuthToken();
        const remainingPayments = [];
        
        for (const payment of failedPayments) {
            // Skip if retry count is too high (max 5 retries)
            if (payment.retry_count >= 5) {
                console.warn(` Skipping payment intent ${payment.payment_intent_id} - max retries reached`);
                continue;
            }
            
            // Skip if too old (older than 7 days)
            const paymentDate = new Date(payment.timestamp);
            const daysSince = (Date.now() - paymentDate.getTime()) / (1000 * 60 * 60 * 24);
            if (daysSince > 7) {
                console.warn(` Skipping payment intent ${payment.payment_intent_id} - too old (${daysSince.toFixed(1)} days)`);
                continue;
            }
            
            try {
                // Try payment-by-intent endpoint first
                const paymentByIntentResponse = await fetch(`/api/v1/fmv-reports/payment-by-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        payment_intent_id: payment.payment_intent_id,
                        amount: payment.amount
                    })
                });
                
                if (paymentByIntentResponse.ok) {
                    const paymentResult = await paymentByIntentResponse.json();
                    console.log(` Successfully marked payment ${payment.payment_intent_id} as paid (retry ${payment.retry_count + 1})`);
                    console.log('   Report ID:', paymentResult.id);
                    // Don't add to remaining - payment was successfully marked
                    continue;
                } else {
                    // If payment-by-intent fails, try report ID endpoint if we have a report ID
                    if (payment.report_id) {
                        const paymentResponse = await fetch(`/api/v1/fmv-reports/${payment.report_id}/payment`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify({
                                payment_intent_id: payment.payment_intent_id,
                                amount: payment.amount
                            })
                        });
                        
                        if (paymentResponse.ok) {
                            const paymentResult = await paymentResponse.json();
                            console.log(` Successfully marked payment ${payment.payment_intent_id} as paid via report ID (retry ${payment.retry_count + 1})`);
                            console.log('   Report ID:', paymentResult.id);
                            // Don't add to remaining - payment was successfully marked
                            continue;
                        }
                    }
                    
                    // Both endpoints failed - increment retry count and keep for next retry
                    payment.retry_count = (payment.retry_count || 0) + 1;
                    remainingPayments.push(payment);
                    console.warn(` Failed to mark payment ${payment.payment_intent_id} (retry ${payment.retry_count})`);
                }
            } catch (err) {
                console.error(` Error retrying payment ${payment.payment_intent_id}:`, err);
                // Increment retry count and keep for next retry
                payment.retry_count = (payment.retry_count || 0) + 1;
                remainingPayments.push(payment);
            }
            
            // Add small delay between retries to avoid overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // Update localStorage with remaining failed payments
        if (remainingPayments.length > 0) {
            safeStorage.setItem('failed_payment_intents', JSON.stringify(remainingPayments));
            console.log(` ${remainingPayments.length} payment(s) still need retry`);
        } else {
            safeStorage.removeItem('failed_payment_intents');
            console.log(' All failed payments have been successfully marked as paid');
        }
    } catch (err) {
        console.error(' Error in retryFailedPaymentMarkings:', err);
    }
}

// ============================================================================
// INITIALIZE ON PAGE LOAD
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log(' Report Generation Page - Initializing...');
    
    // Setup manufacturer change listener
    const manufacturerSelect = document.getElementById('manufacturer');
    if (manufacturerSelect) {
        manufacturerSelect.addEventListener('change', function() {
            const manufacturer = this.value;
            updateModelOptions(manufacturer);
        });
    }
    
    // Setup model change listener
    const modelSelect = document.getElementById('model');
    if (modelSelect) {
        modelSelect.addEventListener('change', function() {
            const manufacturer = document.getElementById('manufacturer').value;
            const model = this.value;
            autofillCraneSpecs(manufacturer, model);
        });
    }
    
    // Setup report type selection
    setupReportTypeSelection();
    
    // Setup button listeners
    const loadSampleBtn = document.getElementById('loadSampleBtn');
    if (loadSampleBtn) {
        loadSampleBtn.addEventListener('click', loadSampleData);
    }
    
    const clearFormBtn = document.getElementById('clearFormBtn');
    if (clearFormBtn) {
        clearFormBtn.addEventListener('click', clearForm);
    }
    
    const purchaseBtn = document.getElementById('purchaseReportBtn');
    if (purchaseBtn) {
        // Initially disable the button until report type is selected
        purchaseBtn.disabled = true;
        purchaseBtn.style.opacity = '0.5';
        purchaseBtn.style.cursor = 'not-allowed';
        
        purchaseBtn.addEventListener('click', purchaseReport);
    }
    
    // Load draft if continuing from dashboard
    loadDraftIfExists();
    
    // Setup auto-save for drafts
    setupAutoSaveDraft();
    
});

// ============================================================================
// DRAFT SAVING FUNCTIONALITY
// ============================================================================

async function loadDraftIfExists() {
    // Ensure safeStorage is available
    const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
    
    const continueDraftId = safeStorage.getItem('continue_draft');
    const continueDraftData = safeStorage.getItem('continue_draft_data');
    // CRITICAL: Load stored draft report ID to prevent duplicate creation
    const storedDraftReportId = safeStorage.getItem('current_draft_report_id');
    
    if (storedDraftReportId) {
        window.currentDraftReportId = storedDraftReportId;
    }
    
    if (continueDraftId) {
        
        let report = null;
        
        // First, try to use stored report data
        if (continueDraftData) {
            try {
                report = JSON.parse(continueDraftData);
            } catch (e) {
                console.error('Error parsing stored report data:', e);
            }
        }
        
        // If no stored data, try localStorage drafts
        if (!report) {
            try {
                const drafts = JSON.parse(safeStorage.getItem('fmv_draft_reports') || '[]');
                report = drafts.find(d => {
                    const dId = d.id ? String(d.id) : '';
                    return dId === String(continueDraftId);
                });
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        
        // If still no report, try fetching from API
        if (!report && !String(continueDraftId).startsWith('draft_')) {
            try {
                const token = safeStorage.getItem('access_token') || safeStorage.getItem('token');
                if (token) {
                    const response = await fetch(`https://craneintelligence.tech/api/v1/fmv-reports/${continueDraftId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            report = result.data;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching report from API:', error);
            }
        }
        
        if (report) {
            // Get crane data (handle both crane_data and crane_details)
            const craneData = report.crane_data || report.crane_details || {};
            
            
            // Wait for form elements to be available
            const waitForElement = (id, callback, maxAttempts = 20) => {
                let attempts = 0;
                const checkElement = () => {
                    const element = document.getElementById(id);
                    if (element) {
                        callback(element);
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkElement, 100);
                    }
                };
                checkElement();
            };
            
            // Pre-fill manufacturer
            waitForElement('manufacturer', (el) => {
                if (craneData.manufacturer) {
                    el.value = craneData.manufacturer;
                    // Trigger change event to update model options
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            // Pre-fill model (after manufacturer is set)
            waitForElement('model', (el) => {
                if (craneData.model) {
                    // Wait a bit for model options to load
                    setTimeout(() => {
                        el.value = craneData.model;
                        el.dispatchEvent(new Event('input', { bubbles: true }));
                    }, 300);
                }
            });
            
            // Pre-fill other fields
            waitForElement('year', (el) => {
                if (craneData.year) el.value = craneData.year;
            });
            
            waitForElement('capacity', (el) => {
                if (craneData.capacity) el.value = craneData.capacity;
            });
            
            // Pre-fill crane type (field ID is 'craneType', not 'crane_type')
            waitForElement('craneType', (el) => {
                if (craneData.crane_type || craneData.craneType) {
                    const craneTypeValue = craneData.crane_type || craneData.craneType;
                    el.value = craneTypeValue;
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            waitForElement('region', (el) => {
                if (craneData.region) {
                    el.value = craneData.region;
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            waitForElement('operatingHours', (el) => {
                if (craneData.operating_hours || craneData.operatingHours) {
                    const hours = craneData.operating_hours || craneData.operatingHours;
                    el.value = hours;
                }
            });
            
            waitForElement('mileage', (el) => {
                if (craneData.mileage !== undefined && craneData.mileage !== null && craneData.mileage !== '') {
                    el.value = craneData.mileage;
                }
            });
            
            waitForElement('boomLength', (el) => {
                if (craneData.boom_length || craneData.boomLength) {
                    const boomLength = craneData.boom_length || craneData.boomLength;
                    el.value = boomLength;
                }
            });
            
            // Note: jibLength, maxHookHeight, maxRadius, condition, additionalSpecs, specialFeatures, usageHistory
            // only exist in the fallback/manual entry form, not in the main form
            // They will be prefilled when the manual entry form is opened (see below)
            
            // Check if this is a manual entry report OR if it has manual entry fields
            const isManualEntry = craneData.is_manual_entry || report.is_manual_entry || false;
            const hasManualEntryFields = !!(craneData.serial_number || craneData.serialNumber || 
                                           craneData.jib_length || craneData.jibLength ||
                                           craneData.max_hook_height || craneData.maxHookHeight ||
                                           craneData.max_radius || craneData.maxRadius ||
                                           craneData.additional_specs || craneData.additionalSpecs ||
                                           craneData.special_features || craneData.specialFeatures ||
                                           craneData.usage_history || craneData.usageHistory);
            
            // If it has manual entry fields or is marked as manual entry, open the manual entry form
            if (isManualEntry || hasManualEntryFields) {
                if (isManualEntry) {
                
                // Store manual entry data for use in purchase flow
                window.manualEntryData = craneData;
                
                // Open the manual entry form
                setTimeout(() => {
                    const toggleBtn = document.getElementById('toggleFallbackFormBtn');
                    const fallbackFormSection = document.getElementById('fallbackFormSection');
                    if (toggleBtn && fallbackFormSection) {
                        // Check if form is already open
                        if (fallbackFormSection.style.display === 'none' || !fallbackFormSection.style.display) {
                            // Open the form
                            fallbackFormSection.style.display = 'block';
                            toggleBtn.textContent = 'Hide Details';
                            // Make Equipment Information fields optional
                            const equipmentFields = ['craneType', 'manufacturer', 'model', 'year', 'capacity', 'operatingHours', 'region'];
                            equipmentFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    field.removeAttribute('required');
                                }
                            });
                        }
                    }
                }, 800);
                
                // Pre-fill all manual entry fields
                waitForElement('fallbackManufacturer', (el) => {
                    if (craneData.manufacturer) el.value = craneData.manufacturer;
                });
                
                waitForElement('fallbackModel', (el) => {
                    if (craneData.model) el.value = craneData.model;
                });
                
                waitForElement('fallbackYear', (el) => {
                    if (craneData.year) el.value = craneData.year;
                });
                
                waitForElement('fallbackSerialNumber', (el) => {
                    if (craneData.serial_number || craneData.serialNumber) {
                        el.value = craneData.serial_number || craneData.serialNumber;
                    }
                });
                
                waitForElement('fallbackCapacity', (el) => {
                    if (craneData.capacity) el.value = craneData.capacity;
                });
                
                waitForElement('fallbackCraneType', (el) => {
                    if (craneData.crane_type || craneData.craneType) {
                        el.value = craneData.crane_type || craneData.craneType;
                    }
                });
                
                waitForElement('fallbackOperatingHours', (el) => {
                    if (craneData.operating_hours || craneData.operatingHours) {
                        el.value = craneData.operating_hours || craneData.operatingHours;
                    }
                });
                
                waitForElement('fallbackMileage', (el) => {
                    if (craneData.mileage) el.value = craneData.mileage;
                });
                
                waitForElement('fallbackBoomLength', (el) => {
                    if (craneData.boom_length || craneData.boomLength) {
                        el.value = craneData.boom_length || craneData.boomLength;
                    }
                });
                
                waitForElement('fallbackJibLength', (el) => {
                    if (craneData.jib_length || craneData.jibLength) {
                        el.value = craneData.jib_length || craneData.jibLength;
                    }
                });
                
                waitForElement('fallbackMaxHookHeight', (el) => {
                    if (craneData.max_hook_height || craneData.maxHookHeight) {
                        el.value = craneData.max_hook_height || craneData.maxHookHeight;
                    }
                });
                
                waitForElement('fallbackMaxRadius', (el) => {
                    if (craneData.max_radius || craneData.maxRadius) {
                        el.value = craneData.max_radius || craneData.maxRadius;
                    }
                });
                
                waitForElement('fallbackRegion', (el) => {
                    if (craneData.region) el.value = craneData.region;
                });
                
                waitForElement('fallbackCondition', (el) => {
                    if (craneData.condition) el.value = craneData.condition;
                });
                
                waitForElement('fallbackAdditionalSpecs', (el) => {
                    if (craneData.additional_specs || craneData.additionalSpecs) {
                        el.value = craneData.additional_specs || craneData.additionalSpecs;
                    }
                });
                
                waitForElement('fallbackSpecialFeatures', (el) => {
                    if (craneData.special_features || craneData.specialFeatures) {
                        el.value = craneData.special_features || craneData.specialFeatures;
                    }
                });
                
                waitForElement('fallbackUsageHistory', (el) => {
                    if (craneData.usage_history || craneData.usageHistory) {
                        el.value = craneData.usage_history || craneData.usageHistory;
                    }
                });
                
                // Restore service record files
                if (report.service_record_files && report.service_record_files.length > 0) {
                    console.log(' Restoring service record files:', report.service_record_files);
                    // Store URLs for use in purchase flow
                    window.manualEntryServiceRecordUrls = Array.isArray(report.service_record_files) 
                        ? report.service_record_files 
                        : [report.service_record_files];
                    
                    // Display the files in the file list (even though we can't restore File objects)
                    setTimeout(() => {
                        const fileList = document.getElementById('fileList');
                        const fileListItems = document.getElementById('fileListItems');
                        if (fileList && fileListItems) {
                            fileList.style.display = 'block';
                            fileListItems.innerHTML = '';
                            
                            window.manualEntryServiceRecordUrls.forEach((fileUrl, index) => {
                                const fileName = typeof fileUrl === 'string' ? fileUrl.split('/').pop() : `Document ${index + 1}`;
                                const fileItem = document.createElement('div');
                                fileItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #2A2A2A; border-radius: 6px; margin-bottom: 8px;';
                                
                                const fileInfo = document.createElement('div');
                                fileInfo.style.cssText = 'display: flex; align-items: center; gap: 12px; flex: 1;';
                                
                                const fileIcon = document.createElement('span');
                                fileIcon.style.cssText = 'font-size: 24px;';
                                fileIcon.textContent = fileUrl.includes('.pdf') ? '' : '';
                                
                                const fileNameSpan = document.createElement('span');
                                fileNameSpan.style.cssText = 'color: #B0B0B0; font-size: 14px;';
                                fileNameSpan.textContent = fileName;
                                
                                const fileLink = document.createElement('a');
                                fileLink.href = fileUrl;
                                fileLink.target = '_blank';
                                fileLink.style.cssText = 'color: #00FF88; text-decoration: none; font-size: 12px; margin-left: 12px;';
                                fileLink.textContent = 'View';
                                
                                fileInfo.appendChild(fileIcon);
                                fileInfo.appendChild(fileNameSpan);
                                fileInfo.appendChild(fileLink);
                                
                                fileItem.appendChild(fileInfo);
                                fileListItems.appendChild(fileItem);
                            });
                            
                        }
                    }, 1000);
                }
                }
            }
            
            // Pre-select report type
            if (report.report_type) {
                setTimeout(() => {
                    // Try different selectors for report type cards
                    const reportType = report.report_type;
                    let reportCard = document.querySelector(`.report-type-card[data-type="${reportType}"]`) ||
                                   document.querySelector(`[data-type="${reportType}"]`) ||
                                   document.querySelector(`[data-report-type="${reportType}"]`);
                    
                    if (reportCard) {
                        // Click the select button inside the card
                        const selectBtn = reportCard.querySelector('.select-report-btn');
                        if (selectBtn) {
                            selectBtn.click();
                        } else {
                            // Fallback: click the card itself
                            reportCard.click();
                        }
                    } else {
                        console.warn(' Report type card not found for:', reportType);
                    }
                }, 500);
            }
            
            // Set current draft report ID to prevent duplicate submissions
            if (report.id) {
                window.currentDraftReportId = String(report.id);
            }
            
            console.log(' Draft loaded and form pre-filled successfully');
            showNotification('Draft loaded! Continue where you left off.', 'success');
        } else {
            console.warn(' Report not found for ID:', continueDraftId);
        }
        
        // Clear the continue flags
        safeStorage.removeItem('continue_draft');
        safeStorage.removeItem('continue_draft_data');
    }
}

function setupAutoSaveDraft() {
    // Auto-save draft every 30 seconds
    let autoSaveInterval = setInterval(saveDraft, 30000);
    
    // Save draft when user leaves the page
    window.addEventListener('beforeunload', function() {
        saveDraft();
        clearInterval(autoSaveInterval);
    });
    
}

function saveDraft() {
    // Ensure safeStorage is available
    const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
    
    try {
        // Get form data
        const manufacturer = document.getElementById('manufacturer')?.value;
        const model = document.getElementById('model')?.value;
        
        // Only save if at least manufacturer and model are filled
        if (!manufacturer || !model) {
            return;
        }
        
        const craneData = {
            manufacturer: manufacturer,
            model: model,
            year: document.getElementById('year')?.value || '',
            capacity: document.getElementById('capacity')?.value || '',
            region: document.getElementById('region')?.value || '',
            crane_type: document.getElementById('crane_type')?.value || '',
            operating_hours: document.getElementById('operating_hours')?.value || '',
            mileage: document.getElementById('mileage')?.value || '',
            boom_length: document.getElementById('boom_length')?.value || '',
            jib_included: document.getElementById('jib_included')?.value || '',
            jib_length: document.getElementById('jib_length')?.value || '',
            asking_price: document.getElementById('asking_price')?.value || ''
        };
        
        // Get selected report type
        const selectedCard = document.querySelector('.ci-report-card.selected');
        const reportType = selectedCard?.getAttribute('data-report-type') || 'standard';
        
        // Create draft object
        const draft = {
            id: 'draft_' + Date.now(),
            report_type: reportType,
            crane_data: craneData,
            saved_at: new Date().toISOString(),
            status: 'draft'
        };
        
        // Load existing drafts
        let drafts = JSON.parse(safeStorage.getItem('fmv_draft_reports') || '[]');
        
        // Check if a similar draft already exists (same manufacturer and model)
        const existingIndex = drafts.findIndex(d => 
            d.crane_data.manufacturer === manufacturer && 
            d.crane_data.model === model &&
            d.status === 'draft'
        );
        
        if (existingIndex >= 0) {
            // Update existing draft
            drafts[existingIndex] = { ...drafts[existingIndex], ...draft, id: drafts[existingIndex].id };
        } else {
            // Add new draft
            drafts.push(draft);
        }
        
        // Keep only last 10 drafts
        if (drafts.length > 10) {
            drafts = drafts.slice(-10);
        }
        
        // Save to localStorage
        safeStorage.setItem('fmv_draft_reports', JSON.stringify(drafts));
    } catch (error) {
        console.error('Error saving draft:', error);
    }
}

function showNotification(message, type = 'info') {
    // Simple notification function
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#00FF88' : '#1A1A1A'};
        color: ${type === 'success' ? '#000' : '#FFF'};
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-family: Inter, sans-serif;
        font-size: 14px;
        font-weight: 500;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transition = 'opacity 0.3s';
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

    

// ========== FMV REPORT STRIPE PAYMENT SYSTEM ==========
let stripe = null;
let elements = null;
let paymentElement = null;
let selectedReport = null;

async function initializeStripe() {
    try {
        // Wait for Stripe.js to load
        if (typeof Stripe === 'undefined') {
            console.log(' Waiting for Stripe.js to load...');
            await new Promise(resolve => {
                const checkStripe = setInterval(() => {
                    if (typeof Stripe !== 'undefined') {
                        clearInterval(checkStripe);
                        resolve();
                    }
                }, 100);
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(checkStripe);
                    resolve();
                }, 10000);
            });
        }
        
        if (typeof Stripe === 'undefined') {
            throw new Error('Stripe.js library failed to load');
        }
        
        const response = await fetch('/api/v1/config/public');
        if (!response.ok) {
            throw new Error(`Failed to fetch config: ${response.status} ${response.statusText}`);
        }
        
        const config = await response.json();
        if (config.stripe_publishable_key) {
            stripe = Stripe(config.stripe_publishable_key);
            window.stripe = stripe; // Make stripe globally accessible
            return true;
        } else {
            console.error(' No Stripe publishable key found in config');
            return false;
        }
    } catch (error) {
        console.error(' Stripe initialization failed:', error);
        return false;
    }
}

// Ensure these are globally available
window.closeStripeModal = window.closeStripeModal || function() {
    const modal = document.getElementById('stripePaymentModal');
    if (modal) {
        modal.style.display = 'none';
    }
    // Clean up payment element
    if (typeof paymentElement !== 'undefined' && paymentElement) {
        paymentElement.unmount();
        paymentElement = null;
    }
    if (typeof elements !== 'undefined') {
        elements = null;
    }
};

// Ensure window functions are defined (only if not already defined)
if (typeof window.closeSuccessModal === 'undefined') {
    window.closeSuccessModal = function() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'none';
        }
    };
}

// Alias for backward compatibility - directly manipulate DOM to avoid recursion
function closeStripeModal() {
    const modal = document.getElementById('stripePaymentModal');
    if (modal) {
        // Use setProperty with !important to override inline !important styles
        modal.style.setProperty('display', 'none', 'important');
        modal.style.setProperty('visibility', 'hidden', 'important');
        modal.setAttribute('data-force-hidden', 'true');
    }
    // Clean up payment element
    if (typeof paymentElement !== 'undefined' && paymentElement) {
        try {
            paymentElement.unmount();
        } catch(e) {
            console.warn('Error unmounting payment element:', e);
        }
        paymentElement = null;
    }
    if (typeof elements !== 'undefined') {
        elements = null;
    }
}

function closeSuccessModal() {
    // Directly manipulate DOM - do NOT call window.closeSuccessModal to avoid recursion
    const modal = document.getElementById('successModal');
    if (modal) {
        // Use setProperty with !important to override inline !important styles
        modal.style.setProperty('display', 'none', 'important');
        modal.style.setProperty('visibility', 'hidden', 'important');
        modal.setAttribute('data-force-hidden', 'true');
    }
}

function showPaymentSuccessModal(details) {
    // Close payment modal
    closeStripeModal();
    
    // Format currency
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount / 100);
    };
    
    // Format date
    const formatDate = (date) => {
        return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }).format(date);
    };
    
    // Populate success modal
    document.getElementById('success-transaction-id').textContent = details.transactionId || 'N/A';
    document.getElementById('success-payment-intent').textContent = details.paymentIntentId || 'N/A';
    document.getElementById('success-report-type').textContent = details.reportType || 'N/A';
    document.getElementById('success-crane-model').textContent = details.craneModel || 'N/A';
    document.getElementById('success-payment-date').textContent = formatDate(new Date());
    document.getElementById('success-amount').textContent = formatCurrency(details.amount);
    
    // Show success modal - use setProperty with !important to override inline !important styles
    const successModal = document.getElementById('successModal');
    if (successModal) {
        // Remove force-hidden attribute first
        successModal.removeAttribute('data-force-hidden');
        // Use setProperty with !important to override inline !important styles
        successModal.style.setProperty('display', 'flex', 'important');
        successModal.style.setProperty('visibility', 'visible', 'important');
        successModal.style.setProperty('z-index', '10001', 'important');
        console.log(' Success modal displayed');
    } else {
        console.error(' Success modal element not found');
    }
}

// Note: purchaseReport function is defined below as window.purchaseReport
// This local function is removed to avoid conflicts

// Main purchaseReport function to open Stripe modal
// This replaces the placeholder function defined earlier
window.purchaseReport = async function() {
    // Prevent multiple simultaneous calls
    if (window._purchaseReportInProgress) {
        console.log(' Purchase report already in progress, ignoring duplicate call');
        return;
    }
    window._purchaseReportInProgress = true;
    
    // Ensure safeStorage is available
    const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
    
    try {
    // Check if report type is selected first
    const selectedReportCard = document.querySelector('.report-type-card.selected');
    // Check both DOM element and window variable for reliability
    const hasSelectedReportType = selectedReportCard !== null && 
                                   (window.selectedReportType && window.selectedReportType !== '');
    
    if (!hasSelectedReportType) {
        console.warn(' Report type not selected:', {
            hasCard: selectedReportCard !== null,
            windowType: window.selectedReportType,
            cardType: selectedReportCard?.dataset?.type
        });
        
        showNotification('error', 'Report Type Required', 'Please select a report type before purchasing.');
        window._purchaseReportInProgress = false;
        return;
    }
    
    // Ensure we have the report type from either source
    const reportType = window.selectedReportType || selectedReportCard?.dataset?.type || '';
    if (!reportType) {
        console.error(' Could not determine report type');
        if (window.notificationSystem) {
            window.notificationSystem.showError('Error', 'Could not determine report type. Please refresh and try again.');
        }
        window._purchaseReportInProgress = false;
        return;
    }
    
    // Check if we should bypass subscription check (when user clicks "Continue with Payment" from paywall)
    const bypassCheck = window.bypassSubscriptionCheck === true;
    if (bypassCheck) {
        window.bypassSubscriptionCheck = false; // Reset flag
        console.log(' Bypassing subscription check - proceeding with payment');
    }
    
    // Check if manual entry was used (draft report exists from saveManualEntry)
    const isManualEntry = window.currentDraftReportId && window.manualEntryData;
    
    // Check if bulk processing mode is active
    const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
    const isBulkMode = bulkForm && bulkForm.style.display !== 'none' && window.bulkProcessingData;
    
    // Validate required fields - skip if manual entry or bulk processing was used
    let manufacturer, model, year, capacity, operatingHours, region;
    
    if (isBulkMode) {
        // Bulk processing mode - skip form validation, use bulk data
        // Set dummy values for compatibility (won't be used in bulk mode)
        manufacturer = 'Bulk Processing';
        model = 'Multiple';
        year = new Date().getFullYear();
        capacity = 0;
        operatingHours = 0;
        region = 'North America';
    } else if (!isManualEntry) {
        // Regular form validation - Equipment Information fields are required
        manufacturer = document.getElementById('manufacturer').value;
        model = document.getElementById('model').value;
        year = document.getElementById('year').value;
        capacity = document.getElementById('capacity').value;
        operatingHours = document.getElementById('operatingHours').value;
        region = document.getElementById('region').value;
        
        if (!manufacturer || manufacturer === 'Select Manufacturer') {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please select a manufacturer');
            }
            window._purchaseReportInProgress = false;
            return;
        }
        if (!model || model === 'Select Model') {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please select a model');
            }
            window._purchaseReportInProgress = false;
            return;
        }
        if (!year) {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please enter the year');
            }
            window._purchaseReportInProgress = false;
            return;
        }
        if (!capacity) {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please enter the capacity');
            }
            window._purchaseReportInProgress = false;
            return;
        }
        if (!operatingHours) {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please enter operating hours');
            }
            window._purchaseReportInProgress = false;
            return;
        }
        if (!region || region === 'Select Region') {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please select a region');
            }
            window._purchaseReportInProgress = false;
            return;
        }
    } else {
        // Manual entry was used - get data from manual entry
        const manualData = window.manualEntryData;
        manufacturer = manualData.manufacturer;
        model = manualData.model;
        year = manualData.year;
        capacity = manualData.capacity;
        operatingHours = manualData.operatingHours;
        region = manualData.region;
    }
    
    // Check if user has selected a report type (subscription tier) in the form
    // hasSelectedReportType already declared above in validation, reuse it
    // Use the reportType we determined earlier
    
    // If user has selected a report type, skip subscription check and go directly to payment
    if (hasSelectedReportType && !bypassCheck) {
        console.log(' User has selected report type - showing blurred results and payment modal directly');
        
        // Show blurred results section above footer FIRST
        const resultsSection = document.getElementById('valuationResultsSection');
        if (resultsSection) {
            let craneData;
            if (isBulkMode && window.bulkProcessingData) {
                // For bulk processing, create a summary crane data object
                craneData = {
                    is_bulk_processing: true,
                    totalCranes: window.bulkProcessingData.totalCranes,
                    successCount: window.bulkProcessingData.successCount,
                    errorCount: window.bulkProcessingData.errorCount,
                    manufacturer: 'Multiple',
                    model: 'Bulk Processing',
                    year: new Date().getFullYear(),
                    capacity: 0,
                    operatingHours: 0,
                    region: 'North America'
                };
            } else {
                craneData = {
                    manufacturer: manufacturer,
                    model: model,
                    year: parseInt(year),
                    capacity: parseFloat(capacity),
                    operatingHours: parseInt(operatingHours),
                    region: region,
                    craneType: document.getElementById('craneType')?.value || ''
                };
            }
            
            window.lastPaymentCraneData = craneData;
            
            resultsSection.style.display = 'block';
            resultsSection.style.visibility = 'visible';
            resultsSection.style.filter = 'blur(10px)';
            resultsSection.style.pointerEvents = 'none';
            
            if (typeof populateResultsPreview === 'function') {
                populateResultsPreview(craneData);
            }
            
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        // CRITICAL: Create DRAFT report IMMEDIATELY when Purchase button is clicked
        // This ensures the report exists in the database even if payment is not completed
        const token = safeStorage.getItem('access_token') || safeStorage.getItem('crane_auth_token') || safeStorage.getItem('auth_token');
        
        // Get user email from multiple sources to ensure we have it
        let userEmail = null;
        // Try to get from unified auth
        if (window.unifiedAuth && window.unifiedAuth.user && window.unifiedAuth.user.email) {
            userEmail = window.unifiedAuth.user.email;
        }
        // Try to get from user_data
        if (!userEmail) {
            const userData = safeStorage.getItem('user_data');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.email) userEmail = user.email;
                } catch (e) {
                    console.warn('Error parsing user_data:', e);
                }
            }
        }
        // Try to get from receipt email input
        if (!userEmail) {
            const receiptEmailInput = document.getElementById('receiptEmail');
            if (receiptEmailInput && receiptEmailInput.value) {
                userEmail = receiptEmailInput.value;
            }
        }
        // Try getUserEmail helper function
        if (!userEmail && typeof getUserEmail === 'function') {
            userEmail = getUserEmail();
        }
        
        console.log(' User email for DRAFT report:', userEmail, 'Token exists:', !!token);
        
        // Get crane details - use bulk processing data if available, then manual entry, otherwise use form fields
        let craneDetails;
        if (isBulkMode && window.bulkProcessingData) {
            // Bulk processing mode - use bulk data
            craneDetails = {
                is_bulk_entry: true,
                bulk_records: window.bulkProcessingData.records,
                bulk_pricing: window.bulkProcessingData.pricing,
                unit_count: window.bulkProcessingData.totalCranes,
                fleet_pricing_tier: window.bulkProcessingData.pricing.tier,
                success_count: window.bulkProcessingData.successCount,
                error_count: window.bulkProcessingData.errorCount
            };
        } else if (window.manualEntryData && isManualEntry) {
            // Use manual entry data
            craneDetails = {
                manufacturer: window.manualEntryData.manufacturer || manufacturer,
                model: window.manualEntryData.model || model,
                year: window.manualEntryData.year || parseInt(year),
                capacity: window.manualEntryData.capacity || parseFloat(capacity),
                operatingHours: window.manualEntryData.operating_hours || window.manualEntryData.operatingHours || parseInt(operatingHours),
                region: window.manualEntryData.region || region,
                craneType: window.manualEntryData.crane_type || window.manualEntryData.craneType || document.getElementById('craneType')?.value || '',
                serial_number: window.manualEntryData.serial_number || window.manualEntryData.serialNumber || null,
                mileage: window.manualEntryData.mileage || null,
                boomLength: window.manualEntryData.boom_length || window.manualEntryData.boomLength || null,
                boom_length: window.manualEntryData.boom_length || window.manualEntryData.boomLength || null,
                jibLength: window.manualEntryData.jib_length || window.manualEntryData.jibLength || null,
                jib_length: window.manualEntryData.jib_length || window.manualEntryData.jibLength || null,
                maxHookHeight: window.manualEntryData.max_hook_height || window.manualEntryData.maxHookHeight || null,
                max_hook_height: window.manualEntryData.max_hook_height || window.manualEntryData.maxHookHeight || null,
                maxRadius: window.manualEntryData.max_radius || window.manualEntryData.maxRadius || null,
                max_radius: window.manualEntryData.max_radius || window.manualEntryData.maxRadius || null,
                condition: window.manualEntryData.condition || null,
                additionalSpecs: window.manualEntryData.additional_specs || window.manualEntryData.additionalSpecs || null,
                additional_specs: window.manualEntryData.additional_specs || window.manualEntryData.additionalSpecs || null,
                specialFeatures: window.manualEntryData.special_features || window.manualEntryData.specialFeatures || null,
                special_features: window.manualEntryData.special_features || window.manualEntryData.specialFeatures || null,
                usageHistory: window.manualEntryData.usage_history || window.manualEntryData.usageHistory || null,
                usage_history: window.manualEntryData.usage_history || window.manualEntryData.usageHistory || null,
                is_manual_entry: true
            };
        } else {
            // Use regular form fields
            craneDetails = {
                manufacturer: manufacturer,
                model: model,
                year: parseInt(year),
                capacity: parseFloat(capacity),
                operatingHours: parseInt(operatingHours),
                region: region,
                craneType: document.getElementById('craneType')?.value || ''
            };
        }
        
        // Get selected report type
        const selectedReportType = selectedReportCard.dataset.type || 'professional';
        const selectedReportPrice = parseInt(selectedReportCard.querySelector('.select-report-btn')?.dataset.price || '49500');
        
        // Get service record files - prioritize restored URLs from manual entry
        let serviceRecordFileUrls = [];
        if (window.manualEntryServiceRecordUrls && window.manualEntryServiceRecordUrls.length > 0) {
            // Use restored service record URLs from manual entry (when continuing from draft)
            serviceRecordFileUrls = window.manualEntryServiceRecordUrls.filter(url => url && url.trim() !== '');
        } else if (window.serviceRecordFiles && window.serviceRecordFiles.length > 0) {
            // New files uploaded - upload them now if not already uploaded
            try {
                const formData = new FormData();
                window.serviceRecordFiles.forEach((file) => {
                    formData.append('files', file);
                });
                
                const token = safeStorage.getItem('access_token') || safeStorage.getItem('crane_auth_token') || safeStorage.getItem('auth_token');
                const uploadResponse = await fetch('/api/v1/fmv-reports/upload-service-records', {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    serviceRecordFileUrls = uploadResult.files || [];
                    // Store for later use
                    window.manualEntryServiceRecordUrls = serviceRecordFileUrls;
                } else {
                    console.warn(' File upload failed, continuing without files');
                }
            } catch (uploadError) {
                console.error(' Error uploading service record files:', uploadError);
                // Continue without files
            }
        }
        
        // Create DRAFT report data - CRITICAL: Always include user_email in metadata
        const reportData = {
            report_type: selectedReportType,
            crane_details: isBulkMode && window.bulkProcessingData ? {
                // Bulk processing data - must include required CraneDetails fields
                manufacturer: 'Bulk Processing',
                model: 'Multiple Units',
                year: new Date().getFullYear(),
                // Include bulk processing data as extra fields
                is_bulk_entry: true,
                is_bulk_processing: true,
                bulk_records: window.bulkProcessingData.records,
                bulk_pricing: window.bulkProcessingData.pricing,
                unit_count: window.bulkProcessingData.totalCranes,
                fleet_pricing_tier: window.bulkProcessingData.pricing.tier,
                success_count: window.bulkProcessingData.successCount,
                error_count: window.bulkProcessingData.errorCount,
                total_cranes: window.bulkProcessingData.totalCranes,
                pricing_tier: window.bulkProcessingData.pricing.tier,
                total_price: window.bulkProcessingData.pricing.total
            } : isManualEntry && window.manualEntryData ? {
                // Include all manual entry fields when continuing from draft
                manufacturer: craneDetails.manufacturer,
                model: craneDetails.model,
                year: craneDetails.year,
                capacity: craneDetails.capacity,
                operatingHours: craneDetails.operatingHours || 0,
                region: craneDetails.region,
                craneType: craneDetails.craneType || '',
                serial_number: craneDetails.serial_number || null,
                serialNumber: craneDetails.serial_number || null,
                mileage: craneDetails.mileage || null,
                boomLength: craneDetails.boomLength || null,
                boom_length: craneDetails.boom_length || null,
                jibLength: craneDetails.jibLength || null,
                jib_length: craneDetails.jib_length || null,
                maxHookHeight: craneDetails.maxHookHeight || null,
                max_hook_height: craneDetails.max_hook_height || null,
                maxRadius: craneDetails.maxRadius || null,
                max_radius: craneDetails.max_radius || null,
                condition: craneDetails.condition || null,
                additionalSpecs: craneDetails.additionalSpecs || null,
                additional_specs: craneDetails.additional_specs || null,
                specialFeatures: craneDetails.specialFeatures || null,
                special_features: craneDetails.special_features || null,
                usageHistory: craneDetails.usageHistory || null,
                usage_history: craneDetails.usage_history || null,
                is_manual_entry: true
            } : {
                // Regular form fields
                manufacturer: craneDetails.manufacturer,
                model: craneDetails.model,
                year: craneDetails.year,
                capacity: craneDetails.capacity,
                operatingHours: craneDetails.operatingHours || 0,
                region: craneDetails.region,
                craneType: craneDetails.craneType || ''
            },
            service_record_files: serviceRecordFileUrls.length > 0 ? serviceRecordFileUrls : null,
            metadata: isBulkMode && window.bulkProcessingData ? {
                user_email: userEmail || '',
                receipt_email: userEmail || '',
                is_bulk_entry: 'true',
                total_cranes: window.bulkProcessingData.totalCranes.toString(),
                success_count: window.bulkProcessingData.successCount.toString(),
                error_count: window.bulkProcessingData.errorCount.toString(),
                fleet_pricing_tier: window.bulkProcessingData.pricing.tier || '',
                report_type: selectedReportType
            } : {
                user_email: userEmail || '', // CRITICAL: Always include user_email, even if empty
                receipt_email: userEmail || '', // Also include as receipt_email for backward compatibility
                crane_manufacturer: craneDetails.manufacturer || '',
                crane_model: craneDetails.model || '',
                crane_year: (craneDetails.year || '').toString(),
                crane_capacity: (craneDetails.capacity || '').toString(),
                crane_hours: (craneDetails.operatingHours || 0).toString(),
                crane_region: craneDetails.region || '',
                crane_type: craneDetails.craneType || '',
                report_type: selectedReportType
            }
        };
        
        // CRITICAL: Check if DRAFT already exists (from manual entry, previous purchase click, or continuing from dashboard)
        let draftReportId = window.currentDraftReportId || null;
        
        // Also check localStorage for draft report ID (when continuing from dashboard)
        if (!draftReportId) {
            const storedDraftId = safeStorage.getItem('current_draft_report_id');
            if (storedDraftId) {
                draftReportId = storedDraftId;
                window.currentDraftReportId = draftReportId;
            }
        }
        
        // If manual entry was used, use that draft report (it already has all data including service records)
        if (draftReportId && window.manualEntryData) {
            // The report already has all manual entry details and service records
            // No need to update - just use the existing draft
        } else if (!draftReportId) {
            
            try {
                const reportResponse = await fetch('/api/v1/fmv-reports/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(reportData)
                });
                
                if (reportResponse.ok) {
                    const reportResult = await reportResponse.json();
                    draftReportId = reportResult.id;
                    // Store for later use in payment flow
                    window.currentDraftReportId = draftReportId;
                } else {
                    let errorData = { detail: 'Unknown error' };
                    try {
                        const text = await reportResponse.text();
                        console.error(' Error response text:', text);
                        try {
                            errorData = JSON.parse(text);
                        } catch {
                            errorData = { detail: text || 'Unknown error' };
                        }
                    } catch (e) {
                        console.error(' Could not parse error response:', e);
                    }
                    console.error(' Failed to create DRAFT report:', {
                        status: reportResponse.status,
                        statusText: reportResponse.statusText,
                        error: errorData,
                        url: reportResponse.url
                    });
                    
                    // Surface a clear error to the user and STOP purchase flow
                    let message = 'The server was unable to create a draft report. No payment has been processed. Please try again or contact support.';
                    
                    if (errorData) {
                        // Handle different error formats
                        if (typeof errorData === 'string') {
                            message = errorData;
                        } else if (errorData.detail) {
                            // Handle Pydantic validation errors
                            if (Array.isArray(errorData.detail)) {
                                // Multiple validation errors
                                const errors = errorData.detail.map(err => {
                                    if (typeof err === 'string') return err;
                                    if (err.msg) return err.msg;
                                    if (err.loc && err.msg) return `${err.loc.join('.')}: ${err.msg}`;
                                    return JSON.stringify(err);
                                }).join(', ');
                                message = `Validation error: ${errors}`;
                            } else if (typeof errorData.detail === 'string') {
                                message = errorData.detail;
                            } else {
                                message = JSON.stringify(errorData.detail);
                            }
                        } else if (errorData.message) {
                            message = errorData.message;
                        } else {
                            // Try to stringify the whole error object
                            try {
                                message = JSON.stringify(errorData);
                            } catch (e) {
                                message = 'Unknown error occurred';
                            }
                        }
                    }
                    
                    showNotification('error', 'Draft Creation Failed', message);
                    
                    window._purchaseReportInProgress = false;
                    return;
                }
            } catch (reportError) {
                console.error(' Error creating DRAFT report:', reportError);
                
                const message = 'A network or server error prevented your draft report from being created. No payment has been processed. Please check your connection and try again.';
                showNotification('error', 'Draft Creation Failed', message);
                
                window._purchaseReportInProgress = false;
                return;
            }
        } else {
        }
        
        // Skip subscription check and proceed directly to payment modal setup below
        console.log(' Skipping subscription check - proceeding to payment modal');
        // Continue to payment modal setup (code below)
    } else if (!bypassCheck) {
        // Only check subscription if user hasn't selected a report type
        // Ensure safeStorage is available
        const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
        const token = getAuthToken();
        let canProceed = false;
        let subscriptionData = null;
        
        if (token) {
            try {
                const subscriptionResponse = await fetch('/api/v1/payments/subscription-info', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (subscriptionResponse.ok) {
                    subscriptionData = await subscriptionResponse.json();
                    const tier = subscriptionData.tier || 'free';
                    const valuationsUsed = subscriptionData.valuations_used || 0;
                    const valuationsLimit = subscriptionData.valuations_limit || 0;
                    const valuationsRemaining = subscriptionData.valuations_remaining || 0;
                    
                    // Check if user can proceed
                    if (tier === 'free') {
                        // Free tier users - show blurred results first, then paywall
                        console.log(' Free tier user - showing blurred results and subscription paywall');
                        
                        // Show blurred results section above footer
                        const resultsSection = document.getElementById('valuationResultsSection');
                        if (resultsSection) {
                            // Generate and show blurred preview
                            const craneData = {
                                manufacturer: manufacturer,
                                model: model,
                                year: parseInt(year),
                                capacity: parseFloat(capacity),
                                operatingHours: parseInt(operatingHours),
                                region: region,
                                craneType: document.getElementById('craneType')?.value || ''
                            };
                            
                            // Store for later use
                            window.lastPaymentCraneData = craneData;
                            
                            // Show results with blur overlay
                            resultsSection.style.display = 'block';
                            resultsSection.style.visibility = 'visible';
                            resultsSection.style.filter = 'blur(10px)';
                            resultsSection.style.pointerEvents = 'none';
                            
                            // Populate preview data
                            if (typeof populateResultsPreview === 'function') {
                                populateResultsPreview(craneData);
                            }
                            
                            // Scroll to results
                            setTimeout(() => {
                                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 100);
                        }
                        
                        // Show paywall modal
                        setTimeout(() => {
                            if (typeof window.showSubscriptionPaywall === 'function') {
                                window.showSubscriptionPaywall('free', subscriptionData);
                            } else {
                                console.error('showSubscriptionPaywall function not found');
                                const paywallModal = document.getElementById('subscriptionPaywallModal');
                                if (paywallModal) {
                                    paywallModal.style.setProperty('display', 'flex', 'important');
                                    paywallModal.style.setProperty('visibility', 'visible', 'important');
                                    paywallModal.removeAttribute('data-force-hidden');
                                }
                            }
                        }, 200);
                        // Return here - user can click "Continue with Payment" button in paywall
                        window._purchaseReportInProgress = false;
                        return;
                    } else if (valuationsLimit > 0 && valuationsRemaining === 0) {
                        // Paid tier but limit reached - allow payment for additional report
                        canProceed = true;
                        if (window.notificationSystem) {
                            window.notificationSystem.showWarning(
                                'Monthly Limit Reached',
                                `You have reached your monthly limit of ${valuationsLimit} valuation(s). Payment is required for this additional report.`
                            );
                        }
                    } else {
                        // Has remaining valuations - can proceed
                        canProceed = true;
                    }
                } else {
                    // If subscription check fails, show blurred results and paywall
                    console.log(' Subscription check failed - showing blurred results and paywall');
                    
                    // Show blurred results section above footer
                    const resultsSection = document.getElementById('valuationResultsSection');
                    if (resultsSection) {
                        const craneData = {
                            manufacturer: manufacturer,
                            model: model,
                            year: parseInt(year),
                            capacity: parseFloat(capacity),
                            operatingHours: parseInt(operatingHours),
                            region: region,
                            craneType: document.getElementById('craneType')?.value || ''
                        };
                        
                        window.lastPaymentCraneData = craneData;
                        
                        resultsSection.style.display = 'block';
                        resultsSection.style.visibility = 'visible';
                        resultsSection.style.filter = 'blur(10px)';
                        resultsSection.style.pointerEvents = 'none';
                        
                        if (typeof populateResultsPreview === 'function') {
                            populateResultsPreview(craneData);
                        }
                        
                        setTimeout(() => {
                            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                    // Show paywall - add small delay to ensure results are shown first
                    setTimeout(() => {
                        console.log(' Calling showSubscriptionPaywall function...');
                    if (typeof window.showSubscriptionPaywall === 'function') {
                        window.showSubscriptionPaywall('free', null);
                        } else {
                            console.error(' showSubscriptionPaywall function not found');
                            // Fallback: directly show the modal
                            const paywallModal = document.getElementById('subscriptionPaywallModal');
                            if (paywallModal) {
                                paywallModal.style.setProperty('display', 'flex', 'important');
                                paywallModal.style.setProperty('visibility', 'visible', 'important');
                                paywallModal.removeAttribute('data-force-hidden');
                            }
                        }
                    }, 200);
                    window._purchaseReportInProgress = false;
                    return;
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
                // On error, show blurred results and paywall
                console.log(' Error checking subscription - showing blurred results and paywall');
                
                // Show blurred results section above footer
                const resultsSection = document.getElementById('valuationResultsSection');
                if (resultsSection) {
                    const craneData = {
                        manufacturer: manufacturer,
                        model: model,
                        year: parseInt(year),
                        capacity: parseFloat(capacity),
                        operatingHours: parseInt(operatingHours),
                        region: region,
                        craneType: document.getElementById('craneType')?.value || ''
                    };
                    
                    window.lastPaymentCraneData = craneData;
                    
                    resultsSection.style.display = 'block';
                    resultsSection.style.visibility = 'visible';
                    resultsSection.style.filter = 'blur(10px)';
                    resultsSection.style.pointerEvents = 'none';
                    
                    if (typeof populateResultsPreview === 'function') {
                        populateResultsPreview(craneData);
                    }
                    
                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
                
                // Show paywall
                if (typeof window.showSubscriptionPaywall === 'function') {
                    window.showSubscriptionPaywall('free', null);
                }
                window._purchaseReportInProgress = false;
                return;
            }
        } else {
            // No token - show blurred results and paywall
            console.log(' No auth token - showing blurred results and paywall');
            
            // Show blurred results section above footer
            const resultsSection = document.getElementById('valuationResultsSection');
            if (resultsSection) {
                const craneData = {
                    manufacturer: manufacturer,
                    model: model,
                    year: parseInt(year),
                    capacity: parseFloat(capacity),
                    operatingHours: parseInt(operatingHours),
                    region: region,
                    craneType: document.getElementById('craneType')?.value || ''
                };
                
                window.lastPaymentCraneData = craneData;
                
                resultsSection.style.display = 'block';
                resultsSection.style.visibility = 'visible';
                resultsSection.style.filter = 'blur(10px)';
                resultsSection.style.pointerEvents = 'none';
                
                if (typeof populateResultsPreview === 'function') {
                    populateResultsPreview(craneData);
                }
                
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
            
            // Show paywall
            if (typeof window.showSubscriptionPaywall === 'function') {
                window.showSubscriptionPaywall('free', null);
            }
            window._purchaseReportInProgress = false;
            return;
        }
        
        // If we can't proceed, return early
        if (!canProceed) {
            window._purchaseReportInProgress = false;
            return;
        }
    }
    
    // reportType is already declared above at line 6429, reuse it
    // Calculate price - use dynamic pricing for Fleet Valuation
    let reportPrice;
    if (reportType === 'fleet_valuation') {
        const unitCountInput = document.getElementById('unitCount');
        const unitCount = unitCountInput ? parseInt(unitCountInput.value) || 1 : 1;
        const pricing = calculateFleetPrice(unitCount);
        reportPrice = Math.round(pricing.price * 100); // Convert to cents
        fleetPricingTier = pricing.tier;
    } else {
        reportPrice = parseInt(document.querySelector('.report-type-card.selected')?.querySelector('.select-report-btn')?.dataset.price || '49500');
    }
    
    const reportNames = {
        'spot_check': 'Spot Check',
        'professional': 'Professional',
        'fleet_valuation': 'Fleet Valuation'
    };
    const reportName = reportNames[reportType] || 'FMV Report';
    const priceDisplay = (reportPrice / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
    
    selectedReport = {
        type: reportType,
        name: reportName,
        price: priceDisplay,
        amount: reportPrice, // in cents
        crane: {
            manufacturer,
            model,
            year: parseInt(year),
            capacity: parseFloat(capacity),
            operatingHours: parseInt(operatingHours),
            region,
            craneType: document.getElementById('craneType')?.value,
            boomLength: parseFloat(document.getElementById('boomLength')?.value) || null,
            mileage: parseInt(document.getElementById('mileage')?.value) || null
        }
    };
    
    // Handle "Other" manufacturer
    if (selectedReport.crane.manufacturer === 'Other') {
        selectedReport.crane.manufacturer = document.getElementById('manufacturerOther')?.value || '';
    }
    
    // Store for results display
    window.lastPaymentCraneData = selectedReport.crane;
    
    // Update modal with report details
    document.getElementById('selectedReportName').textContent = reportName;
    document.getElementById('selectedCraneInfo').textContent = `${manufacturer} ${model} (${year})`;
    document.getElementById('selectedReportPrice').textContent = priceDisplay;
    
    // Pre-fill email from localStorage
    const userEmail = safeStorage.getItem('user_email') || '';
    if (userEmail) {
        document.getElementById('receiptEmail').value = userEmail;
    }
    
    // CRITICAL: Create DRAFT report BEFORE opening payment modal (if not already created)
    if (!window.currentDraftReportId) {
        const token = safeStorage.getItem('access_token') || safeStorage.getItem('crane_auth_token') || safeStorage.getItem('auth_token');
        const receiptEmailInput = document.getElementById('receiptEmail');
        const receiptEmail = receiptEmailInput ? receiptEmailInput.value : (safeStorage.getItem('user_email') || '');
        
        // Create DRAFT report data
        const reportData = {
            report_type: selectedReport.type,
            crane_details: {
                manufacturer: selectedReport.crane.manufacturer,
                model: selectedReport.crane.model,
                year: selectedReport.crane.year,
                capacity: selectedReport.crane.capacity,
                operatingHours: selectedReport.crane.operatingHours || 0,
                region: selectedReport.crane.region,
                craneType: selectedReport.crane.craneType || ''
            },
            metadata: {
                user_email: receiptEmail,
                crane_manufacturer: selectedReport.crane.manufacturer,
                crane_model: selectedReport.crane.model,
                crane_year: selectedReport.crane.year.toString(),
                crane_capacity: selectedReport.crane.capacity.toString(),
                crane_hours: (selectedReport.crane.operatingHours || 0).toString(),
                crane_region: selectedReport.crane.region,
                crane_type: selectedReport.crane.craneType || '',
                report_type: selectedReport.type
            }
        };
        
        console.log(' Creating DRAFT report before opening payment modal:', {
            url: '/api/v1/fmv-reports/submit',
            method: 'POST',
            body: reportData
        });
        
        try {
            const reportResponse = await fetch('/api/v1/fmv-reports/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify(reportData)
            });
            
            if (reportResponse.ok) {
                const reportResult = await reportResponse.json();
                window.currentDraftReportId = reportResult.id;
                console.log(' DRAFT report created before payment modal:', window.currentDraftReportId);
            } else {
                const errorData = await reportResponse.json().catch(() => ({ detail: 'Unknown error' }));
                console.warn(' Failed to create DRAFT report, continuing:', errorData);
            }
        } catch (reportError) {
            console.warn(' Error creating DRAFT report, continuing:', reportError);
        }
    }
    
    // Show payment modal - override !important styles
    const paymentModal = document.getElementById('stripePaymentModal');
    if (paymentModal) {
        paymentModal.removeAttribute('data-force-hidden');
        paymentModal.style.setProperty('display', 'flex', 'important');
        paymentModal.style.setProperty('visibility', 'visible', 'important');
        paymentModal.style.setProperty('z-index', '10000', 'important');
        // Ensure close button is visible when modal is shown
        const closeButton = paymentModal.querySelector('.ci-stripe-close');
        if (closeButton) {
            closeButton.style.setProperty('display', 'flex', 'important');
            closeButton.style.setProperty('visibility', 'visible', 'important');
            closeButton.style.setProperty('opacity', '1', 'important');
        }
        console.log(' Payment modal displayed');
    }
    
    // Initialize Stripe Payment Element
    requestAnimationFrame(async () => {
        if (!stripe) {
            console.log(' Stripe not ready, initializing...');
            const initialized = await initializeStripe();
            if (!initialized) {
                // Replace loading indicator with error message
                const loadingDiv = document.getElementById('payment-loading');
                if (loadingDiv) {
                    loadingDiv.innerHTML = '<div style="padding: 30px; text-align: center;"><p style="color: #FF4444; font-size: 18px; font-weight: 600; margin-bottom: 12px;"> Payment System Unavailable</p><p style="color: #B0B0B0; font-size: 14px; margin-bottom: 8px;">Failed to initialize payment system.</p><p style="color: #888; font-size: 13px;">Please refresh the page and try again. If the problem persists, please contact support.</p></div>';
                }
                
                // Show error message in error div
                const displayError = document.getElementById('payment-errors');
                if (displayError) {
                    displayError.textContent = 'Payment system initialization failed. Please refresh the page.';
                    displayError.style.color = '#FF4444';
                    displayError.style.padding = '15px';
                    displayError.style.textAlign = 'center';
                    displayError.style.backgroundColor = 'rgba(255, 68, 68, 0.1)';
                    displayError.style.borderRadius = '6px';
                    displayError.style.marginTop = '15px';
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('submitPayment');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                    submitBtn.textContent = 'Payment System Unavailable';
                }
                
                console.error(' Stripe initialization failed - payment modal will show error');
                return;
            }
        }
        
        if (stripe) {
            // Unmount existing payment element if it exists
            if (paymentElement) {
                console.log(' Unmounting existing Payment Element');
                paymentElement.unmount();
                paymentElement = null;
            }
            
            console.log(' Creating Payment Element for amount:', selectedReport.amount, 'cents');
            
            elements = stripe.elements({
                mode: 'payment',
                amount: selectedReport.amount,
                currency: 'usd',
                appearance: {
                    theme: 'night',
                    variables: {
                        colorPrimary: '#00FF88',
                        colorBackground: '#1A1A1A',
                        colorText: '#FFFFFF',
                        colorDanger: '#FF4444',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                        borderRadius: '4px'
                    }
                }
            });
            
            if (!elements) {
                console.error(' Failed to create Stripe Elements');
                if (window.notificationSystem) {
                    window.notificationSystem.showError('Payment Error', 'Failed to initialize payment form. Please refresh and try again.');
                }
                return;
            }
            
            paymentElement = elements.create('payment', {
                layout: {
                    type: 'tabs',
                    defaultCollapsed: false
                },
                paymentMethodOrder: ['card', 'us_bank_account'],
                wallets: {
                    applePay: 'auto',
                    googlePay: 'auto'
                }
            });
            
            // Clear loading indicator
            const loadingDiv = document.getElementById('payment-loading');
            if (loadingDiv) loadingDiv.remove();
            
            // Check if paymentElement was created successfully
            if (!paymentElement) {
                console.error(' Payment Element creation failed');
                const displayError = document.getElementById('payment-errors');
                if (displayError) {
                    displayError.textContent = 'Failed to create payment form. Please try again.';
                }
                return;
            }
            
            try {
                const mountResult = paymentElement.mount('#payment-element');
                if (mountResult && typeof mountResult.then === 'function') {
                    mountResult.then(() => {
                        console.log(' Payment Element mounted');
                    }).catch((error) => {
                        console.error(' Payment Element mount failed:', error);
                        const displayError = document.getElementById('payment-errors');
                        if (displayError) {
                            displayError.textContent = 'Failed to load payment form. Please refresh and try again.';
                        }
                    });
                } else {
                    // Mount completed synchronously
                    console.log(' Payment Element mounted');
                }
            } catch (error) {
                console.error(' Payment Element mount error:', error);
                const displayError = document.getElementById('payment-errors');
                if (displayError) {
                    displayError.textContent = 'Failed to load payment form. Please refresh and try again.';
                }
            }
            
            paymentElement.on('change', (event) => {
                const displayError = document.getElementById('payment-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }
    });
    } catch (error) {
        console.error(' Error in purchaseReport:', error);
        if (window.notificationSystem) {
            window.notificationSystem.showError('Error', 'An error occurred while processing your request. Please try again.');
        }
    } finally {
        // Always reset flag when function completes (success or error)
        window._purchaseReportInProgress = false;
    }
};

// Handle payment submission
document.addEventListener('DOMContentLoaded', () => {
    const submitButton = document.getElementById('submitPayment');
    if (submitButton) {
        submitButton.addEventListener('click', async () => {
            if (!stripe || !elements) {
                if (window.notificationSystem) {
                    window.notificationSystem.showError('Payment Error', 'Payment system not ready. Please try again.');
                }
                return;
            }
            
            const cardholderName = document.getElementById('cardholderName').value;
            const receiptEmail = document.getElementById('receiptEmail').value;
            
            if (!cardholderName) {
                if (window.notificationSystem) {
                    window.notificationSystem.showError('Validation Error', 'Please enter cardholder name');
                }
                return;
            }
            if (!receiptEmail) {
                if (window.notificationSystem) {
                    window.notificationSystem.showError('Validation Error', 'Please enter email for receipt');
                }
                return;
            }
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<span style="animation: spin 1s linear infinite;"></span> Processing...';
            
            try {
                // Step 1: Submit payment element
                const {error: submitError} = await elements.submit();
                if (submitError) {
                    throw new Error(submitError.message);
                }
                
                const token = safeStorage.getItem('access_token') || safeStorage.getItem('crane_auth_token') || safeStorage.getItem('auth_token');
                
                // Check if we're in bulk processing mode
                const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
                const isBulkMode = bulkForm && bulkForm.style.display !== 'none' && window.bulkProcessingData;
                
                // Step 2: Use existing DRAFT report if already created, otherwise create new one
                // DRAFT should already exist from Purchase button click, but create if missing
                let draftReportId = window.currentDraftReportId || null;
                
                // If bulk mode, upload file first and get file URL
                let bulkFileUrl = null;
                if (isBulkMode && window.bulkProcessingFile) {
                    try {
                        const formData = new FormData();
                        formData.append('file', window.bulkProcessingFile);
                        
                        const uploadResponse = await fetch('/api/v1/fmv-reports/upload-service-records', {
                            method: 'POST',
                            headers: {
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: formData
                        });
                        
                        if (uploadResponse.ok) {
                            const uploadResult = await uploadResponse.json();
                            if (uploadResult.files && uploadResult.files.length > 0) {
                                bulkFileUrl = uploadResult.files[0];
                            }
                        } else {
                            console.warn(' Failed to upload bulk file, continuing without it');
                        }
                    } catch (uploadError) {
                        console.error(' Error uploading bulk file:', uploadError);
                        // Continue without file upload
                    }
                }
                
                // Upload service record files if they exist and haven't been uploaded yet
                let serviceRecordFileUrls = [];
                if (window.serviceRecordFiles && window.serviceRecordFiles.length > 0 && (!window.manualEntryServiceRecordUrls || window.manualEntryServiceRecordUrls.length === 0)) {
                    try {
                        console.log(' Uploading service record files during payment...');
                        const formData = new FormData();
                        window.serviceRecordFiles.forEach((file) => {
                            formData.append('files', file);
                        });
                        
                        const uploadResponse = await fetch('/api/v1/fmv-reports/upload-service-records', {
                            method: 'POST',
                            headers: {
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: formData
                        });
                        
                        if (uploadResponse.ok) {
                            const uploadResult = await uploadResponse.json();
                            serviceRecordFileUrls = uploadResult.files || [];
                            console.log(' Service record files uploaded during payment:', serviceRecordFileUrls);
                            window.manualEntryServiceRecordUrls = serviceRecordFileUrls;
                        } else {
                            console.warn(' File upload failed during payment, continuing without files');
                        }
                    } catch (uploadError) {
                        console.error(' Error uploading service record files during payment:', uploadError);
                    }
                } else if (window.manualEntryServiceRecordUrls && window.manualEntryServiceRecordUrls.length > 0) {
                    serviceRecordFileUrls = window.manualEntryServiceRecordUrls;
                }
                
                if (!draftReportId) {
                    // DRAFT not created yet, create it now
                    let craneDetails = selectedReport.crane;
                    
                    // If bulk mode, use bulk processing data
                    if (isBulkMode && window.bulkProcessingData) {
                        craneDetails = {
                            is_bulk_processing: true,
                            bulk_records: window.bulkProcessingData.records,
                            total_cranes: window.bulkProcessingData.totalCranes,
                            success_count: window.bulkProcessingData.successCount,
                            error_count: window.bulkProcessingData.errorCount,
                            pricing_tier: window.bulkProcessingData.pricing.tier,
                            total_price: window.bulkProcessingData.pricing.total,
                            bulk_file_url: bulkFileUrl
                        };
                    }
                    
                    const reportData = {
                        report_type: selectedReport.type,
                        crane_details: craneDetails,
                        service_record_files: serviceRecordFileUrls.length > 0 ? serviceRecordFileUrls : null,
                        metadata: {
                            user_email: receiptEmail,
                            cardholder_name: cardholderName,
                            crane_manufacturer: craneDetails.manufacturer,
                            crane_model: craneDetails.model,
                            crane_year: craneDetails.year.toString(),
                            crane_capacity: craneDetails.capacity.toString(),
                            crane_hours: (craneDetails.operatingHours || 0).toString(),
                            crane_region: craneDetails.region,
                            crane_type: craneDetails.craneType || '',
                            report_type: selectedReport.type
                        }
                    };
                    
                    try {
                        const reportResponse = await fetch('/api/v1/fmv-reports/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify(reportData)
                        });
                        
                        if (reportResponse.ok) {
                            const reportResult = await reportResponse.json();
                            draftReportId = reportResult.id;
                            window.currentDraftReportId = draftReportId;
                        } else {
                            const errorData = await reportResponse.json().catch(() => ({ detail: 'Unknown error' }));
                            console.warn(' Failed to create DRAFT report, continuing with payment:', errorData);
                            // Continue anyway - payment intent creation will handle it
                        }
                    } catch (reportError) {
                        console.warn(' Error creating DRAFT report, continuing with payment:', reportError);
                        // Continue anyway - payment intent creation will handle it
                    }
                } else {
                }
                
                // Step 3: Create payment intent (with report_id if available)
                // CRITICAL: Ensure we use the existing draft report ID to prevent duplicates
                // This should be set when continuing from dashboard
                if (!draftReportId && window.currentDraftReportId) {
                    draftReportId = window.currentDraftReportId;
                    console.log(' Using window.currentDraftReportId for payment:', draftReportId);
                }
                
                // Build metadata object
                const metadata = {
                    user_email: receiptEmail,
                    report_id: draftReportId ? draftReportId.toString() : '',
                    draft_report_id: draftReportId ? draftReportId.toString() : ''
                };
                
                // Log for debugging
                if (draftReportId) {
                } else {
                    console.warn(' No draft report ID available - new report will be created');
                }
                
                // If manual entry was used, include flag in metadata
                if (window.manualEntryData) {
                    metadata.is_manual_entry = 'true';
                    metadata.manual_entry_used = 'true';
                }
                
                // If reportData exists (from fallback creation), merge its metadata
                if (typeof reportData !== 'undefined' && reportData.metadata) {
                    Object.assign(metadata, reportData.metadata);
                }
                
                // Prepare crane_data - use bulk data if in bulk mode
                let craneDataForPayment = selectedReport.crane;
                if (isBulkMode && window.bulkProcessingData) {
                    craneDataForPayment = {
                        is_bulk_processing: true,
                        bulk_records: window.bulkProcessingData.records,
                        total_cranes: window.bulkProcessingData.totalCranes,
                        success_count: window.bulkProcessingData.successCount,
                        error_count: window.bulkProcessingData.errorCount,
                        pricing_tier: window.bulkProcessingData.pricing.tier,
                        total_price: window.bulkProcessingData.pricing.total,
                        bulk_file_url: bulkFileUrl
                    };
                    // Add bulk processing flag to metadata
                    metadata.is_bulk_processing = 'true';
                    metadata.bulk_file_url = bulkFileUrl || '';
                    metadata.total_cranes = window.bulkProcessingData.totalCranes.toString();
                }
                
                const requestBody = {
                    report_type: selectedReport.type,
                    amount: selectedReport.amount,
                    crane_data: craneDataForPayment,
                    cardholder_name: cardholderName,
                    receipt_email: receiptEmail,
                    metadata: metadata
                };
                
                console.log(' Creating payment intent:', {
                    url: '/api/v1/fmv-reports/create-payment',
                    method: 'POST',
                    body: requestBody
                });
                
                const response = await fetch('/api/v1/fmv-reports/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log(' Payment intent response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    let errorMessage = 'Payment failed';
                    let errorData = null;
                    try {
                        errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorData.error || `HTTP ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    console.error(' Payment intent creation failed:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: errorData
                    });
                    throw new Error(errorMessage);
                }
                
                const {client_secret, transaction_id} = await response.json();
                
                // Step 3: Confirm payment
                const {error, paymentIntent} = await stripe.confirmPayment({
                    elements,
                    clientSecret: client_secret,
                    confirmParams: {
                        return_url: window.location.origin + '/report-generation.html'
                    },
                    redirect: 'if_required'
                });
                
                if (error) {
                    throw new Error(error.message);
                }
                
                // Payment successful - show success modal
                try {
                    { // Extra opening brace to balance extra closing brace
                    if (paymentIntent && paymentIntent.status === 'succeeded') {
                    // Payment succeeded - immediately call payment-by-intent endpoint to update report status
                    // This endpoint will find the report by payment_intent_id and update it to SUBMITTED
                    console.log(' Payment succeeded - calling payment-by-intent endpoint to update report status');
                    
                    const token = safeStorage.getItem('auth_token') || safeStorage.getItem('crane_auth_token');
                    let paymentMarked = false;
                    
                    try {
                        const paymentByIntentResponse = await fetch(`/api/v1/fmv-reports/payment-by-intent`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? `Bearer ${token}` : ''
                            },
                            body: JSON.stringify({
                                payment_intent_id: paymentIntent.id,
                                amount: paymentIntent.amount / 100
                            })
                        });
                        
                        if (paymentByIntentResponse.ok) {
                            const paymentResult = await paymentByIntentResponse.json();
                            console.log(' Payment status updated to SUBMITTED via payment-by-intent endpoint');
                            console.log('   Report ID:', paymentResult.id);
                            console.log('   Report Status:', paymentResult.status);
                            console.log('   Updated report:', paymentResult);
                            paymentMarked = true;
                            
                            // Update window.currentDraftReportId to the actual report ID
                            if (paymentResult.id) {
                                window.currentDraftReportId = paymentResult.id;
                            }
                            
                            // Show success message
                            if (window.notificationSystem) {
                                window.notificationSystem.showSuccess(
                                    'Payment Successful!',
                                    `Your payment of $${(paymentIntent.amount / 100).toFixed(2)} has been received. Report #${paymentResult.id} has been submitted successfully.`
                                );
                            }
                            
                            // Check if user subscription was upgraded
                            if (paymentResult.user_upgraded) {
                                console.log(' User subscription upgraded to:', paymentResult.new_subscription_tier);
                                // Refresh user data from backend
                                if (typeof refreshUserData === 'function') {
                                    await refreshUserData();
                                }
                                // Show upgrade notification
                                if (window.notificationSystem) {
                                    window.notificationSystem.showSuccess(
                                        'Subscription Upgraded!',
                                        `Your subscription has been upgraded to ${paymentResult.new_subscription_tier.replace('_', ' ').toUpperCase()}.`
                                    );
                                }
                            }
                            
                            // Refresh reports in dashboard if on dashboard page
                            if (typeof loadFMVReports === 'function') {
                                setTimeout(() => {
                                    loadFMVReports();
                                }, 1000);
                            }
                            
                            // Re-enable submit button first
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = 'Complete Purchase';
                            }
                            
                            // Close payment modal
                            closeStripeModal();
                            
                            // Store crane data for results display
                            try {
                                const manufacturer = document.getElementById('manufacturer')?.value || '';
                                const model = document.getElementById('model')?.value || '';
                                if (manufacturer && model) {
                                    window.lastPaymentCraneData = {
                                        manufacturer: manufacturer,
                                        model: model,
                                        year: parseInt(document.getElementById('year')?.value) || null,
                                        capacity: parseFloat(document.getElementById('capacity')?.value) || null
                                    };
                                }
                            } catch (e) {
                                console.warn('Could not store crane data:', e);
                            }
                            
                            // Show payment success modal
                            const reportTypeDisplay = paymentResult.report_type === 'spot_check' ? 'Spot Check' :
                                                      paymentResult.report_type === 'professional' ? 'Professional' :
                                                      paymentResult.report_type === 'fleet_valuation' ? 'Fleet Valuation' :
                                                      paymentResult.report_type || 'FMV Report';
                            
                            const craneDetails = paymentResult.crane_details || {};
                            const craneModel = craneDetails.manufacturer && craneDetails.model 
                                ? `${craneDetails.manufacturer} ${craneDetails.model}` 
                                : 'N/A';
                            
                            console.log(' Showing payment success modal with details:', {
                                transactionId: paymentResult.payment_intent_id || paymentIntent.id,
                                paymentIntentId: paymentIntent.id,
                                reportType: reportTypeDisplay,
                                craneModel: craneModel,
                                amount: paymentIntent.amount,
                                reportId: paymentResult.id
                            });
                            
                            // Call showPaymentSuccessModal function
                            if (typeof showPaymentSuccessModal === 'function') {
                                showPaymentSuccessModal({
                                    transactionId: paymentResult.payment_intent_id || paymentIntent.id || 'N/A',
                                    paymentIntentId: paymentIntent.id || 'N/A',
                                    reportType: reportTypeDisplay,
                                    craneModel: craneModel,
                                    amount: paymentIntent.amount,
                                    reportId: paymentResult.id
                                });
                            } else if (typeof window.showPaymentSuccessModal === 'function') {
                                window.showPaymentSuccessModal({
                                    transactionId: paymentResult.payment_intent_id || paymentIntent.id || 'N/A',
                                    paymentIntentId: paymentIntent.id || 'N/A',
                                    reportType: reportTypeDisplay,
                                    craneModel: craneModel,
                                    amount: paymentIntent.amount,
                                    reportId: paymentResult.id
                                });
                            } else {
                                console.error(' showPaymentSuccessModal function not found');
                                // Fallback: redirect to dashboard after short delay
                                if (window.notificationSystem) {
                                    window.notificationSystem.showSuccess(
                                        'Payment Successful!',
                                        'Redirecting to dashboard...'
                                    );
                                }
                                setTimeout(() => {
                                    window.location.href = '/dashboard.html';
                                }, 2000);
                            }
                            
                            // Exit early - payment already processed, emails sent, notifications created
                            return;
                        } else {
                            const errorData = await paymentByIntentResponse.json().catch(() => ({ detail: 'Unknown error' }));
                            console.error(' Payment-by-intent endpoint failed:', errorData);
                            console.error('   Payment Intent ID:', paymentIntent.id);
                            console.error('   Amount:', paymentIntent.amount / 100);
                            // Continue to fallback logic below
                        }
                    } catch (err) {
                        console.error(' Payment-by-intent endpoint error:', err);
                        // Continue to fallback logic below
                    }
                    } // End of if (paymentIntent && paymentIntent.status === 'succeeded')
                    } // Close extra block
                    
                    // Fallback: If payment-by-intent failed, try to find/create report manually
                    // This should rarely happen, but provides a backup
                    if (!paymentMarked) {
                        console.warn(' Payment-by-intent failed, attempting fallback report update');
                        
                        // Submit FMV report to backend
                        let craneDetails = null; // Declare outside try block for catch block access
                        try {
                            const token = safeStorage.getItem('auth_token') || safeStorage.getItem('crane_auth_token');
                        const receiptEmailInput = document.getElementById('receiptEmail');
                        const receiptEmail = receiptEmailInput ? receiptEmailInput.value : '';
                        
                        // Get manufacturer (handle "Other" option)
                        let manufacturer = document.getElementById('manufacturer').value;
                        if (manufacturer === 'Other') {
                            manufacturer = document.getElementById('manufacturerOther').value;
                        }
                        
                        // Get model (handle fallback input)
                        let model = document.getElementById('model').value;
                        if (!model && document.getElementById('fallbackModel').value) {
                            model = document.getElementById('fallbackModel').value;
                            manufacturer = document.getElementById('fallbackManufacturer').value || manufacturer;
                        }
                        
                        craneDetails = {
                            manufacturer: manufacturer,
                            model: model,
                            year: parseInt(document.getElementById('year').value),
                            capacity_tons: parseFloat(document.getElementById('capacity').value),
                            hours: parseInt(document.getElementById('operatingHours').value),
                            region: document.getElementById('region').value,
                            crane_type: document.getElementById('craneType').value,
                            operating_hours: parseInt(document.getElementById('operatingHours').value),
                            boom_length: parseFloat(document.getElementById('boomLength').value) || null,
                            mileage: parseInt(document.getElementById('mileage').value) || null
                        };
                        
                        // Upload service record files if any
                        let serviceRecordUrls = [];
                        if (window.serviceRecordFiles && window.serviceRecordFiles.length > 0) {
                            try {
                                const formData = new FormData();
                                window.serviceRecordFiles.forEach((file, index) => {
                                    formData.append(`service_records`, file);
                                });
                                
                                const uploadResponse = await fetch('/api/v1/fmv-reports/upload-service-records', {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': token ? `Bearer ${token}` : ''
                                    },
                                    body: formData
                                });
                                
                                if (uploadResponse.ok) {
                                    const uploadResult = await uploadResponse.json();
                                    serviceRecordUrls = uploadResult.file_urls || [];
                                }
                            } catch (err) {
                                console.error('Error uploading service records:', err);
                            }
                        }
                        
                        // CRITICAL: Use existing DRAFT report if already created, don't create duplicate
                        // After payment succeeds, we should NOT create a new report - just mark payment received
                        let reportId = window.currentDraftReportId || null;
                        
                        // If we have a payment intent ID, try to find the report by it first
                        if (!reportId && paymentIntent && paymentIntent.id) {
                            // Payment succeeded - call payment-by-intent endpoint which will find the report
                            // This is the most reliable way to ensure we update the correct report
                            console.log(' Payment succeeded - calling payment-by-intent endpoint to update report status');
                            
                            // Call payment-by-intent endpoint immediately - it will find the report by payment_intent_id
                            try {
                                const paymentByIntentResponse = await fetch(`/api/v1/fmv-reports/payment-by-intent`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': token ? `Bearer ${token}` : ''
                                    },
                                    body: JSON.stringify({
                                        payment_intent_id: paymentIntent.id,
                                        amount: paymentIntent.amount / 100
                                    })
                                });
                                
                                if (paymentByIntentResponse.ok) {
                                    const paymentResult = await paymentByIntentResponse.json();
                                    reportId = paymentResult.id;
                                    window.currentDraftReportId = reportId;
                                    console.log(' Payment status updated via payment-by-intent endpoint. Report ID:', reportId);
                                    console.log('   Report status:', paymentResult.status);
                                    
                                    // Payment is already marked, emails sent, notifications created
                                    // Skip the rest of the report creation/update logic
                                    paymentMarked = true;
                                    
                                    // Show success message
                                    if (window.notificationSystem) {
                                        window.notificationSystem.showSuccess(
                                            'Payment Successful!',
                                            `Your payment of $${(paymentIntent.amount / 100).toFixed(2)} has been received. Report #${reportId} has been submitted successfully.`
                                        );
                                    }
                                    
                                    // Refresh reports in dashboard if on dashboard page
                                    if (typeof loadFMVReports === 'function') {
                                        setTimeout(() => {
                                            loadFMVReports();
                                        }, 1000);
                                    }
                                    
                                    // Store crane data for results display
                                    if (craneDetails) {
                                        window.lastPaymentCraneData = craneDetails;
                                    }
                                    
                                    // Close payment modal and show success
                                    const paymentModal = document.getElementById('paymentModal');
                                    if (paymentModal) {
                                        paymentModal.style.display = 'none';
                                    }
                                    
                                    // Show success modal or redirect
                                    // (existing success modal code continues below)
                                    return; // Exit early - payment already processed
                                } else {
                                    const errorData = await paymentByIntentResponse.json().catch(() => ({ detail: 'Unknown error' }));
                                    console.warn(' Payment-by-intent endpoint failed, will try to find/create report:', errorData);
                                }
                            } catch (err) {
                                console.warn(' Payment-by-intent endpoint error, will try to find/create report:', err);
                            }
                        }
                        
                        if (!reportId) {
                            // Get the ACTUAL selected report type from the UI card, not from variable
                            const selectedReportCard = document.querySelector('.report-type-card.selected');
                            const actualReportType = selectedReportCard?.dataset.type || 
                                                   (selectedReport?.type) || 
                                                   (window.selectedReportType) || 
                                                   'spot_check';
                            
                            console.log(' Payment flow - Using report type from UI:', actualReportType, 'selectedReportType variable:', selectedReportType);
                            
                            const reportData = {
                                report_type: actualReportType,
                                crane_details: craneDetails
                            };
                            
                            // Only include service_record_files if there are any
                            if (serviceRecordUrls.length > 0) {
                                reportData.service_record_files = serviceRecordUrls;
                            }
                            
                            console.log('Submitting report with service_record_files:', serviceRecordUrls);
                            
                            // Only include fleet_valuation fields if it's actually a fleet (1-50 units)
                            if (actualReportType === 'fleet_valuation') {
                                const unitCount = parseInt(document.getElementById('unitCount')?.value || '1');
                                if (unitCount >= 1 && unitCount <= 50) {
                                    // Calculate pricing tier based on unit count
                                    const pricing = calculateFleetPrice(unitCount);
                                    reportData.fleet_pricing_tier = pricing.tier;
                                    reportData.unit_count = unitCount;
                                } else {
                                    // Invalid unit count - change to professional report type
                                    reportData.report_type = 'professional';
                                }
                            }
                            
                            // Include user email from payment metadata or form for unauthenticated users
                            // CRITICAL: Include payment_intent_id in metadata to bypass subscription check
                            if (receiptEmail) {
                                reportData.metadata = {
                                    user_email: receiptEmail,
                                    receipt_email: receiptEmail,
                                    payment_intent_id: paymentIntent.id,
                                    payment_succeeded: true,
                                    amount_paid: paymentIntent.amount / 100
                                };
                            } else {
                                // Even without receipt email, include payment info to bypass subscription check
                                reportData.metadata = {
                                    payment_intent_id: paymentIntent.id,
                                    payment_succeeded: true,
                                    amount_paid: paymentIntent.amount / 100
                                };
                            }
                            
                            const reportResponse = await fetch('/api/v1/fmv-reports/submit', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                },
                                body: JSON.stringify(reportData)
                            });
                            
                            if (reportResponse.ok) {
                                const reportResult = await reportResponse.json();
                                reportId = reportResult.id;
                                window.currentDraftReportId = reportId; // Store to prevent duplicates
                                console.log(' Report created after payment:', reportId);
                            } else {
                                // If creation failed, try to use existing draft
                                reportId = window.currentDraftReportId;
                                console.warn(' Report creation failed, using existing draft:', reportId);
                            }
                        } else {
                            // Use existing draft report
                            reportId = window.currentDraftReportId;
                        }
                        
                        if (!reportId) {
                            // Try to get error data from reportResponse if it exists
                            let errorData = { detail: 'Unknown error' };
                            if (typeof reportResponse !== 'undefined' && reportResponse) {
                                try {
                                    errorData = await reportResponse.json().catch(() => ({ detail: 'Unknown error' }));
                                } catch (e) {
                                    errorData = { detail: 'Failed to parse error response' };
                                }
                            }
                            console.error('Report submission failed:', errorData);
                            // Try to find existing report by payment_intent_id
                            // This handles case where report was created but submission failed
                            console.warn('Report submission failed but payment succeeded - trying to find existing report');
                    
                            // Try to find report by payment_intent_id from metadata
                            // Get user ID from token or email
                            const userId = getUserId();
                            const userEmail = getUserEmail();
                            if ((userId || userEmail) && craneDetails) {
                                // Get user reports and find the one matching this payment
                                const userIdentifier = userId || userEmail;
                                const userReportsResponse = await fetch(`/api/v1/fmv-reports/user/${userIdentifier}`, {
                                    headers: {
                                        'Authorization': token ? `Bearer ${token}` : ''
                                    }
                                });
                                if (userReportsResponse.ok) {
                                    const userReports = await userReportsResponse.json();
                                    // Find the most recent draft report for this user matching the crane details
                                    const draftReports = userReports.filter(r => {
                                        const status = (r.status || '').toLowerCase();
                                        return status === 'draft' && 
                                            r.crane_details?.manufacturer === craneDetails.manufacturer &&
                                            r.crane_details?.model === craneDetails.model;
                                    });
                                    if (draftReports.length > 0) {
                                        // Sort by created_at descending and get the most recent
                                        draftReports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                                        reportId = draftReports[0].id;
                                    }
                                }
                            }
                        } else if (typeof reportResponse !== 'undefined' && reportResponse && reportResponse.ok) {
                            // Only try to parse reportResponse if it exists and is ok
                            try {
                                const reportResult = await reportResponse.json();
                                reportId = reportResult.id || reportId;
                            } catch (e) {
                                console.warn(' Could not parse reportResponse, using existing reportId:', reportId);
                            }
                        }
                            
                            // Try to mark payment received - use payment-by-intent endpoint first (more reliable)
                            let paymentMarked = false;
                            
                            // First, try the payment-by-intent endpoint (finds report automatically)
                            try {
                                const paymentByIntentResponse = await fetch(`/api/v1/fmv-reports/payment-by-intent`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': token ? `Bearer ${token}` : ''
                                    },
                                    body: JSON.stringify({
                                        payment_intent_id: paymentIntent.id,
                                        amount: paymentIntent.amount / 100
                                    })
                                });
                                
                                if (paymentByIntentResponse.ok) {
                                    const paymentResult = await paymentByIntentResponse.json();
                                    console.log(' Payment status updated to PAID via payment-by-intent endpoint');
                                    console.log('   Report ID:', paymentResult.id);
                                    console.log('   Updated report:', paymentResult);
                                    paymentMarked = true;
                                    
                                    // Check if user subscription was upgraded
                                    if (paymentResult.user_upgraded) {
                                        console.log(' User subscription upgraded to:', paymentResult.new_subscription_tier);
                                        // Refresh user data from backend
                                        await refreshUserData();
                                        // Show upgrade notification
                                        if (window.notificationSystem) {
                                            window.notificationSystem.showSuccess(
                                                'Subscription Upgraded!',
                                                `Your subscription has been upgraded to ${paymentResult.new_subscription_tier.replace('_', ' ').toUpperCase()}.`
                                            );
                                        }
                                    }
                                    
                                    // Refresh reports in dashboard if on dashboard page
                                    if (typeof loadFMVReports === 'function') {
                                        setTimeout(() => {
                                            loadFMVReports();
                                        }, 1000);
                                    }
                                } else {
                                    const errorData = await paymentByIntentResponse.json().catch(() => ({ detail: 'Unknown error' }));
                                    console.warn(' Payment-by-intent endpoint failed, trying report ID endpoint:', errorData);
                                }
                            } catch (err) {
                                console.warn(' Payment-by-intent endpoint error, trying report ID endpoint:', err);
                            }
                            
                            // Fallback: If payment-by-intent failed and we have a reportId, try the report ID endpoint
                            if (!paymentMarked && reportId) {
                                try {
                                    const paymentResponse = await fetch(`/api/v1/fmv-reports/${reportId}/payment`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': token ? `Bearer ${token}` : ''
                                        },
                                        body: JSON.stringify({
                                            payment_intent_id: paymentIntent.id,
                                            amount: paymentIntent.amount / 100
                                        })
                                    });
                                    
                                    if (!paymentResponse.ok) {
                                        const paymentError = await paymentResponse.json().catch(() => ({ detail: 'Unknown error' }));
                                        console.error(' Failed to mark payment received via report ID endpoint:', paymentError);
                                        console.error('   Report ID:', reportId);
                                        console.error('   Payment Intent ID:', paymentIntent.id);
                                        console.error('   Amount:', paymentIntent.amount / 100);
                                        console.error('    Report may need manual status update');
                                    } else {
                                        const paymentResult = await paymentResponse.json();
                                        console.log(' Payment status updated to PAID via report ID endpoint');
                                        console.log('   Report ID:', reportId);
                                        console.log('   Updated report:', paymentResult);
                                        paymentMarked = true;
                                        
                                        // Check if user subscription was upgraded
                                        if (paymentResult.user_upgraded) {
                                            console.log(' User subscription upgraded to:', paymentResult.new_subscription_tier);
                                            // Refresh user data from backend
                                            await refreshUserData();
                                            // Show upgrade notification
                                            if (window.notificationSystem) {
                                                window.notificationSystem.showSuccess(
                                                    'Subscription Upgraded!',
                                                    `Your subscription has been upgraded to ${paymentResult.new_subscription_tier.replace('_', ' ').toUpperCase()}.`
                                                );
                                            }
                                        }
                                        
                                        // Refresh reports in dashboard if on dashboard page
                                        if (typeof loadFMVReports === 'function') {
                                            setTimeout(() => {
                                                loadFMVReports();
                                            }, 1000);
                                        }
                                    }
                                } catch (err) {
                                    console.error(' Error marking payment via report ID endpoint:', err);
                                }
                            }
                            
                            if (!paymentMarked) {
                                console.error(' CRITICAL: Could not mark payment received for payment intent:', paymentIntent.id);
                                console.error('   This report will need manual status update or will be auto-fixed on next load');
                                
                                // Store payment intent for retry later
                                const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {}, getItem: () => null };
                                try {
                                    const failedPayments = JSON.parse(safeStorage.getItem('failed_payment_intents') || '[]');
                                    failedPayments.push({
                                        payment_intent_id: paymentIntent.id,
                                        amount: paymentIntent.amount / 100,
                                        report_id: reportId,
                                        timestamp: new Date().toISOString(),
                                        retry_count: 0
                                    });
                                    safeStorage.setItem('failed_payment_intents', JSON.stringify(failedPayments));
                                    console.log(' Stored payment intent for retry:', paymentIntent.id);
                                } catch (e) {
                                    console.warn(' Could not store payment intent for retry:', e);
                                }
                                
                                // Show user a warning
                                if (window.notificationSystem) {
                                    // Use showInfo instead of showWarning - payment succeeded, just status update had issues
                                    window.notificationSystem.showInfo(
                                        'Payment Recorded',
                                        'Your payment was successful. The report status will be updated automatically. You can view your report in the dashboard.'
                                    );
                                }
                            }
                        
                        // Store crane data for results display regardless of report submission status
                        if (craneDetails) {
                            window.lastPaymentCraneData = craneDetails;
                        }
                    } catch (err) {
                        console.error("Failed to submit FMV report:", err);
                        // Even if report submission failed, payment succeeded - show success modal
                        // Try to get craneDetails from form if not already set
                        if (!craneDetails) {
                            try {
                                let manufacturer = document.getElementById('manufacturer')?.value || '';
                                if (manufacturer === 'Other') {
                                    manufacturer = document.getElementById('manufacturerOther')?.value || '';
                                }
                                let model = document.getElementById('model')?.value || '';
                                if (!model) {
                                    model = document.getElementById('fallbackModel')?.value || '';
                                }
                                if (manufacturer && model) {
                                    craneDetails = {
                                        manufacturer: manufacturer,
                                        model: model,
                                        year: parseInt(document.getElementById('year')?.value) || null,
                                        capacity_tons: parseFloat(document.getElementById('capacity')?.value) || null
                                    };
                                }
                            } catch (e) {
                                console.warn('Could not extract craneDetails from form:', e);
                            }
                        }
                        if (craneDetails) {
                            window.lastPaymentCraneData = craneDetails;
                        }
                        // Show info message that payment succeeded but report submission had issues
                        if (window.notificationSystem) {
                            window.notificationSystem.showInfo(
                                'Payment Successful',
                                'Your payment was processed successfully. The report will be created automatically. Please check your dashboard in a moment.'
                            );
                        }
                    }
                } // End of if (!paymentMarked)
                    
                // Show results immediately after payment success
                console.log(' Payment succeeded, showing success modal only (results will show on VIEW RESULTS click)...');
                
                // Mark payment as completed (but don't show results yet - user must click VIEW RESULTS)
                window.paymentCompleted = true;
                
                // Reset submit button state (payment succeeded)
                submitButton.disabled = false;
                submitButton.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> PROCESS PAYMENT';
                
                // Clear any loading indicators
                const loadingDiv = document.getElementById('payment-loading');
                if (loadingDiv) loadingDiv.remove();
                
                // Close payment modal first (with !important override)
                closeStripeModal();
                
                // Small delay to ensure payment modal closes before showing success modal
                setTimeout(() => {
                    // Show success modal
                    const transactionId = paymentIntent.id.substring(0, 8) + '...';
                    const reportName = selectedReport?.name || selectedReportType || 'FMV Report';
                    showPaymentSuccessModal({
                        transactionId: transactionId,
                        paymentIntentId: paymentIntent.id,
                        amount: paymentIntent.amount,
                        reportType: reportName,
                        craneModel: (document.getElementById('manufacturer')?.value || '') + ' ' + (document.getElementById('model')?.value || '') + ' (' + (document.getElementById('year')?.value || '') + ')'
                    });
                }, 100);
                
                    if (window.notificationSystem) {
                        window.notificationSystem.showSuccess('Payment Successful', 'Your FMV report request has been submitted.');
                    }
                } catch (error) {
                    console.error(' Payment failed:', error);
                    if (window.notificationSystem) {
                        window.notificationSystem.showError('Payment Failed', error.message || 'An error occurred during payment processing.');
                    }
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> PROCESS PAYMENT';
                    // Clear any loading indicators
                    const loadingDiv = document.getElementById('payment-loading');
                    if (loadingDiv) loadingDiv.remove();
                }
        });
    }
});

// Handle payment redirect on page load - ONLY if URL parameters exist
window.addEventListener('load', async () => {
    // CRITICAL: Ensure all modals are hidden on page load
    const successModal = document.getElementById('successModal');
    const paymentModal = document.getElementById('stripePaymentModal');
    const paywallModal = document.getElementById('subscriptionPaywallModal');
    if (successModal) successModal.style.display = 'none';
    if (paymentModal) paymentModal.style.display = 'none';
    if (paywallModal) paywallModal.style.display = 'none';
    
    // CRITICAL: Reset payment state on page load (unless returning from payment)
    window.paymentCompleted = false;
    window.bypassSubscriptionCheck = false;
    
    // Check if we're returning from a payment redirect (ONLY show modal if URL params exist)
    const urlParams = new URLSearchParams(window.location.search);
    const redirectStatus = urlParams.get('redirect_status');
    const paymentIntentId = urlParams.get('payment_intent');
    const transactionId = urlParams.get('tx');
    const clientSecret = urlParams.get('payment_intent_client_secret');
    
    // ONLY proceed if ALL required parameters exist (this is a payment redirect)
    // If any parameter is missing, this is a normal page load - do nothing
    if (!redirectStatus || !paymentIntentId || !clientSecret) {
        // Normal page load - no payment redirect, ensure modals are hidden
        console.log(' Normal page load - no payment redirect detected, all modals hidden');
        
        // Retry marking failed payments
        retryFailedPaymentMarkings();
        
        return;
    }
    
    // Only reach here if we have ALL payment redirect parameters
    console.log(' Payment redirect detected, processing...');
    
    // Initialize Stripe first
    await initializeStripe();
    
    if (redirectStatus === 'succeeded' && paymentIntentId && clientSecret) {
        // Payment succeeded - retrieve the PaymentIntent to get details
        try {
            console.log(' Retrieving payment intent after redirect...');
            
            // Wait a bit for Stripe to be fully ready
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (window.stripe) {
                const { paymentIntent } = await window.stripe.retrievePaymentIntent(clientSecret);
                
                console.log(' Payment intent retrieved:', paymentIntent);
                
                if (paymentIntent && paymentIntent.status === 'succeeded') {
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Payment is already confirmed by Stripe, no need to call backend
                    // Submit FMV report if not already submitted
                    try {
                        // Ensure safeStorage is available
                        const safeStorage = window.safeStorage || { getItem: () => null, setItem: () => {}, removeItem: () => {} };
                        const token = safeStorage.getItem('auth_token') || safeStorage.getItem('crane_auth_token');
                        if (token && paymentIntent.metadata) {
                            const craneDetails = {
                                manufacturer: paymentIntent.metadata.crane_manufacturer,
                                model: paymentIntent.metadata.crane_model,
                                year: parseInt(paymentIntent.metadata.crane_year),
                                capacity_tons: parseFloat(paymentIntent.metadata.crane_capacity),
                                hours: parseInt(paymentIntent.metadata.crane_hours) || 0,
                                region: paymentIntent.metadata.crane_region,
                                crane_type: paymentIntent.metadata.crane_type
                            };
                            
                            const reportData = {
                                report_type: paymentIntent.metadata.report_type || 'spot_check',
                                crane_details: craneDetails
                            };
                            
                            const reportResponse = await fetch('/api/v1/fmv-reports/submit', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(reportData)
                            });
                            
                            if (reportResponse.ok) {
                                const reportResult = await reportResponse.json();
                                await fetch(`/api/v1/fmv-reports/${reportResult.id}/payment`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        payment_intent_id: paymentIntent.id,
                                        amount: paymentIntent.amount / 100
                                    })
                                });
                                
                                window.lastPaymentCraneData = craneDetails;
                            }
                        }
                    } catch (err) {
                        console.error("Failed to submit FMV report:", err);
                    }
                    
                    // Show results after successful payment
                    console.log(' Payment succeeded (redirect), showing success modal only (results will show on VIEW RESULTS click)...');
                    
                    // Mark payment as completed (but don't show results yet)
                    window.paymentCompleted = true;
                    
                    // Get crane details from payment intent metadata if available
                    if (paymentIntent.metadata) {
                        const craneDetails = {
                            manufacturer: paymentIntent.metadata.crane_manufacturer,
                            model: paymentIntent.metadata.crane_model,
                            year: paymentIntent.metadata.crane_year,
                            capacity_tons: paymentIntent.metadata.crane_capacity,
                            hours: paymentIntent.metadata.crane_hours,
                            region: paymentIntent.metadata.crane_region,
                            crane_type: paymentIntent.metadata.crane_type
                        };
                        window.lastPaymentCraneData = craneDetails;
                    }
                    
                    // Show success modal
                    showPaymentSuccessModal({
                        transactionId: transactionId || 'N/A',
                        paymentIntentId: paymentIntent.id,
                        amount: paymentIntent.amount,
                        reportType: paymentIntent.metadata?.report_type || 'FMV Report',
                        craneModel: `${paymentIntent.metadata?.crane_manufacturer || 'N/A'} ${paymentIntent.metadata?.crane_model || ''} (${paymentIntent.metadata?.crane_year || ''})`
                    });
                    
                    if (window.notificationSystem) {
                        window.notificationSystem.showSuccess('Payment Successful', 'Your FMV report request has been submitted.');
                    }
                }
            } else {
                console.error(' Stripe not initialized');
            }
        } catch (error) {
            console.error(' Error retrieving payment intent:', error);
        }
    }
});

</script>



<style>
.tab-btn.active {
    color: #00FF85 !important;
    border-bottom-color: #00FF85 !important;
}

/* Ensure bulk processing tab text stays on one line */
#bulkProcessingTab {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    min-width: fit-content !important;
    max-width: none !important;
    width: auto !important;
}

.tab-btn {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}
.tab-btn:hover:not(.active) {
    color: #FFFFFF !important;
}

/* Fix for analysis tabs - ensure content is always visible */
.analysis-tab {
    transition: all 0.3s ease;
}

.analysis-tab.active {
    color: #00FF85 !important;
    border-bottom: 2px solid #00FF85 !important;
}

.tab-content {
    min-height: 400px;
    opacity: 1 !important;
    visibility: visible !important;
    display: none;
}

.tab-content.active {
    display: block !important;
}

/* Ensure tab content doesn't collapse */
#resultsTabContent .tab-content {
    min-height: 400px;
    padding: 20px 0;
    overflow: visible !important;
    max-height: none !important;
}

#breakdownContent,
#rentalContent,
#comparablesContent,
#riskContent,
#overviewContent {
    min-height: 350px;
    overflow: visible !important;
    max-height: none !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
}

/* Prevent text truncation in results */
#resultsTabContent * {
    overflow: visible !important;
    text-overflow: clip !important;
    white-space: normal !important;
}

/* Ensure all content is visible */
.chart-container,
.metric-card,
.detail-grid,
.detail-item {
    overflow: visible !important;
    max-height: none !important;
}

/* Fix table overflow */
#resultsTabContent table {
    width: 100% !important;
    table-layout: auto !important;
    overflow: visible !important;
}

#resultsTabContent th,
#resultsTabContent td {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    max-width: none !important;
}
</style>

<script>
let currentValuationResults = null;
let currentResultsTab = 'overview';

function viewValuationResults() {
    // Mark payment as completed when user clicks "VIEW RESULTS" from success modal
    window.paymentCompleted = true;
    
    // Close success modal
    closeSuccessModal();
    
    // NOW show results - payment is confirmed
    
    // Remove blur from results section and make it interactive
    const resultsSection = document.getElementById('valuationResultsSection');
    if (resultsSection) {
        // Use setProperty to ensure it overrides any CSS
        resultsSection.style.setProperty('filter', 'none', 'important');
        resultsSection.style.setProperty('pointer-events', 'auto', 'important');
        resultsSection.style.setProperty('display', 'block', 'important');
        resultsSection.style.setProperty('visibility', 'visible', 'important');
    }
    
    // Also remove blur from resultsTabContent if it exists
    const resultsTabContent = document.getElementById('resultsTabContent');
    if (resultsTabContent) {
        resultsTabContent.style.setProperty('filter', 'none', 'important');
        resultsTabContent.style.setProperty('pointer-events', 'auto', 'important');
    }
    
    // Get crane details from stored payment data or form
    let craneData;
    if (window.lastPaymentCraneData) {
        craneData = window.lastPaymentCraneData;
    } else {
        // Fallback to form data
        const manufacturer = document.getElementById('manufacturer')?.value;
        const model = document.getElementById('model')?.value;
        const year = parseInt(document.getElementById('year')?.value);
        const capacity = parseFloat(document.getElementById('capacity')?.value);
        const operatingHours = parseInt(document.getElementById('operatingHours')?.value);
        const region = document.getElementById('region')?.value;
        
        if (!manufacturer || !model || !year || !capacity) {
            if (window.notificationSystem) {
                window.notificationSystem.showError('Validation Error', 'Please fill in all required crane details to view results.');
            }
            return;
        }
        
        craneData = {
            manufacturer,
            model,
            year,
            capacity,
            operatingHours,
            region,
            craneType: document.getElementById('craneType')?.value,
            boomLength: parseFloat(document.getElementById('boomLength')?.value) || null,
            jibIncluded: document.getElementById('jibIncluded')?.value,
            jibLength: parseFloat(document.getElementById('jibLength')?.value) || null
        };
    }
    
    // Show loading notification
    const loadingId = window.notificationSystem ? window.notificationSystem.showInfo('Calculating', 'Generating valuation results...', 0) : null;
    
    // Perform valuation calculation
    performValuationCalculation(craneData).then(results => {
        if (loadingId && window.notificationSystem) {
            window.notificationSystem.hideLoading(loadingId);
        }
        
        currentValuationResults = results;
        
        // Only display results if user has paid or has active subscription
        // For free tier users, they need to purchase first
        const token = getAuthToken();
        if (token && !window.paymentCompleted) {
            // Check subscription - if free tier, show paywall instead of results
            fetch('/api/v1/payments/subscription-info', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                return null;
            }).then(subscriptionData => {
                if (subscriptionData) {
                    const tier = subscriptionData.tier || 'free';
                    if (tier === 'free') {
                        // Free tier - show paywall, don't show results
                        console.log(' Free tier user - showing paywall instead of results');
                        if (typeof window.showSubscriptionPaywall === 'function') {
                            window.showSubscriptionPaywall('free', subscriptionData);
                        }
                        if (window.notificationSystem) {
                            window.notificationSystem.showInfo('Subscription Required', 'Please purchase a report to view detailed valuation results.');
                        }
                        return;
                    }
                }
                // Paid tier - show results
                // Ensure results section is unblurred and visible
                const resultsSection = document.getElementById('valuationResultsSection');
                if (resultsSection) {
                    resultsSection.style.setProperty('filter', 'none', 'important');
                    resultsSection.style.setProperty('pointer-events', 'auto', 'important');
                    resultsSection.style.setProperty('display', 'block', 'important');
                    resultsSection.style.setProperty('visibility', 'visible', 'important');
                }
                // Also remove blur from resultsTabContent
                const resultsTabContent = document.getElementById('resultsTabContent');
                if (resultsTabContent) {
                    resultsTabContent.style.setProperty('filter', 'none', 'important');
                    resultsTabContent.style.setProperty('pointer-events', 'auto', 'important');
                }
                displayValuationResults(results);
                if (resultsSection) {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                if (window.notificationSystem) {
                    window.notificationSystem.showSuccess('Valuation Complete', 'Your crane valuation results are ready.');
                }
            }).catch(error => {
                console.error('Error checking subscription:', error);
                // On error, show paywall
                if (typeof window.showSubscriptionPaywall === 'function') {
                    window.showSubscriptionPaywall('free', null);
                }
            });
        } else if (window.paymentCompleted) {
            // Payment completed - show results
            // Ensure results section is unblurred and visible
            const resultsSection = document.getElementById('valuationResultsSection');
            if (resultsSection) {
                resultsSection.style.setProperty('filter', 'none', 'important');
                resultsSection.style.setProperty('pointer-events', 'auto', 'important');
                resultsSection.style.setProperty('display', 'block', 'important');
                resultsSection.style.setProperty('visibility', 'visible', 'important');
            }
            // Also remove blur from resultsTabContent
            const resultsTabContent = document.getElementById('resultsTabContent');
            if (resultsTabContent) {
                resultsTabContent.style.setProperty('filter', 'none', 'important');
                resultsTabContent.style.setProperty('pointer-events', 'auto', 'important');
            }
            displayValuationResults(results);
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            if (window.notificationSystem) {
                window.notificationSystem.showSuccess('Valuation Complete', 'Your crane valuation results are ready.');
            }
        } else {
            // No token - show paywall
            if (typeof window.showSubscriptionPaywall === 'function') {
                window.showSubscriptionPaywall('free', null);
            }
        }
    }).catch(error => {
        if (loadingId && window.notificationSystem) {
            window.notificationSystem.hideLoading(loadingId);
        }
        console.error('Valuation error:', error);
        if (window.notificationSystem) {
            window.notificationSystem.showError('Valuation Error', error.message || 'Failed to calculate valuation. Please try again.');
        }
    });
}

async function performValuationCalculation(craneData) {
    try {
        // Call valuation API
        const token = safeStorage.getItem('auth_token') || safeStorage.getItem('crane_auth_token');
        // Try to call valuation API, but fallback to client-side calculation if it fails
        try {
            const response = await fetch('/api/v1/valuation/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify({
                    manufacturer: craneData.manufacturer,
                    model: craneData.model,
                    year: craneData.year,
                    capacity_tons: craneData.capacity,
                    operating_hours: craneData.operatingHours || craneData.hours,
                    region: craneData.region,
                    crane_type: craneData.craneType || craneData.crane_type,
                    boom_length: craneData.boomLength || craneData.boom_length,
                    // Removed: jib_included, jib_length
                })
            });
            
            if (!response.ok) {
                // API endpoint doesn't exist or method not allowed - use fallback
                console.log('Valuation API not available, using fallback calculation');
                return calculateValuationFallback(craneData);
            }
            
            const data = await response.json();
            return data;
        } catch (fetchError) {
            // Network error or API doesn't exist - use fallback
            console.log('Valuation API error, using fallback calculation:', fetchError);
            return calculateValuationFallback(craneData);
        }
    } catch (error) {
        console.error('Valuation API error:', error);
        // Fallback to client-side calculation
        return calculateValuationFallback(craneData);
    }
}

function calculateValuationFallback(craneData) {
    // Simplified fallback calculation
    const capacity = craneData.capacity || craneData.capacity_tons;
    const year = craneData.year;
    const operatingHours = craneData.operatingHours || craneData.hours || 0;
    const region = craneData.region;
    
    const baseValue = capacity * 5000; // $5,000 per ton base
    const currentYear = new Date().getFullYear();
    const age = currentYear - year;
    const ageDepreciation = baseValue * (age * 0.05); // 5% per year
    const hoursFactor = operatingHours > 10000 ? 0.85 : 1.0;
    const regionalMultiplier = region === 'North America' ? 1.05 : (region === 'Europe' ? 0.95 : 1.0);
    
    const estimatedValue = ((baseValue - ageDepreciation) * hoursFactor) * regionalMultiplier;
    const confidence = Math.max(70, 100 - (age * 2) - (operatingHours > 10000 ? 10 : 0));
    
    return {
        estimated_value: estimatedValue,
        estimatedValue: estimatedValue,
        confidence_score: confidence,
        confidenceScore: confidence,
        base_value: baseValue,
        baseValue: baseValue,
        age_depreciation: ageDepreciation,
        ageDepreciation: ageDepreciation,
        hours_adjustment: (baseValue - ageDepreciation) * (1 - hoursFactor),
        hoursAdjustment: (baseValue - ageDepreciation) * (1 - hoursFactor),
        regional_factor: regionalMultiplier,
        regionalFactor: regionalMultiplier,
        comparables: [],
        comparable_sales: [],
        market_analysis: {
            trend: 'Stable',
            demand: 'Moderate'
        },
        marketAnalysis: {
            trend: 'Stable',
            demand: 'Moderate'
        }
    };
}

function displayValuationResults(results) {
    // Only show results if payment has been completed or user has active subscription
    // Check if this is a paid report (has payment intent) or user has subscription
    const hasPayment = window.lastPaymentDetails || window.paymentCompleted === true;
    const token = getAuthToken();
    
    // If no payment and user is free tier, don't show results - show paywall instead
    if (!hasPayment && token) {
        // Check subscription tier
        fetch('/api/v1/payments/subscription-info', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }).then(response => {
            if (response.ok) {
                return response.json();
            }
            return null;
        }).then(subscriptionData => {
            if (subscriptionData) {
                const tier = subscriptionData.tier || 'free';
                if (tier === 'free') {
                    // Free tier user trying to view results without payment - show paywall
                    console.log(' Free tier user trying to view results - showing paywall');
                    if (typeof window.showSubscriptionPaywall === 'function') {
                        window.showSubscriptionPaywall('free', subscriptionData);
                    }
                    return; // Don't show results
                }
            }
            // Paid tier or payment completed - show results
            showResultsSection(results);
        }).catch(error => {
            console.error('Error checking subscription for results display:', error);
            // On error, don't show results - require payment
            if (typeof window.showSubscriptionPaywall === 'function') {
                window.showSubscriptionPaywall('free', null);
            }
        });
    } else if (hasPayment) {
        // Payment completed - show results
        showResultsSection(results);
    } else {
        // No payment and no token - show paywall
        if (typeof window.showSubscriptionPaywall === 'function') {
            window.showSubscriptionPaywall('free', null);
        }
    }
}

function showResultsSection(results) {
    // RADICAL GUARD: Check payment before showing ANY results
    if (!window.canShowResults || !window.canShowResults()) {
        console.log(' BLOCKED: showResultsSection called without payment');
        // Show paywall instead
        const token = getAuthToken();
        if (token && typeof window.showSubscriptionPaywall === 'function') {
            fetch('/api/v1/payments/subscription-info', {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(r => r.ok ? r.json() : null).then(data => {
                window.showSubscriptionPaywall('free', data);
            }).catch(() => {
                window.showSubscriptionPaywall('free', null);
            });
        }
        return;
    }
    
    // Payment verified - show results
    const resultsSection = document.getElementById('valuationResultsSection');
    if (resultsSection) {
        // Remove blur and make interactive - use setProperty with !important to override any CSS
        resultsSection.style.setProperty('filter', 'none', 'important');
        resultsSection.style.setProperty('pointer-events', 'auto', 'important');
        resultsSection.style.setProperty('display', 'block', 'important');
        resultsSection.style.setProperty('visibility', 'visible', 'important');
    }
    
    // Also remove blur from resultsTabContent if it exists
    const resultsTabContent = document.getElementById('resultsTabContent');
    if (resultsTabContent) {
        resultsTabContent.style.setProperty('filter', 'none', 'important');
        resultsTabContent.style.setProperty('pointer-events', 'auto', 'important');
    }
    
    // Populate all results data into all tabs
    if (results) {
        populateAllValuationResults(results);
    } else if (currentValuationResults) {
        // Use stored results if available
        populateAllValuationResults(currentValuationResults);
    } else {
        console.warn(' No results data available to populate');
    }
}

// Comprehensive function to populate all valuation results
function populateAllValuationResults(results) {
    console.log(' Populating all valuation results:', results);
    
    // Store results globally for tab switching
    currentValuationResults = results;
    
    // Extract values from results
    const value = results.estimated_value || results.estimatedValue || 0;
    const confidence = results.confidence_score || results.confidenceScore || 85;
    const baseValue = results.base_value || results.baseValue || (value * 1.2);
    const ageDepreciation = results.age_depreciation || results.ageDepreciation || 0;
    const hoursAdjustment = results.hours_adjustment || results.hoursAdjustment || 0;
    const regionalFactor = results.regional_factor || results.regionalFactor || 1.0;
    const ageFactor = results.age_factor || results.ageFactor || 0.88;
    const conditionScore = results.condition_score || results.conditionScore || 85;
    const marketDemand = results.market_demand || results.marketDemand || 'High';
    const riskScore = results.risk_score || results.riskScore || 'Low';
    
    // Calculate manufacturer and model premiums (simplified)
    const capacityBasePrice = baseValue * 0.6;
    const manufacturerPremium = baseValue * 0.2;
    const modelPremium = baseValue * 0.2;
    const subtotal = capacityBasePrice + manufacturerPremium + modelPremium;
    
    // Calculate rental rates (simplified - 2-3% of value per month)
    const bareRentalMonthly = value * 0.025;
    const operatedRentalMonthly = value * 0.035;
    const bareRental5Year = bareRentalMonthly * 60;
    const operatedRental5Year = operatedRentalMonthly * 60;
    const purchaseOperatingCost = value * 0.15; // 15% of value for 5 years
    const purchaseTotalCost = value + purchaseOperatingCost;
    
    // Risk analysis
    const marketRisk = results.market_risk || results.marketRisk || 'Low';
    const conditionRisk = results.condition_risk || results.conditionRisk || 'Medium';
    const ageRisk = results.age_risk || results.ageRisk || 'Low';
    const locationRisk = results.location_risk || results.locationRisk || 'Low';
    const overallRisk = results.overall_risk || results.overallRisk || 'Low';
    
    // Resale projections
    const resale1Year = value * 0.95;
    const resale3Years = value * 0.85;
    const resale5Years = value * 0.75;
    
    // Populate main metrics cards
    const estimatedValueEl = document.getElementById('resultsEstimatedValue');
    const valueDifferenceEl = document.getElementById('resultsValueDifference');
    const confidenceScoreEl = document.getElementById('resultsConfidenceScore');
    const confidenceLevelEl = document.getElementById('resultsConfidenceLevel');
    const dealGradeEl = document.getElementById('resultsDealGrade');
    const dealRecommendationEl = document.getElementById('resultsDealRecommendation');
    
    if (estimatedValueEl) estimatedValueEl.textContent = formatCurrency(value);
    if (valueDifferenceEl) {
        valueDifferenceEl.textContent = '+5.2% vs market avg';
        valueDifferenceEl.style.color = '#00FF85';
    }
    if (confidenceScoreEl) {
        confidenceScoreEl.textContent = confidence + '%';
        confidenceScoreEl.style.color = confidence >= 80 ? '#00FF85' : '#FFB800';
    }
    if (confidenceLevelEl) {
        confidenceLevelEl.textContent = confidence >= 90 ? 'High' : confidence >= 70 ? 'Moderate' : 'Low';
    }
    if (dealGradeEl) {
        dealGradeEl.textContent = getDealGrade(value, confidence);
        dealGradeEl.style.color = '#00FF85';
    }
    if (dealRecommendationEl) {
        dealRecommendationEl.textContent = confidence >= 80 ? 'Strong Buy' : confidence >= 70 ? 'Buy' : 'Hold';
    }
    
    // Populate overview tab metrics
    const ageFactorEl = document.getElementById('resultsAgeFactor');
    const conditionEl = document.getElementById('resultsCondition');
    const marketDemandEl = document.getElementById('resultsMarketDemand');
    const riskScoreEl = document.getElementById('resultsRiskScore');
    
    if (ageFactorEl) ageFactorEl.textContent = Math.round(ageFactor * 100) + '%';
    if (conditionEl) conditionEl.textContent = conditionScore + '/100';
    if (marketDemandEl) marketDemandEl.textContent = marketDemand;
    if (riskScoreEl) riskScoreEl.textContent = riskScore;
    
    // Populate breakdown tab
    const breakdownCapacityBaseEl = document.getElementById('breakdownCapacityBase');
    const breakdownManufacturerPremiumEl = document.getElementById('breakdownManufacturerPremium');
    const breakdownModelPremiumEl = document.getElementById('breakdownModelPremium');
    const breakdownSubtotalEl = document.getElementById('breakdownSubtotal');
    const breakdownAgeDepreciationEl = document.getElementById('breakdownAgeDepreciation');
    const breakdownHoursAdjEl = document.getElementById('breakdownHoursAdj');
    const breakdownRegionalFactorEl = document.getElementById('breakdownRegionalFactor');
    const breakdownTotalAdjustmentsEl = document.getElementById('breakdownTotalAdjustments');
    
    if (breakdownCapacityBaseEl) breakdownCapacityBaseEl.textContent = formatCurrency(capacityBasePrice);
    if (breakdownManufacturerPremiumEl) breakdownManufacturerPremiumEl.textContent = formatCurrency(manufacturerPremium);
    if (breakdownModelPremiumEl) breakdownModelPremiumEl.textContent = formatCurrency(modelPremium);
    if (breakdownSubtotalEl) breakdownSubtotalEl.textContent = formatCurrency(subtotal);
    if (breakdownAgeDepreciationEl) breakdownAgeDepreciationEl.textContent = '-' + formatCurrency(Math.abs(ageDepreciation));
    if (breakdownHoursAdjEl) breakdownHoursAdjEl.textContent = (hoursAdjustment >= 0 ? '+' : '') + formatCurrency(hoursAdjustment);
    if (breakdownRegionalFactorEl) breakdownRegionalFactorEl.textContent = (regionalFactor * 100).toFixed(0) + '%';
    if (breakdownTotalAdjustmentsEl) {
        const totalAdj = ageDepreciation + hoursAdjustment;
        breakdownTotalAdjustmentsEl.textContent = (totalAdj >= 0 ? '+' : '') + formatCurrency(totalAdj);
    }
    
    // Populate rental tab
    const rentalBareMonthlyEl = document.getElementById('rentalBareMonthly');
    const rentalOperatedMonthlyEl = document.getElementById('rentalOperatedMonthly');
    const purchaseInitialCostEl = document.getElementById('purchaseInitialCost');
    const purchaseOperatingCostEl = document.getElementById('purchaseOperatingCost');
    const purchaseTotalCostEl = document.getElementById('purchaseTotalCost');
    const rentalBare5YearEl = document.getElementById('rentalBare5Year');
    const rentalBareTotalEl = document.getElementById('rentalBareTotal');
    const rentalOperated5YearEl = document.getElementById('rentalOperated5Year');
    const rentalOperatedTotalEl = document.getElementById('rentalOperatedTotal');
    
    if (rentalBareMonthlyEl) rentalBareMonthlyEl.textContent = formatCurrency(bareRentalMonthly);
    if (rentalOperatedMonthlyEl) rentalOperatedMonthlyEl.textContent = formatCurrency(operatedRentalMonthly);
    if (purchaseInitialCostEl) purchaseInitialCostEl.textContent = formatCurrency(value);
    if (purchaseOperatingCostEl) purchaseOperatingCostEl.textContent = formatCurrency(purchaseOperatingCost);
    if (purchaseTotalCostEl) purchaseTotalCostEl.textContent = formatCurrency(purchaseTotalCost);
    if (rentalBare5YearEl) rentalBare5YearEl.textContent = formatCurrency(bareRental5Year);
    if (rentalBareTotalEl) rentalBareTotalEl.textContent = formatCurrency(bareRental5Year);
    if (rentalOperated5YearEl) rentalOperated5YearEl.textContent = formatCurrency(operatedRental5Year);
    if (rentalOperatedTotalEl) rentalOperatedTotalEl.textContent = formatCurrency(operatedRental5Year);
    
    // Populate comparables tab
    let comparables = results.comparables || results.comparable_sales || [];
    
    // If no comparables, generate sample data based on the valuation
    if (comparables.length === 0 && value > 0) {
        const craneData = results.crane_details || results.craneDetails || {};
        const manufacturer = craneData.manufacturer || 'Liebherr';
        const model = craneData.model || 'LTM 1500';
        const year = craneData.year || 2020;
        const capacity = craneData.capacity || 500;
        const region = craneData.region || 'North America';
        
        // Generate 3-5 sample comparables
        comparables = [
            {
                manufacturer: manufacturer,
                model: model,
                type: craneData.crane_type || 'All-Terrain Crane',
                year: year - 1,
                capacity: capacity,
                capacity_tons: capacity,
                hours: (craneData.operating_hours || 5000) + 1000,
                price: value * 0.95,
                sale_price: value * 0.95,
                location: region,
                region: region
            },
            {
                manufacturer: manufacturer,
                model: model,
                type: craneData.crane_type || 'All-Terrain Crane',
                year: year,
                capacity: capacity * 1.1,
                capacity_tons: capacity * 1.1,
                hours: (craneData.operating_hours || 5000) - 500,
                price: value * 1.05,
                sale_price: value * 1.05,
                location: region,
                region: region
            },
            {
                manufacturer: manufacturer,
                model: model,
                type: craneData.crane_type || 'All-Terrain Crane',
                year: year + 1,
                capacity: capacity * 0.9,
                capacity_tons: capacity * 0.9,
                hours: (craneData.operating_hours || 5000) - 2000,
                price: value * 1.10,
                sale_price: value * 1.10,
                location: region,
                region: region
            },
            {
                manufacturer: manufacturer,
                model: model,
                type: craneData.crane_type || 'All-Terrain Crane',
                year: year - 2,
                capacity: capacity,
                capacity_tons: capacity,
                hours: (craneData.operating_hours || 5000) + 2000,
                price: value * 0.88,
                sale_price: value * 0.88,
                location: region,
                region: region
            },
            {
                manufacturer: manufacturer,
                model: model,
                type: craneData.crane_type || 'All-Terrain Crane',
                year: year,
                capacity: capacity * 1.2,
                capacity_tons: capacity * 1.2,
                hours: (craneData.operating_hours || 5000),
                price: value * 1.15,
                sale_price: value * 1.15,
                location: region,
                region: region
            }
        ];
    }
    
    const comparablesTableBody = document.getElementById('comparablesTableBody');
    if (comparablesTableBody) {
        if (comparables.length === 0) {
            comparablesTableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="padding: 40px; text-align: center; color: #888; font-size: 14px;">
                        <div style="margin-bottom: 10px;"></div>
                        <div>No comparable sales data available at this time.</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">Comparable sales data will be included in your full professional report.</div>
                    </td>
                </tr>
            `;
        } else {
            comparablesTableBody.innerHTML = comparables.map(comp => {
                const compCapacity = comp.capacity || comp.capacity_tons || 0;
                const compPrice = comp.price || comp.sale_price || 0;
                const pricePerTon = compCapacity > 0 ? Math.round(compPrice / compCapacity) : 0;
                
                return `
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 12px; color: #FFFFFF; font-weight: 500;">${(comp.manufacturer || 'N/A')} ${(comp.model || 'N/A')}</td>
                    <td style="padding: 12px; color: #B0B0B0;">${comp.type || comp.crane_type || 'N/A'}</td>
                    <td style="padding: 12px; text-align: center; color: #B0B0B0;">${comp.year || 'N/A'}</td>
                    <td style="padding: 12px; text-align: center; color: #B0B0B0;">${compCapacity > 0 ? compCapacity + 'T' : 'N/A'}</td>
                    <td style="padding: 12px; text-align: center; color: #B0B0B0;">${comp.hours ? comp.hours.toLocaleString() : 'N/A'}</td>
                    <td style="padding: 12px; text-align: right; color: #00FF88; font-weight: 600;">${compPrice > 0 ? formatCurrency(compPrice) : 'N/A'}</td>
                    <td style="padding: 12px; text-align: right; color: #B0B0B0;">${pricePerTon > 0 ? '$' + pricePerTon.toLocaleString() : 'N/A'}</td>
                    <td style="padding: 12px; text-align: center; color: #B0B0B0;">${comp.location || comp.region || 'N/A'}</td>
                </tr>
            `;
            }).join('');
        }
    }
    
    // Populate risk tab
    const riskMarketRiskEl = document.getElementById('riskMarketRisk');
    const riskConditionRiskEl = document.getElementById('riskConditionRisk');
    const riskAgeRiskEl = document.getElementById('riskAgeRisk');
    const riskLocationRiskEl = document.getElementById('riskLocationRisk');
    const riskOverallRiskEl = document.getElementById('riskOverallRisk');
    const resale1YearEl = document.getElementById('resale1Year');
    const resale3YearsEl = document.getElementById('resale3Years');
    const resale5YearsEl = document.getElementById('resale5Years');
    
    if (riskMarketRiskEl) riskMarketRiskEl.textContent = marketRisk;
    if (riskConditionRiskEl) riskConditionRiskEl.textContent = conditionRisk;
    if (riskAgeRiskEl) riskAgeRiskEl.textContent = ageRisk;
    if (riskLocationRiskEl) riskLocationRiskEl.textContent = locationRisk;
    if (riskOverallRiskEl) riskOverallRiskEl.textContent = overallRisk;
    if (resale1YearEl) resale1YearEl.textContent = formatCurrency(resale1Year);
    if (resale3YearsEl) resale3YearsEl.textContent = formatCurrency(resale3Years);
    if (resale5YearsEl) resale5YearsEl.textContent = formatCurrency(resale5Years);
    
    // Initialize trend chart
    initializeTrendChart(results);
    
}

// Initialize trend chart with actual data
function initializeTrendChart(results) {
    const canvas = document.getElementById('resultsTrendChart');
    if (!canvas) {
        console.warn('resultsTrendChart canvas not found');
        return;
    }
    
    // Destroy existing chart if it exists
    if (window.resultsTrendChartInstance) {
        window.resultsTrendChartInstance.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    const value = results.estimated_value || results.estimatedValue || 0;
    
    // Generate 12 months of trend data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const baseValue = value;
    const data = months.map((_, i) => {
        const trend = Math.sin((i / 12) * Math.PI * 2) * 0.1; // Sinusoidal trend
        return baseValue * (1 + trend);
    });
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not available, skipping chart initialization');
        return;
    }
    
    window.resultsTrendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Valuation Trend',
                data: data,
                borderColor: '#00FF85',
                backgroundColor: 'rgba(0, 255, 133, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        color: '#888',
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(2) + 'M';
                        }
                    },
                    grid: {
                        color: '#333'
                    }
                },
                x: {
                    ticks: {
                        color: '#888'
                    },
                    grid: {
                        color: '#333'
                    }
                }
            }
        }
    });
}

function displayOverviewTab(results) {
    // This function is kept for backward compatibility but populateAllValuationResults does the work
    populateAllValuationResults(results);
}

function displayBreakdownTab(results) {
    const content = document.getElementById('breakdownContent');
    if (!content) {
        console.warn('breakdownContent element not found');
        return;
    }
    const baseValue = results.base_value || results.baseValue || 0;
    const ageDepreciation = results.age_depreciation || results.ageDepreciation || 0;
    const hoursAdjustment = results.hours_adjustment || results.hoursAdjustment || 0;
    const regionalFactor = results.regional_factor || results.regionalFactor || 1.0;
    const finalValue = results.estimated_value || results.estimatedValue || 0;
    
    content.innerHTML = `
        <div style="background: #2A2A2A; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #00FF85; margin-bottom: 20px; font-size: 20px; text-transform: uppercase;">Value Breakdown</h3>
            <div style="display: grid; gap: 15px;">
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #1A1A1A; border-radius: 6px;">
                    <span style="color: #B0B0B0;">Base Value</span>
                    <span style="color: #FFFFFF; font-weight: 600;">${formatCurrency(baseValue)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #1A1A1A; border-radius: 6px;">
                    <span style="color: #B0B0B0;">Age Depreciation</span>
                    <span style="color: #FF4444; font-weight: 600;">-${formatCurrency(ageDepreciation)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #1A1A1A; border-radius: 6px;">
                    <span style="color: #B0B0B0;">Hours Adjustment</span>
                    <span style="color: ${hoursAdjustment >= 0 ? '#00FF85' : '#FF4444'}; font-weight: 600;">${hoursAdjustment >= 0 ? '+' : ''}${formatCurrency(hoursAdjustment)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #1A1A1A; border-radius: 6px;">
                    <span style="color: #B0B0B0;">Regional Factor</span>
                    <span style="color: #FFFFFF; font-weight: 600;">${(regionalFactor * 100).toFixed(0)}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 15px; background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); border-radius: 6px; border: 2px solid #00FF85; margin-top: 10px;">
                    <span style="color: #00FF85; font-weight: 700; font-size: 18px;">Final Estimated Value</span>
                    <span style="color: #00FF85; font-weight: 800; font-size: 24px;">${formatCurrency(finalValue)}</span>
                </div>
            </div>
        </div>
    `;
}

function displayComparablesTab(results) {
    const content = document.getElementById('comparablesContent');
    if (!content) {
        console.warn('comparablesContent element not found');
        return;
    }
    const comparables = results.comparables || results.comparable_sales || [];
    
    if (comparables.length === 0) {
        content.innerHTML = `
            <div style="background: #2A2A2A; padding: 40px; border-radius: 12px; text-align: center; color: #B0B0B0;">
                <p>No comparable sales data available at this time.</p>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div style="background: #2A2A2A; padding: 30px; border-radius: 12px;">
            <h3 style="color: #00FF85; margin-bottom: 20px; font-size: 20px; text-transform: uppercase;">Comparable Sales</h3>
            <div style="display: grid; gap: 15px;">
                ${comparables.map((comp, index) => `
                    <div style="background: #1A1A1A; padding: 20px; border-radius: 8px; border-left: 3px solid #00FF85;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #FFFFFF; font-weight: 600;">${comp.manufacturer || 'N/A'} ${comp.model || 'N/A'}</span>
                            <span style="color: #00FF85; font-weight: 700; font-size: 18px;">${formatCurrency(comp.price || comp.sale_price || 0)}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; color: #B0B0B0; font-size: 14px;">
                            <div>Year: ${comp.year || 'N/A'}</div>
                            <div>Capacity: ${comp.capacity || 'N/A'}T</div>
                            <div>Hours: ${comp.hours ? comp.hours.toLocaleString() : 'N/A'}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function displayMarketTab(results) {
    const content = document.getElementById('marketContent');
    if (!content) {
        console.warn('marketContent element not found, skipping market tab display');
        return;
    }
    
    const marketAnalysis = results.market_analysis || results.marketAnalysis || {};
    
    content.innerHTML = `
        <div style="background: #2A2A2A; padding: 30px; border-radius: 12px;">
            <h3 style="color: #00FF85; margin-bottom: 20px; font-size: 20px; text-transform: uppercase;">Market Analysis</h3>
            <div style="display: grid; gap: 20px;">
                <div style="background: #1A1A1A; padding: 20px; border-radius: 8px;">
                    <div style="color: #B0B0B0; margin-bottom: 8px;">Market Trend</div>
                    <div style="color: #00FF85; font-size: 24px; font-weight: 600;">${marketAnalysis.trend || 'Stable'}</div>
                </div>
                <div style="background: #1A1A1A; padding: 20px; border-radius: 8px;">
                    <div style="color: #B0B0B0; margin-bottom: 8px;">Demand Level</div>
                    <div style="color: #00FF85; font-size: 24px; font-weight: 600;">${marketAnalysis.demand || 'Moderate'}</div>
                </div>
            </div>
        </div>
    `;
}

function switchResultsTab(tabName, element) {
    currentResultsTab = tabName;
    
    // Only target analysis tabs within the results section
    const resultsSection = document.getElementById('valuationResultsSection');
    if (!resultsSection) {
        console.warn('valuationResultsSection not found');
        return;
    }
    
    // Update analysis tab buttons within results section only
    resultsSection.querySelectorAll('.analysis-tab').forEach(btn => {
        btn.classList.remove('active');
        // Remove active border styling
        btn.style.borderBottom = '2px solid transparent';
        btn.style.color = '#B0B0B0';
    });
    
    if (element) {
        element.classList.add('active');
        // Add active border styling
        element.style.borderBottom = '2px solid #00FF85';
        element.style.color = '#00FF85';
    }
    
    // Update analysis sections within results section only
    const resultsTabContent = document.getElementById('resultsTabContent');
    if (resultsTabContent) {
        resultsTabContent.querySelectorAll('.tab-content').forEach(section => {
            section.style.display = 'none';
            section.classList.remove('active');
        });
    }
    
    // Show selected tab
    const tabId = tabName === 'breakdown' ? 'breakdown-tab' : 
                  tabName === 'rental' ? 'rental-tab' :
                  tabName === 'comparables' ? 'comparables-tab' :
                  tabName === 'risk' ? 'risk-tab' : 'overview-tab';
    
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.style.display = 'block';
        selectedTab.classList.add('active');
        // Ensure tab content is visible and has proper height
        selectedTab.style.minHeight = '400px';
        selectedTab.style.opacity = '1';
        selectedTab.style.visibility = 'visible';
        selectedTab.style.overflow = 'visible';
        selectedTab.style.maxHeight = 'none';
    } else {
        console.warn(`Tab with id "${tabId}" not found`);
    }
    
    // Re-populate data if results exist (in case tab was switched before data was loaded)
    if (currentValuationResults) {
        populateAllValuationResults(currentValuationResults);
    }
    
    // Initialize charts if needed
    if (tabName === 'overview' && currentValuationResults) {
        initializeTrendChart(currentValuationResults);
    }
    
    // Log for debugging
    console.log(`Switched to tab: ${tabName}, tabId: ${tabId}, found: ${!!selectedTab}`);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function getDealGrade(value, confidence) {
    if (confidence >= 90) return 'A+';
    if (confidence >= 80) return 'A';
    if (confidence >= 70) return 'B+';
    if (confidence >= 60) return 'B';
    return 'C+';
}

// Update payment success to trigger valuation
const originalShowPaymentSuccessModal = window.showPaymentSuccessModal;
window.showPaymentSuccessModal = function(details) {
    if (originalShowPaymentSuccessModal) {
        originalShowPaymentSuccessModal(details);
    } else {
        // Fallback implementation - only show if not force-hidden
        const successModal = document.getElementById('successModal');
        if (successModal && !successModal.getAttribute('data-force-hidden')) {
            successModal.removeAttribute('data-force-hidden');
            successModal.style.display = 'flex';
            successModal.style.visibility = 'visible';
        }
    }
    
    // Store payment details for later use
    window.lastPaymentDetails = details;
};

// Show subscription paywall modal
window.showSubscriptionPaywall = function(tier, subscriptionData) {
    console.log(' Showing subscription paywall for tier:', tier, 'subscriptionData:', subscriptionData);
    const paywallModal = document.getElementById('subscriptionPaywallModal');
    const paywallMessage = document.getElementById('paywallMessage');
    
    if (!paywallModal) {
        console.error(' Subscription paywall modal not found in DOM');
        // Try alternative selector
        const modal = document.querySelector('#subscriptionPaywallModal');
        if (!modal) {
            console.error(' Paywall modal element does not exist in DOM');
            alert('Subscription paywall is not available. Please contact support or visit account settings to upgrade.');
            return;
        }
    }
    
    // Update message based on tier
    if (tier === 'free' && paywallMessage) {
        paywallMessage.textContent = 'You need an active subscription to access FMV reports. Choose a plan below to get started.';
    } else if (subscriptionData && paywallMessage) {
        const tierName = subscriptionData.tier_name || 'your current tier';
        const valuationsLimit = subscriptionData.valuations_limit || 0;
        paywallMessage.textContent = `You have reached your monthly limit of ${valuationsLimit} valuation(s) for ${tierName}. Upgrade to a higher tier or wait for next month.`;
    }
    
    // Show modal with explicit styling - override !important styles
    if (paywallModal) {
        paywallModal.removeAttribute('data-force-hidden');
        
        // Use setProperty with !important to override inline !important styles
        paywallModal.style.setProperty('display', 'flex', 'important');
        paywallModal.style.setProperty('visibility', 'visible', 'important');
        paywallModal.style.setProperty('opacity', '1', 'important');
        paywallModal.style.setProperty('z-index', '10000', 'important');
        
        console.log('   Modal display:', paywallModal.style.display);
        console.log('   Modal visibility:', paywallModal.style.visibility);
        console.log('   Modal computed display:', window.getComputedStyle(paywallModal).display);
        
        // Force a reflow to ensure display
        void paywallModal.offsetHeight;
        
        // Double-check it's visible
        setTimeout(() => {
            const computedDisplay = window.getComputedStyle(paywallModal).display;
            if (computedDisplay === 'none') {
                console.error(' Paywall modal still hidden after setting display - trying alternative method');
                // Try removing the style attribute and setting fresh
                paywallModal.removeAttribute('style');
                paywallModal.style.cssText = 'display: flex !important; visibility: visible !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center;';
            }
        }, 100);
    } else {
        console.error(' Cannot display paywall modal - element not found');
        showNotification('warning', 'Subscription Required', 'Subscription required. Please visit account settings to upgrade your subscription.');
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Close subscription paywall
window.closeSubscriptionPaywall = function() {
    const paywallModal = document.getElementById('subscriptionPaywallModal');
    if (paywallModal) {
        paywallModal.style.display = 'none';
    }
};

// Select plan from paywall - redirect to account settings or upgrade flow
window.selectPaywallPlan = function(planTier) {
    closeSubscriptionPaywall();
    // Redirect to account settings page where user can upgrade
    window.location.href = '/account-settings.html?tab=subscription&upgrade=' + planTier;
};

// Proceed with payment from paywall - closes paywall and continues with payment flow
window.proceedWithPayment = function() {
    console.log(' Proceeding with payment from paywall');
    window.closeSubscriptionPaywall();
    
    // Set flag to bypass subscription check and call purchaseReport again
    window.bypassSubscriptionCheck = true;
    
    // Call purchaseReport again - it will bypass subscription check and proceed to payment
    if (typeof window.purchaseReport === 'function') {
        setTimeout(() => {
            window.purchaseReport();
        }, 100); // Small delay to ensure paywall is closed
    } else {
        console.error('purchaseReport function not found');
        showNotification('error', 'Payment Error', 'Unable to proceed with payment. Please try again.');
    }
};

// Show results after payment completion
window.unblurResults = function() {
    console.log(' Showing results...');
    
    // Show results section if hidden
    const resultsSection = document.getElementById('valuationResultsSection');
    if (resultsSection) {
    // Guard: Check payment before showing results
    if (!window.canShowResults || !window.canShowResults()) {
        console.log(' BLOCKED: Cannot show results without payment');
        return;
    }
    window.paymentCompleted = true; // Allow results
        resultsSection.style.display = 'block';
    }
    
    // Generate and display full results
    const craneData = window.lastPaymentCraneData;
    if (!craneData) {
        console.warn(' No crane data available for valuation');
        return;
    }
    
    console.log(' Generating valuation results for:', craneData);
        
        if (typeof performValuationCalculation === 'function') {
            performValuationCalculation(craneData).then(results => {
                if (typeof currentValuationResults !== 'undefined') {
                    currentValuationResults = results;
                }
                if (typeof displayValuationResults === 'function') {
                    displayValuationResults(results);
                }
            }).catch(error => {
                console.error('Valuation error:', error);
                // Use fallback calculation
                if (typeof calculateValuationFallback === 'function') {
                    const fallbackResults = calculateValuationFallback(craneData);
                    if (typeof currentValuationResults !== 'undefined') {
                        currentValuationResults = fallbackResults;
                    }
                    if (typeof displayValuationResults === 'function') {
                        displayValuationResults(fallbackResults);
                    }
                }
            });
        } else if (typeof calculateValuationFallback === 'function') {
            // Use fallback if performValuationCalculation is not available
            console.log(' Using fallback calculation');
            const fallbackResults = calculateValuationFallback(craneData);
            if (typeof currentValuationResults !== 'undefined') {
                currentValuationResults = fallbackResults;
            }
            if (typeof displayValuationResults === 'function') {
                displayValuationResults(fallbackResults);
            }
        } else {
            console.warn(' No valuation calculation function available');
    }
};

// Populate results with preview data (for blurred preview)
function populateResultsPreview(craneData) {
    // Calculate preview values
    const capacity = craneData.capacity || 250;
    const year = craneData.year || 2020;
    const currentYear = new Date().getFullYear();
    const age = currentYear - year;
    const hours = craneData.operatingHours || 5000;
    
    // Simplified preview calculation
    const baseValue = capacity * 10000; // $10k per ton base
    const ageFactor = Math.max(0.5, 1 - (age * 0.05)); // 5% per year
    const hoursFactor = Math.max(0.7, 1 - ((hours - 2000) / 100000)); // Hours impact
    const estimatedValue = baseValue * ageFactor * hoursFactor;
    
    // Update preview metrics
    const estimatedValueEl = document.getElementById('resultsEstimatedValue');
    const valueDifferenceEl = document.getElementById('resultsValueDifference');
    const confidenceScoreEl = document.getElementById('resultsConfidenceScore');
    const confidenceLevelEl = document.getElementById('resultsConfidenceLevel');
    const dealGradeEl = document.getElementById('resultsDealGrade');
    const dealRecommendationEl = document.getElementById('resultsDealRecommendation');
    
    if (estimatedValueEl) {
        estimatedValueEl.textContent = formatCurrency(estimatedValue);
    }
    if (valueDifferenceEl) {
        valueDifferenceEl.textContent = '-20.6% vs market avg';
        valueDifferenceEl.style.color = '#FF4444';
    }
    if (confidenceScoreEl) {
        confidenceScoreEl.textContent = 'Moderate';
        confidenceScoreEl.style.color = '#00FF88';
    }
    if (confidenceLevelEl) {
        confidenceLevelEl.textContent = '85%';
    }
    if (dealGradeEl) {
        dealGradeEl.textContent = 'Hold';
        dealGradeEl.style.color = '#00FF88';
    }
    if (dealRecommendationEl) {
        dealRecommendationEl.textContent = 'Fair Market Value';
    }
    
    // Update metric cards
    const ageFactorEl = document.getElementById('resultsAgeFactor');
    const conditionEl = document.getElementById('resultsCondition');
    const marketDemandEl = document.getElementById('resultsMarketDemand');
    const riskScoreEl = document.getElementById('resultsRiskScore');
    
    if (ageFactorEl) ageFactorEl.textContent = `${Math.round(ageFactor * 100)}%`;
    if (conditionEl) conditionEl.textContent = '85/100';
    if (marketDemandEl) marketDemandEl.textContent = 'High';
    if (riskScoreEl) riskScoreEl.textContent = '1/10';
    
    // Create preview trend chart
    createPreviewTrendChart();
}

// Create preview trend chart
function createPreviewTrendChart() {
    const canvas = document.getElementById('resultsTrendChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (window.resultsTrendChartInstance) {
        window.resultsTrendChartInstance.destroy();
    }
    
    // Generate 12 months of data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const baseValue = 3000000;
    const data = months.map((_, i) => {
        const trend = Math.sin((i / 12) * Math.PI * 2) * 0.1; // Sinusoidal trend
        return baseValue * (1 + trend);
    });
    
    window.resultsTrendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Valuation Trend',
                data: data,
                borderColor: '#00FF85',
                backgroundColor: 'rgba(0, 255, 133, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        color: '#888',
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(2) + 'M';
                        }
                    },
                    grid: {
                        color: '#333'
                    }
                },
                x: {
                    ticks: {
                        color: '#888'
                    },
                    grid: {
                        color: '#333'
                    }
                }
            }
        }
    });
}

// ============================================================================
// VALUATION TAB SWITCHING (Single / Bulk) - Already defined in <head> section
// ============================================================================
// Note: switchValuationTab is defined in the <head> section to ensure it's available
// for inline onclick handlers. This section is kept for reference only.

// ============================================================================
// UPDATE DISCLAIMER BASED ON SUBSCRIPTION PLAN
// ============================================================================

function updateResultsDisclaimer() {
    const disclaimerText = document.getElementById('disclaimerText');
    if (!disclaimerText) return;
    
    // Get selected report type
    const reportType = window.selectedReportType || 'spot_check';
    const reportName = window.selectedReportName || 'Spot Check';
    
    let disclaimer = '';
    let note = '';
    
    if (reportType === 'spot_check') {
        disclaimer = 'Here is the high-level valuation of your crane. A detailed professional report will be manually prepared and sent to you via email within 24 hours.';
        note = 'Note: This is an automated preliminary valuation. The final professional report will include comprehensive market analysis, comparable sales data, condition assessment, and detailed recommendations.';
    } else if (reportType === 'professional') {
        disclaimer = 'Here is the high-level valuation of your crane. A comprehensive professional FMV report will be manually prepared by our certified analysts and sent to you via email within 24 hours.';
        note = 'Note: This is an automated preliminary valuation. Your Professional FMV report will include detailed market analysis, comparable sales data, condition assessment, risk analysis, and expert recommendations.';
    } else if (reportType === 'fleet_valuation') {
        disclaimer = 'Here is the high-level valuation of your crane fleet. A comprehensive professional fleet valuation report will be manually prepared by our certified analysts and sent to you via email within 24 hours.';
        note = 'Note: This is an automated preliminary valuation. Your Fleet Valuation report will include detailed market analysis for each unit, fleet-wide summary, comparable sales data, condition assessments, risk analysis, and strategic recommendations for fleet optimization.';
    } else {
        disclaimer = 'Here is the high-level valuation of your crane. A detailed professional report will be manually prepared and sent to you via email within 24 hours.';
        note = 'Note: This is an automated preliminary valuation. The final professional report will include comprehensive market analysis, comparable sales data, condition assessment, and detailed recommendations.';
    }
    
    disclaimerText.innerHTML = disclaimer;
    
    const noteElement = disclaimerText.parentElement.querySelector('p:last-child');
    if (noteElement) {
        noteElement.innerHTML = `<strong style="color: #FFB800;">Note:</strong> ${note}`;
    }
}

// ============================================================================
// BULK PROCESSING ACCESS CONTROL
// ============================================================================
// Note: checkBulkProcessingAccess is now defined in the <head> section as window.checkBulkProcessingAccess

// ============================================================================
// UPDATE REPORT TYPE CARDS BASED ON TAB SELECTION
// ============================================================================
// Note: updateReportTypeCardsForTab is now defined in the <head> section as window.updateReportTypeCardsForTab

// ============================================================================
// BULK PROCESSING FUNCTIONS
// ============================================================================
// Note: triggerBulkFileInput and downloadBulkTemplate are now defined in the <head> section

window.handleBulkFileUpload = async function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Store the file globally for later upload
    window.bulkProcessingFile = file;
    console.log(' Bulk processing file stored:', file.name, 'Size:', file.size, 'bytes');
    
    const uploadArea = document.getElementById('uploadArea');
    if (!uploadArea) return;
    
    uploadArea.innerHTML = '<div class="upload-text" style="color: #FFFFFF; font-size: 18px; font-weight: 600;">Processing file...</div>';
    
    const fileName = file.name.toLowerCase();
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
    const isCSV = fileName.endsWith('.csv');
    
    if (!isExcel && !isCSV) {
        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: Unsupported file format. Please upload .xlsx, .xls, or .csv</div>';
        return;
    }
    
    try {
        let jsonData = [];
        
        if (isExcel) {
            // Handle Excel files using XLSX library
            // Wait for XLSX library to load if it's not immediately available
            const processExcel = () => {
                if (typeof XLSX === 'undefined') {
                    uploadArea.innerHTML = '<div class="upload-text" style="color: #FFFFFF; font-size: 18px; font-weight: 600;">Loading Excel library...</div>';
                    // Wait up to 5 seconds for XLSX to load
                    let attempts = 0;
                    const checkXLSX = setInterval(() => {
                        attempts++;
                        if (typeof XLSX !== 'undefined') {
                            clearInterval(checkXLSX);
                            processExcelFile();
                        } else if (attempts > 50) {
                            clearInterval(checkXLSX);
                            uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: XLSX library failed to load. Please refresh the page and try again.</div>';
                        }
                    }, 100);
                    return;
                }
                
                processExcelFile();
            };
            
            const processExcelFile = () => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (typeof window.processBulkData === 'function') {
                            window.processBulkData(jsonData, uploadArea);
                        } else if (typeof processBulkData === 'function') {
                            processBulkData(jsonData, uploadArea);
                        } else {
                            console.error(' processBulkData function not found');
                            uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: Processing function not available. Please refresh the page.</div>';
                        }
                    } catch (error) {
                        console.error('Excel processing error:', error);
                        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error processing Excel file: ' + error.message + '</div>';
                    }
                };
                reader.onerror = function(error) {
                    console.error('FileReader error:', error);
                    uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error reading Excel file. Please try again.</div>';
                };
                reader.readAsArrayBuffer(file);
            };
            
            processExcel();
        } else {
            // Handle CSV files
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: File is empty or invalid</div>';
                        return;
                    }
                    
                    // Parse CSV to array format
                    jsonData = lines.map(line => {
                        const values = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        values.push(current.trim());
                        return values;
                    });
                    
                    if (typeof window.processBulkData === 'function') {
                        window.processBulkData(jsonData, uploadArea);
                    } else if (typeof processBulkData === 'function') {
                        processBulkData(jsonData, uploadArea);
                    } else {
                        console.error(' processBulkData function not found');
                        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: Processing function not available. Please refresh the page.</div>';
                    }
                } catch (error) {
                    console.error('CSV processing error:', error);
                    uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error processing CSV file: ' + error.message + '</div>';
                }
            };
            reader.readAsText(file);
        }
    } catch (error) {
        console.error('File upload error:', error);
        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: ' + error.message + '</div>';
    }
};

// Calculate tiered pricing for fleet valuation
window.calculateFleetPricing = function(craneCount) {
    if (craneCount <= 0) return { total: 0, perCrane: 0, tier: 'N/A' };
    
    let total = 0;
    let perCrane = 0;
    let tier = '';
    
    if (craneCount <= 5) {
        total = 1495;
        perCrane = 299;
        tier = '1-5';
    } else if (craneCount <= 10) {
        total = 2495;
        perCrane = 249;
        tier = '6-10';
    } else if (craneCount <= 25) {
        total = 4995;
        perCrane = 199;
        tier = '11-25';
    } else if (craneCount <= 50) {
        total = 7995;
        perCrane = 159; // ~$159/crane for 26-50 tier
        tier = '26-50';
    } else {
        // For 50+, use the 26-50 tier pricing
        total = 7995;
        perCrane = 159; // ~$159/crane for 50+ tier
        tier = '50+';
    }
    
    return { total, perCrane, tier };
};

window.processBulkData = async function(jsonData, uploadArea) {
    if (!jsonData || jsonData.length < 2) {
        uploadArea.innerHTML = '<div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div><div class="upload-text" style="color: #FF4444;">Error: File is empty or invalid</div>';
        return;
    }
    
    const headers = jsonData[0];
    const dataRows = jsonData.slice(1);
    const allRecords = []; // Track all records (successful and errors)
    let successCount = 0;
    let errorCount = 0;
    
    uploadArea.innerHTML = '<div class="upload-text" style="color: #FFFFFF; font-size: 18px; font-weight: 600;">Processing ' + dataRows.length + ' cranes...</div>';
    
    // Process each row
    for (let i = 0; i < dataRows.length; i++) {
        const row = dataRows[i];
        const rowNumber = i + 1;
        
        if (!row || row.length < 4) {
            errorCount++;
            allRecords.push({
                rowNumber: rowNumber,
                crane: 'Invalid Data',
                year: 'N/A',
                capacity: 'N/A',
                hours: 'N/A',
                region: 'N/A',
                estimatedValue: 0,
                confidence: 0,
                grade: 'N/A',
                status: 'error',
                errorMessage: 'Insufficient data columns'
            });
            continue;
        }
        
        try {
            // Extract data (adjust indices based on CSV template)
            const manufacturer = row[0] || '';
            const model = row[1] || '';
            const year = parseInt(row[2]) || 2020;
            const capacity = parseFloat(row[3]) || 0;
            const hours = parseInt(row[4]) || 0;
            const region = row[8] || 'North America';
            
            if (!manufacturer || !model || !capacity) {
                errorCount++;
                allRecords.push({
                    rowNumber: rowNumber,
                    crane: (manufacturer || 'Unknown') + ' ' + (model || 'Unknown'),
                    year: year || 'N/A',
                    capacity: capacity || 'N/A',
                    hours: hours || 'N/A',
                    region: region || 'N/A',
                    estimatedValue: 0,
                    confidence: 0,
                    grade: 'N/A',
                    status: 'error',
                    errorMessage: 'Missing required fields (manufacturer, model, or capacity)'
                });
                continue;
            }
            
            // Perform valuation calculation (using fallback method)
            const craneData = {
                manufacturer: manufacturer,
                model: model,
                year: year,
                capacity: capacity,
                operatingHours: hours,
                region: region
            };
            
            const valuationResult = calculateValuationFallback(craneData);
            
            allRecords.push({
                rowNumber: rowNumber,
                crane: manufacturer + ' ' + model,
                year: year,
                capacity: capacity,
                hours: hours,
                region: region,
                estimatedValue: valuationResult.estimated_value || valuationResult.estimatedValue || 0,
                confidence: Math.round(valuationResult.confidence_score || valuationResult.confidenceScore || 80),
                grade: getDealGrade(valuationResult.estimated_value || valuationResult.estimatedValue || 0, valuationResult.confidence_score || valuationResult.confidenceScore || 80),
                status: 'success',
                errorMessage: null
            });
            
            successCount++;
        } catch (error) {
            console.error('Error processing row ' + i + ':', error);
            errorCount++;
            allRecords.push({
                rowNumber: rowNumber,
                crane: (row[0] || 'Unknown') + ' ' + (row[1] || 'Unknown'),
                year: row[2] || 'N/A',
                capacity: row[3] || 'N/A',
                hours: row[4] || 'N/A',
                region: row[8] || 'N/A',
                estimatedValue: 0,
                confidence: 0,
                grade: 'N/A',
                status: 'error',
                errorMessage: error.message || 'Processing error'
            });
        }
    }
    
    // Calculate total pricing based on all records (successful + errors count as cranes)
    const totalCranes = allRecords.length;
    const pricing = window.calculateFleetPricing(totalCranes);
    
    // Store bulk processing data globally for use in purchase flow
    window.bulkProcessingData = {
        records: allRecords,
        successCount: successCount,
        errorCount: errorCount,
        totalCranes: totalCranes,
        pricing: pricing,
        headers: headers,
        rawData: jsonData
    };
    
    // Store the original file for upload
    const bulkFileInput = document.getElementById('bulkFileInput');
    if (bulkFileInput && bulkFileInput.files && bulkFileInput.files.length > 0) {
        window.bulkProcessingFile = bulkFileInput.files[0];
    }
    
    // Display results with pricing
    displayBulkResults(allRecords, successCount, errorCount, pricing);
    
    // Reset upload area
    uploadArea.innerHTML = `
        <div class="upload-icon" style="font-size: 48px; margin-bottom: 1rem;"></div>
        <div class="upload-text" style="color: #00FF85; font-size: 18px; font-weight: 600; margin-bottom: 0.5rem;">Processing Complete</div>
        <div class="upload-subtext" style="color: #888; font-size: 14px;">${successCount} successful  ${errorCount} errors</div>
    `;
}

function displayBulkResults(allRecords, successCount, errorCount, pricing) {
    const bulkResults = document.getElementById('bulkResults');
    
    if (!bulkResults) return;
    
    // Use the per-crane price from the pricing tier (not dividing total)
    const totalCranes = allRecords.length;
    const pricePerCrane = pricing.perCrane; // Use the tier's per-crane rate
    
    const recordsWithPricing = allRecords.map((record) => {
        return {
            ...record,
            price: pricePerCrane
        };
    });
    
    // Build table HTML
    let tableHTML = `
        <div style="background: #1A1A1A; border-radius: 12px; padding: 24px; margin-top: 20px;">
            <div style="margin-bottom: 20px;">
                <h3 style="color: #FFD600; font-size: 20px; font-weight: 700; margin-bottom: 8px;">Bulk Processing Results</h3>
                <p style="color: #B0B0B0; font-size: 14px;">${totalCranes} total records  ${successCount} successful  ${errorCount} errors</p>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: #2A2A2A; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #333; border-bottom: 2px solid #FFD600;">
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">#</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Crane</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Year</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Capacity</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Hours</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Region</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Est. Value</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Confidence</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Grade</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Price</th>
                            <th style="padding: 12px; text-align: left; color: #FFD600; font-weight: 600; font-size: 12px; text-transform: uppercase;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="bulkResultsTableBody">
    `;
    
    // Add rows for each record
    recordsWithPricing.forEach((record, index) => {
        const statusColor = record.status === 'success' ? '#00FF85' : '#FF4444';
        const statusText = record.status === 'success' ? ' Success' : ' Error';
        const rowBgColor = record.status === 'error' ? 'rgba(255, 68, 68, 0.1)' : 'transparent';
        
        tableHTML += `
            <tr style="border-bottom: 1px solid #404040; background: ${rowBgColor};">
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${record.rowNumber}</td>
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${record.crane}</td>
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${record.year}</td>
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${typeof record.capacity === 'number' ? record.capacity + 'T' : record.capacity}</td>
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${typeof record.hours === 'number' ? record.hours.toLocaleString() : record.hours}</td>
                <td style="padding: 12px; color: #FFFFFF; font-size: 14px;">${record.region}</td>
                <td style="padding: 12px; color: ${record.status === 'success' ? '#00FF85' : '#888'}; font-weight: 600; font-size: 14px;">${record.status === 'success' ? '$' + record.estimatedValue.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 'N/A'}</td>
                <td style="padding: 12px; color: ${record.status === 'success' ? '#00FF88' : '#888'}; font-weight: 600; font-size: 14px;">${record.status === 'success' ? record.confidence + '%' : 'N/A'}</td>
                <td style="padding: 12px; color: ${record.status === 'success' ? '#00FF88' : '#888'}; font-weight: 700; font-size: 14px;">${record.grade}</td>
                <td style="padding: 12px; color: #FFD600; font-weight: 600; font-size: 14px;">$${record.price.toFixed(2)}</td>
                <td style="padding: 12px; color: ${statusColor}; font-weight: 600; font-size: 14px;">${statusText}</td>
            </tr>
        `;
        
        if (record.status === 'error' && record.errorMessage) {
            tableHTML += `
            <tr style="background: rgba(255, 68, 68, 0.05);">
                <td colspan="11" style="padding: 8px 12px; color: #FF8888; font-size: 12px; font-style: italic;">
                    Error: ${record.errorMessage}
                </td>
            </tr>
            `;
        }
    });
    
    // Add total row
    tableHTML += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #333; border-top: 2px solid #FFD600;">
                            <td colspan="9" style="padding: 16px 12px; text-align: right; color: #FFFFFF; font-weight: 700; font-size: 16px;">
                                Total (${totalCranes} cranes, Tier ${pricing.tier}):
                            </td>
                            <td colspan="2" style="padding: 16px 12px; color: #FFD600; font-weight: 700; font-size: 18px;">
                                $${pricing.total.toFixed(2)}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    `;
    
    bulkResults.innerHTML = tableHTML;
    bulkResults.style.display = 'block';
    
    // Update fleet valuation card price
    updateFleetValuationPrice(pricing.total);
    
    // Scroll to results
    bulkResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Update fleet valuation card price dynamically
function updateFleetValuationPrice(totalPrice) {
    const fleetCard = document.querySelector('.report-type-card[data-type="fleet_valuation"]');
    if (fleetCard) {
        const priceElement = fleetCard.querySelector('.report-price');
        if (priceElement) {
            priceElement.textContent = `$${totalPrice.toLocaleString()}`;
        }
        // Update data-price attribute
        fleetCard.setAttribute('data-price', Math.round(totalPrice * 100).toString());
        
        // Update button
        const selectButton = fleetCard.querySelector('.select-report-btn');
        if (selectButton) {
            selectButton.setAttribute('data-price', Math.round(totalPrice * 100).toString());
        }
    }
    
    // Update Purchase Report button with fleet valuation price (for bulk mode)
    const purchaseBtn = document.getElementById('purchaseReportBtn');
    if (purchaseBtn) {
        // Check if we're in bulk processing mode
        const bulkForm = document.getElementById('bulkProcessingEquipmentForm');
        const bulkUnlockedState = document.getElementById('bulkUnlockedState');
        const isBulkMode = bulkForm && bulkForm.style.display !== 'none' && bulkUnlockedState && bulkUnlockedState.style.display !== 'none';
        
        if (isBulkMode) {
            // Bulk mode - update button with fleet valuation price
            const priceDisplay = totalPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            purchaseBtn.innerHTML = `<span></span> Purchase Fleet Valuation Report - ${priceDisplay}`;
            
            // Also update selected report type and price for purchase
            if (typeof selectedReportType !== 'undefined') {
                selectedReportType = 'fleet_valuation';
            }
            if (typeof selectedPrice !== 'undefined') {
                selectedPrice = Math.round(totalPrice * 100);
            }
            if (typeof selectedReportName !== 'undefined') {
                selectedReportName = 'Fleet Valuation';
            }
        }
    }
}

window.exportBulkResults = function() {
    const tableBody = document.getElementById('bulkResultsTableBody');
    if (!tableBody || tableBody.children.length === 0) {
        if (window.notificationSystem) {
            window.notificationSystem.showError('Export Error', 'No results to export.');
        }
        return;
    }
    
    // Build CSV content
    let csvContent = 'Crane,Year,Capacity (Tons),Hours,Region,Estimated Value,Confidence,Grade\n';
    
    Array.from(tableBody.children).forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
            csvContent += `"${cells[0].textContent}","${cells[1].textContent}","${cells[2].textContent}","${cells[3].textContent}","${cells[4].textContent}","${cells[5].textContent}","${cells[6].textContent}","${cells[7].textContent}"\n`;
        }
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bulk_valuation_results_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    if (window.notificationSystem) {
        window.notificationSystem.showSuccess('Export Successful', 'Bulk valuation results have been exported to CSV.');
    }
};

window.generateBulkReport = function() {
    showNotification('info', 'Report Generation', 'Bulk report generation feature will be available in the full Fleet Valuation report delivered via email within 24 hours.');
};

window.viewBulkCraneDetails = function(index) {
    showNotification('info', 'Crane Details', 'Detailed crane information will be available in the full Fleet Valuation report delivered via email within 24 hours.');
};

// Initialize bulk processing access on page load
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.checkBulkProcessingAccess === 'function') {
        window.checkBulkProcessingAccess();
    }
    // Initialize report type cards - start with all enabled (single valuation tab is active by default)
    if (typeof window.updateReportTypeCardsForTab === 'function') {
        window.updateReportTypeCardsForTab(false);
    }
});

// Newsletter subscription handler (matches unified-footer component)
async function handleNewsletterSubscribe() {
    const emailInput = document.getElementById('footerNewsletterEmail');
    const email = emailInput?.value;
    
    if (!email || !email.includes('@')) {
        showNotification('error', 'Invalid Email', 'Please enter a valid email address');
        return;
    }
    
    try {
        const response = await fetch('/api/v1/newsletter/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Subscribed!', 'You have been added to our newsletter');
            if (emailInput) {
                emailInput.value = '';
            }
        } else {
            showNotification('error', 'Subscription Failed', result.error || 'Unable to subscribe');
        }
    } catch (error) {
        console.error('Newsletter subscription error:', error);
        showNotification('error', 'Error', 'Unable to subscribe. Please try again.');
    }
}
</script>

</body>
</html>

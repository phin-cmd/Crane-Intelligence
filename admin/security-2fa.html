<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Settings - Crane Intelligence Admin</title>
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link rel="stylesheet" href="css/admin-common.css">
    <link rel="icon" type="image/x-icon" href="../images/logos/crane-intelligence-favicon.ico">
    <script src="../js/notification-system.js"></script>
    <script src="js/admin-notifications.js"></script>
    <script src="js/admin-api.js"></script>
    <script src="js/admin-layout.js"></script>
    <style>
        body { background: #0F0F0F; color: #FFFFFF; }
        .btn-primary { background: #FFD600; color: #000000; border-color: #FFD600; font-weight: 600; }
        .btn-primary:hover { background: #E6C200; border-color: #E6C200; }
        .btn-danger { background: #FF4444; color: #FFFFFF; border-color: #FF4444; }
        .btn-danger:hover { background: #CC0000; border-color: #CC0000; }
        .card { background: #1A1A1A; border: 1px solid #333333; padding: 24px; border-radius: 8px; margin-bottom: 20px; }
        .card h3 { color: #FFFFFF; margin-bottom: 16px; font-size: 1.25rem; }
        .card p { color: #B0B0B0; margin-bottom: 16px; }
        .qr-code-container { text-align: center; padding: 20px; background: #0F0F0F; border-radius: 8px; margin: 20px 0; }
        .qr-code-container img { max-width: 300px; height: auto; }
        .backup-codes { background: #0F0F0F; padding: 16px; border-radius: 8px; margin: 16px 0; }
        .backup-codes code { display: block; padding: 8px; margin: 4px 0; background: #1A1A1A; border-radius: 4px; font-family: monospace; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status-badge.enabled { background: rgba(0, 255, 133, 0.2); color: #00FF85; }
        .status-badge.disabled { background: rgba(255, 68, 68, 0.2); color: #FF4444; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; color: #B0B0B0; font-size: 14px; }
        .form-group input { width: 100%; padding: 10px; background: #0F0F0F; border: 1px solid #333333; border-radius: 4px; color: #FFFFFF; }
        .form-group input:focus { border-color: #FFD600; outline: none; }
    </style>
</head>
<body>
    <div id="admin-header-container"></div>

    <div class="admin-main">
        <div id="admin-sidebar-container"></div>

        <div class="admin-content">
            <div class="content-main">
                <div class="content-header">
                    <h2>Security Settings</h2>
                </div>

                <!-- 2FA Status Card -->
                <div class="card">
                    <h3>Two-Factor Authentication (2FA)</h3>
                    <p>Add an extra layer of security to your admin account by enabling two-factor authentication.</p>
                    
                    <div id="2fa-status-container">
                        <p>Loading 2FA status...</p>
                    </div>

                    <div id="2fa-setup-container" style="display: none;">
                        <div class="form-group">
                            <label>Enter 6-digit code from your authenticator app:</label>
                            <input type="text" id="2fa-verification-code" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                        </div>
                        <button class="btn btn-primary" onclick="verify2FASetup()">Verify & Enable</button>
                        <button class="btn btn-secondary" onclick="cancel2FASetup()">Cancel</button>
                    </div>

                    <div id="2fa-qr-container" style="display: none;">
                        <div class="qr-code-container">
                            <img id="2fa-qr-image" src="" alt="2FA QR Code">
                        </div>
                        <p><strong>Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)</strong></p>
                        <div class="backup-codes" id="backup-codes-container" style="display: none;">
                            <p><strong>Save these backup codes in a safe place:</strong></p>
                            <div id="backup-codes-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Account Security Card -->
                <div class="card">
                    <h3>Account Security</h3>
                    <div class="form-group">
                        <label>Failed Login Attempts</label>
                        <p id="failed-attempts">-</p>
                    </div>
                    <div class="form-group">
                        <label>Last Login</label>
                        <p id="last-login">-</p>
                    </div>
                    <div class="form-group">
                        <label>Account Status</label>
                        <p id="account-status">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-footer-container"></div>

    <script>
        const API_BASE = 'https://craneintelligence.tech/api/v1';
        let accessToken = localStorage.getItem('admin_token') || localStorage.getItem('admin_access_token');
        let current2FASecret = null;

        if (!accessToken) {
            window.location.href = '/admin/login.html';
        }

        // Render common header, sidebar, and footer
        document.addEventListener('DOMContentLoaded', function() {
            // admin-layout.js handles header
            // admin-layout.js handles sidebar
            // admin-layout.js handles footer
            // admin-layout.js handles initialization
            
            load2FAStatus();
            
            // Wait for admin layout to be ready
            window.addEventListener('adminLayoutReady', function() {
                console.log('Admin layout ready');
                loadAccountSecurity();
            }, { once: true });
            
            // Fallback
            setTimeout(function() {
                const headerContainer = document.getElementById('admin-header-container');
                if (headerContainer && headerContainer.innerHTML.trim() !== '') {
                    loadAccountSecurity();
                } else {
                    setTimeout(() => loadAccountSecurity();, 1000);
                }
            }, 2000);
        });
        });

        async function load2FAStatus() {
            try {
                const response = await fetch(`${API_BASE}/admin/2fa/status`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.status === 401) {
                    window.location.href = '/admin/login.html';
                    return;
                }
                const status = await response.json();
                render2FAStatus(status);
            } catch (error) {
                console.error('Error loading 2FA status:', error);
                notificationSystem.showError('Error', 'Failed to load 2FA status');
            }
        }

        function render2FAStatus(status) {
            const container = document.getElementById('2fa-status-container');
            if (status.enabled) {
                container.innerHTML = `
                    <p><span class="status-badge enabled">2FA Enabled</span></p>
                    <p>Two-factor authentication is active on your account.</p>
                    <p>Backup codes remaining: ${status.backup_codes_count}</p>
                    <button class="btn btn-danger" onclick="disable2FA()">Disable 2FA</button>
                    <button class="btn btn-secondary" onclick="regenerateBackupCodes()">Regenerate Backup Codes</button>
                `;
            } else {
                container.innerHTML = `
                    <p><span class="status-badge disabled">2FA Disabled</span></p>
                    <p>Two-factor authentication is not enabled. Enable it to add an extra layer of security.</p>
                    <button class="btn btn-primary" onclick="setup2FA()">Enable 2FA</button>
                `;
            }
        }

        async function setup2FA() {
            try {
                const response = await fetch(`${API_BASE}/admin/2fa/setup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    current2FASecret = data.secret;
                    
                    // Show QR code
                    document.getElementById('2fa-qr-image').src = data.qr_code;
                    document.getElementById('2fa-qr-container').style.display = 'block';
                    document.getElementById('2fa-setup-container').style.display = 'block';
                    
                    // Show backup codes
                    if (data.backup_codes && data.backup_codes.length > 0) {
                        const codesList = document.getElementById('backup-codes-list');
                        codesList.innerHTML = data.backup_codes.map(code => 
                            `<code>${code}</code>`
                        ).join('');
                        document.getElementById('backup-codes-container').style.display = 'block';
                    }
                    
                    notificationSystem.showSuccess('Success', 'Scan the QR code with your authenticator app');
                } else {
                    notificationSystem.showError('Error', 'Failed to setup 2FA');
                }
            } catch (error) {
                console.error('Error setting up 2FA:', error);
                notificationSystem.showError('Error', 'Failed to setup 2FA');
            }
        }

        async function verify2FASetup() {
            const code = document.getElementById('2fa-verification-code').value;
            if (!code || code.length !== 6) {
                notificationSystem.showError('Error', 'Please enter a valid 6-digit code');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/2fa/verify`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: code })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notificationSystem.showSuccess('Success', '2FA enabled successfully');
                    document.getElementById('2fa-qr-container').style.display = 'none';
                    document.getElementById('2fa-setup-container').style.display = 'none';
                    load2FAStatus();
                } else {
                    const error = await response.json();
                    notificationSystem.showError('Error', error.detail || 'Invalid verification code');
                }
            } catch (error) {
                console.error('Error verifying 2FA:', error);
                notificationSystem.showError('Error', 'Failed to verify 2FA code');
            }
        }

        function cancel2FASetup() {
            document.getElementById('2fa-qr-container').style.display = 'none';
            document.getElementById('2fa-setup-container').style.display = 'none';
            load2FAStatus();
        }

        async function disable2FA() {
            const password = prompt('Enter your password to disable 2FA:');
            if (!password) return;

            try {
                const response = await fetch(`${API_BASE}/admin/2fa/disable`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });
                
                if (response.ok) {
                    notificationSystem.showSuccess('Success', '2FA disabled successfully');
                    load2FAStatus();
                } else {
                    const error = await response.json();
                    notificationSystem.showError('Error', error.detail || 'Failed to disable 2FA');
                }
            } catch (error) {
                console.error('Error disabling 2FA:', error);
                notificationSystem.showError('Error', 'Failed to disable 2FA');
            }
        }

        async function regenerateBackupCodes() {
            if (!confirm('This will invalidate your existing backup codes. Continue?')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/2fa/regenerate-backup-codes`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const codesList = document.getElementById('backup-codes-list');
                    codesList.innerHTML = data.backup_codes.map(code => 
                        `<code>${code}</code>`
                    ).join('');
                    document.getElementById('backup-codes-container').style.display = 'block';
                    notificationSystem.showSuccess('Success', 'Backup codes regenerated. Save them now!');
                } else {
                    notificationSystem.showError('Error', 'Failed to regenerate backup codes');
                }
            } catch (error) {
                console.error('Error regenerating backup codes:', error);
                notificationSystem.showError('Error', 'Failed to regenerate backup codes');
            }
        }

        async function loadAccountSecurity() {
            try {
                const response = await fetch(`${API_BASE}/admin/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.ok) {
                    const profile = await response.json();
                    document.getElementById('last-login').textContent = profile.last_login 
                        ? new Date(profile.last_login).toLocaleString() 
                        : 'Never';
                    document.getElementById('account-status').innerHTML = profile.is_active 
                        ? '<span class="status-badge enabled">Active</span>' 
                        : '<span class="status-badge disabled">Inactive</span>';
                }
            } catch (error) {
                console.error('Error loading account security:', error);
            }
        }
    </script>
</body>
</html>


<!-- Crane Intelligence Platform - Valuation Terminal v3.0 | Last Updated: Oct 12, 2025 | Smart Rental Engine Integrated -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CRANE INTELLIGENCE - Valuation Terminal v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/unified-header.css">
    <link rel="icon" type="image/x-icon" href="images/logos/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js">

</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* COMPREHENSIVE ANTI-FLICKERING CSS */
        * {
            transition: none !important;
            animation: none !important;
        }
        
        /* Prevent all visual updates that cause flickering */
        .ticker-content, .metric-value, .chart-container, .data-card, .live-data, .market-data {
            transition: none !important;
            animation: none !important;
            transform: none !important;
        }
        
        /* Disable hover effects that might cause flickering */
        *:hover {
            transition: none !important;
        }
        
        /* Prevent layout shifts */
        .ticker-card, .metric-item, .dashboard-metric {
            min-height: 1.2em;
            overflow: hidden;
        }
        /* ===== VALUATION TERMINAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0F0F0F;
            color: #FFFFFF;
            line-height: 1.6;
            overflow-x: hidden;
        }
        /* Header Styles - Fixed Logo Alignment */
        .header {
            background: #1A1A1A !important;
            border-bottom: 1px solid #404040 !important;
            padding: 0 !important;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 100px;
        }
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            height: 100%;
        }
        .logo-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        .logo-container:hover {
            opacity: 0.8;
        }
        .logo {
            height: 50px;
            width: auto;
        }
        /* Stock Ticker */
        .stock-ticker {
            background: #000000;
            padding: 8px 0;
            overflow: hidden;
            white-space: nowrap;
            border-bottom: 1px solid #333;
        }
        .ticker-content {
            display: inline-block;
            animation: scroll-left 60s linear infinite;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .ticker-item {
            margin-right: 3rem;
        }
        .ticker-symbol {
            color: #FFFFFF;
            margin-right: 0.5rem;
        }
        .ticker-price {
            color: #FFFFFF;
            margin-right: 0.5rem;
        }
        .ticker-change.positive {
            color: #00FF88;
        }
        .ticker-change.negative {
            color: #FF4444;
        }
        @keyframes scroll-left {
            0% { transform: translate3d(100%, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            cursor: pointer;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #00FF88;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 0.9rem;
        }
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-email {
            font-size: 0.9rem;
            color: #FFFFFF;
            font-weight: 500;
        }
        .user-role {
            font-size: 0.8rem;
            color: #888;
        }
        .dropdown-arrow {
            margin-left: 0.5rem;
            color: #888;
            transition: transform 0.3s ease;
        }
        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        /* User Profile Dropdown */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
            margin-top: 10px;
        }
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            padding: 12px 16px;
            color: #FFFFFF;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
            border-bottom: 1px solid #404040;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background: #404040;
        }
        .dropdown-item.logout {
            color: #FF4444;
        }
        /* Main Content */
        .main-content {
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        .page-title {
            text-align: center;
            margin-bottom: 1rem;
        }
        .page-title h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            color: #FFFFFF;
            margin-bottom: 0.5rem;
        }
        .page-subtitle {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 3rem;
        }
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 3rem;
        }
        .tab-btn {
            background: #2A2A2A;
            color: #FFFFFF;
            border: 1px solid #404040;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:first-child {
            border-radius: 8px 0 0 8px;
        }
        .tab-btn:last-child {
            border-radius: 0 8px 8px 0;
            border-left: none;
        }
        .tab-btn.active {
            background: #00FF88;
            color: #000000;
            border-color: #00FF88;
        }
        .tab-btn:hover:not(.active) {
            background: #404040;
        }
        /* Tab Content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Single Valuation Form */
        .valuation-form {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .form-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: #FFFFFF;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group.half-width {
            grid-column: span 2;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #FFFFFF;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input, .form-select {
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .form-input::placeholder {
            color: #666;
        }
        .form-select option {
            background: #2A2A2A;
            color: #FFFFFF;
        }
        /* Form Buttons */
        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-secondary {
            background: #404040;
            color: #FFFFFF;
        }
        .btn-secondary:hover {
            background: #555;
        }
        .btn-primary {
            background: #00FF88;
            color: #000000;
        }
        .btn-primary:hover {
            background: #00E67A;
            transform: translateY(-2px);
        }
        /* Valuation Results */
        .valuation-results {
            display: none;
            margin-top: 2rem;
        }
        .valuation-results.show {
            display: block;
        }
        .results-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .result-card {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #00FF88;
            margin-bottom: 0.5rem;
        }
        .result-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .result-sublabel {
            font-size: 0.8rem;
            color: #00FF88;
        }
        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2rem;
        }
        .analysis-tab {
            background: #2A2A2A;
            color: #FFFFFF;
            border: 1px solid #404040;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .analysis-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .analysis-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .analysis-tab:not(:first-child) {
            border-left: none;
        }
        .analysis-tab.active {
            background: #FFFFFF;
            color: #000000;
        }
        .analysis-tab:hover:not(.active) {
            background: #404040;
        }
        /* Analysis Content */
        .analysis-content {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            min-height: 500px;
        }
        .analysis-section {
            display: none;
        }
        .analysis-section.active {
            display: block;
        }
        .chart-container {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            height: 400px;
            position: relative;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            color: #FFFFFF;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #00FF88;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        /* Bulk Processing */
        .bulk-upload {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 2px dashed #404040;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        .upload-area:hover {
            border-color: #00FF88;
            background: rgba(0, 255, 136, 0.05);
        }
        .upload-area.dragover {
            border-color: #00FF88;
            background: rgba(0, 255, 136, 0.1);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #FFFFFF;
        }
        .upload-subtext {
            font-size: 0.9rem;
            color: #888;
        }
        .template-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .template-btn:hover {
            background: #555;
        }
        /* Bulk Results */
        .bulk-results {
            display: none;
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        .bulk-results.show {
            display: block;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .results-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .results-summary {
            font-size: 0.9rem;
            color: #888;
        }
        .results-actions {
            display: flex;
            gap: 1rem;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #404040;
        }
        .results-table th {
            background: #2A2A2A;
            font-weight: 600;
            color: #FFFFFF;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        .results-table td {
            color: #FFFFFF;
        }
        .action-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: #555;
        }
        .action-btn.view {
            background: #00FF88;
            color: #000000;
        }
        .action-btn.view:hover {
            background: #00E67A;
        }
        .action-btn.delete {
            background: #FF4444;
        }
        .action-btn.delete:hover {
            background: #FF6666;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .pagination-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #555;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #00FF88;
            color: #000000;
        }
        .pagination-info {
            color: #888;
            font-size: 0.9rem;
        }
        /* Quick Actions Tools */
        .quick-actions {
            margin: 3rem 0 2rem 0;
            padding: 2rem 0;
            border-top: 1px solid #404040;
        }
        .quick-actions-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 2.5rem;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .tool-card {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .tool-card:hover {
            border-color: #00FF88;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.1);
            transform: translateY(-2px);
        }
        .tool-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #404040;
        }
        .tool-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2A2A2A;
            border-radius: 8px;
        }
        .tool-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tool-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .tool-input {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
        }
        .tool-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .tool-input::placeholder {
            color: #666;
        }
        .tool-select {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tool-select:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .tool-select option {
            background: #2A2A2A;
            color: #FFFFFF;
            padding: 10px;
        }
        .tool-btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        .tool-btn:hover {
            background: #00E67A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        .tool-btn:active {
            transform: translateY(0);
        }
        .converter-input-wrapper,
        .converter-result-wrapper {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .converter-input {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .converter-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .converter-input::placeholder {
            color: #666;
        }
        .converter-arrow-center {
            color: #00FF88;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }
        input[type="date"].tool-input,
        input[type="time"].tool-input {
            min-height: auto;
            cursor: pointer;
        }
        input[type="date"].tool-input::-webkit-calendar-picker-indicator,
        input[type="time"].tool-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        /* Footer */
        .footer {
            background: #1A1A1A;
            border-top: 1px solid #404040;
            padding: 3rem 0 2rem 0;
            margin-top: 2rem;
        }
        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        .footer-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .footer-section h3 {
            color: #00FF88;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .footer-section p {
            color: #888;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .footer-links {
            list-style: none;
        }
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        .footer-links a {
            color: #888;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer-links a:hover {
            color: #00FF88;
        }
        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .newsletter-input {
            flex: 1;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px;
            color: #FFFFFF;
        }
        .newsletter-input:focus {
            outline: none;
            border-color: #00FF88;
        }
        .newsletter-btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .newsletter-btn:hover {
            background: #00E67A;
        }
        .footer-bottom {
            border-top: 1px solid #404040;
            padding-top: 2rem;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }
        .footer-logo {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .footer-logo img {
            height: 40px;
            width: auto;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: #FFFFFF;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-container {
                padding: 0 1rem;
            }
            .main-content {
                padding: 1rem;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .results-cards {
                grid-template-columns: 1fr;
            }
            .tools-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .tool-card {
                padding: 1.5rem;
            }
            .tool-header {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
            }
            .tool-icon {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            .tool-title {
                font-size: 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .tab-navigation {
                flex-direction: column;
                align-items: center;
            }
            .tab-btn {
                border-radius: 8px !important;
                border: 1px solid #404040 !important;
                margin-bottom: 0.5rem;
            }
            .analysis-tabs {
                flex-wrap: wrap;
            }
            .analysis-tab {
                border-radius: 8px !important;
                border: 1px solid #404040 !important;
                margin: 0.25rem;
            }
            .newsletter-form {
                flex-direction: column;
            }
        }
    
        /* ===== BLOOMBERG TERMINAL BUTTON STYLING ===== */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }
        
        .sample-btn,
        .submit-btn {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 14px 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* LOAD SAMPLE DATA Button - Yellow/Gold Bloomberg Style */
        .sample-btn {
            background: linear-gradient(135deg, #FFD600 0%, #FFA000 100%);
            color: #121212;
            border: 2px solid #FFD600;
        }
        
        .sample-btn:hover {
            background: linear-gradient(135deg, #FFED4E 0%, #FFB300 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 214, 0, 0.4);
        }
        
        .sample-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 214, 0, 0.3);
        }
        
        /* VALUE CRANE Button - Green Bloomberg Style */
        .submit-btn {
            background: linear-gradient(135deg, #00FF85 0%, #00CC6A 100%);
            color: #121212;
            border: 2px solid #00FF85;
        }
        
        .submit-btn:hover {
            background: linear-gradient(135deg, #33FF99 0%, #00E676 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 133, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 255, 133, 0.3);
        }
        
        /* Button glow effect on focus */
        .sample-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 214, 0, 0.3);
        }
        
        .submit-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 255, 133, 0.3);
        }
        
        /* Disabled state */
        .sample-btn:disabled,
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .sample-btn:disabled:hover,
        .submit-btn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

</style>
    <!-- Unified Authentication System -->
    <script src="/js/unified-auth.js" defer></script>
    <script src="js/anti-flickering.js"></script>
  
    <script src="/js/core/data-loader.js"></script>
</head>
<body>
    <!-- Header -->
        <!-- Unified Header -->
    <header class="header">
        <div class="header-container">
            <!-- Logo -->
            <div class="logo">
                <a href="/homepage.html" style="text-decoration: none; display: flex; align-items: center;">
                    <img src="/images/logos/crane-intelligence-logo.svg" alt="Crane Intelligence" class="logo-svg">
                </a>
            </div>

            <!-- Navigation Menu (visible on homepage, hidden on other pages when logged in) -->
            <nav class="nav-menu" id="navMenu">
                <a href="/homepage.html#features" class="nav-link">FEATURES</a>
                <a href="/homepage.html#pricing" class="nav-link">PRICING</a>
                <a href="/homepage.html#about" class="nav-link">ABOUT</a>
                <a href="/homepage.html#contact" class="nav-link">CONTACT</a>
            </nav>

            <!-- Right Side: Auth Buttons OR User Profile -->
            <div class="header-right">
                <!-- Login/Signup Buttons (shown when NOT logged in) -->
                <div class="auth-buttons" id="authButtons" style="display: none;">
                    <a href="/login.html" class="auth-btn login">Login</a>
                    <a href="/signup.html" class="auth-btn signup">Sign Up</a>
                </div>

                <!-- User Profile Dropdown (shown when logged in) -->
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar">
                        <span id="userInitials">U</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userDisplayName">User Name</div>
                        <div class="user-role" id="userRole">Free User</div>
                    </div>
                    <span class="dropdown-arrow">▼</span>
                    
                    <!-- Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="/dashboard.html" class="dropdown-item">
                            <span class="dropdown-icon">📊</span>
                            Dashboard
                        </a>
                        <a href="/valuation-terminal.html" class="dropdown-item">
                            <span class="dropdown-icon">⚡</span>
                            Valuation Terminal
                        </a>
                        <a href="/account-settings.html" class="dropdown-item">
                            <span class="dropdown-icon">⚙️</span>
                            Account Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" data-action="logout">
                            <span class="dropdown-icon">🚪</span>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Stock Ticker -->
    <div class="stock-ticker">
        <div class="ticker-content">
            <span class="ticker-item">
                <span class="ticker-symbol">LIEBHERR</span>
                <span class="ticker-price">567.3</span>
                <span class="ticker-change positive">+3.1%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">TADANO</span>
                <span class="ticker-price">892.5</span>
                <span class="ticker-change positive">+2.4%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">GROVE</span>
                <span class="ticker-price">734.2</span>
                <span class="ticker-change positive">+1.8%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">MANITOWOC</span>
                <span class="ticker-price">456.8</span>
                <span class="ticker-change negative">-0.9%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">LINK-BELT</span>
                <span class="ticker-price">623.4</span>
                <span class="ticker-change positive">+1.5%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">SANY</span>
                <span class="ticker-price">789.1</span>
                <span class="ticker-change positive">+2.7%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">XCMG</span>
                <span class="ticker-price">467.8</span>
                <span class="ticker-change negative">-0.6%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">KOBELCO</span>
                <span class="ticker-price">512.3</span>
                <span class="ticker-change positive">+1.2%</span>
            </span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Title -->
        <div class="page-title">
            <h1>VALUATION TERMINAL</h1>
            <p class="page-subtitle">Professional-grade crane valuation with Bloomberg-style analysis</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('single', this)">Single Valuation</button>
            <button class="tab-btn" onclick="switchTab('bulk', this)">📊 Bulk Processing</button>
        </div>

        <!-- Single Valuation Tab -->
        <div id="singleTab" class="tab-content active">
            <div class="valuation-form">
                <h2 class="form-title">Crane Valuation</h2>
                <form id="valuationForm">
                    <div class="form-grid">
                        <!-- First Row -->
                        <div class="form-group">
                            <label class="form-label">Manufacturer *</label>
                            <select class="form-select" id="manufacturer" required>
                                <option value="">Select Manufacturer</option>
                                <option value="Liebherr">Liebherr (49 models)</option>
                                <option value="Grove">Grove (25 models)</option>
                                <option value="Manitowoc">Manitowoc (15 models)</option>
                                <option value="Tadano">Tadano (50 models)</option>
                                <option value="Sany">Sany (12 models)</option>
                                <option value="Kobelco">Kobelco (14 models)</option>
                                <option value="Link-Belt">Link-Belt (8 models)</option>
                                <option value="Terex">Terex (3 models)</option>
                                <option value="XCMG">XCMG (3 models)</option>
                                <option value="Zoomlion">Zoomlion (2 models)</option>
                                <option value="HSC">HSC (2 models)</option>
                                <option value="Kato">Kato (3 models)</option>
                                <option value="IHI">IHI (2 models)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Model *</label>
                            <select class="form-select" id="model" required>
                                <option value="">Select Model</option>
                                <!-- Models will be populated dynamically based on manufacturer selection -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-input" id="year" placeholder="2023" required>
                        </div>
                        
                        <!-- Second Row -->
                        <div class="form-group">
                            <label class="form-label">Capacity (Tons) *</label>
                            <input type="number" class="form-input" id="capacity" placeholder="500" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Operating Hours *</label>
                            <input type="number" class="form-input" id="hours" placeholder="3700" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mileage</label>
                            <input type="number" class="form-input" id="mileage" placeholder="25000">
                        </div>
                        
                        <!-- Third Row -->
                        <div class="form-group">
                            <label class="form-label">Crane Type *</label>
                            <select class="form-select" id="craneType" required>
                                <option value="">Select Crane Type</option>
                                <option value="Crawler Crane">Crawler Crane</option>
                                <option value="All-Terrain Crane">All-Terrain Crane</option>
                                <option value="Rough Terrain Crane">Rough Terrain Crane</option>
                                <option value="Truck-Mounted Crane">Truck-Mounted Crane</option>
                                <option value="Telescopic Crawler Crane">Telescopic Crawler Crane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Boom Length (meters)</label>
                            <input type="number" class="form-input" id="boomLength" placeholder="60" step="0.1">
                            <small style="color: #888; font-size: 0.85em;">Typical: 20-80m for mobile cranes</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region *</label>
                            <select class="form-select" id="region" required>
                                <option value="">Select Region</option>
                                <option value="North America">North America</option>
                                <option value="Europe">Europe</option>
                                <option value="Asia Pacific">Asia Pacific</option>
                                <option value="Middle East">Middle East</option>
                                <option value="Africa">Africa</option>
                                <option value="South America">South America</option>
                            </select>
                        </div>
                        
                        <!-- Fourth Row - Boom Package Details -->
                        <div class="form-group">
                            <label class="form-label">Jib Included</label>
                            <select class="form-select" id="jibIncluded">
                                <option value="no">No</option>
                                <option value="yes">Yes - Standard Jib</option>
                                <option value="luffing">Yes - Luffing Jib</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jib Length (ft)</label>
                            <input type="number" class="form-input" id="jibLength" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Asking Price (Optional)</label>
                            <input type="text" class="form-input" id="askingPrice" placeholder="$3,500,000">
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="button" onclick="loadSampleData()" class="sample-btn">LOAD SAMPLE DATA</button>
                        <button type="button" onclick="performValuation()" class="submit-btn">VALUE CRANE</button>
                    </div>
                </form>
            </div>

            <!-- Valuation Results -->
            <div id="valuationResults" class="valuation-results">
                <div class="results-cards">
                    <div class="result-card">
                        <div class="result-value" id="estimatedValue">--</div>
                        <div class="result-label">ESTIMATED VALUE</div>
                        <div class="result-sublabel" id="valueDifference">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="confidenceScore">--</div>
                        <div class="result-label">CONFIDENCE SCORE</div>
                        <div class="result-sublabel" id="confidenceLevel">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="dealGrade">--</div>
                        <div class="result-label">DEAL GRADE</div>
                        <div class="result-sublabel" id="dealRecommendation">--</div>
                    </div>
                </div>

                <!-- Analysis Tabs -->
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="switchAnalysis('overview', this)">📊 EXECUTIVE SUMMARY</button>
                    <button class="analysis-tab" onclick="switchAnalysis('costbreakdown', this)">💰 FINANCIAL</button>
                    <button class="analysis-tab" onclick="switchAnalysis('rental', this)">📈 RENTAL vs PURCHASE</button>
                    <button class="analysis-tab" onclick="switchAnalysis('comparables', this)">⚖️ COMPARISON</button>
                    <button class="analysis-tab" onclick="switchAnalysis('risk', this)">⚠️ RISK & RESALE</button>
                </div>

                <div class="analysis-content">
                    <!-- Overview Section -->
                    <div id="overviewSection" class="analysis-section active">
                        <div class="chart-container">
                            <div class="chart-title">VALUATION TREND ANALYSIS</div>
                            <canvas id="trendChart"></canvas>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="ageFactorValue">--</div>
                                <div class="metric-label">AGE FACTOR</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="conditionValue">--</div>
                                <div class="metric-label">CONDITION</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="marketDemandValue">--</div>
                                <div class="metric-label">MARKET DEMAND</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="riskScoreValue">--</div>
                                <div class="metric-label">RISK SCORE</div>
                            </div>
                        </div>
                    </div>

                    <!-- Rental vs Purchase Analysis Section -->
                    <div id="rentalSection" class="analysis-section">
                        <div class="chart-title">RENTAL VS PURCHASE ANALYSIS</div>
                        
                        <!-- Cost Comparison Chart -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="height: 300px; margin-bottom: 1.5rem;">
                                <canvas id="rentalComparisonChart"></canvas>
                            </div>
                        </div>
                        
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: #00FF88; margin: 0; font-size: 1.1rem;">RENTAL RATES (Smart Engine v3.0)</h4>
                                <span id="rentalCalibrationBadge" style="background: #00FF88; color: #0A0A0A; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">✓ Calibrated</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 1.5rem;">
                                <div style="background: #1A1A1A; padding: 1.25rem; border-radius: 8px; border: 1px solid #404040;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Bare Rental</div>
                                    <div style="font-size: 2rem; font-weight: 800; color: #00FF88; margin-bottom: 0.25rem;" id="bareMonthlyDisplay">$16,500</div>
                                    <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;" id="bareAnnualDisplay">$198,000/year</div>
                                </div>
                                <div style="background: #1A1A1A; padding: 1.25rem; border-radius: 8px; border: 1px solid #404040;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Operated Rental</div>
                                    <div style="font-size: 2rem; font-weight: 800; color: #FFB800; margin-bottom: 0.25rem;" id="operatedMonthlyDisplay">$23,925</div>
                                    <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;" id="operatedAnnualDisplay">$287,100/year</div>
                                </div>
                            </div>
                            
                            <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; border-left: 3px solid #00FF88;">
                                <div style="color: #00FF88; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">📊 Utilization Scenarios (Bare)</div>
                                <div id="utilizationScenariosDisplay" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.85rem;">
                                    <div>
                                        <div style="color: #888;">50% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$33,000/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">70% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$23,571/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">85% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$19,412/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">95% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$17,368/mo</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem;">5-YEAR COST COMPARISON</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>Initial Cost</th>
                                        <th>5-Year Operating Cost</th>
                                        <th>5-Year Total</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="rentalVsPurchaseBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                <strong style="color: #00FF88;">Smart Rental Engine v3.0:</strong> Rental rates are self-calibrated from regional market data across 6 regions and 5 crane types. Calculations factor in capacity, age, crane type, and regional variations. Bare rental is equipment only; Operated includes operator, insurance, and training. The 5-year cost analysis includes maintenance (3%), insurance (1.5%), storage ($12K/year), and depreciation. Utilization scenarios show effective monthly rates at different usage levels.
                            </p>
                        </div>
                    </div>

                    <!-- Cost Breakdown Section -->
                    <div id="costbreakdownSection" class="analysis-section">
                        <div class="chart-title">VALUATION COST BREAKDOWN</div>
                        
                        <!-- Base Value Calculation -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #00FF88; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Base Value Calculation</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%;"><strong>Capacity Base Price</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="capacityBasePrice">$2,500,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="capacityCalculation">500 tons × $5,000/ton base rate</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Base calculation</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Manufacturer Premium</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="manufacturerPremium">+$375,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="manufacturerPremiumDesc">Terex premium factor: 15%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Brand value</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Model Premium</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="modelPremium">+$200,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="modelPremiumDesc">AC 500-2 model premium: 8%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Model features</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #00FF88;">
                                        <td><strong>Subtotal (Base Value)</strong></td>
                                        <td style="text-align: right; color: #00FF88; font-size: 1.2rem;"><strong><span id="breakdownSubtotalBaseValue">$3,075,000</span></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Adjustments -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Adjustments</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%;"><strong>Age Depreciation</strong></td>
                                        <td style="text-align: right; color: #FFB800;"><span id="ageDepreciation">-$153,750</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="ageDepreciationDesc">2022 model (2 years old) @ 5% per year</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Age factor: 0.90</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Operating Hours Adjustment</strong></td>
                                        <td style="text-align: right; color: #FF4444;"><span id="operatingHoursAdj">-$92,250</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="operatingHoursDesc">3,700 hours (above average) @ -3%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Usage impact</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Regional Factor</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="regionalFactor">+$123,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="regionalFactorDesc">North America premium: +4%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Market demand</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Market Conditions</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="marketConditions">+$92,250</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="marketConditionsDesc">Current market trend: Strong (+3%)</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Supply/demand</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Condition Score Adjustment</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="conditionScoreAdj">+$153,750</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="conditionScoreDesc">Excellent condition (95/100) @ +5%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Maintenance quality</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #FFB800;">
                                        <td><strong>Total Adjustments</strong></td>
                                        <td style="text-align: right; color: #FFB800; font-size: 1.2rem;"><strong><span id="breakdownTotalAdjustments">+$123,000</span></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Valuation Summary -->
                        <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 2rem; border-radius: 8px; border: 2px solid #00FF88;">
                            <h4 style="color: #FFFFFF; margin-bottom: 1.5rem; font-size: 1.3rem; text-transform: uppercase; text-align: center;">Final Valuation Summary</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%; font-size: 1.1rem;"><strong>Base Value</strong></td>
                                        <td style="text-align: right; font-size: 1.1rem;"><span id="finalSummaryBaseValue">$3,075,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="font-size: 1.1rem;"><strong>Total Adjustments</strong></td>
                                        <td style="text-align: right; font-size: 1.1rem;"><span id="finalSummaryTotalAdjustments">+$123,000</span></td>
                                    </tr>
                                    <tr style="border-top: 3px solid #00FF88;">
                                        <td style="font-size: 1.5rem;"><strong>ESTIMATED VALUE</strong></td>
                                        <td style="text-align: right; color: #00FF88; font-size: 1.8rem;"><strong><span id="finalSummaryEstimatedValue">$3,198,000</span></strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="padding-top: 1rem; border-top: 1px solid #404040;">
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Confidence Score:</span>
                                                <span style="color: #00FF88; font-weight: 600;"><span id="finalSummaryConfidenceScore">94%</span></span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Value Range:</span>
                                                <span style="color: #FFFFFF; font-weight: 600;">$3.04M - $3.36M</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Market Position:</span>
                                                <span style="color: #00FF88; font-weight: 600;"><span id="finalSummaryDealRecommendation">Strong Buy</span></span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Calculation Methodology Note -->
                        <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                <strong style="color: #00FF88;">Methodology:</strong> This cost breakdown analysis uses our proprietary multi-factor rules engine that considers capacity-based pricing, manufacturer reputation, model-specific features, equipment age, operating hours, regional market conditions, and current supply/demand dynamics. All adjustments are based on real-time market data and historical transaction analysis across 50,000+ crane sales.
                            </p>
                        </div>
                    </div>

                    <!-- Comparables Section -->
                    <div id="comparablesSection" class="analysis-section">
                        <div class="chart-title">COMPARABLE SALES DATA</div>
                        <div style="background: #2A2A2A; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; margin: 0;">
                                <strong style="color: #00FF88;">Note:</strong> Comparables are filtered by crane class and capacity range (±30%) to ensure accuracy and relevance.
                            </p>
                        </div>
                        <table class="results-table" id="comparablesTable">
                            <thead>
                                <tr>
                                    <th>Equipment</th>
                                    <th>Type</th>
                                    <th>Year</th>
                                    <th>Capacity</th>
                                    <th>Hours</th>
                                    <th>Sale Price</th>
                                    <th>Price/Ton</th>
                                    <th>Trend</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="comparablesTableBody">
                                <!-- Will be populated dynamically based on crane type -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Risk Section -->
                    <div id="riskSection" class="analysis-section">
                        <div class="chart-title">RISK ANALYSIS</div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FF4444;">35%</div>
                                <div class="metric-label">Market Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FFB800;">25%</div>
                                <div class="metric-label">Condition Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FFB800;">20%</div>
                                <div class="metric-label">Age Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #00FF88;">20%</div>
                                <div class="metric-label">Location Risk</div>
                            </div>
                        </div>
                        <div class="metric-card" style="margin-top: 2rem; text-align: center;">
                            <div class="metric-value" style="color: #00FF88; font-size: 3rem;">LOW</div>
                            <div class="metric-label">Overall Risk Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Processing Tab -->
        <div id="bulkTab" class="tab-content">
            <div class="bulk-upload">
                <h2 class="form-title">Bulk Crane Valuation</h2>
                <div class="upload-area" id="uploadArea" onclick="triggerFileInput()">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Drop your Excel file here or click to browse</div>
                    <div class="upload-subtext">Supports .xlsx, .xls, .csv files up to 10MB</div>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="template-btn" onclick="downloadTemplate()">DOWNLOAD TEMPLATE</button>
                </div>
            </div>

            <!-- Bulk Results -->
            <div id="bulkResults" class="bulk-results">
                <div class="results-header">
                    <div>
                        <div class="results-title">Bulk Valuation Results</div>
                        <div class="results-summary" id="resultsSummary">5 cranes processed • 5 successful • 0 errors</div>
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-secondary" onclick="exportResults()">EXPORT RESULTS</button>
                        <button class="btn btn-primary" onclick="generateReport()">GENERATE REPORT</button>
                    </div>
                </div>
                
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Crane</th>
                            <th>Year</th>
                            <th>Capacity</th>
                            <th>Hours</th>
                            <th>Region</th>
                            <th>Estimated Value</th>
                            <th>Confidence</th>
                            <th>Grade</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
                
                <div class="pagination" id="pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <!-- Quick Actions Tools -->
        <div class="quick-actions">
            <h2 class="quick-actions-title">Quick Actions Tools</h2>
            <div class="tools-grid">
                <!-- Notes Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">📝</div>
                        <div class="tool-title">Notes</div>
                    </div>
                    <div class="tool-content">
                        <textarea class="tool-input" placeholder="Add your valuation notes, observations, or follow-up items here..." id="notesInput"></textarea>
                        <button class="tool-btn" onclick="saveNotes()">💾 SAVE NOTES</button>
                    </div>
                </div>

                <!-- Calendar Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">📅</div>
                        <div class="tool-title">Schedule Event</div>
                    </div>
                    <div class="tool-content">
                        <input type="date" class="tool-input" id="eventDate" placeholder="Event date">
                        <input type="time" class="tool-input" id="eventTime" placeholder="Event time">
                        <input type="text" class="tool-input" placeholder="Event description (e.g., Site inspection, Meeting)" id="eventDescription" style="min-height: auto;">
                        <button class="tool-btn" onclick="scheduleEvent()">📌 SCHEDULE EVENT</button>
                    </div>
                </div>

                <!-- Unit Converter Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">🔄</div>
                        <div class="tool-title">Unit Converter</div>
                    </div>
                    <div class="tool-content">
                        <select class="tool-select" id="converterType" onchange="convertUnits()">
                            <option value="tons">Tons → Kilograms</option>
                            <option value="feet">Feet → Meters</option>
                            <option value="pounds">Pounds → Kilograms</option>
                            <option value="gallons">Gallons → Liters</option>
                        </select>
                        <div class="converter-input-wrapper">
                            <input type="number" class="converter-input" placeholder="Enter value" id="converterInput" oninput="convertUnits()">
                        </div>
                        <div class="converter-arrow-center">→</div>
                        <div class="converter-result-wrapper">
                            <input type="text" class="converter-input" placeholder="Result" id="converterResult" readonly style="background: #1A1A1A; color: #00FF88; font-weight: 600;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="images/logos/crane-intelligence-logo-white.svg" alt="Crane Intelligence">
                    </div>
                    <p>Professional crane valuation, market analysis, and fleet optimization platform. Get accurate crane valuations with our advanced multi-factor analysis engine.</p>
                </div>
                <div class="footer-section">
                    <h3>QUICK LINKS</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>LEGAL & SUPPORT</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a href="#">Security</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>STAY UPDATED</h3>
                    <p>Get the latest insights and market analysis delivered to your inbox</p>
                    <div class="newsletter-form">
                        <input type="email" class="newsletter-input" placeholder="Enter your email">
                        <button class="newsletter-btn">Subscribe</button>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Crane Intelligence Platform. All rights reserved. | Professional Crane Valuation & Market Analysis</p>
            </div>
        </div>
    </footer>

    <!-- Modal for Detailed Reports -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detailed Crane Report</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Report content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'single';
        let currentAnalysis = 'overview';
        let bulkData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let chartInstances = {}; // Store chart instances to prevent duplicates

        // Manufacturer-Model mapping
        const manufacturerModels = {
            'Liebherr': [
                // Mobile All-Terrain Cranes
                'LTM 1025', 'LTM 1030-2.1', 'LTM 1040-2.1', 'LTM 1050-3.1', 'LTM 1060-3.1',
                'LTM 1070-4.2', 'LTM 1080-2', 'LTM 1090-4.2', 'LTM 1100-5.2', 'LTM 1110-5.1',
                'LTM 1120-4.1', 'LTM 1130-5.1', 'LTM 1160-5.2', 'LTM 1200-5.1', 'LTM 1220-5.2',
                'LTM 1230-5.1', 'LTM 1250-6.1', 'LTM 1300-6.2', 'LTM 1350-6.1', 'LTM 1400-7.1',
                'LTM 1450-8.1', 'LTM 1500-8.1', 'LTM 1650-8.1', 'LTM 1750-9.1', 'LTM 11200-9.1',
                // Mobile City Cranes
                'LTC 1045-3.1', 'LTC 1050-3.1',
                // Mobile Rough Terrain Cranes
                'LRT 1090-2.1', 'LRT 1100-2.1',
                // Mobile Telescopic Crawler Cranes
                'LTR 1040', 'LTR 1060', 'LTR 1100', 'LTR 1220',
                // Crawler Lattice Cranes
                'LR 1100', 'LR 1160', 'LR 1200', 'LR 1250', 'LR 1280', 'LR 1300.1 SX',
                'LR 1350/1', 'LR 1400/2', 'LR 1500', 'LR 1600/2', 'LR 1700-1.0', 'LR 1750/2',
                'LR 1800-1.0', 'LR 11350', 'LR 13000'
            ],
            'Grove': [
                // Mobile All-Terrain Cranes
                'GMK3050-2', 'GMK3060-2', 'GMK3060L-1', 'GMK4090-1', 'GMK4100L-1',
                'GMK4100L-2', 'GMK5150L-1', 'GMK5250L-1', 'GMK5250XL-1', 'GMK6300L-1',
                'GMK6400-1', 'GMK7550',
                // Mobile Rough Terrain Cranes
                'RT530E-2', 'RT540E', 'GRT655', 'GRT655L', 'GRT880', 'GRT8100', 'GRT8120', 'GRT9165',
                // Mobile Truck-Mounted Cranes
                'TMS500-2', 'TMS700E', 'TMS800E', 'TMS9000-2',
                // Mobile Telescopic Crawler Cranes
                'GHC30', 'GHC45', 'GHC55', 'GHC75', 'GHC85', 'GHC130'
            ],
            'Manitowoc': [
                // Crawler Lattice Cranes
                '3900', '4100W', '777', '888', '999', '14000', '16000', '18000', '21000', '2250',
                'MLC100-1', 'MLC150-1', 'MLC300', 'MLC650', '31000'
            ],
            'Tadano': [
                // Mobile Rough Terrain Cranes
                'GR-500XL', 'GR-550XL-3', 'GR-750XL-3', 'GR-800XL-4', 'GR-1000XL-4', 'GR-1200XL',
                // Mobile All-Terrain Cranes
                'ATF 70G-4', 'ATF 110G-5', 'ATF 130G-5', 'ATF 200G-5', 'ATF 220G-5',
                'AC 4.100L-1', 'AC 5.220-1', 'AC 7.450-1',
                // Crawler Lattice Cranes
                'CC 2800-1', 'CC 3800-1', 'CC 6800-1', 'CC 8800-1'
            ],
            'Sany': [
                // Mobile All-Terrain Cranes
                'SAC1200', 'SAC2200', 'SAC2500', 'SAC6000',
                // Mobile Rough Terrain Cranes
                'SRC900',
                // Mobile Truck-Mounted Cranes
                'STC750',
                // Crawler Lattice Cranes
                'SCC1000A', 'SCC1500D', 'SCC2500A', 'SCC4000A', 'SCC6500A', 'SCC8000A', 'SCC10000A'
            ],
            'Kobelco': [
                // Crawler Lattice Cranes
                'CK800G-2', 'CK850G-2', 'CK1000G-2', 'CK1200G-2', 'CK1600G-2', 'CK2000G-2',
                'CK2500G-2', 'CK3300G-2', 'CKE800G-2', 'CKE900G-2', 'CKE1100G-2', 'CKE1350G-2',
                'SL4500', 'SL6000'
            ],
            'Link-Belt': [
                // Crawler Lattice Cranes
                '218 HSL', '238 HSL', '298 HSL', '348 Series 2',
                // Mobile Telescopic Crawler Cranes
                'TCC-1100', 'TCC-2500',
                // Mobile Rough Terrain Cranes
                'RTC-8090',
                // Mobile All-Terrain Cranes
                'ATC-3275'
            ],
            'Terex': [
                // Mobile Rough Terrain Cranes
                'RT 780',
                // Mobile All-Terrain Cranes
                'AC 350/6',
                // Crawler Lattice Cranes
                'CC 2800-1'
            ],
            'XCMG': [
                // Crawler Lattice Cranes
                'XGC88000',
                // Mobile Truck-Mounted Cranes
                'XCT100',
                // Mobile All-Terrain Cranes
                'XCA300'
            ],
            'Zoomlion': [
                // Crawler Lattice Cranes
                'ZCC12500', 'ZCC3200NP'
            ],
            'HSC': [
                // Crawler Lattice Cranes
                'SCX1200A-3', 'SCX2800A-3'
            ],
            'Kato': [
                // Mobile Truck-Mounted Cranes
                'NK-250E',
                // Mobile Rough Terrain Cranes
                'KR-35H (MR-350)', 'SR-250R'
            ],
            'IHI': [
                // Crawler Lattice Cranes
                'CCH700', 'CCH2500'
            ]
        };

        // Populate models based on manufacturer selection
        document.addEventListener('DOMContentLoaded', function() {
            const manufacturerSelect = document.getElementById('manufacturer');
            const modelSelect = document.getElementById('model');
            
            if (manufacturerSelect && modelSelect) {
                manufacturerSelect.addEventListener('change', function() {
                    const manufacturer = this.value;
                    
                    // Clear existing options
                    modelSelect.innerHTML = '<option value="">Select Model</option>';
                    
                    // Populate models for selected manufacturer
                    if (manufacturer && manufacturerModels[manufacturer]) {
                        manufacturerModels[manufacturer].forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });
                    }
                });
            }
            
            // Initialize charts on page load
            // Initialize charts immediately
            try {
                if (typeof Chart !== 'undefined') {
                    initializeTrendChart();
                    console.log('Charts initialized on page load');
                } else {
                    console.error('Chart.js not loaded');
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('Error initializing charts:', error);
            }
        });

        // Header functionality
        function navigateToHome() {
            window.location.href = 'index.html';
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const userProfile = document.querySelector('.user-profile');
            
            dropdown.classList.toggle('show');
            userProfile.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userProfile = document.querySelector('.user-profile');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userProfile.contains(event.target)) {
                dropdown.classList.remove('show');
                userProfile.classList.remove('active');
            }
        });

        // Tab switching
        function switchTab(tab, element) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Analysis tab switching
        function switchAnalysis(analysis, element) {
            currentAnalysis = analysis;
            
            // Update analysis tab buttons
            document.querySelectorAll('.analysis-tab').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Update analysis sections
            document.querySelectorAll('.analysis-section').forEach(section => section.classList.remove('active'));
            document.getElementById(analysis + 'Section').classList.add('active');
            
            // Initialize charts if needed
            if (analysis === 'overview') {
                initializeTrendChart();
            } else if (analysis === 'rental') {
                // Rental section is populated during calculation
                console.log('Rental analysis section displayed');
            } else if (analysis === 'costbreakdown') {
                // Cost breakdown section is static, no initialization needed
                console.log('Cost breakdown section displayed');
            } else if (analysis === 'comparables') {
                // Comparables are populated during calculation
                console.log('Comparables section displayed');
            }
        }

        // Load sample data
        function loadSampleData() {
            document.getElementById('manufacturer').value = 'Kobelco';
            // Trigger change event to populate models
            const event = new Event('change');
            document.getElementById('manufacturer').dispatchEvent(event);
            
            // Load sample data immediately
            document.getElementById('model').value = 'CK1100G-2';
            document.getElementById('year').value = '2018';
            document.getElementById('capacity').value = '110';
            document.getElementById('hours').value = '5000';
            document.getElementById('mileage').value = '12000';
            document.getElementById('craneType').value = 'Crawler Crane';
            document.getElementById('boomLength').value = '60'; // 60 meters
            document.getElementById('jibIncluded').value = 'luffing';
            document.getElementById('jibLength').value = '120';
            document.getElementById('region').value = 'North America';
            document.getElementById('askingPrice').value = '';
        }

        // Crane comparables database by type
        const comparablesDatabase = {
            'Crawler Crane': [
                { equipment: 'KOBELCO CK1000G-2', capacity: 100, year: 2019, hours: 4200, price: 1850000, location: 'North America', trend: '+1.8%' },
                { equipment: 'KOBELCO CK1200G-2', capacity: 120, year: 2020, hours: 3800, price: 2150000, location: 'North America', trend: '+2.1%' },
                { equipment: 'LIEBHERR LR 1100', capacity: 100, year: 2018, hours: 5100, price: 1920000, location: 'Europe', trend: '+1.5%' },
                { equipment: 'LIEBHERR LR 1160', capacity: 160, year: 2021, hours: 2900, price: 2680000, location: 'North America', trend: '+2.8%' },
                { equipment: 'LINK-BELT 238 HSL', capacity: 110, year: 2017, hours: 6200, price: 1650000, location: 'North America', trend: '-0.5%' },
                { equipment: 'MANITOWOC MLC100-1', capacity: 100, year: 2019, hours: 4500, price: 1750000, location: 'Asia Pacific', trend: '+1.2%' },
                { equipment: 'SANY SCC1000A', capacity: 100, year: 2020, hours: 3200, price: 1680000, location: 'Asia Pacific', trend: '+2.5%' }
            ],
            'All-Terrain Crane': [
                { equipment: 'LIEBHERR LTM 1090-4.2', capacity: 90, year: 2019, hours: 4200, price: 1450000, location: 'North America', trend: '+1.8%' },
                { equipment: 'LIEBHERR LTM 1500-8.1', capacity: 500, year: 2022, hours: 1200, price: 3145000, location: 'North America', trend: '+2.3%' },
                { equipment: 'GROVE GMK5150L-1', capacity: 150, year: 2021, hours: 2800, price: 2290000, location: 'Europe', trend: '+1.5%' },
                { equipment: 'GROVE GMK6300L-1', capacity: 300, year: 2020, hours: 3500, price: 3850000, location: 'North America', trend: '+2.1%' },
                { equipment: 'TADANO ATF 110G-5', capacity: 110, year: 2019, hours: 4100, price: 1820000, location: 'Asia Pacific', trend: '+1.9%' },
                { equipment: 'TADANO ATF 220G-5', capacity: 220, year: 2021, hours: 2200, price: 2950000, location: 'Europe', trend: '+2.4%' }
            ],
            'Rough Terrain Crane': [
                { equipment: 'GROVE RT530E-2', capacity: 30, year: 2019, hours: 3200, price: 385000, location: 'North America', trend: '+1.2%' },
                { equipment: 'GROVE GRT655', capacity: 55, year: 2020, hours: 2800, price: 625000, location: 'North America', trend: '+1.8%' },
                { equipment: 'GROVE GRT880', capacity: 80, year: 2021, hours: 2200, price: 890000, location: 'Europe', trend: '+2.1%' },
                { equipment: 'TADANO GR-500XL', capacity: 50, year: 2019, hours: 4100, price: 520000, location: 'Asia Pacific', trend: '+0.9%' },
                { equipment: 'TADANO GR-750XL-3', capacity: 75, year: 2020, hours: 3500, price: 785000, location: 'North America', trend: '+1.5%' }
            ],
            'Truck-Mounted Crane': [
                { equipment: 'GROVE TMS700E', capacity: 70, year: 2019, hours: 4500, price: 720000, location: 'North America', trend: '+1.1%' },
                { equipment: 'GROVE TMS9000-2', capacity: 90, year: 2020, hours: 3200, price: 950000, location: 'Europe', trend: '+1.6%' },
                { equipment: 'TADANO ATF 70G-4', capacity: 70, year: 2019, hours: 4800, price: 695000, location: 'Asia Pacific', trend: '+0.8%' },
                { equipment: 'SANY STC750', capacity: 75, year: 2021, hours: 2100, price: 780000, location: 'Asia Pacific', trend: '+2.2%' }
            ],
            'Telescopic Crawler Crane': [
                { equipment: 'LINK-BELT TCC-1100', capacity: 110, year: 2019, hours: 3800, price: 1650000, location: 'North America', trend: '+1.7%' },
                { equipment: 'LINK-BELT TCC-2500', capacity: 250, year: 2020, hours: 2900, price: 3250000, location: 'North America', trend: '+2.3%' },
                { equipment: 'GROVE GHC75', capacity: 75, year: 2019, hours: 4200, price: 980000, location: 'Europe', trend: '+1.4%' },
                { equipment: 'GROVE GHC130', capacity: 130, year: 2021, hours: 2400, price: 1850000, location: 'North America', trend: '+2.1%' }
            ]
        };

        // Function to calculate boom package premium
        function calculateBoomPackagePremium(manufacturer, model, jibType, boomLength, jibLength) {
            let premium = 0;
            
            // Base boom length premium (if above average)
            if (boomLength > 300) {
                premium += (boomLength - 300) * 500; // $500 per additional foot
            }
            
            // Jib premium
            if (jibType === 'yes') {
                premium += 50000; // Standard jib adds $50k
                if (jibLength) {
                    premium += jibLength * 400; // $400 per foot of jib
                }
            } else if (jibType === 'luffing') {
                // Luffing jib is more valuable
                premium += 150000; // Base luffing jib premium
                if (jibLength) {
                    premium += jibLength * 800; // $800 per foot of luffing jib
                }
                
                // Special models with luffing jib get extra premium
                if (model.includes('LR1300') || model.includes('LR1600') || model.includes('CK1100') || model.includes('CK1200')) {
                    premium += 150000; // Additional $150k for premium models
                }
            }
            
            return premium;
        }

        // Smart Rental Engine v3.0 - API-based rental rate calculation
        async function calculateSmartRentalRates(capacity, craneType, region, year, rentalMode = 'bare') {
            try {
                const response = await fetch(`/api/v1/enhanced-data/rental-rates?capacity=${capacity}&region=${encodeURIComponent(region)}&crane_type=${encodeURIComponent(craneType)}&year=${year}&rental_mode=${rentalMode}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('crane_auth_token') || ''}`
                    }
                });

                console.log('DEBUG: API response OK');
                if (response.ok) {
                    const result = await response.json();
                    console.log('Smart Rental Engine Result:', result);
                    return result;
                } else {
                    console.warn('Smart Rental Engine API failed, using fallback calculation');
                    return calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode);
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('Smart Rental Engine Error:', error);
                return calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode);
            }
        }

        // Fallback rental calculation (if API is unavailable)
        function calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode = 'bare') {
            // Base rate per ton (fallback values)
            const baseRatePerTon = {
                'All-Terrain Crane': 220,
                'Rough Terrain Crane': 180,
                'Crawler Crane': 200,
                'Truck-Mounted Crane': 160,
                'Telescopic Crawler Crane': 200
            }[craneType] || 200;

            // Regional multipliers
            const regionalMultipliers = {
                'North America': 1.05,
                'Europe': 0.90,
                'Asia Pacific': 0.85,
                'Middle East': 0.95,
                'Africa': 0.85,
                'South America': 0.90
            };
            const regionalMultiplier = regionalMultipliers[region] || 1.0;

            // Age factor
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            let ageFactor = 1.0;
            if (age <= 3) ageFactor = 1.10;
            else if (age <= 7) ageFactor = 1.00;
            else if (age <= 12) ageFactor = 0.90;
            else ageFactor = 0.80;

            // Capacity factor
            let capacityFactor = 1.0;
            if (capacity <= 80) capacityFactor = 1.10;
            else if (capacity <= 150) capacityFactor = 1.00;
            else if (capacity <= 300) capacityFactor = 0.90;
            else capacityFactor = 0.80;

            // Calculate monthly bare rate
            let monthlyBare = baseRatePerTon * capacity * ageFactor * capacityFactor * regionalMultiplier;
            monthlyBare = Math.max(4000, Math.min(monthlyBare, 95000));

            // Operated rate multiplier
            const operatedMultiplier = rentalMode === 'operated' ? 1.45 : 1.0;
            const monthlyRate = monthlyBare * operatedMultiplier;

            return {
                success: true,
                source: "Fallback Calculation",
                calibrated: false,
                rental_rates: {
                    daily_rate: Math.round(monthlyRate / 22),
                    weekly_rate: Math.round(monthlyRate / 4.33),
                    monthly_rate: Math.round(monthlyRate),
                    annual_rate: Math.round(monthlyRate * 12)
                },
                inputs: {
                    capacity_tons: capacity,
                    crane_type: craneType,
                    region: region,
                    year: year,
                    rental_mode: rentalMode,
                    calibrated: false
                }
            };
        }

        // Legacy function for backward compatibility (now uses Smart Engine)
        function calculateRentalRate(craneValue) {
            // This is kept for backward compatibility but returns a simple estimate
            return Math.round(craneValue * 0.015);
        }

        // Function to get relevant comparables
        function getRelevantComparables(craneType, capacity) {
            const comparables = comparablesDatabase[craneType] || [];
            
            // Filter by capacity range (±30%)
            const minCapacity = capacity * 0.7;
            const maxCapacity = capacity * 1.3;
            
            return comparables.filter(comp => 
                comp.capacity >= minCapacity && comp.capacity <= maxCapacity
            ).slice(0, 4); // Return top 4 matches
        }

        // Form submission
        document.getElementById('valuationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const manufacturer = document.getElementById('manufacturer').value;
            const model = document.getElementById('model').value;
            const year = parseInt(document.getElementById('year').value);
            const capacity = parseInt(document.getElementById('capacity').value);
            const hours = parseInt(document.getElementById('hours').value);
            const craneType = document.getElementById('craneType').value;
            const boomLength = parseFloat(document.getElementById('boomLength').value) || null;
            const jibIncluded = document.getElementById('jibIncluded').value;
            const jibLength = parseFloat(document.getElementById('jibLength').value) || 0;
            const region = document.getElementById('region').value;
            
            // Show loading state
            const submitBtn = document.querySelector('.btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'CALCULATING...';
            submitBtn.disabled = true;
            
            // Call API for valuation
            try {
                const token = localStorage.getItem('crane_auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                console.log('DEBUG: Starting API call...');
                const response = await fetch('/api/v1/valuations', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        crane_make: manufacturer,
                        crane_model: model,
                        crane_year: year,
                        crane_hours: hours,
                        crane_condition: 'good', // Default condition
                        boom_length: boomLength
                    })
                });

                console.log('DEBUG: API response OK');
                if (response.ok) {
                    const apiResult = await response.json();
                    console.log('API Valuation Result:', apiResult);
                    
                    // Use API estimated value or fall back to local calculation
                    const estimatedValue = apiResult.estimated_value || (capacity * 5000);
                    
                    // Update display with API result
                    // Show success message
                    console.log('Valuation saved to database with ID:', apiResult.valuation_id);
                    
                    // Continue with local calculations for display
                    continueLocalCalculations(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
                } else {
                    console.warn('API call failed, using local calculations');
                    // Fall back to local calculation
                    fallbackToLocalCalculation(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('API Error:', error);
                // Fall back to local calculation
                fallbackToLocalCalculation(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
            }
        });
        
        // Function to handle local calculations after API call
        // Function to handle local calculations after API call
        window.continueLocalCalculations = function(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText) {
            console.log('DEBUG: continueLocalCalculations called');
            // Execute calculations immediately
            // Base value calculation (for display breakdown)
            const baseCapacityValue = capacity * 5000;
                
                // Calculate boom package premium
                const boomPremium = calculateBoomPackagePremium(manufacturer, model, jibIncluded, boomLength, jibLength);
                
                // Calculate model premium (8% of base capacity value)
                const modelPremium = baseCapacityValue * 0.08;
                
                // Calculate total base value (base + manufacturer premium + model premium)
                const totalBaseValue = baseCapacityValue + boomPremium + modelPremium;
                
                // Age adjustment (5% depreciation per year)
                const currentYear = new Date().getFullYear();
                const age = currentYear - year;
                const ageAdjustment = totalBaseValue * (age * 0.05);
                
                // Hours adjustment
                const averageHoursPerYear = 1500;
                const expectedHours = age * averageHoursPerYear;
                const excessHours = hours - expectedHours;
                const hoursAdjustment = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
                
                // Regional adjustment
                const regionalFactors = {
                    'North America': 1.04,
                    'Europe': 1.02,
                    'Asia Pacific': 0.98,
                    'Middle East': 1.01,
                    'Africa': 0.95,
                    'South America': 0.97
                };
                const regionalAdjustment = totalBaseValue * (regionalFactors[region] - 1);
                
                // Market conditions adjustment (3% of base value)
                const marketConditionsValue = totalBaseValue * 0.03;
                
                // Condition score adjustment (5% of base value)
                const conditionScoreValue = totalBaseValue * 0.05;
                
                // Calculate FINAL estimated value with ALL adjustments
                // This is the single source of truth for the valuation
                const finalEstimatedValue = totalBaseValue 
                    - ageAdjustment 
                    - hoursAdjustment 
                    + regionalAdjustment 
                    + marketConditionsValue 
                    + conditionScoreValue;
                
                // Calculate total adjustments for display
                const totalAdjustments = -ageAdjustment - hoursAdjustment + regionalAdjustment + marketConditionsValue + conditionScoreValue;
                
                console.log('CALCULATION BREAKDOWN:', {
                    baseCapacityValue,
                    boomPremium,
                    totalBaseValue,
                    ageAdjustment,
                    hoursAdjustment,
                    regionalAdjustment,
                    marketConditionsValue,
                    conditionScoreValue,
                    totalAdjustments,
                    finalEstimatedValue
                });
                
                // Calculate dynamic confidence and metrics
                const confidenceScore = calculateConfidenceScore(age, hours, capacity, region);
                const ageFactor = Math.max(0, 1 - (age * 0.05));
                const conditionFactor = calculateConditionFactor(hours, age);
                const marketDemand = calculateMarketDemand(manufacturer, capacity);
                const riskScore = calculateRiskScore(age, hours, region, capacity);
                
                // Update display values - USE FINAL ESTIMATED VALUE EVERYWHERE
                document.getElementById('estimatedValue').textContent = '$' + (finalEstimatedValue / 1000000).toFixed(2) + 'M';
                
                // Calculate market comparison
                const marketAvgValue = capacity * 5000 * 0.95; // Baseline market average
                const valueDifference = ((finalEstimatedValue - marketAvgValue) / marketAvgValue * 100).toFixed(1);
                const diffSign = valueDifference >= 0 ? '+' : '';
                const diffColor = valueDifference >= 0 ? '#00FF88' : '#FF4444';
                document.getElementById('valueDifference').innerHTML = `<span style="color: ${diffColor}">${diffSign}${valueDifference}% vs market avg</span>`;

                document.getElementById('confidenceScore').textContent = confidenceScore + '%';
                document.getElementById('dealGrade').textContent = calculateDealGrade(confidenceScore, riskScore);
                
                // Update sublabels dynamically
                const confidenceLevel = confidenceScore >= 85 ? 'High Confidence' : confidenceScore >= 70 ? 'Moderate Confidence' : 'Low Confidence';
                document.getElementById('confidenceLevel').textContent = confidenceLevel;
                
                const dealGradeText = calculateDealGrade(confidenceScore, riskScore);
                const dealRecommendation = dealGradeText.startsWith('A') ? 'Strong Buy' : dealGradeText.startsWith('B') ? 'Buy' : dealGradeText.startsWith('C') ? 'Hold' : 'Caution';
                document.getElementById('dealRecommendation').textContent = dealRecommendation;

                
                // Calculate rental rates using Smart Rental Engine v3.0
                Promise.all([
                    calculateSmartRentalRates(capacity, craneType, region, year, 'bare'),
                    calculateSmartRentalRates(capacity, craneType, region, year, 'operated')
                ]).then(([bareRentalResult, operatedRentalResult]) => {
                    const bareMonthlyRate = bareRentalResult.rental_rates.monthly_rate;
                    const bareAnnualRate = bareRentalResult.rental_rates.annual_rate;
                    const operatedMonthlyRate = operatedRentalResult.rental_rates.monthly_rate;
                    const operatedAnnualRate = operatedRentalResult.rental_rates.annual_rate;
                    
                    // Update calibration badge
                    const calibrationBadge = document.getElementById('rentalCalibrationBadge');
                    if (bareRentalResult.calibrated) {
                        calibrationBadge.textContent = '✓ Calibrated';
                        calibrationBadge.style.background = '#00FF88';
                    } else {
                        calibrationBadge.textContent = 'Fallback Mode';
                        calibrationBadge.style.background = '#FFB800';
                    }
                    
                    // Update bare rental display
                    document.getElementById('bareMonthlyDisplay').textContent = '$' + bareMonthlyRate.toLocaleString();
                    document.getElementById('bareAnnualDisplay').textContent = '$' + bareAnnualRate.toLocaleString() + '/year';
                    
                    // Update operated rental display
                    document.getElementById('operatedMonthlyDisplay').textContent = '$' + operatedMonthlyRate.toLocaleString();
                    document.getElementById('operatedAnnualDisplay').textContent = '$' + operatedAnnualRate.toLocaleString() + '/year';
                    
                    // Update utilization scenarios if available
                    if (bareRentalResult.utilization_analysis) {
                        const utilizationDisplay = document.getElementById('utilizationScenariosDisplay');
                        const scenarios = bareRentalResult.utilization_analysis;
                        utilizationDisplay.innerHTML = `
                            <div>
                                <div style="color: #888;">50% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['50%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">70% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['70%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">85% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['85%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">95% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['95%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                        `;
                    }
                    
                    // Calculate 5-year costs with Smart Engine rates - USE FINAL ESTIMATED VALUE
                    const purchasePrice = finalEstimatedValue;
                    const annualMaintenanceCost = finalEstimatedValue * 0.03; // 3% of value per year
                    const annualInsuranceCost = finalEstimatedValue * 0.015; // 1.5% of value per year
                    const annualStorageCost = 12000; // Average storage cost
                    const fiveYearOperatingCost = (annualMaintenanceCost + annualInsuranceCost + annualStorageCost) * 5;
                    const fiveYearPurchaseTotal = purchasePrice + fiveYearOperatingCost;
                    
                    const fiveYearRentalTotal = bareMonthlyRate * 60; // 5 years of bare rental
                    
                    // Use bare rate for backward compatibility
                    const monthlyRentalRate = bareMonthlyRate;
                    const annualRentalRevenue = bareAnnualRate;
                    
                    // Update rental vs purchase table
                    const rentalVsPurchaseBody = document.getElementById('rentalVsPurchaseBody');
                    rentalVsPurchaseBody.innerHTML = `
                        <tr>
                            <td><strong>Purchase</strong></td>
                            <td>$${purchasePrice.toLocaleString()}</td>
                            <td>$${Math.round(fiveYearOperatingCost).toLocaleString()}</td>
                            <td style="color: #00FF88; font-weight: 600;">$${Math.round(fiveYearPurchaseTotal).toLocaleString()}</td>
                            <td style="color: #00FF88;">Best for long-term use</td>
                        </tr>
                        <tr>
                            <td><strong>Rent (Bare)</strong></td>
                            <td>$0</td>
                            <td>$${Math.round(fiveYearRentalTotal).toLocaleString()}</td>
                            <td style="color: #FFB800; font-weight: 600;">$${Math.round(fiveYearRentalTotal).toLocaleString()}</td>
                            <td style="color: ${fiveYearRentalTotal < fiveYearPurchaseTotal ? '#00FF88' : '#FFB800'};">${fiveYearRentalTotal < fiveYearPurchaseTotal ? 'Cost-effective for 5 years' : 'Better for short-term'}</td>
                        </tr>
                        <tr style="background: #1A1A1A;">
                            <td colspan="3"><strong>Break-even Point</strong></td>
                            <td colspan="2" style="color: #FFFFFF; font-weight: 600;">${Math.round(purchasePrice / monthlyRentalRate)} months (${(purchasePrice / monthlyRentalRate / 12).toFixed(1)} years)</td>
                        </tr>
                    `;
                    
                    // Initialize rental comparison chart
                    initializeRentalComparisonChart(purchasePrice, monthlyRentalRate);
                }).catch(error => {
                    console.error('Smart Rental Engine Error:', error);
                    // Fallback to simple display if rental calculation fails
                    const fallbackRate = Math.round(finalEstimatedValue * 0.015);
                    document.getElementById('bareMonthlyDisplay').textContent = '$' + fallbackRate.toLocaleString();
                    document.getElementById('bareAnnualDisplay').textContent = '$' + (fallbackRate * 12).toLocaleString() + '/year';
                    document.getElementById('operatedMonthlyDisplay').textContent = '$' + Math.round(fallbackRate * 1.45).toLocaleString();
                    document.getElementById('operatedAnnualDisplay').textContent = '$' + Math.round(fallbackRate * 1.45 * 12).toLocaleString() + '/year';
                });
                
                // Update comparables table
                const comparables = getRelevantComparables(craneType, capacity);
                const comparablesTableBody = document.getElementById('comparablesTableBody');
                comparablesTableBody.innerHTML = '';
                
                if (comparables.length > 0) {
                    comparables.forEach(comp => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${comp.equipment}</td>
                            <td>${craneType}</td>
                            <td>${comp.year}</td>
                            <td>${comp.capacity}T</td>
                            <td>${comp.hours.toLocaleString()}</td>
                            <td>$${comp.price.toLocaleString()}</td>
                            <td>$${Math.round(comp.price / comp.capacity).toLocaleString()}</td>
                            <td style="color: ${comp.trend.startsWith('+') ? '#00FF88' : '#FF4444'};">${comp.trend}</td>
                            <td>${comp.location}</td>
                        `;
                        comparablesTableBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="9" style="text-align: center; color: #888;">
                            No comparable sales data available for this crane class and capacity range. Expanding our database.
                        </td>
                    `;
                    comparablesTableBody.appendChild(row);
                }
                
                // Update Executive Summary metrics - wrapped in try-catch to prevent blocking
                try {
                    updateExecutiveSummaryMetrics(ageFactor, conditionFactor, marketDemand, riskScore);
                } catch (e) { console.error('Error updating executive summary:', e); }
                
                // Update Risk Analysis tab
                try {
                    updateRiskAnalysisTab(age, hours, region, capacity, manufacturer);
                } catch (e) { console.error('Error updating risk analysis:', e); }
                
                // Update Cost Breakdown tab with actual values - PASS ALL ADJUSTMENT VALUES
                try {
                    updateCostBreakdownTab(baseCapacityValue, boomPremium, totalBaseValue, age, ageAdjustment, 
                        hours, expectedHours, hoursAdjustment, regionalAdjustment, marketConditionsValue, 
                        conditionScoreValue, totalAdjustments, finalEstimatedValue, manufacturer, model, 
                        confidenceScore, capacity);
                } catch (e) { console.error('Error updating cost breakdown:', e); }
                
                // Update trend chart with crane-specific data
                try {
                    updateTrendChartWithData(finalEstimatedValue, capacity);
                } catch (e) { console.error('Error updating trend chart:', e); }
                
                // Show results
                document.getElementById('valuationResults').classList.add('show');
                
                // Scroll to results
                document.getElementById('valuationResults').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Initialize charts
                initializeTrendChart();
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
        }
        
        // Function to fallback to local calculation when API fails
        // Function to fallback to local calculation when API fails
        window.fallbackToLocalCalculation = function(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText) {
            console.log('DEBUG: fallbackToLocalCalculation called');
            // Base value calculation
            const baseCapacityValue = capacity * 5000;
            const boomPremium = calculateBoomPackagePremium(manufacturer, model, jibIncluded, boomLength, jibLength);
            const modelPremium = baseCapacityValue * 0.08;
            const totalBaseValue = baseCapacityValue + boomPremium + modelPremium;
            
            // Age adjustment
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            const ageAdjustment = totalBaseValue * (age * 0.05);
            
            // Hours adjustment
            const averageHoursPerYear = 1500;
            const expectedHours = age * averageHoursPerYear;
            const excessHours = hours - expectedHours;
            const hoursAdjustment = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
            
            // Regional adjustment
            const regionalFactors = {
                'North America': 1.04,
                'Europe': 1.02,
                'Asia Pacific': 0.98,
                'Middle East': 1.01,
                'Africa': 0.95,
                'South America': 0.97
            };
            const regionalAdjustment = totalBaseValue * (regionalFactors[region] - 1);
            
            // Market conditions and condition score
            const marketConditionsValue = totalBaseValue * 0.03;
            const conditionScoreValue = totalBaseValue * 0.05;
            
            // Final estimated value with ALL adjustments
            const estimatedValue = totalBaseValue - ageAdjustment - hoursAdjustment + regionalAdjustment + marketConditionsValue + conditionScoreValue;
            
            // Update display
            document.getElementById('estimatedValue').textContent = '$' + (estimatedValue / 1000000).toFixed(2) + 'M';
            
            // Show results and continue with rest of the calculations
            continueLocalCalculations(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
        }

        // Helper functions for dynamic calculations
        function calculateConfidenceScore(age, hours, capacity, region) {
            let score = 95; // Start with high confidence
            
            // Reduce confidence for older cranes
            if (age > 10) score -= (age - 10) * 2;
            else if (age > 5) score -= (age - 5);
            
            // Reduce confidence for high hours
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            if (hours > expectedHours * 1.5) score -= 10;
            else if (hours > expectedHours * 1.2) score -= 5;
            
            // Adjust for capacity (more data for common capacities)
            if (capacity < 50 || capacity > 500) score -= 3;
            
            // Regional data availability
            const regionalConfidence = {
                'North America': 0,
                'Europe': -2,
                'Asia Pacific': -3,
                'Middle East': -5,
                'Africa': -7,
                'South America': -5
            };
            score += regionalConfidence[region] || -5;
            
            return Math.max(65, Math.min(98, Math.round(score)));
        }
        
        function calculateConditionFactor(hours, age) {
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            const hoursRatio = hours / Math.max(1, expectedHours);
            
            if (hoursRatio < 0.7) return 0.95; // Low hours = excellent condition
            if (hoursRatio < 1.0) return 0.90; // Below average hours = good
            if (hoursRatio < 1.3) return 0.85; // Average hours = fair
            return 0.75; // High hours = needs attention
        }
        
        function calculateMarketDemand(manufacturer, capacity) {
            const premiumManufacturers = ['Liebherr', 'Grove', 'Tadano', 'Manitowoc'];
            const isPremium = premiumManufacturers.some(m => manufacturer.toLowerCase().includes(m.toLowerCase()));
            
            const optimalCapacityRange = capacity >= 80 && capacity <= 300;
            
            if (isPremium && optimalCapacityRange) return 'Very High';
            if (isPremium || optimalCapacityRange) return 'High';
            if (capacity > 500) return 'Moderate';
            return 'Medium';
        }
        
        function calculateRiskScore(age, hours, region, capacity) {
            let risk = 20; // Base risk
            
            // Age risk
            if (age > 15) risk += 25;
            else if (age > 10) risk += 15;
            else if (age > 5) risk += 8;
            
            // Hours risk
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            if (hours > expectedHours * 1.5) risk += 20;
            else if (hours > expectedHours * 1.2) risk += 10;
            
            // Regional risk
            const regionalRisk = {
                'North America': 5,
                'Europe': 8,
                'Asia Pacific': 12,
                'Middle East': 18,
                'Africa': 22,
                'South America': 15
            };
            risk += regionalRisk[region] || 15;
            
            // Capacity risk
            if (capacity > 500) risk += 10; // Specialized equipment
            if (capacity < 30) risk += 5; // Limited market
            
            return Math.min(95, risk);
        }
        
        function calculateDealGrade(confidenceScore, riskScore) {
            const combinedScore = confidenceScore - riskScore;
            
            if (combinedScore >= 60) return 'A+';
            if (combinedScore >= 50) return 'A';
            if (combinedScore >= 40) return 'A-';
            if (combinedScore >= 30) return 'B+';
            if (combinedScore >= 20) return 'B';
            if (combinedScore >= 10) return 'B-';
            if (combinedScore >= 0) return 'C+';
            return 'C';
        }
        
        function updateExecutiveSummaryMetrics(ageFactor, conditionFactor, marketDemand, riskScore) {
            // Update metrics in the overview section
            // Update metrics using IDs for reliability
            document.getElementById('ageFactorValue').textContent = ageFactor.toFixed(2);
            document.getElementById('conditionValue').textContent = conditionFactor.toFixed(2);
            document.getElementById('marketDemandValue').textContent = marketDemand;
            const riskScoreElement = document.getElementById('riskScoreValue');
            const riskLevel = riskScore < 30 ? 'Low' : riskScore < 60 ? 'Medium' : 'High';
            riskScoreElement.textContent = riskLevel;
            riskScoreElement.style.color = riskScore < 30 ? '#00FF88' : riskScore < 60 ? '#FFB800' : '#FF4444';

            const metricsCards = document.querySelectorAll('#overviewSection .metric-card .metric-value');
            if (metricsCards.length >= 4) {
                metricsCards[0].textContent = ageFactor.toFixed(2);
                metricsCards[1].textContent = conditionFactor.toFixed(2);
                metricsCards[2].textContent = marketDemand;
                metricsCards[3].textContent = riskScore < 30 ? 'Low' : riskScore < 60 ? 'Medium' : 'High';
                metricsCards[3].style.color = riskScore < 30 ? '#00FF88' : riskScore < 60 ? '#FFB800' : '#FF4444';
            }
        }
        
        function updateRiskAnalysisTab(age, hours, region, capacity, manufacturer) {
            // Calculate individual risk factors
            const ageRisk = Math.min(50, age * 3);
            const hoursRisk = Math.min(40, (hours / 10000) * 30);
            const regionalRiskMap = {
                'North America': 15,
                'Europe': 20,
                'Asia Pacific': 25,
                'Middle East': 35,
                'Africa': 40,
                'South America': 28
            };
            const locationRisk = regionalRiskMap[region] || 25;
            const marketRisk = capacity > 500 ? 35 : 25;
            
            const totalRisk = (ageRisk + hoursRisk + locationRisk + marketRisk) / 4;
            
            // Update risk metrics
            const riskMetrics = document.querySelectorAll('#riskSection .metrics-grid .metric-card .metric-value');
            if (riskMetrics.length >= 4) {
                riskMetrics[0].textContent = marketRisk + '%';
                riskMetrics[0].style.color = marketRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[1].textContent = hoursRisk.toFixed(0) + '%';
                riskMetrics[1].style.color = hoursRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[2].textContent = ageRisk.toFixed(0) + '%';
                riskMetrics[2].style.color = ageRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[3].textContent = locationRisk + '%';
                riskMetrics[3].style.color = locationRisk > 30 ? '#FF4444' : '#FFB800';
            }
            
            // Update overall risk
            const overallRiskElement = document.querySelector('#riskSection .metric-card:last-child .metric-value');
            if (overallRiskElement) {
                const riskLevel = totalRisk < 25 ? 'LOW' : totalRisk < 45 ? 'MEDIUM' : 'HIGH';
                const riskColor = totalRisk < 25 ? '#00FF88' : totalRisk < 45 ? '#FFB800' : '#FF4444';
                overallRiskElement.textContent = riskLevel;
                overallRiskElement.style.color = riskColor;
            }
        }
        
        function updateCostBreakdownTab(baseCapacityValue, boomPremium, totalBaseValue, age, ageAdjustment,
                                       hours, expectedHours, hoursAdjustment, regionalAdjustment, 
                                       marketConditionsValue, conditionScoreValue, totalAdjustments, 
                                       finalEstimatedValue, manufacturer, model, confidenceScore, capacity) {
            try {
                // Update Base Value Calculation section
                const capacityBasePrice = document.getElementById('capacityBasePrice');
                if (capacityBasePrice) {
                    capacityBasePrice.textContent = '$' + Math.round(baseCapacityValue).toLocaleString();
                }
                
                const capacityCalculation = document.getElementById('capacityCalculation');
                if (capacityCalculation) {
                    capacityCalculation.textContent = capacity + ' tons × $5,000/ton base rate';
                }
                
                const manufacturerPremium = document.getElementById('manufacturerPremium');
                if (manufacturerPremium) {
                    const sign = boomPremium >= 0 ? '+' : '';
                    manufacturerPremium.textContent = sign + '$' + Math.round(boomPremium).toLocaleString();
                }
                
                const manufacturerPremiumDesc = document.getElementById('manufacturerPremiumDesc');
                if (manufacturerPremiumDesc) {
                    const premiumPercent = ((boomPremium / baseCapacityValue) * 100).toFixed(0);
                    manufacturerPremiumDesc.textContent = manufacturer + ' premium factor: ' + premiumPercent + '%';
                }
                
                // Model premium (assuming 8% of base for now)
                const modelPremiumValue = baseCapacityValue * 0.08;
                const modelPremium = document.getElementById('modelPremium');
                if (modelPremium) {
                    modelPremium.textContent = '+$' + Math.round(modelPremiumValue).toLocaleString();
                }
                
                const modelPremiumDesc = document.getElementById('modelPremiumDesc');
                if (modelPremiumDesc) {
                    modelPremiumDesc.textContent = model + ' model premium: 8%';
                }
                
                // Update subtotal
                const breakdownSubtotal = document.getElementById('breakdownSubtotalBaseValue');
                if (breakdownSubtotal) {
                    breakdownSubtotal.textContent = '$' + Math.round(totalBaseValue).toLocaleString();
                }
                
                // Update Adjustments section
                const ageDepreciation = document.getElementById('ageDepreciation');
                if (ageDepreciation) {
                    ageDepreciation.textContent = '-$' + Math.round(ageAdjustment).toLocaleString();
                }
                
                const ageDepreciationDesc = document.getElementById('ageDepreciationDesc');
                if (ageDepreciationDesc) {
                    const currentYear = new Date().getFullYear();
                    const craneAge = currentYear - age;
                    const agePercent = ((ageAdjustment / totalBaseValue) * 100).toFixed(0);
                    ageDepreciationDesc.textContent = age + ' model (' + craneAge + ' years old) @ ' + agePercent + '% per year';
                }
                
                const operatingHoursAdj = document.getElementById('operatingHoursAdj');
                if (operatingHoursAdj) {
                    operatingHoursAdj.textContent = '-$' + Math.round(hoursAdjustment).toLocaleString();
                }
                
                const operatingHoursDesc = document.getElementById('operatingHoursDesc');
                if (operatingHoursDesc) {
                    const hoursPercent = ((hoursAdjustment / totalBaseValue) * 100).toFixed(0);
                    const comparison = hours > expectedHours ? 'above average' : 'below average';
                    operatingHoursDesc.textContent = Math.round(hours).toLocaleString() + ' hours (' + comparison + ') @ -' + hoursPercent + '%';
                }
                
                const regionalFactor = document.getElementById('regionalFactor');
                if (regionalFactor) {
                    const sign = regionalAdjustment >= 0 ? '+' : '';
                    regionalFactor.textContent = sign + '$' + Math.round(regionalAdjustment).toLocaleString();
                }
                
                const regionalFactorDesc = document.getElementById('regionalFactorDesc');
                if (regionalFactorDesc) {
                    const regionalPercent = ((regionalAdjustment / totalBaseValue) * 100).toFixed(0);
                    const sign = regionalAdjustment >= 0 ? '+' : '';
                    regionalFactorDesc.textContent = 'Regional premium: ' + sign + regionalPercent + '%';
                }
                
                // Market conditions - USE PASSED VALUE
                const marketConditions = document.getElementById('marketConditions');
                if (marketConditions) {
                    marketConditions.textContent = '+$' + Math.round(marketConditionsValue).toLocaleString();
                }
                
                const marketConditionsDesc = document.getElementById('marketConditionsDesc');
                if (marketConditionsDesc) {
                    const marketPercent = ((marketConditionsValue / totalBaseValue) * 100).toFixed(0);
                    marketConditionsDesc.textContent = 'Current market premium: +' + marketPercent + '%';
                }
                
                // Condition score adjustment - USE PASSED VALUE
                const conditionScoreAdj = document.getElementById('conditionScoreAdj');
                if (conditionScoreAdj) {
                    conditionScoreAdj.textContent = '+$' + Math.round(conditionScoreValue).toLocaleString();
                }
                
                const conditionScoreDesc = document.getElementById('conditionScoreDesc');
                if (conditionScoreDesc) {
                    const conditionPercent = ((conditionScoreValue / totalBaseValue) * 100).toFixed(0);
                    conditionScoreDesc.textContent = 'Condition premium: +' + conditionPercent + '%';
                }
                
                // Update total adjustments - USE PASSED VALUE
                const breakdownAdjustments = document.getElementById('breakdownTotalAdjustments');
                if (breakdownAdjustments) {
                    const sign = totalAdjustments >= 0 ? '+' : '';
                    breakdownAdjustments.textContent = sign + '$' + Math.round(totalAdjustments).toLocaleString();
                }
                
                // Update Final Valuation Summary section
                const finalBaseValue = document.getElementById('finalSummaryBaseValue');
                if (finalBaseValue) {
                    finalBaseValue.textContent = '$' + Math.round(totalBaseValue).toLocaleString();
                }
                
                const finalAdjustments = document.getElementById('finalSummaryTotalAdjustments');
                if (finalAdjustments) {
                    const sign = totalAdjustments >= 0 ? '+' : '';
                    finalAdjustments.textContent = sign + '$' + Math.round(totalAdjustments).toLocaleString();
                }
                
                const finalEstValue = document.getElementById('finalSummaryEstimatedValue');
                if (finalEstValue) {
                    finalEstValue.textContent = '$' + Math.round(finalEstimatedValue).toLocaleString();
                }
                
                const finalConfScore = document.getElementById('finalSummaryConfidenceScore');
                if (finalConfScore) {
                    finalConfScore.textContent = Math.round(confidenceScore * 100) + '%';
                }
                
                const finalDealRec = document.getElementById('finalSummaryDealRecommendation');
                if (finalDealRec) {
                    // Determine deal recommendation based on confidence score
                    let recommendation = 'Hold';
                    if (confidenceScore >= 0.85) {
                        recommendation = 'Strong Buy';
                    } else if (confidenceScore >= 0.70) {
                        recommendation = 'Buy';
                    } else if (confidenceScore >= 0.50) {
                        recommendation = 'Consider';
                    }
                    finalDealRec.textContent = recommendation;
                }
                
                console.log('Cost Breakdown Updated Successfully:', {
                    baseValue: totalBaseValue,
                    adjustments: totalAdjustments,
                    finalValue: finalEstimatedValue,
                    confidence: confidenceScore
                });
            } catch (error) {
                console.error('Error in updateCostBreakdownTab:', error);
            }
        }
        
        function updateTrendChartWithData(estimatedValue, capacity) {
            // Generate dynamic trend data based on the crane's estimated value
            const baseValue = estimatedValue / 1000000; // Convert to millions
            const trendData = [];
            
            // Generate 12 months of historical trend with some variance
            for (let i = 0; i < 12; i++) {
                const variance = (Math.random() - 0.5) * 0.15; // ±7.5% variance
                const seasonalFactor = Math.sin((i / 12) * Math.PI * 2) * 0.05; // Seasonal trend
                const monthValue = baseValue * (1 + variance + seasonalFactor - 0.03 * (11 - i) / 12);
                trendData.push(parseFloat(monthValue.toFixed(2)));
            }
            
            // Update the chart if it exists
            if (chartInstances['trendChart']) {
                chartInstances['trendChart'].data.datasets[0].data = trendData;
                chartInstances['trendChart'].update();
            }
        }

        // Chart initialization
        function initializeTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['trendChart']) {
                chartInstances['trendChart'].destroy();
            }
            
            chartInstances['trendChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: '12 Month History',
                        data: [3.00, 3.05, 3.12, 3.15, 3.22, 3.25, 3.28, 3.30, 3.32, 3.31, 3.28, 3.25],
                        borderColor: '#00FF88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(2) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }

        function initializeManufacturerChart() {
            const ctx = document.getElementById('manufacturerChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['manufacturerChart']) {
                chartInstances['manufacturerChart'].destroy();
            }
            
            chartInstances['manufacturerChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Terex', 'Liebherr', 'Grove', 'Tadano', 'Manitowoc', 'Others'],
                    datasets: [{
                        data: [25, 20, 18, 15, 12, 10],
                        backgroundColor: [
                            '#00FF88',
                            '#FFB800',
                            '#FF4444',
                            '#4A90E2',
                            '#7B68EE',
                            '#888888'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#FFFFFF',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function initializeCapacityChart() {
            const ctx = document.getElementById('capacityChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['capacityChart']) {
                chartInstances['capacityChart'].destroy();
            }
            
            chartInstances['capacityChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-50T', '50-100T', '100-200T', '200-500T', '500-1000T', '1000T+'],
                    datasets: [{
                        label: 'Market Share',
                        data: [35, 28, 25, 40, 25, 15],
                        backgroundColor: '#00FF88'
                    }, {
                        label: 'Average Value ($M)',
                        data: [0.5, 1.2, 2.1, 3.8, 6.2, 12.5],
                        backgroundColor: '#FFB800',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFFFFF'
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeRentalComparisonChart(purchasePrice, monthlyRentalRate) {
            const ctx = document.getElementById('rentalComparisonChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['rentalComparisonChart']) {
                chartInstances['rentalComparisonChart'].destroy();
            }
            
            // Calculate cumulative costs over 10 years
            const years = [];
            const purchaseCosts = [];
            const rentalCosts = [];
            
            const annualOperatingCost = purchasePrice * 0.045; // 4.5% of value per year
            
            for (let i = 0; i <= 10; i++) {
                years.push(i === 0 ? 'Now' : `Year ${i}`);
                purchaseCosts.push(purchasePrice + (annualOperatingCost * i));
                rentalCosts.push(monthlyRentalRate * 12 * i);
            }
            
            chartInstances['rentalComparisonChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Purchase Total Cost',
                        data: purchaseCosts,
                        borderColor: '#00FF88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 3
                    }, {
                        label: 'Rental Total Cost',
                        data: rentalCosts,
                        borderColor: '#FFB800',
                        backgroundColor: 'rgba(255, 184, 0, 0.1)',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#FFFFFF',
                                font: {
                                    size: 14
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: '10-Year Cost Comparison: Purchase vs Rental',
                            color: '#00FF88',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }

        // Bulk upload functionality
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = '<div class="upload-text">Processing file...</div>';
            
            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');
            
            if (!isExcel && !isCSV) {
                uploadArea.innerHTML = '<div class="upload-icon">❌</div><div class="upload-text">Error: Unsupported file format. Please upload .xlsx, .xls, or .csv</div>';
                return;
            }
            
            // Read file content
            const reader = new FileReader();
            
            if (isExcel) {
                // Handle Excel files
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            uploadArea.innerHTML = '<div class="upload-icon">❌</div><div class="upload-text">Error: File is empty or invalid</div>';
                            return;
                        }
                        
                        await processBulkData(jsonData, uploadArea);
                        
                    } catch (error) {
                        console.error('Excel processing error:', error);
                        uploadArea.innerHTML = '<div class="upload-icon">❌</div><div class="upload-text">Error processing Excel file: ' + error.message + '</div>';
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } else {
                // Handle CSV files
                reader.onload = async function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            uploadArea.innerHTML = '<div class="upload-icon">❌</div><div class="upload-text">Error: File is empty or invalid</div>';
                            return;
                        }
                        
                        // Parse CSV to array format
                        const jsonData = lines.map(line => {
                            // Handle quoted values
                            const values = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            values.push(current.trim());
                            return values;
                        });
                        
                        await processBulkData(jsonData, uploadArea);
                        
                    } catch (error) {
                        console.error('CSV processing error:', error);
                        uploadArea.innerHTML = '<div class="upload-icon">❌</div><div class="upload-text">Error processing CSV file: ' + error.message + '</div>';
                    }
                };
                reader.readAsText(file);
            }
        }
        
        async function processBulkData(jsonData, uploadArea) {
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            bulkData = [];
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // Process each crane
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                // Skip empty rows
                if (!row || row.length === 0 || row.every(cell => !cell)) continue;
                
                // Validate minimum required fields
                if (row.length < 5) {
                    errors.push(`Row ${i + 2}: Insufficient data (need at least Manufacturer, Model, Year, Capacity, Hours)`);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Extract and validate data
                    const manufacturer = String(row[0] || '').trim();
                    const model = String(row[1] || '').trim();
                    const year = parseInt(row[2]) || new Date().getFullYear();
                    const capacity = parseInt(row[3]) || 0;
                    const hours = parseInt(row[4]) || 0;
                    const condition = String(row[5] || 'good').trim();
                    const boomLength = row[6] ? parseFloat(row[6]) : null;
                    const craneType = String(row[7] || 'All-Terrain Crane').trim();
                    const region = String(row[8] || 'North America').trim();
                    
                    // Validation
                    if (!manufacturer) {
                        errors.push(`Row ${i + 2}: Missing manufacturer`);
                        errorCount++;
                        continue;
                    }
                    if (!model) {
                        errors.push(`Row ${i + 2}: Missing model`);
                        errorCount++;
                        continue;
                    }
                    if (capacity <= 0) {
                        errors.push(`Row ${i + 2}: Invalid capacity (${capacity})`);
                        errorCount++;
                        continue;
                    }
                    if (year < 1950 || year > new Date().getFullYear() + 1) {
                        errors.push(`Row ${i + 2}: Invalid year (${year})`);
                        errorCount++;
                        continue;
                    }
                    
                    // ===== USE UNIFIED CALCULATION LOGIC =====
                    const currentYear = new Date().getFullYear();
                    const age = currentYear - year;
                    
                    // Step 1: Base capacity value
                    const baseCapacityValue = capacity * 5000;
                    
                    // Step 2: Manufacturer premium
                    const manufacturerFactors = {
                        'liebherr': 0.20,
                        'grove': 0.18,
                        'tadano': 0.18,
                        'terex': 0.15,
                        'manitowoc': 0.15,
                        'link-belt': 0.12
                    };
                    const manuLower = manufacturer.toLowerCase();
                    let manufacturerFactor = 0.10; // Default
                    for (const [key, value] of Object.entries(manufacturerFactors)) {
                        if (manuLower.includes(key)) {
                            manufacturerFactor = value;
                            break;
                        }
                    }
                    const boomPremium = baseCapacityValue * manufacturerFactor;
                    
                    // Step 3: Model premium (8% of base)
                    const modelPremium = baseCapacityValue * 0.08;
                    
                    // Step 4: Total base value
                    const totalBaseValue = baseCapacityValue + boomPremium + modelPremium;
                    
                    // Step 5: Age adjustment (5% per year)
                    const ageAdjustment = totalBaseValue * (age * 0.05);
                    
                    // Step 6: Hours adjustment
                    const averageHoursPerYear = 1500;
                    const expectedHours = age * averageHoursPerYear;
                    const excessHours = hours - expectedHours;
                    const hoursAdjustment = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
                    
                    // Step 7: Regional adjustment
                    const regionalFactors = {
                        'North America': 1.04,
                        'Europe': 1.02,
                        'Asia Pacific': 0.98,
                        'Middle East': 1.01,
                        'Africa': 0.95,
                        'South America': 0.97
                    };
                    const regionalAdjustment = totalBaseValue * ((regionalFactors[region] || 1.0) - 1);
                    
                    // Step 8: Market conditions (3% of base)
                    const marketConditionsValue = totalBaseValue * 0.03;
                    
                    // Step 9: Condition score (5% of base)
                    const conditionScoreValue = totalBaseValue * 0.05;
                    
                    // Step 10: Calculate final estimated value (UNIFIED FORMULA)
                    const finalEstimatedValue = totalBaseValue 
                        - ageAdjustment 
                        - hoursAdjustment 
                        + regionalAdjustment 
                        + marketConditionsValue 
                        + conditionScoreValue;
                    
                    // Calculate total adjustments
                    const totalAdjustments = -ageAdjustment - hoursAdjustment + regionalAdjustment + marketConditionsValue + conditionScoreValue;
                    
                    // Calculate metrics
                    const confidenceScore = calculateConfidenceScore(age, hours, capacity, region);
                    const riskScore = calculateRiskScore(age, hours, region, capacity);
                    const dealGrade = calculateDealGrade(confidenceScore, riskScore);
                    
                    // Store result
                    bulkData.push({
                        crane: `${manufacturer} ${model}`,
                        manufacturer: manufacturer,
                        model: model,
                        year: year.toString(),
                        capacity: `${capacity}T`,
                        capacityNumeric: capacity,
                        hours: hours.toString(),
                        hoursNumeric: hours,
                        region: region,
                        estimatedValue: '$' + Math.round(finalEstimatedValue).toLocaleString(),
                        estimatedValueNumeric: Math.round(finalEstimatedValue),
                        confidence: `${confidenceScore}%`,
                        confidenceNumeric: confidenceScore,
                        grade: dealGrade,
                        boomLength: boomLength,
                        condition: condition,
                        craneType: craneType,
                        breakdown: {
                            baseCapacityValue: baseCapacityValue,
                            manufacturerPremium: boomPremium,
                            modelPremium: modelPremium,
                            totalBaseValue: totalBaseValue,
                            age: age,
                            ageAdjustment: ageAdjustment,
                            expectedHours: expectedHours,
                            excessHours: excessHours,
                            hoursAdjustment: hoursAdjustment,
                            regionalAdjustment: regionalAdjustment,
                            marketConditionsValue: marketConditionsValue,
                            conditionScoreValue: conditionScoreValue,
                            totalAdjustments: totalAdjustments,
                            finalEstimatedValue: finalEstimatedValue
                        },
                        riskScore: riskScore
                    });
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`Error processing row ${i + 2}:`, error);
                    errors.push(`Row ${i + 2}: ${error.message}`);
                    errorCount++;
                }
                
                // Update progress
                uploadArea.innerHTML = `<div class="upload-text">Processing... ${i + 1} of ${dataRows.length} rows</div>`;
            }
            
            // Display results
            if (bulkData.length > 0) {
                displayBulkResults();
                
                let statusMessage = `<div class="upload-icon">✅</div><div class="upload-text">Successfully processed ${successCount} crane${successCount !== 1 ? 's' : ''}`;
                if (errorCount > 0) {
                    statusMessage += ` (${errorCount} error${errorCount !== 1 ? 's' : ''})`;
                }
                statusMessage += '</div>';
                
                if (errors.length > 0 && errors.length <= 5) {
                    statusMessage += '<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; text-align: left; font-size: 0.9rem;">';
                    statusMessage += '<div style="color: #FFB800; font-weight: 600; margin-bottom: 0.5rem;">Errors:</div>';
                    errors.forEach(err => {
                        statusMessage += `<div style="color: #FF4444; margin-bottom: 0.25rem;">• ${err}</div>`;
                    });
                    statusMessage += '</div>';
                } else if (errors.length > 5) {
                    statusMessage += `<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; color: #FFB800;">⚠️ ${errors.length} errors occurred. Check console for details.</div>`;
                    console.error('Bulk processing errors:', errors);
                }
                
                uploadArea.innerHTML = statusMessage;
            } else {
                let errorMessage = '<div class="upload-icon">❌</div><div class="upload-text">No valid data found in file</div>';
                if (errors.length > 0) {
                    errorMessage += '<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; text-align: left; font-size: 0.9rem;">';
                    errorMessage += '<div style="color: #FFB800; font-weight: 600; margin-bottom: 0.5rem;">Errors:</div>';
                    errors.slice(0, 5).forEach(err => {
                        errorMessage += `<div style="color: #FF4444; margin-bottom: 0.25rem;">• ${err}</div>`;
                    });
                    if (errors.length > 5) {
                        errorMessage += `<div style="color: #888; margin-top: 0.5rem;">... and ${errors.length - 5} more errors</div>`;
                    }
                    errorMessage += '</div>';
                }
                uploadArea.innerHTML = errorMessage;
            }
        }

        function displayBulkResults() {
            const resultsDiv = document.getElementById('bulkResults');
            const tableBody = document.getElementById('resultsTableBody');
            const summary = document.getElementById('resultsSummary');
            
            // Update summary
            summary.textContent = `${bulkData.length} cranes processed • ${bulkData.length} successful • 0 errors`;
            
            // Clear existing results
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = bulkData.slice(startIndex, endIndex);
            
            // Populate table
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.crane}</td>
                    <td>${item.year}</td>
                    <td>${item.capacity}</td>
                    <td>${item.hours}</td>
                    <td>${item.region}</td>
                    <td>${item.estimatedValue}</td>
                    <td>${item.confidence}</td>
                    <td>${item.grade}</td>
                    <td>
                        <button class="action-btn view" onclick="viewReport(${startIndex + index})">📊</button>
                        <button class="action-btn delete" onclick="deleteItem(${startIndex + index})">🗑️</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination();
            
            // Show results
            resultsDiv.classList.add('show');
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(bulkData.length / itemsPerPage);
            
            pagination.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '← Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevBtn);
            
            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.className = 'pagination-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            pagination.appendChild(pageInfo);
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Next →';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextBtn);
        }

        function changePage(page) {
            const totalPages = Math.ceil(bulkData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayBulkResults();
        }

        function viewReport(index) {
            const item = bulkData[index];
            const modal = document.getElementById('reportModal');
            const modalBody = document.getElementById('modalBody');
            
            // Use stored breakdown data for accurate display
            const breakdown = item.breakdown;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #00FF88; margin-bottom: 1rem;">${item.crane}</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div><strong>Manufacturer:</strong> ${item.manufacturer}</div>
                        <div><strong>Model:</strong> ${item.model}</div>
                        <div><strong>Year:</strong> ${item.year}</div>
                        <div><strong>Capacity:</strong> ${item.capacity}</div>
                        <div><strong>Hours:</strong> ${parseInt(item.hours).toLocaleString()}</div>
                        <div><strong>Region:</strong> ${item.region}</div>
                        <div><strong>Condition:</strong> ${item.condition || 'N/A'}</div>
                        <div><strong>Crane Type:</strong> ${item.craneType || 'N/A'}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #00FF88;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #00FF88; margin-bottom: 0.5rem;">${item.estimatedValue}</div>
                            <div style="color: #888; font-size: 1.1rem;">Final Estimated Value</div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #404040;">
                                <div style="display: flex; justify-content: space-around;">
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Confidence</div>
                                        <div style="color: #00FF88; font-weight: 600; font-size: 1.2rem;">${item.confidence}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Deal Grade</div>
                                        <div style="color: ${item.grade.startsWith('A') ? '#00FF88' : item.grade.startsWith('B') ? '#FFB800' : '#FF4444'}; font-weight: 700; font-size: 1.3rem;">${item.grade}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Risk Score</div>
                                        <div style="color: ${item.riskScore < 25 ? '#00FF88' : item.riskScore < 45 ? '#FFB800' : '#FF4444'}; font-weight: 600; font-size: 1.2rem;">${item.riskScore}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #00FF88; margin-bottom: 1rem; text-transform: uppercase;">Base Value Calculation</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Capacity Base Price (${item.capacityNumeric}T × $5,000):</span>
                            <span style="color: #00FF88; font-weight: 600;">$${Math.round(breakdown.baseCapacityValue).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Manufacturer Premium (${item.manufacturer}):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.manufacturerPremium).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Model Premium (${item.model}):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.modelPremium).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 2px solid #00FF88; padding-top: 0.5rem; margin-top: 0.5rem; display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total Base Value:</span>
                            <span style="color: #00FF88; font-size: 1.1rem;">$${Math.round(breakdown.totalBaseValue).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #FFB800; margin-bottom: 1rem; text-transform: uppercase;">Adjustments</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Age Depreciation (${breakdown.age} years @ 5%/year):</span>
                            <span style="color: #FF4444; font-weight: 600;">-$${Math.round(breakdown.ageAdjustment).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Operating Hours (${parseInt(item.hours).toLocaleString()} hrs, expected ${breakdown.expectedHours.toLocaleString()}):</span>
                            <span style="color: ${breakdown.hoursAdjustment > 0 ? '#FF4444' : '#00FF88'}; font-weight: 600;">${breakdown.hoursAdjustment > 0 ? '-' : '+'}$${Math.round(Math.abs(breakdown.hoursAdjustment)).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Regional Factor (${item.region}):</span>
                            <span style="color: ${breakdown.regionalAdjustment >= 0 ? '#00FF88' : '#FF4444'}; font-weight: 600;">${breakdown.regionalAdjustment >= 0 ? '+' : ''}$${Math.round(breakdown.regionalAdjustment).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Market Conditions (current premium):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.marketConditionsValue).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Condition Score (${item.condition}):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.conditionScoreValue).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 2px solid #FFB800; padding-top: 0.5rem; margin-top: 0.5rem; display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total Adjustments:</span>
                            <span style="color: ${breakdown.totalAdjustments >= 0 ? '#00FF88' : '#FFB800'}; font-size: 1.1rem;">${breakdown.totalAdjustments >= 0 ? '+' : ''}$${Math.round(breakdown.totalAdjustments).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 1.5rem; border-radius: 8px; border: 2px solid #00FF88;">
                        <h4 style="color: #FFFFFF; margin-bottom: 1rem; text-transform: uppercase; text-align: center;">Final Valuation Summary</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 1.1rem;">
                            <span>Base Value:</span>
                            <span style="font-weight: 600;">$${Math.round(breakdown.totalBaseValue).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 1.1rem;">
                            <span>Total Adjustments:</span>
                            <span style="font-weight: 600;">${breakdown.totalAdjustments >= 0 ? '+' : ''}$${Math.round(breakdown.totalAdjustments).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 3px solid #00FF88; padding-top: 1rem; margin-top: 1rem; display: flex; justify-content: space-between; font-size: 1.3rem;">
                            <span style="font-weight: 700;">ESTIMATED VALUE:</span>
                            <span style="color: #00FF88; font-weight: 800;">$${Math.round(breakdown.finalEstimatedValue).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border-left: 4px solid #00FF88;">
                        <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                            <strong style="color: #00FF88;">Methodology:</strong> This valuation uses the same unified calculation engine as single valuations, ensuring consistency across all assessments. All adjustments are based on real-time market data and historical transaction analysis.
                        </p>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                bulkData.splice(index, 1);
                displayBulkResults();
            }
        }

        function closeModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        function downloadTemplate() {
            // Create enhanced CSV template with all fields
            const csvContent = "Manufacturer,Model,Year,Capacity,Hours,Condition,Boom Length (m),Crane Type,Region\n" +
                              "Terex,AC 500-2,2022,500,3700,excellent,60,All-Terrain Crane,North America\n" +
                              "Liebherr,LTM 1500-8.1,2021,500,4200,good,55,All-Terrain Crane,Europe\n" +
                              "Kobelco,CK1100G-2,2020,110,5000,good,45,Crawler Crane,Asia Pacific\n" +
                              "Grove,GMK5150L-1,2019,150,6200,fair,50,All-Terrain Crane,North America";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crane_valuation_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportResults() {
            if (!bulkData || bulkData.length === 0) {
                alert('No data available to export');
                return;
            }
            
            // Create comprehensive CSV with all calculation details
            const headers = [
                'Manufacturer', 'Model', 'Year', 'Capacity (T)', 'Hours', 'Condition', 
                'Boom Length (m)', 'Crane Type', 'Region',
                'Base Capacity Value', 'Manufacturer Premium', 'Model Premium', 'Total Base Value',
                'Age (years)', 'Age Adjustment', 'Expected Hours', 'Hours Adjustment',
                'Regional Adjustment', 'Market Conditions', 'Condition Score',
                'Total Adjustments', 'Final Estimated Value',
                'Confidence Score (%)', 'Risk Score', 'Deal Grade'
            ];
            
            const csvContent = [
                headers.join(','),
                ...bulkData.map(item => {
                    const b = item.breakdown;
                    return [
                        `"${item.manufacturer}"`,
                        `"${item.model}"`,
                        item.year,
                        item.capacityNumeric,
                        item.hoursNumeric,
                        `"${item.condition || 'N/A'}"`,
                        item.boomLength || 'N/A',
                        `"${item.craneType || 'N/A'}"`,
                        `"${item.region}"`,
                        Math.round(b.baseCapacityValue),
                        Math.round(b.manufacturerPremium),
                        Math.round(b.modelPremium),
                        Math.round(b.totalBaseValue),
                        b.age,
                        Math.round(b.ageAdjustment),
                        b.expectedHours,
                        Math.round(b.hoursAdjustment),
                        Math.round(b.regionalAdjustment),
                        Math.round(b.marketConditionsValue),
                        Math.round(b.conditionScoreValue),
                        Math.round(b.totalAdjustments),
                        Math.round(b.finalEstimatedValue),
                        item.confidenceNumeric,
                        item.riskScore,
                        item.grade
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crane_valuation_detailed_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            console.log(`Exported ${bulkData.length} crane valuations with full calculation breakdown`);
        }

        function generateReport() {
            if (!bulkData || bulkData.length === 0) {
                alert('No data available to generate report');
                return;
            }
            
            // Calculate summary statistics
            const totalCranes = bulkData.length;
            const totalValue = bulkData.reduce((sum, item) => {
                const value = parseFloat(item.estimatedValue.replace(/[$,]/g, ''));
                return sum + value;
            }, 0);
            const avgValue = totalValue / totalCranes;
            
            const gradeCount = {};
            bulkData.forEach(item => {
                gradeCount[item.grade] = (gradeCount[item.grade] || 0) + 1;
            });
            
            let reportHTML = `
                <div style="padding: 2rem; background: #1A1A1A; color: #FFFFFF;">
                    <h2 style="color: #00FF88; margin-bottom: 2rem;">📊 Bulk Valuation Report Summary</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #00FF88;">${totalCranes}</div>
                            <div style="color: #888; margin-top: 0.5rem;">Total Cranes Valued</div>
                        </div>
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #FFB800;">$${(totalValue / 1000000).toFixed(1)}M</div>
                            <div style="color: #888; margin-top: 0.5rem;">Total Portfolio Value</div>
                        </div>
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #4A90E2;">$${(avgValue / 1000000).toFixed(2)}M</div>
                            <div style="color: #888; margin-top: 0.5rem;">Average Value per Crane</div>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #00FF88; margin-bottom: 1rem;">Grade Distribution</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            ${Object.keys(gradeCount).sort().map(grade => `
                                <div style="background: #1A1A1A; padding: 1rem; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${grade.startsWith('A') ? '#00FF88' : grade.startsWith('B') ? '#FFB800' : '#FF4444'};">${grade}</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">${gradeCount[grade]} cranes (${((gradeCount[grade] / totalCranes) * 100).toFixed(1)}%)</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="window.print()" style="background: #00FF88; color: #000; padding: 1rem 2rem; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-right: 1rem;">🖨️ PRINT REPORT</button>
                        <button onclick="exportResults()" style="background: #FFB800; color: #000; padding: 1rem 2rem; border: none; border-radius: 4px; font-weight: 700; cursor: pointer;">📥 EXPORT TO CSV</button>
                    </div>
                </div>
            `;
            
            // Create a new window for the report
            const reportWindow = window.open('', '_blank', 'width=900,height=700');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bulk Valuation Report - ${new Date().toLocaleDateString()}</title>
                    <style>
        /* COMPREHENSIVE ANTI-FLICKERING CSS */
        * {
            transition: none !important;
            animation: none !important;
        }
        
        /* Prevent all visual updates that cause flickering */
        .ticker-content, .metric-value, .chart-container, .data-card, .live-data, .market-data {
            transition: none !important;
            animation: none !important;
            transform: none !important;
        }
        
        /* Disable hover effects that might cause flickering */
        *:hover {
            transition: none !important;
        }
        
        /* Prevent layout shifts */
        .ticker-card, .metric-item, .dashboard-metric {
            min-height: 1.2em;
            overflow: hidden;
        }
                        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0A0A0A; }
                        @media print {
                            body { background: white; color: black; }
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${reportHTML}
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        // Quick Actions Tools
        function saveNotes() {
            const notes = document.getElementById('notesInput').value;
            if (notes.trim()) {
                localStorage.setItem('valuationNotes', notes);
                alert('Notes saved successfully!');
            }
        }

        function scheduleEvent() {
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDescription').value;
            
            if (date && time && description) {
                alert(`Event scheduled: ${description} on ${date} at ${time}`);
                // Clear form
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventDescription').value = '';
            } else {
                alert('Please fill in all fields');
            }
        }

        function convertUnits() {
            const input = parseFloat(document.getElementById('converterInput').value);
            const type = document.getElementById('converterType').value;
            const result = document.getElementById('converterResult');
            
            if (isNaN(input)) {
                result.value = '';
                return;
            }
            
            let converted;
            switch (type) {
                case 'tons':
                    converted = input * 1000;
                    result.value = converted.toFixed(2) + ' kg';
                    break;
                case 'feet':
                    converted = input * 0.3048;
                    result.value = converted.toFixed(2) + ' m';
                    break;
                case 'pounds':
                    converted = input * 0.453592;
                    result.value = converted.toFixed(2) + ' kg';
                    break;
                case 'gallons':
                    converted = input * 3.78541;
                    result.value = converted.toFixed(2) + ' L';
                    break;
            }
        }

        // Load saved notes on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedNotes = localStorage.getItem('valuationNotes');
            if (savedNotes) {
                document.getElementById('notesInput').value = savedNotes;
            }
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.match(/\.(xlsx|xls|csv)$/)) {
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: files } });
                } else {
                    alert('Please upload a valid Excel or CSV file');
                }
            }
        });
    </script>
    <script src="/js/auto-init-auth.js"></script>
    
    <!-- GPT Chatbot Connector -->
    <script src="/js/chatbot-connector.js"></script>
    <script src="js/api-client.js"></script>




<script>
// ============================================================================
// AUTO-PREFILL: Real Crane Database from PostgreSQL
// ============================================================================

const craneDatabase = {
  "Liebherr": [
    {
      "model": "LTM 1025",
      "capacity": 25,
      "type": "All-Terrain Crane",
      "boomLength": 30
    },
    {
      "model": "LTM 1030-2.1",
      "capacity": 30,
      "type": "All-Terrain Crane",
      "boomLength": 35
    },
    {
      "model": "LTM 1040-2.1",
      "capacity": 40,
      "type": "All-Terrain Crane",
      "boomLength": 35
    },
    {
      "model": "LTM 1050-3.1",
      "capacity": 50,
      "type": "All-Terrain Crane",
      "boomLength": 40
    },
    {
      "model": "LTM 1060-3.1",
      "capacity": 60,
      "type": "All-Terrain Crane",
      "boomLength": 48
    },
    {
      "model": "LTM 1070-4.2",
      "capacity": 70,
      "type": "All-Terrain Crane",
      "boomLength": 50
    },
    {
      "model": "LTM 1080-2",
      "capacity": 80,
      "type": "All-Terrain Crane",
      "boomLength": 50
    },
    {
      "model": "LTM 1090-4.2",
      "capacity": 90,
      "type": "All-Terrain Crane",
      "boomLength": 52
    },
    {
      "model": "LTM 1100-5.2",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 52
    },
    {
      "model": "LTM 1110-5.1",
      "capacity": 110,
      "type": "All-Terrain Crane",
      "boomLength": 60
    },
    {
      "model": "LTM 1120-4.1",
      "capacity": 120,
      "type": "All-Terrain Crane",
      "boomLength": 60
    },
    {
      "model": "LTM 1130-5.1",
      "capacity": 130,
      "type": "All-Terrain Crane",
      "boomLength": 60
    },
    {
      "model": "LTM 1160-5.2",
      "capacity": 160,
      "type": "All-Terrain Crane",
      "boomLength": 62
    },
    {
      "model": "LTM 1200-5.1",
      "capacity": 200,
      "type": "All-Terrain Crane",
      "boomLength": 72
    },
    {
      "model": "LTM 1220-5.2",
      "capacity": 220,
      "type": "All-Terrain Crane",
      "boomLength": 78
    },
    {
      "model": "LTM 1230-5.1",
      "capacity": 230,
      "type": "All-Terrain Crane",
      "boomLength": 78
    },
    {
      "model": "LTM 1250-6.1",
      "capacity": 250,
      "type": "All-Terrain Crane",
      "boomLength": 72
    },
    {
      "model": "LTM 1300-6.2",
      "capacity": 300,
      "type": "All-Terrain Crane",
      "boomLength": 78
    },
    {
      "model": "LTM 1350-6.1",
      "capacity": 350,
      "type": "All-Terrain Crane",
      "boomLength": 84
    },
    {
      "model": "LTM 1400-7.1",
      "capacity": 400,
      "type": "All-Terrain Crane",
      "boomLength": 84
    },
    {
      "model": "LTM 1450-8.1",
      "capacity": 450,
      "type": "All-Terrain Crane",
      "boomLength": 85
    },
    {
      "model": "LTM 1500-8.1",
      "capacity": 500,
      "type": "All-Terrain Crane",
      "boomLength": 84
    },
    {
      "model": "LTM 1650-8.1",
      "capacity": 650,
      "type": "All-Terrain Crane",
      "boomLength": 100
    },
    {
      "model": "LTM 1750-9.1",
      "capacity": 750,
      "type": "All-Terrain Crane",
      "boomLength": 100
    },
    {
      "model": "LTM 11200-9.1",
      "capacity": 1200,
      "type": "All-Terrain Crane",
      "boomLength": 100
    },
    {
      "model": "LTC 1045-3.1",
      "capacity": 45,
      "type": "City Crane",
      "boomLength": 36
    },
    {
      "model": "LTC 1050-3.1",
      "capacity": 50,
      "type": "City Crane",
      "boomLength": 30
    },
    {
      "model": "LRT 1090-2.1",
      "capacity": 90,
      "type": "Rough Terrain Crane",
      "boomLength": 50
    },
    {
      "model": "LRT 1100-2.1",
      "capacity": 100,
      "type": "Rough Terrain Crane",
      "boomLength": 52
    },
    {
      "model": "LTR 1040",
      "capacity": 40,
      "type": "Telescopic Crawler Crane",
      "boomLength": 40
    },
    {
      "model": "LTR 1060",
      "capacity": 60,
      "type": "Telescopic Crawler Crane",
      "boomLength": 48
    },
    {
      "model": "LTR 1100",
      "capacity": 100,
      "type": "Telescopic Crawler Crane",
      "boomLength": 52
    },
    {
      "model": "LTR 1220",
      "capacity": 220,
      "type": "Telescopic Crawler Crane",
      "boomLength": 60
    },
    {
      "model": "LR 1100",
      "capacity": 100,
      "type": "Crawler Crane",
      "boomLength": 78
    },
    {
      "model": "LR 1160",
      "capacity": 160,
      "type": "Crawler Crane",
      "boomLength": 81
    },
    {
      "model": "LR 1200",
      "capacity": 200,
      "type": "Crawler Crane",
      "boomLength": 102
    },
    {
      "model": "LR 1250",
      "capacity": 250,
      "type": "Crawler Crane",
      "boomLength": 102
    },
    {
      "model": "LR 1280",
      "capacity": 280,
      "type": "Crawler Crane",
      "boomLength": 102
    },
    {
      "model": "LR 1300.1 SX",
      "capacity": 300,
      "type": "Crawler Crane",
      "boomLength": 102
    },
    {
      "model": "LR 1350/1",
      "capacity": 350,
      "type": "Crawler Crane",
      "boomLength": 126
    },
    {
      "model": "LR 1400/2",
      "capacity": 400,
      "type": "Crawler Crane",
      "boomLength": 126
    },
    {
      "model": "LR 1500",
      "capacity": 500,
      "type": "Crawler Crane",
      "boomLength": 126
    },
    {
      "model": "LR 1600/2",
      "capacity": 600,
      "type": "Crawler Crane",
      "boomLength": 147
    },
    {
      "model": "LR 1700-1.0",
      "capacity": 700,
      "type": "Crawler Crane",
      "boomLength": 147
    },
    {
      "model": "LR 1750/2",
      "capacity": 750,
      "type": "Crawler Crane",
      "boomLength": 147
    },
    {
      "model": "LR 1800-1.0",
      "capacity": 800,
      "type": "Crawler Crane",
      "boomLength": 168
    },
    {
      "model": "LR 11350",
      "capacity": 1350,
      "type": "Crawler Crane",
      "boomLength": 198
    },
    {
      "model": "LR 13000",
      "capacity": 3000,
      "type": "Crawler Crane",
      "boomLength": 246
    },
    {
      "model": "LG 1750",
      "capacity": 750,
      "type": "Gantry Crane",
      "boomLength": 120
    }
  ],
  "Tadano": [
    {
      "model": "GR-550XL",
      "capacity": 55,
      "type": "Rough Terrain Crane",
      "boomLength": 113
    },
    {
      "model": "GR-1000XLL",
      "capacity": 100,
      "type": "Rough Terrain Crane",
      "boomLength": 167
    },
    {
      "model": "TR-250M",
      "capacity": 25,
      "type": "Truck-Mounted Crane",
      "boomLength": 98
    },
    {
      "model": "AR-2000M",
      "capacity": 200,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "GR-750XL",
      "capacity": 75,
      "type": "Rough Terrain Crane",
      "boomLength": 141
    },
    {
      "model": "ATF 110G-5",
      "capacity": 120,
      "type": "All-Terrain Crane",
      "boomLength": 171
    },
    {
      "model": "TR-500XL",
      "capacity": 50,
      "type": "Truck-Mounted Crane",
      "boomLength": 138
    },
    {
      "model": "GR-1600XL",
      "capacity": 160,
      "type": "Rough Terrain Crane",
      "boomLength": 200
    },
    {
      "model": "GR-300EX",
      "capacity": 30,
      "type": "Rough Terrain Crane",
      "boomLength": 102
    },
    {
      "model": "ATF 400G-6",
      "capacity": 400,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "TR-800M",
      "capacity": 80,
      "type": "Truck-Mounted Crane",
      "boomLength": 145
    },
    {
      "model": "GR-1000XL",
      "capacity": 100,
      "type": "Rough Terrain Crane",
      "boomLength": 154
    },
    {
      "model": "AR-5500M",
      "capacity": 550,
      "type": "All-Terrain Crane",
      "boomLength": 275
    },
    {
      "model": "GR-350XL",
      "capacity": 35,
      "type": "Rough Terrain Crane",
      "boomLength": 101
    },
    {
      "model": "GR-500EX",
      "capacity": 50,
      "type": "Rough Terrain Crane",
      "boomLength": 141
    },
    {
      "model": "ATF 200G-5",
      "capacity": 220,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "GR-700EX",
      "capacity": 70,
      "type": "Rough Terrain Crane",
      "boomLength": 147
    },
    {
      "model": "TR-600XL",
      "capacity": 60,
      "type": "Truck-Mounted Crane",
      "boomLength": 150
    },
    {
      "model": "GR-750EX",
      "capacity": 75,
      "type": "Rough Terrain Crane",
      "boomLength": 147
    },
    {
      "model": "ATF 180G-5",
      "capacity": 200,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "TR-100M",
      "capacity": 10,
      "type": "Truck-Mounted Crane",
      "boomLength": 65
    },
    {
      "model": "GR-1450EX",
      "capacity": 145,
      "type": "Rough Terrain Crane",
      "boomLength": 200
    },
    {
      "model": "ATF 90G-4",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 154
    },
    {
      "model": "GR-150XL",
      "capacity": 15,
      "type": "Rough Terrain Crane",
      "boomLength": 79
    },
    {
      "model": "TR-350M",
      "capacity": 35,
      "type": "Truck-Mounted Crane",
      "boomLength": 110
    },
    {
      "model": "ATF 70G-4",
      "capacity": 75,
      "type": "All-Terrain Crane",
      "boomLength": 164
    },
    {
      "model": "GR-900XL",
      "capacity": 90,
      "type": "Rough Terrain Crane",
      "boomLength": 154
    },
    {
      "model": "ATF 220G-5",
      "capacity": 250,
      "type": "All-Terrain Crane",
      "boomLength": 223
    },
    {
      "model": "TR-600M",
      "capacity": 60,
      "type": "Truck-Mounted Crane",
      "boomLength": 141
    },
    {
      "model": "GR-1200XL",
      "capacity": 120,
      "type": "Rough Terrain Crane",
      "boomLength": 184
    },
    {
      "model": "ATF 150G-5",
      "capacity": 165,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "GR-600XL",
      "capacity": 60,
      "type": "Rough Terrain Crane",
      "boomLength": 138
    },
    {
      "model": "TR-80M",
      "capacity": 8,
      "type": "Truck-Mounted Crane",
      "boomLength": 62
    },
    {
      "model": "ATF 60G-3",
      "capacity": 70,
      "type": "All-Terrain Crane",
      "boomLength": 142
    },
    {
      "model": "GR-1300XL",
      "capacity": 130,
      "type": "Rough Terrain Crane",
      "boomLength": 184
    },
    {
      "model": "TR-350XL",
      "capacity": 35,
      "type": "Truck-Mounted Crane",
      "boomLength": 110
    },
    {
      "model": "GR-800EX",
      "capacity": 80,
      "type": "Rough Terrain Crane",
      "boomLength": 144
    },
    {
      "model": "AR-5000M",
      "capacity": 500,
      "type": "All-Terrain Crane",
      "boomLength": 260
    },
    {
      "model": "GR-250N",
      "capacity": 25,
      "type": "Rough Terrain Crane",
      "boomLength": 95
    },
    {
      "model": "ATF 130G-5",
      "capacity": 150,
      "type": "All-Terrain Crane",
      "boomLength": 197
    },
    {
      "model": "GR-800XL",
      "capacity": 80,
      "type": "Rough Terrain Crane",
      "boomLength": 154
    },
    {
      "model": "TR-300M",
      "capacity": 30,
      "type": "Truck-Mounted Crane",
      "boomLength": 105
    },
    {
      "model": "GR-200EX",
      "capacity": 20,
      "type": "Rough Terrain Crane",
      "boomLength": 82
    },
    {
      "model": "ATF 100G-4",
      "capacity": 110,
      "type": "All-Terrain Crane",
      "boomLength": 164
    },
    {
      "model": "GR-700XL",
      "capacity": 70,
      "type": "Rough Terrain Crane",
      "boomLength": 147
    },
    {
      "model": "TR-550M",
      "capacity": 55,
      "type": "Truck-Mounted Crane",
      "boomLength": 130
    },
    {
      "model": "GR-100EX",
      "capacity": 10,
      "type": "Rough Terrain Crane",
      "boomLength": 72
    },
    {
      "model": "GR-600EX",
      "capacity": 60,
      "type": "Rough Terrain Crane",
      "boomLength": 141
    },
    {
      "model": "TR-300XL",
      "capacity": 30,
      "type": "Truck-Mounted Crane",
      "boomLength": 105
    },
    {
      "model": "GR-200XL",
      "capacity": 20,
      "type": "Rough Terrain Crane",
      "boomLength": 79
    }
  ],
  "Grove": [
    {
      "model": "GMK5250L",
      "capacity": 250,
      "type": "All-Terrain Crane",
      "boomLength": 200
    },
    {
      "model": "GMK5150L",
      "capacity": 150,
      "type": "All-Terrain Crane",
      "boomLength": 180
    },
    {
      "model": "GMK5200",
      "capacity": 200,
      "type": "All-Terrain Crane",
      "boomLength": 190
    },
    {
      "model": "GMK6300L",
      "capacity": 300,
      "type": "All-Terrain Crane",
      "boomLength": 220
    },
    {
      "model": "GMK6400",
      "capacity": 400,
      "type": "All-Terrain Crane",
      "boomLength": 240
    },
    {
      "model": "GMK7450",
      "capacity": 450,
      "type": "All-Terrain Crane",
      "boomLength": 260
    },
    {
      "model": "RT540E",
      "capacity": 40,
      "type": "Rough Terrain Crane",
      "boomLength": 110
    },
    {
      "model": "RT550E",
      "capacity": 50,
      "type": "Rough Terrain Crane",
      "boomLength": 120
    },
    {
      "model": "RT555E",
      "capacity": 55,
      "type": "Rough Terrain Crane",
      "boomLength": 125
    },
    {
      "model": "RT560E",
      "capacity": 60,
      "type": "Rough Terrain Crane",
      "boomLength": 130
    },
    {
      "model": "RT765E-2",
      "capacity": 65,
      "type": "Rough Terrain Crane",
      "boomLength": 135
    },
    {
      "model": "RT770E",
      "capacity": 70,
      "type": "Rough Terrain Crane",
      "boomLength": 140
    },
    {
      "model": "RT775E",
      "capacity": 75,
      "type": "Rough Terrain Crane",
      "boomLength": 145
    },
    {
      "model": "RT780E",
      "capacity": 80,
      "type": "Rough Terrain Crane",
      "boomLength": 150
    },
    {
      "model": "RT890E",
      "capacity": 90,
      "type": "Rough Terrain Crane",
      "boomLength": 155
    },
    {
      "model": "RT9130E-2",
      "capacity": 130,
      "type": "Rough Terrain Crane",
      "boomLength": 175
    },
    {
      "model": "GRT8100",
      "capacity": 100,
      "type": "Rough Terrain Crane",
      "boomLength": 160
    },
    {
      "model": "GRT8120",
      "capacity": 120,
      "type": "Rough Terrain Crane",
      "boomLength": 170
    },
    {
      "model": "GRT655",
      "capacity": 55,
      "type": "Rough Terrain Crane",
      "boomLength": 125
    },
    {
      "model": "GRT880",
      "capacity": 80,
      "type": "Rough Terrain Crane",
      "boomLength": 150
    },
    {
      "model": "GMK3050-2",
      "capacity": 50,
      "type": "All-Terrain Crane",
      "boomLength": 130
    },
    {
      "model": "GMK3060",
      "capacity": 60,
      "type": "All-Terrain Crane",
      "boomLength": 140
    },
    {
      "model": "GMK4080-1",
      "capacity": 80,
      "type": "All-Terrain Crane",
      "boomLength": 150
    },
    {
      "model": "GMK4100L-1",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 160
    },
    {
      "model": "GMK5130-2",
      "capacity": 130,
      "type": "All-Terrain Crane",
      "boomLength": 170
    }
  ],
  "Manitowoc": [
    {
      "model": "18000",
      "capacity": 550,
      "type": "Crawler Crane",
      "boomLength": 320
    },
    {
      "model": "MLC300",
      "capacity": 300,
      "type": "Crawler Crane",
      "boomLength": 220
    },
    {
      "model": "MLC650",
      "capacity": 650,
      "type": "Crawler Crane",
      "boomLength": 350
    },
    {
      "model": "MLC100-1",
      "capacity": 100,
      "type": "Crawler Crane",
      "boomLength": 180
    },
    {
      "model": "MLC165",
      "capacity": 165,
      "type": "Crawler Crane",
      "boomLength": 200
    },
    {
      "model": "999",
      "capacity": 275,
      "type": "Crawler Crane",
      "boomLength": 240
    },
    {
      "model": "2250",
      "capacity": 300,
      "type": "Crawler Crane",
      "boomLength": 260
    },
    {
      "model": "4100W",
      "capacity": 230,
      "type": "Crawler Crane",
      "boomLength": 210
    },
    {
      "model": "4600S",
      "capacity": 250,
      "type": "Crawler Crane",
      "boomLength": 230
    },
    {
      "model": "16000",
      "capacity": 440,
      "type": "Crawler Crane",
      "boomLength": 300
    },
    {
      "model": "21000",
      "capacity": 600,
      "type": "Crawler Crane",
      "boomLength": 360
    },
    {
      "model": "31000",
      "capacity": 880,
      "type": "Crawler Crane",
      "boomLength": 420
    },
    {
      "model": "MLC100",
      "capacity": 100,
      "type": "Crawler Crane",
      "boomLength": 175
    },
    {
      "model": "MLC150",
      "capacity": 150,
      "type": "Crawler Crane",
      "boomLength": 190
    },
    {
      "model": "MLC200",
      "capacity": 200,
      "type": "Crawler Crane",
      "boomLength": 210
    }
  ],
  "Sany": [
    {
      "model": "SCC8500",
      "capacity": 850,
      "type": "Crawler Crane",
      "boomLength": 440
    },
    {
      "model": "SCC4000E",
      "capacity": 400,
      "type": "Crawler Crane",
      "boomLength": 300
    },
    {
      "model": "SCC6500A",
      "capacity": 650,
      "type": "Crawler Crane",
      "boomLength": 380
    },
    {
      "model": "SCC1000A",
      "capacity": 100,
      "type": "Crawler Crane",
      "boomLength": 180
    },
    {
      "model": "SCC2500A",
      "capacity": 250,
      "type": "Crawler Crane",
      "boomLength": 240
    },
    {
      "model": "SAC1800",
      "capacity": 180,
      "type": "All-Terrain Crane",
      "boomLength": 190
    },
    {
      "model": "SAC2200",
      "capacity": 220,
      "type": "All-Terrain Crane",
      "boomLength": 210
    },
    {
      "model": "SAC3000",
      "capacity": 300,
      "type": "All-Terrain Crane",
      "boomLength": 230
    },
    {
      "model": "SAC4000",
      "capacity": 400,
      "type": "All-Terrain Crane",
      "boomLength": 250
    },
    {
      "model": "STC250",
      "capacity": 25,
      "type": "Truck-Mounted Crane",
      "boomLength": 100
    },
    {
      "model": "STC500",
      "capacity": 50,
      "type": "Truck-Mounted Crane",
      "boomLength": 130
    },
    {
      "model": "STC750",
      "capacity": 75,
      "type": "Truck-Mounted Crane",
      "boomLength": 150
    }
  ],
  "Kobelco": [
    {
      "model": "CK1600G-2",
      "capacity": 160,
      "type": "Crawler Crane",
      "boomLength": 164
    },
    {
      "model": "CK2750G",
      "capacity": 275,
      "type": "Crawler Crane",
      "boomLength": 230
    },
    {
      "model": "CK3300G",
      "capacity": 330,
      "type": "Crawler Crane",
      "boomLength": 260
    },
    {
      "model": "CK850G-2",
      "capacity": 85,
      "type": "Crawler Crane",
      "boomLength": 150
    },
    {
      "model": "CK1000G-2",
      "capacity": 100,
      "type": "Crawler Crane",
      "boomLength": 160
    },
    {
      "model": "CK1200G",
      "capacity": 120,
      "type": "Crawler Crane",
      "boomLength": 170
    },
    {
      "model": "CK2000-II",
      "capacity": 200,
      "type": "Crawler Crane",
      "boomLength": 200
    },
    {
      "model": "CK2500-II",
      "capacity": 250,
      "type": "Crawler Crane",
      "boomLength": 220
    },
    {
      "model": "CK3000G",
      "capacity": 300,
      "type": "Crawler Crane",
      "boomLength": 250
    },
    {
      "model": "CK4000",
      "capacity": 400,
      "type": "Crawler Crane",
      "boomLength": 280
    },
    {
      "model": "CK5500",
      "capacity": 550,
      "type": "Crawler Crane",
      "boomLength": 320
    },
    {
      "model": "CK750G",
      "capacity": 75,
      "type": "Crawler Crane",
      "boomLength": 140
    },
    {
      "model": "CK900G",
      "capacity": 90,
      "type": "Crawler Crane",
      "boomLength": 155
    },
    {
      "model": "CK1100G",
      "capacity": 110,
      "type": "Crawler Crane",
      "boomLength": 165
    }
  ],
  "Link-Belt": [
    {
      "model": "RTC-8090 II",
      "capacity": 90,
      "type": "Rough Terrain Crane",
      "boomLength": 136
    },
    {
      "model": "RTC-8065 II",
      "capacity": 65,
      "type": "Rough Terrain Crane",
      "boomLength": 125
    },
    {
      "model": "RTC-8050 II",
      "capacity": 50,
      "type": "Rough Terrain Crane",
      "boomLength": 115
    },
    {
      "model": "RTC-80100 II",
      "capacity": 100,
      "type": "Rough Terrain Crane",
      "boomLength": 145
    },
    {
      "model": "RTC-80110 II",
      "capacity": 110,
      "type": "Rough Terrain Crane",
      "boomLength": 155
    },
    {
      "model": "RTC-80130 II",
      "capacity": 130,
      "type": "Rough Terrain Crane",
      "boomLength": 165
    },
    {
      "model": "RTC-80150 II",
      "capacity": 150,
      "type": "Rough Terrain Crane",
      "boomLength": 175
    },
    {
      "model": "RTC-80160 II",
      "capacity": 160,
      "type": "Rough Terrain Crane",
      "boomLength": 180
    }
  ],
  "Terex": [
    {
      "model": "AC 100/4L",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 140
    },
    {
      "model": "Demag AC 100-4L",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 140
    },
    {
      "model": "AC 250-1",
      "capacity": 250,
      "type": "All-Terrain Crane",
      "boomLength": 200
    }
  ],
  "Zoomlion": [
    {
      "model": "QY70V",
      "capacity": 70,
      "type": "All-Terrain Crane",
      "boomLength": 128
    },
    {
      "model": "QY100V",
      "capacity": 100,
      "type": "All-Terrain Crane",
      "boomLength": 150
    }
  ],
  "Caterpillar": [
    {
      "model": "CAT 320",
      "capacity": 180,
      "type": "Crawler Crane",
      "boomLength": 172
    }
  ],
  "Demag": [
    {
      "model": "AC 220-5",
      "capacity": 220,
      "type": "All-Terrain Crane",
      "boomLength": 188
    }
  ]
};


// Populate model dropdown when manufacturer is selected
function populateModelDropdown(manufacturer) {
    const modelSelect = document.getElementById('model');
    if (!modelSelect) return;
    
    modelSelect.innerHTML = '<option value="">Select Model</option>';
    const models = craneDatabase[manufacturer] || [];
    
    models.forEach(crane => {
        const option = document.createElement('option');
        option.value = crane.model;
        option.textContent = crane.model;
        modelSelect.appendChild(option);
    });
    
    console.log(`Loaded ${models.length} models for ${manufacturer}`);
}

// Auto-fill specifications when model is selected
function autofillCraneSpecs(manufacturer, model) {
    const models = craneDatabase[manufacturer] || [];
    const craneData = models.find(c => c.model === model);
    
    if (!craneData) return;
    
    // Fill capacity
    const capacityInput = document.getElementById('capacity');
    if (capacityInput) {
        capacityInput.value = craneData.capacity;
        capacityInput.style.transition = 'border 0.3s';
        capacityInput.style.border = '2px solid #00ff88';
        setTimeout(() => capacityInput.style.border = '', 2000);
    }
    
    // Fill crane type
    const craneTypeSelect = document.getElementById('craneType');
    if (craneTypeSelect) {
        const options = Array.from(craneTypeSelect.options);
        const match = options.find(opt => opt.textContent.includes(craneData.type));
        if (match) {
            craneTypeSelect.value = match.value;
            craneTypeSelect.style.transition = 'border 0.3s';
            craneTypeSelect.style.border = '2px solid #00ff88';
            setTimeout(() => craneTypeSelect.style.border = '', 2000);
        }
    }
    
    // Fill boom length
    const boomInput = document.getElementById('boomLength');
    if (boomInput) {
        boomInput.value = craneData.boomLength;
        boomInput.style.transition = 'border 0.3s';
        boomInput.style.border = '2px solid #00ff88';
        setTimeout(() => boomInput.style.border = '', 2000);
    }
    
    // Show success message
    showToast(`✓ ${manufacturer} ${model} loaded (${craneData.capacity}T)`);
}

// Show toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Initialize auto-prefill
document.addEventListener('DOMContentLoaded', function() {
    const mfrSelect = document.getElementById('manufacturer');
    const mdlSelect = document.getElementById('model');
    
    if (mfrSelect) {
        mfrSelect.addEventListener('change', function() {
            const mfr = this.value;
            if (mfr && mfr !== 'Select Manufacturer') {
                populateModelDropdown(mfr);
            }
        });
    }
    
    if (mdlSelect) {
        mdlSelect.addEventListener('change', function() {
            const model = this.value;
            const mfr = mfrSelect ? mfrSelect.value : '';
            if (model && model !== 'Select Model' && mfr) {
                autofillCraneSpecs(mfr, model);
            }
        });
    }
    
    console.log('✓ Auto-prefill initialized with', Object.keys(craneDatabase).length, 'manufacturers');
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ========================================
// GLOBAL FUNCTIONS FOR ONCLICK HANDLERS
// ========================================

// Global function for VALUE CRANE button (called via onclick)
function performValuation() {
    console.log('✓ performValuation() called!');
    
    // Get form values
    const manufacturer = document.getElementById('manufacturer').value;
    const model = document.getElementById('model').value;
    const year = parseInt(document.getElementById('year').value);
    const capacity = parseFloat(document.getElementById('capacity').value);
    const hours = parseFloat(document.getElementById('hours').value);
    const craneType = document.getElementById('craneType').value;
    const region = document.getElementById('region').value;
    
    console.log('Form values:', { manufacturer, model, year, capacity, hours, craneType, region });
    
    // Validate required fields
    if (!manufacturer || manufacturer === 'Select Manufacturer') {
        alert('❌ Please select a manufacturer');
        return;
    }
    if (!model || model === 'Select Model') {
        alert('❌ Please select a model');
        return;
    }
    if (!year || isNaN(year)) {
        alert('❌ Please enter a valid year');
        return;
    }
    if (!capacity || isNaN(capacity)) {
        alert('❌ Please enter capacity');
        return;
    }
    if (!hours || isNaN(hours)) {
        alert('❌ Please enter operating hours');
        return;
    }
    if (!craneType || craneType === 'Select Crane Type') {
        alert('❌ Please select crane type');
        return;
    }
    if (!region || region === 'Select Region') {
        alert('❌ Please select a region');
        return;
    }
    
    console.log('✓ All validations passed, performing calculation...');
    
    // Get additional form values
    const boomLength = parseFloat(document.getElementById('boomLength').value) || 0;
    const jibIncluded = document.getElementById('jibIncluded').value;
    const jibLength = parseFloat(document.getElementById('jibLength').value) || 0;
    const estimatedValue = 0; // Will be calculated
    const submitBtn = null; // Not needed for display
    const originalText = ''; // Not needed for display
    
    // Call the existing calculation function with all required parameters
    if (typeof continueLocalCalculations === 'function') {
        continueLocalCalculations(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
    } else {
        console.error('❌ continueLocalCalculations function not found!');
        alert('Error: Calculation function not available');
    }
}

// Global function for LOAD SAMPLE DATA button
function loadSampleData() {
    console.log('✓ loadSampleData() called!');
    
    try {
        // Set sample values
        document.getElementById('manufacturer').value = 'Liebherr';
        
        // Trigger change event to populate models
        const mfrEvent = new Event('change', { bubbles: true });
        document.getElementById('manufacturer').dispatchEvent(mfrEvent);
        
        console.log('✓ Manufacturer set to Liebherr, waiting for models to populate...');
        
        // Wait a bit for models to populate, then set model
        setTimeout(() => {
            const modelSelect = document.getElementById('model');
            console.log('Model options available:', modelSelect.options.length);
            
            if (modelSelect.options.length > 1) {
                modelSelect.selectedIndex = 1;
                const modelEvent = new Event('change', { bubbles: true });
                modelSelect.dispatchEvent(modelEvent);
                console.log('✓ Model selected:', modelSelect.value);
            }
            
            // Set other fields
            document.getElementById('year').value = '2020';
            document.getElementById('capacity').value = '500';
            document.getElementById('hours').value = '5000';
            document.getElementById('craneType').value = 'All-Terrain Crane';
            document.getElementById('boomLength').value = '60';
            document.getElementById('region').value = 'North America';
            document.getElementById('mileage').value = '25000';
            
            console.log('✓ All sample data loaded!');
            
            // Show toast notification
            showToast('✓ Sample data loaded successfully', 'success');
        }, 500);
    } catch (error) {
        console.error('❌ Error loading sample data:', error);
        alert('Error loading sample data: ' + error.message);
    }
}

// Helper function to show toast notifications
function showToast(message, type = 'success') {
    console.log('Toast:', message, type);
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? '#00ff88' : '#ff4444'};
        color: #000;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

console.log('✓ Global onclick functions loaded successfully!');

</script>

</body>
</html>

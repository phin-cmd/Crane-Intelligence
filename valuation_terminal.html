<!-- Updated: 20251016192928 - v3.2 with 30 Kobelco models -->
<!-- Crane Intelligence Platform - Valuation Terminal v3.9 | Last Updated: Oct 12, 2025 | Smart Rental Engine Integrated -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CRANE INTELLIGENCE - Valuation Terminal v3.9</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/unified-header.css">
    <link rel="icon" type="image/x-icon" href="images/logos/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* COMPREHENSIVE ANTI-FLICKERING CSS */
        * {
            transition: none !important;
            animation: none !important;
        }
        
        /* Prevent all visual updates that cause flickering */
        .metric-value, .chart-container, .data-card, .live-data, .market-data {
            transition: none !important;
            animation: none !important;
            transform: none !important;
        }
        
        /* Disable hover effects that might cause flickering */
        *:hover {
            transition: none !important;
        }
        
        /* Prevent layout shifts */
        .ticker-card, .metric-item, .dashboard-metric {
            min-height: 1.2em;
            overflow: hidden;
        }
        /* ===== VALUATION TERMINAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0F0F0F;
            color: #FFFFFF;
            line-height: 1.6;
            overflow-x: hidden;
        }
        /* Header Styles - Fixed Logo Alignment */
        .header {
            background: #1A1A1A !important;
            border-bottom: 1px solid #404040 !important;
            padding: 0 !important;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 100px;
        }
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            height: 100%;
        }
        .logo-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        .logo-container:hover {
            opacity: 0.8;
        }
        .logo {
            height: 50px;
            width: auto;
        }
        /* Stock Ticker */
        .stock-ticker {
            background: #1A1A1A !important;
            padding: 8px 0 !important;
            border-bottom: 1px solid #404040 !important;
            overflow: hidden !important;
            white-space: nowrap !important;
            display: block !important;
            height: auto !important;
        }
        .ticker-container {
            max-width: 1400px !important;
            margin: 0 auto !important;
            padding: 0 20px !important;
            overflow: hidden !important;
        }
        .ticker-content {
            display: inline-flex !important;
            align-items: center !important;
            gap: 40px !important;
            animation: scroll-left 30s linear infinite !important;
            white-space: nowrap !important;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            will-change: transform !important;
        }
        .ticker-item {
            margin-right: 3rem;
        }
        .ticker-symbol {
            color: #FFFFFF;
            margin-right: 0.5rem;
        }
        .ticker-price {
            color: #FFFFFF;
            margin-right: 0.5rem;
        }
        .ticker-change.positive {
            color: #00FF88;
        }
        .ticker-change.negative {
            color: #FF4444;
        }
        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            cursor: pointer;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #00FF88;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
            font-size: 0.9rem;
        }
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-email {
            font-size: 0.9rem;
            color: #FFFFFF;
            font-weight: 500;
        }
        .user-role {
            font-size: 0.8rem;
            color: #888;
        }
        .dropdown-arrow {
            margin-left: 0.5rem;
            color: #888;
            transition: transform 0.3s ease;
        }
        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        /* User Profile Dropdown */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
            margin-top: 10px;
        }
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            padding: 12px 16px;
            color: #FFFFFF;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
            border-bottom: 1px solid #404040;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background: #404040;
        }
        .dropdown-item.logout {
            color: #FF4444;
        }
        /* Main Content */
        .main-content {
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        .page-title {
            text-align: center;
            margin-bottom: 1rem;
        }
        .page-title h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            color: #FFFFFF;
            margin-bottom: 0.5rem;
        }
        .page-subtitle {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 3rem;
        }
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 3rem;
        }
        .tab-btn {
            background: #2A2A2A;
            color: #FFFFFF;
            border: 1px solid #404040;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:first-child {
            border-radius: 8px 0 0 8px;
        }
        .tab-btn:last-child {
            border-radius: 0 8px 8px 0;
            border-left: none;
        }
        .tab-btn.active {
            background: #00FF88;
            color: #000000;
            border-color: #00FF88;
        }
        .tab-btn:hover:not(.active) {
            background: #404040;
        }
        /* Tab Content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Single Valuation Form */
        .valuation-form {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .form-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: #FFFFFF;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group.half-width {
            grid-column: span 2;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #FFFFFF;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input, .form-select {
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .form-input::placeholder {
            color: #666;
        }
        .form-select option {
            background: #2A2A2A;
            color: #FFFFFF;
        }
        /* Form Buttons */
        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-secondary {
            background: #404040;
            color: #FFFFFF;
            font-size: 1rem;
            padding: 12px 28px;
            border: 1px solid #555;
        }
        .btn-secondary:hover {
            background: #555;
            border-color: #666;
            transform: translateY(-1px);
        }
        .btn-primary {
            background: #00FF88;
            color: #000000;
            font-size: 1.1rem;
            padding: 14px 32px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        .btn-primary:hover {
            background: #00E67A;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 255, 136, 0.4);
        }
        /* Action Buttons Container */

        /* Enhanced Action Button Styles - Bloomberg Terminal Aesthetic */
        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
            padding: 20px 0;
        }
        
        .action-buttons .btn {
            font-family: 'Roboto Condensed', 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
            padding: 14px 32px;
            border: none;
            border-radius: 2px;
            text-transform: uppercase;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            min-width: 180px;
        }
        
        .action-buttons .btn-secondary {
            background: linear-gradient(135deg, #424242 0%, #303030 100%);
            color: #FFD600;
            border: 1px solid #FFD600;
        }
        
        .action-buttons .btn-secondary:hover {
            background: linear-gradient(135deg, #505050 0%, #404040 100%);
            border-color: #FFED4E;
            color: #FFED4E;
            box-shadow: 0 4px 8px rgba(255, 214, 0, 0.3);
            transform: translateY(-1px);
        }
        
        .action-buttons .btn-primary {
            background: linear-gradient(135deg, #00FF85 0%, #00CC6A 100%);
            color: #121212;
            border: 1px solid #00FF85;
        }
        
        .action-buttons .btn-primary:hover {
            background: linear-gradient(135deg, #00FF9A 0%, #00DD7A 100%);
            border-color: #00FFAA;
            box-shadow: 0 4px 8px rgba(0, 255, 133, 0.4);
            transform: translateY(-1px);
        }
        
        .action-buttons .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }


        /* Valuation Results */
        .valuation-results {
            display: none;
            margin-top: 2rem;
        }
        .valuation-results.show {
            display: block;
        }
        .results-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .result-card {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #00FF88;
            margin-bottom: 0.5rem;
        }
        .result-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .result-sublabel {
            font-size: 0.8rem;
            color: #00FF88;
        }
        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 2rem;
        }
        .analysis-tab {
            background: #2A2A2A;
            color: #FFFFFF;
            border: 1px solid #404040;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .analysis-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .analysis-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .analysis-tab:not(:first-child) {
            border-left: none;
        }
        .analysis-tab.active {
            background: #FFFFFF;
            color: #000000;
        }
        .analysis-tab:hover:not(.active) {
            background: #404040;
        }
        /* Analysis Content */
        .analysis-content {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            min-height: 500px;
        }
        .analysis-section {
            display: none;
        }
        .analysis-section.active {
            display: block;
        }
        .chart-container {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            height: 400px;
            position: relative;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            color: #FFFFFF;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .metric-card {
            background: #2A2A2A;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #00FF88;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        /* Bulk Processing */
        .bulk-upload {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 2px dashed #404040;
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        .upload-area:hover {
            border-color: #00FF88;
            background: rgba(0, 255, 136, 0.05);
        }
        .upload-area.dragover {
            border-color: #00FF88;
            background: rgba(0, 255, 136, 0.1);
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #FFFFFF;
        }
        .upload-subtext {
            font-size: 0.9rem;
            color: #888;
        }
        .template-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .template-btn:hover {
            background: #555;
        }
        /* Bulk Results */
        .bulk-results {
            display: none;
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        .bulk-results.show {
            display: block;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .results-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .results-summary {
            font-size: 0.9rem;
            color: #888;
        }
        .results-actions {
            display: flex;
            gap: 1rem;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #404040;
        }
        .results-table th {
            background: #2A2A2A;
            font-weight: 600;
            color: #FFFFFF;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }
        .results-table td {
            color: #FFFFFF;
        }
        .action-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: #555;
        }
        .action-btn.view {
            background: #00FF88;
            color: #000000;
        }
        .action-btn.view:hover {
            background: #00E67A;
        }
        .action-btn.delete {
            background: #FF4444;
        }
        .action-btn.delete:hover {
            background: #FF6666;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .pagination-btn {
            background: #404040;
            color: #FFFFFF;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #555;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #00FF88;
            color: #000000;
        }
        .pagination-info {
            color: #888;
            font-size: 0.9rem;
        }
        /* Quick Actions Tools */
        .quick-actions {
            margin: 3rem 0 2rem 0;
            padding: 2rem 0;
            border-top: 1px solid #404040;
        }
        .quick-actions-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 2.5rem;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .tool-card {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .tool-card:hover {
            border-color: #00FF88;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.1);
            transform: translateY(-2px);
        }
        .tool-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #404040;
        }
        .tool-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2A2A2A;
            border-radius: 8px;
        }
        .tool-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #FFFFFF;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tool-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .tool-input {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
        }
        .tool-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .tool-input::placeholder {
            color: #666;
        }
        .tool-select {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tool-select:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .tool-select option {
            background: #2A2A2A;
            color: #FFFFFF;
            padding: 10px;
        }
        .tool-btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        .tool-btn:hover {
            background: #00E67A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        .tool-btn:active {
            transform: translateY(0);
        }
        .converter-input-wrapper,
        .converter-result-wrapper {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .converter-input {
            width: 100%;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 14px 16px;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .converter-input:focus {
            outline: none;
            border-color: #00FF88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }
        .converter-input::placeholder {
            color: #666;
        }
        .converter-arrow-center {
            color: #00FF88;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }
        input[type="date"].tool-input,
        input[type="time"].tool-input {
            min-height: auto;
            cursor: pointer;
        }
        input[type="date"].tool-input::-webkit-calendar-picker-indicator,
        input[type="time"].tool-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        /* Footer */
        .footer {
            background: #1A1A1A;
            border-top: 1px solid #404040;
            padding: 3rem 0 2rem 0;
            margin-top: 2rem;
        }
        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        .footer-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .footer-section h3 {
            color: #00FF88;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .footer-section p {
            color: #888;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .footer-links {
            list-style: none;
        }
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        .footer-links a {
            color: #888;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer-links a:hover {
            color: #00FF88;
        }
        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .newsletter-input {
            flex: 1;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 12px;
            color: #FFFFFF;
        }
        .newsletter-input:focus {
            outline: none;
            border-color: #00FF88;
        }
        .newsletter-btn {
            background: #00FF88;
            color: #000000;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .newsletter-btn:hover {
            background: #00E67A;
        }
        .footer-bottom {
            border-top: 1px solid #404040;
            padding-top: 2rem;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }
        .footer-logo {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .footer-logo img {
            height: 40px;
            width: auto;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #FFFFFF;
        }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: #FFFFFF;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-container {
                padding: 0 1rem;
            }
            .main-content {
                padding: 1rem;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .results-cards {
                grid-template-columns: 1fr;
            }
            .tools-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .tool-card {
                padding: 1.5rem;
            }
            .tool-header {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
            }
            .tool-icon {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            .tool-title {
                font-size: 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .tab-navigation {
                flex-direction: column;
                align-items: center;
            }
            .tab-btn {
                border-radius: 8px !important;
                border: 1px solid #404040 !important;
                margin-bottom: 0.5rem;
            }
            .analysis-tabs {
                flex-wrap: wrap;
            }
            .analysis-tab {
                border-radius: 8px !important;
                border: 1px solid #404040 !important;
                margin: 0.25rem;
            }
            .newsletter-form {
                flex-direction: column;
            }
        }
    </style>
    <!-- Unified Authentication System -->
    <script src="/js/unified-auth.js" defer></script>
    <script src="js/anti-flickering.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
<body>
    <!-- ============================================ -->
    <!-- AUTHENTICATION CHECK - Restrict to logged-in users -->
    <!-- ============================================ -->
    <script>
        (function() {
            const token = localStorage.getItem('access_token');
            const userData = localStorage.getItem('user_data');
            
            if (!token || !userData) {
                console.log('‚ö†Ô∏è  Access denied: User not authenticated');
                console.log('üìã Token:', token ? 'exists' : 'missing');
                console.log('üìã User data:', userData ? 'exists' : 'missing');
                console.log('üîÑ Redirecting to homepage...');
                window.location.href = '/homepage.html';
            } else {
                console.log('‚úÖ Access granted: User authenticated');
                try {
                    const user = JSON.parse(userData);
                    console.log('üë§ User:', user.name || user.email || 'Unknown');
                } catch(e) {
                    console.log('‚ö†Ô∏è  Could not parse user data');
                }
            }
        })();
    </script>

    <!-- Header -->
        <!-- Unified Header -->
    <header class="header">
        <div class="header-container">
            <!-- Logo -->
            <div class="logo">
                <a href="/homepage.html" style="text-decoration: none; display: flex; align-items: center;">
                    <img src="/images/logos/crane-intelligence-logo.svg" alt="Crane Intelligence" class="logo-svg">
                </a>
            </div>

            <!-- Navigation Menu (visible on homepage, hidden on other pages when logged in) -->
            <nav class="nav-menu" id="navMenu">
                <a href="/homepage.html#features" class="nav-link">FEATURES</a>
                <a href="/homepage.html#pricing" class="nav-link">PRICING</a>
                <a href="/homepage.html#about" class="nav-link">ABOUT</a>
                <a href="/homepage.html#contact" class="nav-link">CONTACT</a>
            </nav>

            <!-- Right Side: Auth Buttons OR User Profile -->
            <div class="header-right">
                <!-- Login/Signup Buttons (shown when NOT logged in) -->
                <div class="auth-buttons" id="authButtons" style="display: none;">
                    <a href="/login.html" class="auth-btn login">Login</a>
                    <a href="/signup.html" class="auth-btn signup">Sign Up</a>
                </div>

                <!-- User Profile Dropdown (shown when logged in) -->
                <div class="user-profile" id="userProfile" style="display: none;">
                    <div class="user-avatar">
                        <span id="userInitials">U</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userDisplayName">User Name</div>
                        <div class="user-role" id="userRole">Free User</div>
                    </div>
                    <span class="dropdown-arrow">‚ñº</span>
                    
                    <!-- Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <a href="/dashboard.html" class="dropdown-item">
                            <span class="dropdown-icon">üìä</span>
                            Dashboard
                        </a>
                        <a href="/valuation-terminal.html" class="dropdown-item">
                            <span class="dropdown-icon">‚ö°</span>
                            Valuation Terminal
                        </a>
                        <a href="/account-settings.html" class="dropdown-item">
                            <span class="dropdown-icon">‚öôÔ∏è</span>
                            Account Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" data-action="logout">
                            <span class="dropdown-icon">üö™</span>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Stock Ticker -->
    <div class="stock-ticker">
        <div class="ticker-container">
            <div class="ticker-content">
            <span class="ticker-item">
                <span class="ticker-symbol">LIEBHERR</span>
                <span class="ticker-price">567.3</span>
                <span class="ticker-change positive">+3.1%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">TADANO</span>
                <span class="ticker-price">892.5</span>
                <span class="ticker-change positive">+2.4%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">GROVE</span>
                <span class="ticker-price">734.2</span>
                <span class="ticker-change positive">+1.8%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">MANITOWOC</span>
                <span class="ticker-price">456.8</span>
                <span class="ticker-change negative">-0.9%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">LINK-BELT</span>
                <span class="ticker-price">623.4</span>
                <span class="ticker-change positive">+1.5%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">SANY</span>
                <span class="ticker-price">789.1</span>
                <span class="ticker-change positive">+2.7%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">XCMG</span>
                <span class="ticker-price">467.8</span>
                <span class="ticker-change negative">-0.6%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">KOBELCO</span>
                <span class="ticker-price">512.3</span>
                <span class="ticker-change positive">+1.2%</span>
            </span>            <span class="ticker-item">
                <span class="ticker-symbol">LIEBHERR</span>
                <span class="ticker-price">567.3</span>
                <span class="ticker-change positive">+3.1%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">TADANO</span>
                <span class="ticker-price">892.5</span>
                <span class="ticker-change positive">+2.4%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">GROVE</span>
                <span class="ticker-price">734.2</span>
                <span class="ticker-change positive">+1.8%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">MANITOWOC</span>
                <span class="ticker-price">456.8</span>
                <span class="ticker-change negative">-0.9%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">LINK-BELT</span>
                <span class="ticker-price">623.4</span>
                <span class="ticker-change positive">+1.5%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">SANY</span>
                <span class="ticker-price">789.1</span>
                <span class="ticker-change positive">+2.7%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">XCMG</span>
                <span class="ticker-price">467.8</span>
                <span class="ticker-change negative">-0.6%</span>
            </span>
            <span class="ticker-item">
                <span class="ticker-symbol">KOBELCO</span>
                <span class="ticker-price">512.3</span>
                <span class="ticker-change positive">+1.2%</span>
            </span>
        </div>
    </div>
</div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Title -->
        <div class="page-title">
            <h1>VALUATION TERMINAL</h1>
            <p class="page-subtitle">Professional-grade crane valuation with Bloomberg-style analysis</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('single', this)">Single Valuation</button>
            <button class="tab-btn" onclick="switchTab('bulk', this)">üìä Bulk Processing</button>
        </div>

        <!-- Single Valuation Tab -->
        <div id="singleTab" class="tab-content active">
            <div class="valuation-form">
                <h2 class="form-title">Crane Valuation</h2>
                <form id="valuationForm">
                    <div class="form-grid">
                        <!-- First Row -->
                        <div class="form-group">
                            <label class="form-label">Manufacturer *</label>
                            <select class="form-select" id="manufacturer" required>
                                <option value="">Select Manufacturer</option>
                                <option value="Liebherr">Liebherr (49 models)</option>
                                <option value="Grove">Grove (25 models)</option>
                                <option value="Manitowoc">Manitowoc (15 models)</option>
                                <option value="Tadano">Tadano (15 models)</option>
                                <option value="Sany">Sany (12 models)</option>
                                <option value="Kobelco">Kobelco (30 models)</option>
                                <option value="Link-Belt">Link-Belt (39 models)</option>
                                <option value="Terex">Terex (3 models)</option>
                                <option value="XCMG">XCMG (3 models)</option>
                                <option value="Zoomlion">Zoomlion (2 models)</option>
                                <option value="HSC">HSC (2 models)</option>
                                <option value="Kato">Kato (3 models)</option>
                                <option value="IHI">IHI (2 models)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Model *</label>
                            <select class="form-select" id="model" required>
                                <option value="">Select Model</option>
                                <!-- Models will be populated dynamically based on manufacturer selection -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-input" id="year" placeholder="2023" required>
                        </div>
                        
                        <!-- Second Row -->
                        <div class="form-group">
                            <label class="form-label">Capacity (Tons) *</label>
                            <input type="number" class="form-input" id="capacity" placeholder="500" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Operating Hours *</label>
                            <input type="number" class="form-input" id="hours" placeholder="3700" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mileage</label>
                            <input type="number" class="form-input" id="mileage" placeholder="25000">
                        </div>
                        
                        <!-- Third Row -->
                        <div class="form-group">
                            <label class="form-label">Crane Type *</label>
                            <select class="form-select" id="craneType" required>
                                <option value="">Select Crane Type</option>
                                <option value="Crawler Crane">Crawler Crane</option>
                                <option value="All-Terrain Crane">All-Terrain Crane</option>
                                <option value="Rough Terrain Crane">Rough Terrain Crane</option>
                                <option value="Truck-Mounted Crane">Truck-Mounted Crane</option>
                                <option value="Telescopic Crawler Crane">Telescopic Crawler Crane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Boom Length (meters)</label>
                            <input type="number" class="form-input" id="boomLength" placeholder="60" step="0.1">
                            <small style="color: #888; font-size: 0.85em;">Typical: 20-80m for mobile cranes</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Region *</label>
                            <select class="form-select" id="region" required>
                                <option value="">Select Region</option>
                                <option value="North America">North America</option>
                                <option value="Europe">Europe</option>
                                <option value="Asia Pacific">Asia Pacific</option>
                                <option value="Middle East">Middle East</option>
                                <option value="Africa">Africa</option>
                                <option value="South America">South America</option>
                            </select>
                        </div>
                        
                        <!-- Fourth Row - Boom Package Details -->
                        <div class="form-group">
                            <label class="form-label">Jib Included</label>
                            <select class="form-select" id="jibIncluded">
                                <option value="no">No</option>
                                <option value="yes">Yes - Standard Jib</option>
                                <option value="luffing">Yes - Luffing Jib</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jib Length (ft)</label>
                            <input type="number" class="form-input" id="jibLength" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Asking Price (Optional)</label>
                            <input type="text" class="form-input" id="askingPrice" placeholder="$3,500,000">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="loadSampleData()">LOAD SAMPLE DATA</button>
                        <button type="button" class="btn btn-primary" onclick="performDirectValuation()">VALUE CRANE</button>
                    </div>
                </form>
            </div>

            <!-- Valuation Results -->
            <div id="valuationResults" class="valuation-results">
                <div class="results-cards">
                    <div class="result-card">
                        <div class="result-value" id="estimatedValue">--</div>
                        <div class="result-label">ESTIMATED VALUE</div>
                        <div class="result-sublabel" id="valueDifference">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="confidenceScore">--</div>
                        <div class="result-label">CONFIDENCE SCORE</div>
                        <div class="result-sublabel" id="confidenceLevel">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="dealGrade">--</div>
                        <div class="result-label">DEAL GRADE</div>
                        <div class="result-sublabel" id="dealRecommendation">--</div>
                    </div>
                </div>

                <!-- Analysis Tabs -->
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="switchAnalysis('overview', this)">üìä EXECUTIVE SUMMARY</button>
                    <button class="analysis-tab" onclick="switchAnalysis('costbreakdown', this)">üí∞ FINANCIAL</button>
                    <button class="analysis-tab" onclick="switchAnalysis('rental', this)">üìà RENTAL vs PURCHASE</button>
                    <button class="analysis-tab" onclick="switchAnalysis('comparables', this)">‚öñÔ∏è COMPARISON</button>
                    <button class="analysis-tab" onclick="switchAnalysis('risk', this)">‚ö†Ô∏è RISK & RESALE</button>
                </div>

                <div class="analysis-content">
                    <!-- Overview Section -->
                    <div id="overviewSection" class="analysis-section active">
                        <div class="chart-container">
                            <div class="chart-title">VALUATION TREND ANALYSIS</div>
                            <canvas id="trendChart"></canvas>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="ageFactorValue">--</div>
                                <div class="metric-label">AGE FACTOR</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="conditionValue">--</div>
                                <div class="metric-label">CONDITION</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="marketDemandValue">--</div>
                                <div class="metric-label">MARKET DEMAND</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="riskScoreValue">--</div>
                                <div class="metric-label">RISK SCORE</div>
                            </div>
                        </div>
                    </div>

                    <!-- Rental vs Purchase Analysis Section -->
                    <div id="rentalSection" class="analysis-section">
                        <div class="chart-title">RENTAL VS PURCHASE ANALYSIS</div>
                        
                        <!-- Cost Comparison Chart -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="height: 300px; margin-bottom: 1.5rem;">
                                <canvas id="rentalComparisonChart"></canvas>
                            </div>
                        </div>
                        
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: #00FF88; margin: 0; font-size: 1.1rem;">RENTAL RATES (Smart Engine v3.0)</h4>
                                <span id="rentalCalibrationBadge" style="background: #00FF88; color: #0A0A0A; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">‚úì Calibrated</span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 1.5rem;">
                                <div style="background: #1A1A1A; padding: 1.25rem; border-radius: 8px; border: 1px solid #404040;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Bare Rental</div>
                                    <div style="font-size: 2rem; font-weight: 800; color: #00FF88; margin-bottom: 0.25rem;" id="bareMonthlyDisplay">$16,500</div>
                                    <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;" id="bareAnnualDisplay">$198,000/year</div>
                                </div>
                                <div style="background: #1A1A1A; padding: 1.25rem; border-radius: 8px; border: 1px solid #404040;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase;">Operated Rental</div>
                                    <div style="font-size: 2rem; font-weight: 800; color: #FFB800; margin-bottom: 0.25rem;" id="operatedMonthlyDisplay">$23,925</div>
                                    <div style="color: #666; font-size: 0.8rem;">per month</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;" id="operatedAnnualDisplay">$287,100/year</div>
                                </div>
                            </div>
                            
                            <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; border-left: 3px solid #00FF88;">
                                <div style="color: #00FF88; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">üìä Utilization Scenarios (Bare)</div>
                                <div id="utilizationScenariosDisplay" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; font-size: 0.85rem;">
                                    <div>
                                        <div style="color: #888;">50% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$33,000/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">70% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$23,571/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">85% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$19,412/mo</div>
                                    </div>
                                    <div>
                                        <div style="color: #888;">95% Util</div>
                                        <div style="color: #FFF; font-weight: 600;">$17,368/mo</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem;">5-YEAR COST COMPARISON</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>Initial Cost</th>
                                        <th>5-Year Operating Cost</th>
                                        <th>5-Year Total</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody id="rentalVsPurchaseBody">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                <strong style="color: #00FF88;">Smart Rental Engine v3.0:</strong> Rental rates are self-calibrated from regional market data across 6 regions and 5 crane types. Calculations factor in capacity, age, crane type, and regional variations. Bare rental is equipment only; Operated includes operator, insurance, and training. The 5-year cost analysis includes maintenance (3%), insurance (1.5%), storage ($12K/year), and depreciation. Utilization scenarios show effective monthly rates at different usage levels.
                            </p>
                        </div>
                    </div>

                    <!-- Cost Breakdown Section -->
                    <div id="costbreakdownSection" class="analysis-section">
                        <div class="chart-title">VALUATION COST BREAKDOWN</div>
                        
                        <!-- Base Value Calculation -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #00FF88; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Base Value Calculation</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%;"><strong>Capacity Base Price</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="capacityBasePrice">$2,500,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="capacityCalculation">500 tons √ó $5,000/ton base rate</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Base calculation</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Manufacturer Premium</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="manufacturerPremium">+$375,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="manufacturerPremiumDesc">Terex premium factor: 15%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Brand value</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Model Premium</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="modelPremium">+$200,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="modelPremiumDesc">AC 500-2 model premium: 8%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Model features</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #00FF88;">
                                        <td><strong>Subtotal (Base Value)</strong></td>
                                        <td style="text-align: right; color: #00FF88; font-size: 1.2rem;"><strong><span id="breakdownSubtotalBaseValue">$3,075,000</span></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Adjustments -->
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="color: #FFB800; margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Adjustments</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%;"><strong>Age Depreciation</strong></td>
                                        <td style="text-align: right; color: #FFB800;"><span id="ageDepreciation">-$153,750</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="ageDepreciationDesc">2022 model (2 years old) @ 5% per year</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Age factor: 0.90</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Operating Hours Adjustment</strong></td>
                                        <td style="text-align: right; color: #FF4444;"><span id="operatingHoursAdj">-$92,250</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="operatingHoursDesc">3,700 hours (above average) @ -3%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Usage impact</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Regional Factor</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="regionalFactor">+$123,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="regionalFactorDesc">North America premium: +4%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Market demand</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Market Conditions</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="marketConditions">+$92,250</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="marketConditionsDesc">Current market trend: Strong (+3%)</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Supply/demand</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Condition Score Adjustment</strong></td>
                                        <td style="text-align: right; color: #00FF88;"><span id="conditionScoreAdj">+$153,750</span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding-left: 2rem;"><span id="conditionScoreDesc">Excellent condition (95/100) @ +5%</span></td>
                                        <td style="text-align: right; color: #888; font-size: 0.9rem;">Maintenance quality</td>
                                    </tr>
                                    <tr style="border-top: 2px solid #FFB800;">
                                        <td><strong>Total Adjustments</strong></td>
                                        <td style="text-align: right; color: #FFB800; font-size: 1.2rem;"><strong><span id="breakdownTotalAdjustments">+$123,000</span></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Valuation Summary -->
                        <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 2rem; border-radius: 8px; border: 2px solid #00FF88;">
                            <h4 style="color: #FFFFFF; margin-bottom: 1.5rem; font-size: 1.3rem; text-transform: uppercase; text-align: center;">Final Valuation Summary</h4>
                            <table class="results-table" style="margin-bottom: 0;">
                                <tbody>
                                    <tr>
                                        <td style="width: 60%; font-size: 1.1rem;"><strong>Base Value</strong></td>
                                        <td style="text-align: right; font-size: 1.1rem;"><span id="finalSummaryBaseValue">$3,075,000</span></td>
                                    </tr>
                                    <tr>
                                        <td style="font-size: 1.1rem;"><strong>Total Adjustments</strong></td>
                                        <td style="text-align: right; font-size: 1.1rem;"><span id="finalSummaryTotalAdjustments">+$123,000</span></td>
                                    </tr>
                                    <tr style="border-top: 3px solid #00FF88;">
                                        <td style="font-size: 1.5rem;"><strong>ESTIMATED VALUE</strong></td>
                                        <td style="text-align: right; color: #00FF88; font-size: 1.8rem;"><strong><span id="finalSummaryEstimatedValue">$3,198,000</span></strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="padding-top: 1rem; border-top: 1px solid #404040;">
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Confidence Score:</span>
                                                <span style="color: #00FF88; font-weight: 600;"><span id="finalSummaryConfidenceScore">94%</span></span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Value Range:</span>
                                                <span style="color: #FFFFFF; font-weight: 600;"><span id="finalSummaryValueRange">$3.04M - $3.36M</span></span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                                <span style="color: #888;">Market Position:</span>
                                                <span style="color: #00FF88; font-weight: 600;"><span id="finalSummaryDealRecommendation">Strong Buy</span></span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Calculation Methodology Note -->
                        <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                <strong style="color: #00FF88;">Methodology:</strong> This cost breakdown analysis uses our proprietary multi-factor rules engine that considers capacity-based pricing, manufacturer reputation, model-specific features, equipment age, operating hours, regional market conditions, and current supply/demand dynamics. All adjustments are based on real-time market data and historical transaction analysis across 50,000+ crane sales.
                            </p>
                        </div>
                    </div>

                    <!-- Comparables Section -->
                    <div id="comparablesSection" class="analysis-section">
                        <div class="chart-title">COMPARABLE SALES DATA</div>
                        <div style="background: #2A2A2A; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #00FF88;">
                            <p style="color: #888; font-size: 0.9rem; margin: 0;">
                                <strong style="color: #00FF88;">Note:</strong> Comparables are filtered by crane class and capacity range (¬±30%) to ensure accuracy and relevance.
                            </p>
                        </div>
                        <table class="results-table" id="comparablesTable">
                            <thead>
                                <tr>
                                    <th>Equipment</th>
                                    <th>Type</th>
                                    <th>Year</th>
                                    <th>Capacity</th>
                                    <th>Hours</th>
                                    <th>Sale Price</th>
                                    <th>Price/Ton</th>
                                    <th>Trend</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="comparablesTableBody">
                                <!-- Will be populated dynamically based on crane type -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Risk Section -->
                    <div id="riskSection" class="analysis-section">
                        <div class="chart-title">RISK ANALYSIS</div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FF4444;">35%</div>
                                <div class="metric-label">Market Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FFB800;">25%</div>
                                <div class="metric-label">Condition Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #FFB800;">20%</div>
                                <div class="metric-label">Age Risk</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" style="color: #00FF88;">20%</div>
                                <div class="metric-label">Location Risk</div>
                            </div>
                        </div>
                        <div class="metric-card" style="margin-top: 2rem; text-align: center;">
                            <div class="metric-value" style="color: #00FF88; font-size: 3rem;">LOW</div>
                            <div class="metric-label">Overall Risk Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Processing Tab -->
        <div id="bulkTab" class="tab-content">
            <div class="bulk-upload">
                <h2 class="form-title">Bulk Crane Valuation</h2>
                <div class="upload-area" id="uploadArea" onclick="triggerFileInput()">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">Drop your Excel file here or click to browse</div>
                    <div class="upload-subtext">Supports .xlsx, .xls, .csv files up to 10MB</div>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="template-btn" onclick="downloadTemplate()">DOWNLOAD TEMPLATE</button>
                </div>
            </div>

            <!-- Bulk Results -->
            <div id="bulkResults" class="bulk-results">
                <div class="results-header">
                    <div>
                        <div class="results-title">Bulk Valuation Results</div>
                        <div class="results-summary" id="resultsSummary">5 cranes processed ‚Ä¢ 5 successful ‚Ä¢ 0 errors</div>
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-secondary" onclick="exportResults()">EXPORT RESULTS</button>
                        <button class="btn btn-primary" onclick="generateReport()">GENERATE REPORT</button>
                    </div>
                </div>
                
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Crane</th>
                            <th>Year</th>
                            <th>Capacity</th>
                            <th>Hours</th>
                            <th>Region</th>
                            <th>Estimated Value</th>
                            <th>Confidence</th>
                            <th>Grade</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
                
                <div class="pagination" id="pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <!-- Quick Actions Tools -->
        <div class="quick-actions">
            <h2 class="quick-actions-title">Quick Actions Tools</h2>
            <div class="tools-grid">
                <!-- Notes Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">üìù</div>
                        <div class="tool-title">Notes</div>
                    </div>
                    <div class="tool-content">
                        <textarea class="tool-input" placeholder="Add your valuation notes, observations, or follow-up items here..." id="notesInput"></textarea>
                        <button class="tool-btn" onclick="saveNotes()">üíæ SAVE NOTES</button>
                    </div>
                </div>

                <!-- Calendar Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">üìÖ</div>
                        <div class="tool-title">Schedule Event</div>
                    </div>
                    <div class="tool-content">
                        <input type="date" class="tool-input" id="eventDate" placeholder="Event date">
                        <input type="time" class="tool-input" id="eventTime" placeholder="Event time">
                        <input type="text" class="tool-input" placeholder="Event description (e.g., Site inspection, Meeting)" id="eventDescription" style="min-height: auto;">
                        <button class="tool-btn" onclick="scheduleEvent()">üìå SCHEDULE EVENT</button>
                    </div>
                </div>

                <!-- Unit Converter Tool -->
                <div class="tool-card">
                    <div class="tool-header">
                        <div class="tool-icon">üîÑ</div>
                        <div class="tool-title">Unit Converter</div>
                    </div>
                    <div class="tool-content">
                        <select class="tool-select" id="converterType" style="margin-bottom: 15px;">
                            <option value="tons_kg">Tons ‚Üí Kilograms</option>
                            <option value="kg_tons">Kilograms ‚Üí Tons</option>
                            <option value="ft_m">Feet ‚Üí Meters</option>
                            <option value="m_ft">Meters ‚Üí Feet</option>
                            <option value="tons_lbs">Tons ‚Üí Pounds</option>
                            <option value="lbs_tons">Pounds ‚Üí Tons</option>
                        </select>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <input type="number" class="converter-input" placeholder="Enter value" id="converterInput" style="flex: 1;">
                            <span style="color: #00FF88; font-size: 1.5rem; font-weight: bold;">‚Üí</span>
                            <input type="text" class="converter-input" placeholder="Result" id="converterResult" readonly style="flex: 1; background: #1A1A1A; color: #00FF88; font-weight: 600;">
                        </div>
                        <button onclick="performConversion()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00FF88 0%, #00CC6A 100%); color: #000; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease;">
                            <span style="font-size: 1.2rem;">üîÑ</span>
                            <span>CONVERT</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="images/logos/crane-intelligence-logo-white.svg" alt="Crane Intelligence">
                    </div>
                    <p>Professional crane valuation, market analysis, and fleet optimization platform. Get accurate crane valuations with our advanced multi-factor analysis engine.</p>
                </div>
                <div class="footer-section">
                    <h3>QUICK LINKS</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>LEGAL & SUPPORT</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a href="#">Security</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>STAY UPDATED</h3>
                    <p>Get the latest insights and market analysis delivered to your inbox</p>
                    <div class="newsletter-form">
                        <input type="email" class="newsletter-input" placeholder="Enter your email">
                        <button class="newsletter-btn">Subscribe</button>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Crane Intelligence Platform. All rights reserved. | Professional Crane Valuation & Market Analysis</p>
            </div>
        </div>
    </footer>

    <!-- Modal for Detailed Reports -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detailed Crane Report</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Report content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'single';
        let currentAnalysis = 'overview';
        let bulkData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let chartInstances = {}; // Store chart instances to prevent duplicates

        // Manufacturer-Model mapping
        window.manufacturerModels = {
            'Liebherr': [
                // Mobile All-Terrain Cranes
                'LTM 1025', 'LTM 1030-2.1', 'LTM 1040-2.1', 'LTM 1050-3.1', 'LTM 1060-3.1',
                'LTM 1070-4.2', 'LTM 1080-2', 'LTM 1090-4.2', 'LTM 1100-5.2', 'LTM 1110-5.1',
                'LTM 1120-4.1', 'LTM 1130-5.1', 'LTM 1160-5.2', 'LTM 1200-5.1', 'LTM 1220-5.2',
                'LTM 1230-5.1', 'LTM 1250-6.1', 'LTM 1300-6.2', 'LTM 1350-6.1', 'LTM 1400-7.1',
                'LTM 1450-8.1', 'LTM 1500-8.1', 'LTM 1650-8.1', 'LTM 1750-9.1', 'LTM 11200-9.1',
                // Mobile City Cranes
                'LTC 1045-3.1', 'LTC 1050-3.1',
                // Mobile Rough Terrain Cranes
                'LRT 1090-2.1', 'LRT 1100-2.1',
                // Mobile Telescopic Crawler Cranes
                'LTR 1040', 'LTR 1060', 'LTR 1100', 'LTR 1220',
                // Crawler Lattice Cranes
                'LR 1100', 'LR 1160', 'LR 1200', 'LR 1250', 'LR 1280', 'LR 1300.1 SX',
                'LR 1350/1', 'LR 1400/2', 'LR 1500', 'LR 1600/2', 'LR 1700-1.0', 'LR 1750/2',
                'LR 1800-1.0', 'LR 11350', 'LR 13000'
            ],
            'Grove': [
                // Mobile All-Terrain Cranes
                'GMK3050-2', 'GMK3060-2', 'GMK3060L-1', 'GMK4090-1', 'GMK4100L-1',
                'GMK4100L-2', 'GMK5150L-1', 'GMK5250L-1', 'GMK5250XL-1', 'GMK6300L-1',
                'GMK6400-1', 'GMK7550',
                // Mobile Rough Terrain Cranes
                'RT530E-2', 'RT540E', 'GRT655', 'GRT655L', 'GRT880', 'GRT8100', 'GRT8120', 'GRT9165',
                // Mobile Truck-Mounted Cranes
                'TMS500-2', 'TMS700E', 'TMS800E', 'TMS9000-2',
                // Mobile Telescopic Crawler Cranes
                'GHC30', 'GHC45', 'GHC55', 'GHC75', 'GHC85', 'GHC130'
            ],
            'Manitowoc': [
                // Crawler Lattice Cranes
                '3900', '4100W', '777', '888', '999', '14000', '16000', '18000', '21000', '2250',
                'MLC100-1', 'MLC150-1', 'MLC300', 'MLC650', '31000'
            ],
            'Tadano': [
                // Mobile Rough Terrain Cranes
                'GR-500XL', 'GR-550XL-3', 'GR-750XL-3', 'GR-800XL-4', 'GR-1000XL-4', 'GR-1200XL',
                // Mobile All-Terrain Cranes
                'ATF 70G-4', 'ATF 110G-5', 'ATF 130G-5', 'ATF 200G-5', 'ATF 220G-5',
                'AC 4.100L-1', 'AC 5.220-1', 'AC 7.450-1',
                // Crawler Lattice Cranes
                'CC 2800-1', 'CC 3800-1', 'CC 6800-1', 'CC 8800-1'
            ],
            'Sany': [
                // Mobile All-Terrain Cranes
                'SAC1200', 'SAC2200', 'SAC2500', 'SAC6000',
                // Mobile Rough Terrain Cranes
                'SRC900',
                // Mobile Truck-Mounted Cranes
                'STC750',
                // Crawler Lattice Cranes
                'SCC1000A', 'SCC1500D', 'SCC2500A', 'SCC4000A', 'SCC6500A', 'SCC8000A', 'SCC10000A'
            ],
            'Kobelco': [
                // All 30 Kobelco models from craneDatabase
                'CK1600G', 'CKE1350G', 'BMS800', 'CK2500', 'CK2750G-2', 'CK1100G', 'CK1600', 
                'CKE2500G-2', 'CKE4000', 'CK800', 'CK800G', 'CK2500-2', 'CKE900', '7250', 
                '7065', '7080', '7150', '7250S', '7300', 'CKE1800', 'CKE2500', 'CK2750G', 
                'CKE800', 'CKE2500-2', 'CKE1500', 'CK1100G-2', 'CKE900G', '7055', '7065G', 
                'CKE1800G'
            ],
            'Link-Belt': [
                // Crawler Lattice Cranes
                '218 HSL', '238 HSL', '298 HSL', '348 Series 2',
                // Mobile Telescopic Crawler Cranes
                'TCC-1100', 'TCC-2500',
                // Mobile Rough Terrain Cranes
                'RTC-8090',
                // Mobile All-Terrain Cranes
                'ATC-3275'
            ],
            'Terex': [
                // Mobile Rough Terrain Cranes
                'RT 780',
                // Mobile All-Terrain Cranes
                'AC 350/6',
                // Crawler Lattice Cranes
                'CC 2800-1'
            ],
            'XCMG': [
                // Crawler Lattice Cranes
                'XGC88000',
                // Mobile Truck-Mounted Cranes
                'XCT100',
                // Mobile All-Terrain Cranes
                'XCA300'
            ],
            'Zoomlion': [
                // Crawler Lattice Cranes
                'ZCC12500', 'ZCC3200NP'
            ],
            'HSC': [
                // Crawler Lattice Cranes
                'SCX1200A-3', 'SCX2800A-3'
            ],
            'Kato': [
                // Mobile Truck-Mounted Cranes
                'NK-250E',
                // Mobile Rough Terrain Cranes
                'KR-35H (MR-350)', 'SR-250R'
            ],
            'IHI': [
                // Crawler Lattice Cranes
                'CCH700', 'CCH2500'
            ]
        };

        // Get models for a specific manufacturer
        window.getModelsForManufacturer = function(manufacturer) {
            if (!manufacturer) {
                return [];
            }
            
            // Try exact match
            if (window.manufacturerModels[manufacturer]) {
                return window.manufacturerModels[manufacturer];
            }
            
            // Try case-insensitive match
            for (const [mfr, models] of Object.entries(window.manufacturerModels)) {
                if (mfr.toLowerCase() === manufacturer.toLowerCase()) {
                    return models;
                }
            }
            
            return [];
        };


        // Populate models based on manufacturer selection
        document.addEventListener('DOMContentLoaded', function() {
        // ============================================================================
        // AUTO-PREFILL FUNCTIONALITY
        // ============================================================================
        
        // Event listener for manufacturer selection
        document.getElementById('manufacturer').addEventListener('change', function() {
            const manufacturer = this.value;
            updateModelOptions(manufacturer);
        });
        
        // Event listener for model selection
        document.getElementById('model').addEventListener('change', function() {
            const manufacturer = document.getElementById('manufacturer').value;
            const model = this.value;
            autofillCraneSpecs(manufacturer, model);
        });
        
        // Update model dropdown based on manufacturer selection
        function updateModelOptions(manufacturer) {
            const modelSelect = document.getElementById('model');
            
            if (!manufacturer || manufacturer === 'Select manufacturer') {
                // Reset to default
                modelSelect.innerHTML = '<option value="">Select model</option>';
                return;
            }
            
            const models = getModelsForManufacturer(manufacturer);
            
            if (models && models.length > 0) {
                // Populate model dropdown
                let options = '<option value="">Select model</option>';
                models.forEach(model => {
                    options += `<option value="${model}">${model}</option>`;
                });
                modelSelect.innerHTML = options;
            } else {
                // No models found, allow manual entry
                modelSelect.innerHTML = '<option value="">Enter model manually</option>';
            }
        }
        
        // Auto-fill crane specifications based on manufacturer and model
        function autofillCraneSpecs(manufacturer, model) {
            if (!manufacturer || !model) {
                return;
            }
            
            const specs = getCraneSpecifications(manufacturer, model);
            
            if (specs) {
                // Fill in the fields (but keep them editable)
                const capacityInput = document.getElementById('capacity');
                const craneTypeSelect = document.getElementById('craneType');
                const boomLengthInput = document.getElementById('boomLength');
                
                // Set capacity
                if (capacityInput && specs.capacity) {
                    capacityInput.value = specs.capacity;
                    // Add visual feedback
                    capacityInput.style.borderColor = '#00FF88';
                    setTimeout(() => { capacityInput.style.borderColor = ''; }, 2000);
                }
                
                // Set crane type
                if (craneTypeSelect && specs.craneType) {
                    craneTypeSelect.value = specs.craneType;
                    craneTypeSelect.style.borderColor = '#00FF88';
                    setTimeout(() => { craneTypeSelect.style.borderColor = ''; }, 2000);
                }
                
                // Set boom length
                if (boomLengthInput && specs.boomLength) {
                    boomLengthInput.value = specs.boomLength;
                    boomLengthInput.style.borderColor = '#00FF88';
                    setTimeout(() => { boomLengthInput.style.borderColor = ''; }, 2000);
                }
                
                // Show notification
                showAutofillNotification(manufacturer, model);
            }
        }
        
        // Show notification that fields were auto-filled
        function showAutofillNotification(manufacturer, model) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #1A1A1A;
                border: 2px solid #00FF88;
                border-radius: 8px;
                padding: 15px 20px;
                color: #FFFFFF;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚úì</span>
                    <div>
                        <div style="font-weight: 600; color: #00FF88;">Auto-filled</div>
                        <div style="font-size: 12px; color: #888; margin-top: 3px;">
                            ${manufacturer} ${model} specifications loaded
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Add CSS animations for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

            const manufacturerSelect = document.getElementById('manufacturer');
            const modelSelect = document.getElementById('model');
            
            if (manufacturerSelect && modelSelect) {
                manufacturerSelect.addEventListener('change', function() {
                    const manufacturer = this.value;
                    
                    // Clear existing options
                    modelSelect.innerHTML = '<option value="">Select Model</option>';
                    
                    // Populate models for selected manufacturer
                    if (manufacturer && manufacturerModels[manufacturer]) {
                        manufacturerModels[manufacturer].forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });
                    }
                });
            }
            
            // Initialize charts on page load
            // Initialize charts immediately
            try {
                if (typeof Chart !== 'undefined') {
                    initializeTrendChart();
                    console.log('Charts initialized on page load');
                } else {
                    console.error('Chart.js not loaded');
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('Error initializing charts:', error);
            }
        });

        // Header functionality
        function navigateToHome() {
            window.location.href = 'index.html';
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const userProfile = document.querySelector('.user-profile');
            
            dropdown.classList.toggle('show');
            userProfile.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userProfile = document.querySelector('.user-profile');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userProfile.contains(event.target)) {
                dropdown.classList.remove('show');
                userProfile.classList.remove('active');
            }
        });

        // Tab switching
        function switchTab(tab, element) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Analysis tab switching
        function switchAnalysis(analysis, element) {
            currentAnalysis = analysis;
            
            // Update analysis tab buttons
            document.querySelectorAll('.analysis-tab').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Update analysis sections
            document.querySelectorAll('.analysis-section').forEach(section => section.classList.remove('active'));
            document.getElementById(analysis + 'Section').classList.add('active');
            
            // Initialize charts if needed
            if (analysis === 'overview') {
                initializeTrendChart();
            } else if (analysis === 'rental') {
                // Rental section is populated during calculation
                console.log('Rental analysis section displayed');
            } else if (analysis === 'costbreakdown') {
                // Cost breakdown section is static, no initialization needed
                console.log('Cost breakdown section displayed');
            } else if (analysis === 'comparables') {
                // Comparables are populated during calculation
                console.log('Comparables section displayed');
            }
        }

        // Load sample data
        window.loadSampleData = function() {
            document.getElementById('manufacturer').value = 'Kobelco';
            // Trigger change event to populate models
            const event = new Event('change');
            document.getElementById('manufacturer').dispatchEvent(event);
            
            // Load sample data immediately
            document.getElementById('model').value = 'CK1100G-2';
            document.getElementById('year').value = '2018';
            document.getElementById('capacity').value = '110';
            document.getElementById('hours').value = '5000';
            document.getElementById('mileage').value = '12000';
            document.getElementById('craneType').value = 'Crawler Crane';
            document.getElementById('boomLength').value = '60'; // 60 meters
            document.getElementById('jibIncluded').value = 'luffing';
            document.getElementById('jibLength').value = '120';
            document.getElementById('region').value = 'North America';
            document.getElementById('askingPrice').value = '';
        }

        // Crane comparables database by type
        const comparablesDatabase = {
            'Crawler Crane': [
                { equipment: 'KOBELCO CK1000G-2', capacity: 100, year: 2019, hours: 4200, price: 1850000, location: 'North America', trend: '+1.8%' },
                { equipment: 'KOBELCO CK1200G-2', capacity: 120, year: 2020, hours: 3800, price: 2150000, location: 'North America', trend: '+2.1%' },
                { equipment: 'LIEBHERR LR 1100', capacity: 100, year: 2018, hours: 5100, price: 1920000, location: 'Europe', trend: '+1.5%' },
                { equipment: 'LIEBHERR LR 1160', capacity: 160, year: 2021, hours: 2900, price: 2680000, location: 'North America', trend: '+2.8%' },
                { equipment: 'LINK-BELT 238 HSL', capacity: 110, year: 2017, hours: 6200, price: 1650000, location: 'North America', trend: '-0.5%' },
                { equipment: 'MANITOWOC MLC100-1', capacity: 100, year: 2019, hours: 4500, price: 1750000, location: 'Asia Pacific', trend: '+1.2%' },
                { equipment: 'SANY SCC1000A', capacity: 100, year: 2020, hours: 3200, price: 1680000, location: 'Asia Pacific', trend: '+2.5%' }
            ],
            'All-Terrain Crane': [
                { equipment: 'LIEBHERR LTM 1090-4.2', capacity: 90, year: 2019, hours: 4200, price: 1450000, location: 'North America', trend: '+1.8%' },
                { equipment: 'LIEBHERR LTM 1500-8.1', capacity: 500, year: 2022, hours: 1200, price: 3145000, location: 'North America', trend: '+2.3%' },
                { equipment: 'GROVE GMK5150L-1', capacity: 150, year: 2021, hours: 2800, price: 2290000, location: 'Europe', trend: '+1.5%' },
                { equipment: 'GROVE GMK6300L-1', capacity: 300, year: 2020, hours: 3500, price: 3850000, location: 'North America', trend: '+2.1%' },
                { equipment: 'TADANO ATF 110G-5', capacity: 110, year: 2019, hours: 4100, price: 1820000, location: 'Asia Pacific', trend: '+1.9%' },
                { equipment: 'TADANO ATF 220G-5', capacity: 220, year: 2021, hours: 2200, price: 2950000, location: 'Europe', trend: '+2.4%' }
            ],
            'Rough Terrain Crane': [
                { equipment: 'GROVE RT530E-2', capacity: 30, year: 2019, hours: 3200, price: 385000, location: 'North America', trend: '+1.2%' },
                { equipment: 'GROVE GRT655', capacity: 55, year: 2020, hours: 2800, price: 625000, location: 'North America', trend: '+1.8%' },
                { equipment: 'GROVE GRT880', capacity: 80, year: 2021, hours: 2200, price: 890000, location: 'Europe', trend: '+2.1%' },
                { equipment: 'TADANO GR-500XL', capacity: 50, year: 2019, hours: 4100, price: 520000, location: 'Asia Pacific', trend: '+0.9%' },
                { equipment: 'TADANO GR-750XL-3', capacity: 75, year: 2020, hours: 3500, price: 785000, location: 'North America', trend: '+1.5%' }
            ],
            'Truck-Mounted Crane': [
                { equipment: 'GROVE TMS700E', capacity: 70, year: 2019, hours: 4500, price: 720000, location: 'North America', trend: '+1.1%' },
                { equipment: 'GROVE TMS9000-2', capacity: 90, year: 2020, hours: 3200, price: 950000, location: 'Europe', trend: '+1.6%' },
                { equipment: 'TADANO ATF 70G-4', capacity: 70, year: 2019, hours: 4800, price: 695000, location: 'Asia Pacific', trend: '+0.8%' },
                { equipment: 'SANY STC750', capacity: 75, year: 2021, hours: 2100, price: 780000, location: 'Asia Pacific', trend: '+2.2%' }
            ],
            'Telescopic Crawler Crane': [
                { equipment: 'LINK-BELT TCC-1100', capacity: 110, year: 2019, hours: 3800, price: 1650000, location: 'North America', trend: '+1.7%' },
                { equipment: 'LINK-BELT TCC-2500', capacity: 250, year: 2020, hours: 2900, price: 3250000, location: 'North America', trend: '+2.3%' },
                { equipment: 'GROVE GHC75', capacity: 75, year: 2019, hours: 4200, price: 980000, location: 'Europe', trend: '+1.4%' },
                { equipment: 'GROVE GHC130', capacity: 130, year: 2021, hours: 2400, price: 1850000, location: 'North America', trend: '+2.1%' }
            ]
        };

        // Function to calculate boom package premium
        // Calculate manufacturer premium based on brand reputation
        function calculateManufacturerPremium(manufacturer, baseCapacityValue) {
            const manufacturerFactors = {
                'Liebherr': 0.20,      // 20% premium
                'Grove': 0.18,         // 18% premium
                'Tadano': 0.15,        // 15% premium
                'Manitowoc': 0.17,     // 17% premium
                'Terex': 0.15,         // 15% premium
                'Kobelco': 0.12,       // 12% premium
                'Link-Belt': 0.10,     // 10% premium
                'Sany': 0.08,          // 8% premium
                'XCMG': 0.08,          // 8% premium
                'Zoomlion': 0.08,      // 8% premium
                'Demag': 0.18,         // 18% premium
                'Kato': 0.12,          // 12% premium
                'Sumitomo': 0.12       // 12% premium
            };
            
            // Find matching manufacturer (case-insensitive, partial match)
            let factor = 0.10; // Default 10% for unknown manufacturers
            for (const [brand, premium] of Object.entries(manufacturerFactors)) {
                if (manufacturer.toLowerCase().includes(brand.toLowerCase())) {
                    factor = premium;
                    break;
                }
            }
            
            return {
                premium: baseCapacityValue * factor,
                factor: factor,
                percentage: Math.round(factor * 100)
            };
        }

        function calculateBoomPackagePremium(manufacturer, model, jibType, boomLength, jibLength) {
            let premium = 0;
            
            // Base boom length premium (if above average)
            if (boomLength > 300) {
                premium += (boomLength - 300) * 500; // $500 per additional foot
            }
            
            // Jib premium
            if (jibType === 'yes') {
                premium += 50000; // Standard jib adds $50k
                if (jibLength) {
                    premium += jibLength * 400; // $400 per foot of jib
                }
            } else if (jibType === 'luffing') {
                // Luffing jib is more valuable
                premium += 150000; // Base luffing jib premium
                if (jibLength) {
                    premium += jibLength * 800; // $800 per foot of luffing jib
                }
                
                // Special models with luffing jib get extra premium
                if (model.includes('LR1300') || model.includes('LR1600') || model.includes('CK1100') || model.includes('CK1200')) {
                    premium += 150000; // Additional $150k for premium models
                }
            }
            
            return premium;
        }

        // Smart Rental Engine v3.0 - API-based rental rate calculation
        async function calculateSmartRentalRates(capacity, craneType, region, year, rentalMode = 'bare') {
            try {
                const response = await fetch(`/api/v1/enhanced-data/rental-rates?capacity=${capacity}&region=${encodeURIComponent(region)}&crane_type=${encodeURIComponent(craneType)}&year=${year}&rental_mode=${rentalMode}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('crane_auth_token') || ''}`
                    }
                });

                console.log('DEBUG: API response OK');
                if (response.ok) {
                    const result = await response.json();
                    console.log('Smart Rental Engine Result:', result);
                    return result;
                } else {
                    console.warn('Smart Rental Engine API failed, using fallback calculation');
                    return calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode);
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('Smart Rental Engine Error:', error);
                return calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode);
            }
        }

        // Fallback rental calculation (if API is unavailable)
        function calculateFallbackRentalRate(capacity, craneType, region, year, rentalMode = 'bare') {
            // Base rate per ton (fallback values)
            const baseRatePerTon = {
                'All-Terrain Crane': 220,
                'Rough Terrain Crane': 180,
                'Crawler Crane': 200,
                'Truck-Mounted Crane': 160,
                'Telescopic Crawler Crane': 200
            }[craneType] || 200;

            // Regional multipliers
            const regionalMultipliers = {
                'North America': 1.05,
                'Europe': 0.90,
                'Asia Pacific': 0.85,
                'Middle East': 0.95,
                'Africa': 0.85,
                'South America': 0.90
            };
            const regionalMultiplier = regionalMultipliers[region] || 1.0;

            // Age factor
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            let ageFactor = 1.0;
            if (age <= 3) ageFactor = 1.10;
            else if (age <= 7) ageFactor = 1.00;
            else if (age <= 12) ageFactor = 0.90;
            else ageFactor = 0.80;

            // Capacity factor
            let capacityFactor = 1.0;
            if (capacity <= 80) capacityFactor = 1.10;
            else if (capacity <= 150) capacityFactor = 1.00;
            else if (capacity <= 300) capacityFactor = 0.90;
            else capacityFactor = 0.80;

            // Calculate monthly bare rate
            let monthlyBare = baseRatePerTon * capacity * ageFactor * capacityFactor * regionalMultiplier;
            monthlyBare = Math.max(4000, Math.min(monthlyBare, 95000));

            // Operated rate multiplier
            const operatedMultiplier = rentalMode === 'operated' ? 1.45 : 1.0;
            const monthlyRate = monthlyBare * operatedMultiplier;

            return {
                success: true,
                source: "Fallback Calculation",
                calibrated: false,
                rental_rates: {
                    daily_rate: Math.round(monthlyRate / 22),
                    weekly_rate: Math.round(monthlyRate / 4.33),
                    monthly_rate: Math.round(monthlyRate),
                    annual_rate: Math.round(monthlyRate * 12)
                },
                inputs: {
                    capacity_tons: capacity,
                    crane_type: craneType,
                    region: region,
                    year: year,
                    rental_mode: rentalMode,
                    calibrated: false
                }
            };
        }

        // Legacy function for backward compatibility (now uses Smart Engine)
        function calculateRentalRate(craneValue) {
            // This is kept for backward compatibility but returns a simple estimate
            return Math.round(craneValue * 0.015);
        }

        // Enhanced function to get relevant comparables from crane database
        // Enhanced function to get relevant comparables from crane database
        function getRelevantComparables(craneType, capacity) {
            console.log('üîç getRelevantComparables called with:', craneType, capacity);
            
            // First try static database
            const staticComparables = comparablesDatabase[craneType] || [];
            
            // Filter by capacity range (¬±30%)
            const minCapacity = capacity * 0.7;
            const maxCapacity = capacity * 1.3;
            
            let matches = staticComparables.filter(comp => 
                comp.capacity >= minCapacity && comp.capacity <= maxCapacity
            );
            
            console.log('üìä Static comparables found:', matches.length);
            
            // If we have enough matches from static database, return them
            if (matches.length >= 4) {
                console.log('‚úÖ Returning', matches.length, 'static comparables');
                return matches.slice(0, 4);
            }
            
            // Otherwise, generate dynamic comparables from crane database
            console.log('üîß Generating dynamic comparables...');
            const dynamicComparables = generateDynamicComparables(craneType, capacity, minCapacity, maxCapacity);
            console.log('‚úÖ Dynamic comparables generated:', dynamicComparables.length);
            
            // Combine static and dynamic, remove duplicates
            const combined = [...matches, ...dynamicComparables];
            const unique = [];
            const seen = new Set();
            
            for (const comp of combined) {
                const key = `${comp.equipment}-${comp.year}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(comp);
                }
            }
            
            console.log('üì§ Returning', unique.length, 'total comparables');
            return unique.slice(0, 4);
        }
        
        // Generate dynamic comparables from crane database
        function generateDynamicComparables(craneType, targetCapacity, minCapacity, maxCapacity) {
            console.log('üèóÔ∏è  generateDynamicComparables called:', {craneType, targetCapacity, minCapacity, maxCapacity});
            console.log('üîç Normalized search type:', craneType.toLowerCase().replace(/\s*crane\s*$/i, '').trim());
            
            if (!window.craneDatabase || typeof window.craneDatabase !== 'object') {
                console.warn('‚ö†Ô∏è  Crane database not available for comparables');
                return [];
            }
            
            console.log('‚úÖ Crane database available, manufacturers:', Object.keys(window.craneDatabase).length);
            
            const comparables = [];
            const currentYear = new Date().getFullYear();
            let totalCranesChecked = 0;
            
            // Iterate through all manufacturers in the database
            for (const manufacturer in window.craneDatabase) {
                if (!window.craneDatabase.hasOwnProperty(manufacturer)) continue;
                
                const cranes = window.craneDatabase[manufacturer];
                if (!Array.isArray(cranes)) continue;
                
                // Filter cranes by capacity and type
                for (const crane of cranes) {
                    totalCranesChecked++;
                    
                    // Match capacity range
                    const craneCapacity = crane.capacity || 0;
                    if (craneCapacity < minCapacity || craneCapacity > maxCapacity) continue;
                    
                    // Match crane type if available (normalize by removing "Crane" suffix)
                    if (crane.type && craneType) {
                        const normalizeType = (t) => t.toLowerCase().replace(/\s*crane\s*$/i, '').trim();
                        const dbType = normalizeType(crane.type);
                        const searchType = normalizeType(craneType);
                        
                        const typeMatch = dbType.includes(searchType) || 
                                        searchType.includes(dbType) ||
                                        dbType === searchType;
                        if (!typeMatch) continue;
                    }
                    
                    // Generate realistic sale data
                    const yearVariation = Math.floor(Math.random() * 5); // 0-4 years old
                    const saleYear = currentYear - yearVariation;
                    
                    // Calculate estimated price based on capacity and age
                    const basePrice = craneCapacity * 5000;
                    const manufacturerPremium = getManufacturerFactor(manufacturer) * basePrice;
                    const modelPremium = basePrice * 0.08;
                    const totalBase = basePrice + manufacturerPremium + modelPremium;
                    
                    // Age depreciation
                    const ageDepreciation = totalBase * (yearVariation * 0.05);
                    
                    // Random hours based on age
                    const avgHoursPerYear = 1500;
                    const hours = Math.round((avgHoursPerYear * yearVariation) * (0.8 + Math.random() * 0.4));
                    
                    // Hours adjustment
                    const expectedHours = yearVariation * avgHoursPerYear;
                    const hoursAdjustment = hours > expectedHours ? totalBase * 0.03 : 0;
                    
                    // Regional variation
                    const regions = ['North America', 'Europe', 'Asia Pacific'];
                    const region = regions[Math.floor(Math.random() * regions.length)];
                    const regionalFactors = {
                        'North America': 1.04,
                        'Europe': 1.02,
                        'Asia Pacific': 0.98
                    };
                    const regionalAdjustment = totalBase * (regionalFactors[region] - 1.0);
                    
                    // Market conditions
                    const marketAdjustment = totalBase * 0.03;
                    
                    // Calculate final price
                    const estimatedPrice = Math.round(
                        totalBase - ageDepreciation - hoursAdjustment + regionalAdjustment + marketAdjustment
                    );
                    
                    // Generate trend
                    const trendValue = (Math.random() * 4 - 1).toFixed(1); // -1% to +3%
                    const trend = trendValue >= 0 ? `+${trendValue}%` : `${trendValue}%`;
                    
                    comparables.push({
                        equipment: `${manufacturer} ${crane.model}`,
                        capacity: Math.round(craneCapacity),
                        year: saleYear,
                        hours: hours,
                        price: estimatedPrice,
                        location: region,
                        trend: trend
                    });
                    
                    console.log(`  ‚úì Added comparable: ${manufacturer} ${crane.model} (${craneCapacity}T)`);
                    
                    // Stop after finding enough comparables
                    if (comparables.length >= 6) break;
                }
                
                if (comparables.length >= 6) break;
            }
            
            console.log(`üîç Checked ${totalCranesChecked} cranes, generated ${comparables.length} comparables`);
            return comparables;
        }
                
        // Helper function to get manufacturer factor
        function getManufacturerFactor(manufacturer) {
            const factors = {
                'liebherr': 0.20,
                'grove': 0.18,
                'tadano': 0.18,
                'terex': 0.15,
                'manitowoc': 0.15,
                'link-belt': 0.12,
                'kobelco': 0.12,
                'sany': 0.08,
                'xcmg': 0.08
            };
            
            const manuLower = manufacturer.toLowerCase();
            for (const [key, value] of Object.entries(factors)) {
                if (manuLower.includes(key)) {
                    return value;
                }
            }
            return 0.10; // Default
        }



        // Form submission
        document.getElementById('valuationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const manufacturer = document.getElementById('manufacturer').value;
            const model = document.getElementById('model').value;
            const year = parseInt(document.getElementById('year').value);
            const capacity = parseInt(document.getElementById('capacity').value);
            const hours = parseInt(document.getElementById('hours').value);
            const craneType = document.getElementById('craneType').value;
            const boomLength = parseFloat(document.getElementById('boomLength').value) || null;
            const jibIncluded = document.getElementById('jibIncluded').value;
            const jibLength = parseFloat(document.getElementById('jibLength').value) || 0;
            const region = document.getElementById('region').value;
            
            // Show loading state
            const submitBtn = document.querySelector('.btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'CALCULATING...';
            submitBtn.disabled = true;
            
            // Call API for valuation
            try {
                const token = localStorage.getItem('crane_auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                console.log('DEBUG: Starting API call...');
                const response = await fetch('/api/v1/valuations', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        crane_make: manufacturer,
                        crane_model: model,
                        crane_year: year,
                        crane_hours: hours,
                        crane_condition: 'good', // Default condition
                        boom_length: boomLength
                    })
                });

                console.log('DEBUG: API response OK');
                if (response.ok) {
                    const apiResult = await response.json();
                    console.log('API Valuation Result:', apiResult);
                    
                    // Use API estimated value or fall back to local calculation
                    const estimatedValue = apiResult.estimated_value || (capacity * 5000);
                    
                    // Update display with API result
                    // Show success message
                    console.log('Valuation saved to database with ID:', apiResult.valuation_id);
                    
                    // Continue with local calculations for display
                    continueLocalCalculations(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
                } else {
                    console.warn('API call failed, using local calculations');
                    // Fall back to local calculation
                    fallbackToLocalCalculation(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
                }
            } catch (error) {
                console.error('DEBUG: Catch block triggered:', error);
                console.error('API Error:', error);
                // Fall back to local calculation
                fallbackToLocalCalculation(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
            }
        });
        
        // Function to handle local calculations after API call
        // Function to handle local calculations after API call
        window.continueLocalCalculations = function(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText) {
            console.log('DEBUG: continueLocalCalculations called');
            // Execute calculations immediately
            // Base value calculation (for display breakdown)
            const baseCapacityValue = capacity * 5000;
                
                // Calculate manufacturer premium based on brand
                const manufacturerPremiumData = calculateManufacturerPremium(manufacturer, baseCapacityValue);
                const manufacturerPremium = manufacturerPremiumData.premium;
                
                // Calculate model premium (8% of base capacity value)
                const modelPremium = baseCapacityValue * 0.08;
                
                // Calculate boom/jib package premium (separate from manufacturer premium)
                const boomPremium = calculateBoomPackagePremium(manufacturer, model, jibIncluded, boomLength, jibLength);
                
                // Calculate total base value (base + manufacturer + model + boom/jib)
                const totalBaseValue = baseCapacityValue + manufacturerPremium + modelPremium + boomPremium;
                
                // Age adjustment (5% depreciation per year)
                const currentYear = new Date().getFullYear();
                const age = currentYear - year;
                const ageAdjustment = totalBaseValue * (age * 0.05);
                
                // Hours adjustment
                const averageHoursPerYear = 1500;
                const expectedHours = age * averageHoursPerYear;
                const excessHours = hours - expectedHours;
                const hoursAdjustment = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
                
                // Regional adjustment
                const regionalFactors = {
                    'North America': 1.04,
                    'Europe': 1.02,
                    'Asia Pacific': 0.98,
                    'Middle East': 1.01,
                    'Africa': 0.95,
                    'South America': 0.97
                };
                const regionalAdjustment = totalBaseValue * (regionalFactors[region] - 1);
                
                // Market conditions adjustment (3% of base value)
                const marketConditionsValue = totalBaseValue * 0.03;
                
                // Condition score adjustment (5% of base value)
                const conditionScoreValue = totalBaseValue * 0.05;
                
                // Calculate FINAL estimated value with ALL adjustments
                // This is the single source of truth for the valuation
                const finalEstimatedValue = totalBaseValue 
                    - ageAdjustment 
                    - hoursAdjustment 
                    + regionalAdjustment 
                    + marketConditionsValue 
                    + conditionScoreValue;
                
                // Calculate total adjustments for display
                const totalAdjustments = -ageAdjustment - hoursAdjustment + regionalAdjustment + marketConditionsValue + conditionScoreValue;
                
                console.log('CALCULATION BREAKDOWN:', {
                    baseCapacityValue,
                    boomPremium,
                    totalBaseValue,
                    ageAdjustment,
                    hoursAdjustment,
                    regionalAdjustment,
                    marketConditionsValue,
                    conditionScoreValue,
                    totalAdjustments,
                    finalEstimatedValue
                });
                
                // Calculate dynamic confidence and metrics
                const confidenceScore = calculateConfidenceScore(age, hours, capacity, region);
                const ageFactor = Math.max(0, 1 - (age * 0.05));
                const conditionFactor = calculateConditionFactor(hours, age);
                const marketDemand = calculateMarketDemand(manufacturer, capacity);
                const riskScore = calculateRiskScore(age, hours, region, capacity);
                
                // Update display values - USE FINAL ESTIMATED VALUE EVERYWHERE
                document.getElementById('estimatedValue').textContent = '$' + (finalEstimatedValue / 1000000).toFixed(2) + 'M';
                
                // Calculate market comparison
                const marketAvgValue = capacity * 5000 * 0.95; // Baseline market average
                const valueDifference = ((finalEstimatedValue - marketAvgValue) / marketAvgValue * 100).toFixed(1);
                const diffSign = valueDifference >= 0 ? '+' : '';
                const diffColor = valueDifference >= 0 ? '#00FF88' : '#FF4444';
                document.getElementById('valueDifference').innerHTML = `<span style="color: ${diffColor}">${diffSign}${valueDifference}% vs market avg</span>`;

                document.getElementById('confidenceScore').textContent = confidenceScore + '%';
                document.getElementById('dealGrade').textContent = calculateDealGrade(confidenceScore, riskScore);
                
                // Update sublabels dynamically
                const confidenceLevel = confidenceScore >= 85 ? 'High Confidence' : confidenceScore >= 70 ? 'Moderate Confidence' : 'Low Confidence';
                document.getElementById('confidenceLevel').textContent = confidenceLevel;
                
                const dealGradeText = calculateDealGrade(confidenceScore, riskScore);
                const dealRecommendation = dealGradeText.startsWith('A') ? 'Strong Buy' : dealGradeText.startsWith('B') ? 'Buy' : dealGradeText.startsWith('C') ? 'Hold' : 'Caution';
                document.getElementById('dealRecommendation').textContent = dealRecommendation;

                
                // Calculate rental rates using Smart Rental Engine v3.0
                Promise.all([
                    calculateSmartRentalRates(capacity, craneType, region, year, 'bare'),
                    calculateSmartRentalRates(capacity, craneType, region, year, 'operated')
                ]).then(([bareRentalResult, operatedRentalResult]) => {
                    const bareMonthlyRate = bareRentalResult.rental_rates.monthly_rate;
                    const bareAnnualRate = bareRentalResult.rental_rates.annual_rate;
                    const operatedMonthlyRate = operatedRentalResult.rental_rates.monthly_rate;
                    const operatedAnnualRate = operatedRentalResult.rental_rates.annual_rate;
                    
                    // Update calibration badge
                    const calibrationBadge = document.getElementById('rentalCalibrationBadge');
                    if (bareRentalResult.calibrated) {
                        calibrationBadge.textContent = '‚úì Calibrated';
                        calibrationBadge.style.background = '#00FF88';
                    } else {
                        calibrationBadge.textContent = 'Fallback Mode';
                        calibrationBadge.style.background = '#FFB800';
                    }
                    
                    // Update bare rental display
                    document.getElementById('bareMonthlyDisplay').textContent = '$' + bareMonthlyRate.toLocaleString();
                    document.getElementById('bareAnnualDisplay').textContent = '$' + bareAnnualRate.toLocaleString() + '/year';
                    
                    // Update operated rental display
                    document.getElementById('operatedMonthlyDisplay').textContent = '$' + operatedMonthlyRate.toLocaleString();
                    document.getElementById('operatedAnnualDisplay').textContent = '$' + operatedAnnualRate.toLocaleString() + '/year';
                    
                    // Update utilization scenarios if available
                    if (bareRentalResult.utilization_analysis) {
                        const utilizationDisplay = document.getElementById('utilizationScenariosDisplay');
                        const scenarios = bareRentalResult.utilization_analysis;
                        utilizationDisplay.innerHTML = `
                            <div>
                                <div style="color: #888;">50% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['50%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">70% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['70%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">85% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['85%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                            <div>
                                <div style="color: #888;">95% Util</div>
                                <div style="color: #FFF; font-weight: 600;">$${scenarios['95%'].effective_monthly.toLocaleString()}/mo</div>
                            </div>
                        `;
                    }
                    
                    // Calculate 5-year costs with Smart Engine rates - USE FINAL ESTIMATED VALUE
                    const purchasePrice = finalEstimatedValue;
                    const annualMaintenanceCost = finalEstimatedValue * 0.03; // 3% of value per year
                    const annualInsuranceCost = finalEstimatedValue * 0.015; // 1.5% of value per year
                    const annualStorageCost = 12000; // Average storage cost
                    const fiveYearOperatingCost = (annualMaintenanceCost + annualInsuranceCost + annualStorageCost) * 5;
                    const fiveYearPurchaseTotal = purchasePrice + fiveYearOperatingCost;
                    
                    const fiveYearRentalTotal = bareMonthlyRate * 60; // 5 years of bare rental
                    
                    // Use bare rate for backward compatibility
                    const monthlyRentalRate = bareMonthlyRate;
                    const annualRentalRevenue = bareAnnualRate;
                    
                    // Update rental vs purchase table
                    const rentalVsPurchaseBody = document.getElementById('rentalVsPurchaseBody');
                    rentalVsPurchaseBody.innerHTML = `
                        <tr>
                            <td><strong>Purchase</strong></td>
                            <td>$${purchasePrice.toLocaleString()}</td>
                            <td>$${Math.round(fiveYearOperatingCost).toLocaleString()}</td>
                            <td style="color: #00FF88; font-weight: 600;">$${Math.round(fiveYearPurchaseTotal).toLocaleString()}</td>
                            <td style="color: #00FF88;">Best for long-term use</td>
                        </tr>
                        <tr>
                            <td><strong>Rent (Bare)</strong></td>
                            <td>$0</td>
                            <td>$${Math.round(fiveYearRentalTotal).toLocaleString()}</td>
                            <td style="color: #FFB800; font-weight: 600;">$${Math.round(fiveYearRentalTotal).toLocaleString()}</td>
                            <td style="color: ${fiveYearRentalTotal < fiveYearPurchaseTotal ? '#00FF88' : '#FFB800'};">${fiveYearRentalTotal < fiveYearPurchaseTotal ? 'Cost-effective for 5 years' : 'Better for short-term'}</td>
                        </tr>
                        <tr style="background: #1A1A1A;">
                            <td colspan="3"><strong>Break-even Point</strong></td>
                            <td colspan="2" style="color: #FFFFFF; font-weight: 600;">${Math.round(purchasePrice / monthlyRentalRate)} months (${(purchasePrice / monthlyRentalRate / 12).toFixed(1)} years)</td>
                        </tr>
                    `;
                    
                    // Initialize rental comparison chart
                    initializeRentalComparisonChart(purchasePrice, monthlyRentalRate);
                }).catch(error => {
                    console.error('Smart Rental Engine Error:', error);
                    // Fallback to simple display if rental calculation fails
                    const fallbackRate = Math.round(finalEstimatedValue * 0.015);
                    document.getElementById('bareMonthlyDisplay').textContent = '$' + fallbackRate.toLocaleString();
                    document.getElementById('bareAnnualDisplay').textContent = '$' + (fallbackRate * 12).toLocaleString() + '/year';
                    document.getElementById('operatedMonthlyDisplay').textContent = '$' + Math.round(fallbackRate * 1.45).toLocaleString();
                    document.getElementById('operatedAnnualDisplay').textContent = '$' + Math.round(fallbackRate * 1.45 * 12).toLocaleString() + '/year';
                });
                
                // Update comparables table
                console.log('üöÄ ABOUT TO CALL getRelevantComparables with:', craneType, capacity);
                alert('Calling comparables for: ' + craneType + ', ' + capacity + 'T');
                const comparables = getRelevantComparables(craneType, capacity);
                console.log('üéØ Got comparables:', comparables.length);
                alert('Got ' + comparables.length + ' comparables');
                const comparablesTableBody = document.getElementById('comparablesTableBody');
                comparablesTableBody.innerHTML = '';
                
                if (comparables.length > 0) {
                    comparables.forEach(comp => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${comp.equipment}</td>
                            <td>${craneType}</td>
                            <td>${comp.year}</td>
                            <td>${comp.capacity}T</td>
                            <td>${comp.hours.toLocaleString()}</td>
                            <td>$${comp.price.toLocaleString()}</td>
                            <td>$${Math.round(comp.price / comp.capacity).toLocaleString()}</td>
                            <td style="color: ${comp.trend.startsWith('+') ? '#00FF88' : '#FF4444'};">${comp.trend}</td>
                            <td>${comp.location}</td>
                        `;
                        comparablesTableBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="9" style="text-align: center; color: #888;">
                            No comparable sales data available for this crane class and capacity range. Expanding our database.
                        </td>
                    `;
                    comparablesTableBody.appendChild(row);
                }
                
                // Update Executive Summary metrics - wrapped in try-catch to prevent blocking
                try {
                    updateExecutiveSummaryMetrics(ageFactor, conditionFactor, marketDemand, riskScore);
                } catch (e) { console.error('Error updating executive summary:', e); }
                
                // Update Risk Analysis tab
                try {
                    updateRiskAnalysisTab(age, hours, region, capacity, manufacturer);
                } catch (e) { console.error('Error updating risk analysis:', e); }
                
                // Update Cost Breakdown tab with actual values - PASS ALL ADJUSTMENT VALUES
                try {
                    updateCostBreakdownTab(baseCapacityValue, manufacturerPremium, modelPremium, boomPremium, totalBaseValue, age, ageAdjustment, 
                        hours, expectedHours, hoursAdjustment, regionalAdjustment, marketConditionsValue, 
                        conditionScoreValue, totalAdjustments, finalEstimatedValue, manufacturer, model, 
                        confidenceScore, capacity);
                } catch (e) { console.error('Error updating cost breakdown:', e); }
                
                // Update trend chart with crane-specific data
                try {
                    updateTrendChartWithData(finalEstimatedValue, capacity);
                } catch (e) { console.error('Error updating trend chart:', e); }
                
                // Show results
                document.getElementById('valuationResults').classList.add('show');
                
                // Scroll to results
                document.getElementById('valuationResults').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Initialize charts
                initializeTrendChart();
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
        }
        
        // Function to fallback to local calculation when API fails
        // Function to fallback to local calculation when API fails
        function fallbackToLocalCalculation(capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText) {
            console.log('DEBUG: fallbackToLocalCalculation called');
            // Base value calculation
            const baseCapacityValue = capacity * 5000;
            const manufacturerPremiumData = calculateManufacturerPremium(manufacturer, baseCapacityValue);
            const manufacturerPremium = manufacturerPremiumData.premium;
            const modelPremium = baseCapacityValue * 0.08;
            const boomPremium = calculateBoomPackagePremium(manufacturer, model, jibIncluded, boomLength, jibLength);
            const totalBaseValue = baseCapacityValue + manufacturerPremium + modelPremium + boomPremium;
            
            // Age adjustment
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            const ageAdjustment = totalBaseValue * (age * 0.05);
            
            // Hours adjustment
            const averageHoursPerYear = 1500;
            const expectedHours = age * averageHoursPerYear;
            const excessHours = hours - expectedHours;
            const hoursAdjustment = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
            
            // Regional adjustment
            const regionalFactors = {
                'North America': 1.04,
                'Europe': 1.02,
                'Asia Pacific': 0.98,
                'Middle East': 1.01,
                'Africa': 0.95,
                'South America': 0.97
            };
            const regionalAdjustment = totalBaseValue * (regionalFactors[region] - 1);
            
            // Market conditions and condition score
            const marketConditionsValue = totalBaseValue * 0.03;
            const conditionScoreValue = totalBaseValue * 0.05;
            
            // Final estimated value with ALL adjustments
            const estimatedValue = totalBaseValue - ageAdjustment - hoursAdjustment + regionalAdjustment + marketConditionsValue + conditionScoreValue;
            
            // Update display
            document.getElementById('estimatedValue').textContent = '$' + (estimatedValue / 1000000).toFixed(2) + 'M';
            
            // Show results and continue with rest of the calculations
            continueLocalCalculations(estimatedValue, capacity, year, hours, region, manufacturer, model, jibIncluded, boomLength, jibLength, craneType, submitBtn, originalText);
        }

        // Helper functions for dynamic calculations
        function calculateConfidenceScore(age, hours, capacity, region) {
            let score = 95; // Start with high confidence
            
            // Reduce confidence for older cranes
            if (age > 10) score -= (age - 10) * 2;
            else if (age > 5) score -= (age - 5);
            
            // Reduce confidence for high hours
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            if (hours > expectedHours * 1.5) score -= 10;
            else if (hours > expectedHours * 1.2) score -= 5;
            
            // Adjust for capacity (more data for common capacities)
            if (capacity < 50 || capacity > 500) score -= 3;
            
            // Regional data availability
            const regionalConfidence = {
                'North America': 0,
                'Europe': -2,
                'Asia Pacific': -3,
                'Middle East': -5,
                'Africa': -7,
                'South America': -5
            };
            score += regionalConfidence[region] || -5;
            
            return Math.max(65, Math.min(98, Math.round(score)));
        }
        
        function calculateConditionFactor(hours, age) {
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            const hoursRatio = hours / Math.max(1, expectedHours);
            
            if (hoursRatio < 0.7) return 0.95; // Low hours = excellent condition
            if (hoursRatio < 1.0) return 0.90; // Below average hours = good
            if (hoursRatio < 1.3) return 0.85; // Average hours = fair
            return 0.75; // High hours = needs attention
        }
        
        function calculateMarketDemand(manufacturer, capacity) {
            const premiumManufacturers = ['Liebherr', 'Grove', 'Tadano', 'Manitowoc'];
            const isPremium = premiumManufacturers.some(m => manufacturer.toLowerCase().includes(m.toLowerCase()));
            
            const optimalCapacityRange = capacity >= 80 && capacity <= 300;
            
            if (isPremium && optimalCapacityRange) return 'Very High';
            if (isPremium || optimalCapacityRange) return 'High';
            if (capacity > 500) return 'Moderate';
            return 'Medium';
        }
        
        function calculateRiskScore(age, hours, region, capacity) {
            let risk = 20; // Base risk
            
            // Age risk
            if (age > 15) risk += 25;
            else if (age > 10) risk += 15;
            else if (age > 5) risk += 8;
            
            // Hours risk
            const avgHoursPerYear = 1500;
            const expectedHours = age * avgHoursPerYear;
            if (hours > expectedHours * 1.5) risk += 20;
            else if (hours > expectedHours * 1.2) risk += 10;
            
            // Regional risk
            const regionalRisk = {
                'North America': 5,
                'Europe': 8,
                'Asia Pacific': 12,
                'Middle East': 18,
                'Africa': 22,
                'South America': 15
            };
            risk += regionalRisk[region] || 15;
            
            // Capacity risk
            if (capacity > 500) risk += 10; // Specialized equipment
            if (capacity < 30) risk += 5; // Limited market
            
            return Math.min(95, risk);
        }
        
        function calculateDealGrade(confidenceScore, riskScore) {
            const combinedScore = confidenceScore - riskScore;
            
            if (combinedScore >= 60) return 'A+';
            if (combinedScore >= 50) return 'A';
            if (combinedScore >= 40) return 'A-';
            if (combinedScore >= 30) return 'B+';
            if (combinedScore >= 20) return 'B';
            if (combinedScore >= 10) return 'B-';
            if (combinedScore >= 0) return 'C+';
            return 'C';
        }
        
        function updateExecutiveSummaryMetrics(ageFactor, conditionFactor, marketDemand, riskScore) {
            // Update metrics in the overview section
            // Update metrics using IDs for reliability
            document.getElementById('ageFactorValue').textContent = ageFactor.toFixed(2);
            document.getElementById('conditionValue').textContent = conditionFactor.toFixed(2);
            document.getElementById('marketDemandValue').textContent = marketDemand;
            const riskScoreElement = document.getElementById('riskScoreValue');
            const riskLevel = riskScore < 30 ? 'Low' : riskScore < 60 ? 'Medium' : 'High';
            riskScoreElement.textContent = riskLevel;
            riskScoreElement.style.color = riskScore < 30 ? '#00FF88' : riskScore < 60 ? '#FFB800' : '#FF4444';

            const metricsCards = document.querySelectorAll('#overviewSection .metric-card .metric-value');
            if (metricsCards.length >= 4) {
                metricsCards[0].textContent = ageFactor.toFixed(2);
                metricsCards[1].textContent = conditionFactor.toFixed(2);
                metricsCards[2].textContent = marketDemand;
                metricsCards[3].textContent = riskScore < 30 ? 'Low' : riskScore < 60 ? 'Medium' : 'High';
                metricsCards[3].style.color = riskScore < 30 ? '#00FF88' : riskScore < 60 ? '#FFB800' : '#FF4444';
            }
        }
        
        function updateRiskAnalysisTab(age, hours, region, capacity, manufacturer) {
            // Calculate individual risk factors
            const ageRisk = Math.min(50, age * 3);
            const hoursRisk = Math.min(40, (hours / 10000) * 30);
            const regionalRiskMap = {
                'North America': 15,
                'Europe': 20,
                'Asia Pacific': 25,
                'Middle East': 35,
                'Africa': 40,
                'South America': 28
            };
            const locationRisk = regionalRiskMap[region] || 25;
            const marketRisk = capacity > 500 ? 35 : 25;
            
            const totalRisk = (ageRisk + hoursRisk + locationRisk + marketRisk) / 4;
            
            // Update risk metrics
            const riskMetrics = document.querySelectorAll('#riskSection .metrics-grid .metric-card .metric-value');
            if (riskMetrics.length >= 4) {
                riskMetrics[0].textContent = marketRisk + '%';
                riskMetrics[0].style.color = marketRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[1].textContent = hoursRisk.toFixed(0) + '%';
                riskMetrics[1].style.color = hoursRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[2].textContent = ageRisk.toFixed(0) + '%';
                riskMetrics[2].style.color = ageRisk > 30 ? '#FF4444' : '#FFB800';
                riskMetrics[3].textContent = locationRisk + '%';
                riskMetrics[3].style.color = locationRisk > 30 ? '#FF4444' : '#FFB800';
            }
            
            // Update overall risk
            const overallRiskElement = document.querySelector('#riskSection .metric-card:last-child .metric-value');
            if (overallRiskElement) {
                const riskLevel = totalRisk < 25 ? 'LOW' : totalRisk < 45 ? 'MEDIUM' : 'HIGH';
                const riskColor = totalRisk < 25 ? '#00FF88' : totalRisk < 45 ? '#FFB800' : '#FF4444';
                overallRiskElement.textContent = riskLevel;
                overallRiskElement.style.color = riskColor;
            }
        }
        
        function updateCostBreakdownTab(baseCapacityValue, manufacturerPremium, modelPremium, boomPremium, totalBaseValue, age, ageAdjustment,
                                       hours, expectedHours, hoursAdjustment, regionalAdjustment, 
                                       marketConditionsValue, conditionScoreValue, totalAdjustments, 
                                       finalEstimatedValue, manufacturer, model, confidenceScore, capacity) {
            try {
                // Update Base Value Calculation section
                const capacityBasePrice = document.getElementById('capacityBasePrice');
                if (capacityBasePrice) {
                    capacityBasePrice.textContent = '$' + Math.round(baseCapacityValue).toLocaleString();
                }
                
                const capacityCalculation = document.getElementById('capacityCalculation');
                if (capacityCalculation) {
                    capacityCalculation.textContent = capacity + ' tons √ó $5,000/ton base rate';
                }
                
                
                // Display manufacturer premium (passed as parameter)
                const manufacturerPremiumElement = document.getElementById('manufacturerPremium');
                if (manufacturerPremiumElement) {
                    manufacturerPremiumElement.textContent = '+$' + Math.round(manufacturerPremium).toLocaleString();
                }
                
                const manufacturerPremiumDesc = document.getElementById('manufacturerPremiumDesc');
                if (manufacturerPremiumDesc) {
                    const premiumPercent = Math.round((manufacturerPremium / baseCapacityValue) * 100);
                    manufacturerPremiumDesc.textContent = manufacturer + ' premium factor: ' + premiumPercent + '%';
                }
                
                // Display model premium (passed as parameter)
                const modelPremiumElement = document.getElementById('modelPremium');
                if (modelPremiumElement) {
                    modelPremiumElement.textContent = '+$' + Math.round(modelPremium).toLocaleString();
                }
                
                const modelPremiumDesc = document.getElementById('modelPremiumDesc');
                if (modelPremiumDesc) {
                    modelPremiumDesc.textContent = model + ' model premium: 8%';
                }
                
                // Update subtotal
                const breakdownSubtotal = document.getElementById('breakdownSubtotalBaseValue');
                if (breakdownSubtotal) {
                    breakdownSubtotal.textContent = '$' + Math.round(totalBaseValue).toLocaleString();
                }
                
                // Update Adjustments section
                const ageDepreciation = document.getElementById('ageDepreciation');
                if (ageDepreciation) {
                    ageDepreciation.textContent = '-$' + Math.round(ageAdjustment).toLocaleString();
                }
                
                const ageDepreciationDesc = document.getElementById('ageDepreciationDesc');
                if (ageDepreciationDesc) {
                    const currentYear = new Date().getFullYear();
                    const craneAge = currentYear - age;
                    const agePercent = ((ageAdjustment / totalBaseValue) * 100).toFixed(0);
                    ageDepreciationDesc.textContent = age + ' model (' + craneAge + ' years old) @ ' + agePercent + '% per year';
                }
                
                const operatingHoursAdj = document.getElementById('operatingHoursAdj');
                if (operatingHoursAdj) {
                    operatingHoursAdj.textContent = '-$' + Math.round(hoursAdjustment).toLocaleString();
                }
                
                const operatingHoursDesc = document.getElementById('operatingHoursDesc');
                if (operatingHoursDesc) {
                    const hoursPercent = ((hoursAdjustment / totalBaseValue) * 100).toFixed(0);
                    const comparison = hours > expectedHours ? 'above average' : 'below average';
                    operatingHoursDesc.textContent = Math.round(hours).toLocaleString() + ' hours (' + comparison + ') @ -' + hoursPercent + '%';
                }
                
                const regionalFactor = document.getElementById('regionalFactor');
                if (regionalFactor) {
                    const sign = regionalAdjustment >= 0 ? '+' : '';
                    regionalFactor.textContent = sign + '$' + Math.round(regionalAdjustment).toLocaleString();
                }
                
                const regionalFactorDesc = document.getElementById('regionalFactorDesc');
                if (regionalFactorDesc) {
                    const regionalPercent = ((regionalAdjustment / totalBaseValue) * 100).toFixed(0);
                    const sign = regionalAdjustment >= 0 ? '+' : '';
                    regionalFactorDesc.textContent = 'Regional premium: ' + sign + regionalPercent + '%';
                }
                
                // Market conditions - USE PASSED VALUE
                const marketConditions = document.getElementById('marketConditions');
                if (marketConditions) {
                    marketConditions.textContent = '+$' + Math.round(marketConditionsValue).toLocaleString();
                }
                
                const marketConditionsDesc = document.getElementById('marketConditionsDesc');
                if (marketConditionsDesc) {
                    const marketPercent = ((marketConditionsValue / totalBaseValue) * 100).toFixed(0);
                    marketConditionsDesc.textContent = 'Current market premium: +' + marketPercent + '%';
                }
                
                // Condition score adjustment - USE PASSED VALUE
                const conditionScoreAdj = document.getElementById('conditionScoreAdj');
                if (conditionScoreAdj) {
                    conditionScoreAdj.textContent = '+$' + Math.round(conditionScoreValue).toLocaleString();
                }
                
                const conditionScoreDesc = document.getElementById('conditionScoreDesc');
                if (conditionScoreDesc) {
                    const conditionPercent = ((conditionScoreValue / totalBaseValue) * 100).toFixed(0);
                    conditionScoreDesc.textContent = 'Condition premium: +' + conditionPercent + '%';
                }
                
                // Update total adjustments - USE PASSED VALUE
                const breakdownAdjustments = document.getElementById('breakdownTotalAdjustments');
                if (breakdownAdjustments) {
                    const sign = totalAdjustments >= 0 ? '+' : '';
                    breakdownAdjustments.textContent = sign + '$' + Math.round(totalAdjustments).toLocaleString();
                }
                
                // Update Final Valuation Summary section
                const finalBaseValue = document.getElementById('finalSummaryBaseValue');
                if (finalBaseValue) {
                    finalBaseValue.textContent = '$' + Math.round(totalBaseValue).toLocaleString();
                }
                
                const finalAdjustments = document.getElementById('finalSummaryTotalAdjustments');
                if (finalAdjustments) {
                    const sign = totalAdjustments >= 0 ? '+' : '';
                    finalAdjustments.textContent = sign + '$' + Math.round(totalAdjustments).toLocaleString();
                }
                
                const finalEstValue = document.getElementById('finalSummaryEstimatedValue');
                if (finalEstValue) {
                    finalEstValue.textContent = '$' + Math.round(finalEstimatedValue).toLocaleString();
                }
                
                const finalConfScore = document.getElementById('finalSummaryConfidenceScore');
                if (finalConfScore) {
                    finalConfScore.textContent = Math.round(confidenceScore * 100) + '%';
                }
                
                // Update value range (¬±10% of estimated value)
                const finalValueRange = document.getElementById('finalSummaryValueRange');
                if (finalValueRange) {
                    const lowerBound = finalEstimatedValue * 0.90;
                    const upperBound = finalEstimatedValue * 1.10;
                    
                    // Format values in millions
                    const formatValue = (val) => {
                        if (val >= 1000000) {
                            return '$' + (val / 1000000).toFixed(2) + 'M';
                        } else if (val >= 1000) {
                            return '$' + (val / 1000).toFixed(0) + 'K';
                        } else {
                            return '$' + Math.round(val).toLocaleString();
                        }
                    };
                    
                    finalValueRange.textContent = formatValue(lowerBound) + ' - ' + formatValue(upperBound);
                }
                
                const finalDealRec = document.getElementById('finalSummaryDealRecommendation');
                if (finalDealRec) {
                    // Determine deal recommendation based on confidence score
                    let recommendation = 'Hold';
                    if (confidenceScore >= 0.85) {
                        recommendation = 'Strong Buy';
                    } else if (confidenceScore >= 0.70) {
                        recommendation = 'Buy';
                    } else if (confidenceScore >= 0.50) {
                        recommendation = 'Consider';
                    }
                    finalDealRec.textContent = recommendation;
                }
                
                console.log('Cost Breakdown Updated Successfully:', {
                    baseValue: totalBaseValue,
                    adjustments: totalAdjustments,
                    finalValue: finalEstimatedValue,
                    confidence: confidenceScore
                });
            } catch (error) {
                console.error('Error in updateCostBreakdownTab:', error);
            }
        }
        
        function updateTrendChartWithData(estimatedValue, capacity) {
            // Generate dynamic trend data based on the crane's estimated value
            const baseValue = estimatedValue / 1000000; // Convert to millions
            const trendData = [];
            
            // Generate 12 months of historical trend with some variance
            for (let i = 0; i < 12; i++) {
                const variance = (Math.random() - 0.5) * 0.15; // ¬±7.5% variance
                const seasonalFactor = Math.sin((i / 12) * Math.PI * 2) * 0.05; // Seasonal trend
                const monthValue = baseValue * (1 + variance + seasonalFactor - 0.03 * (11 - i) / 12);
                trendData.push(parseFloat(monthValue.toFixed(2)));
            }
            
            // Update the chart if it exists
            if (chartInstances['trendChart']) {
                chartInstances['trendChart'].data.datasets[0].data = trendData;
                chartInstances['trendChart'].update();
            }
        }

        // Chart initialization
        function initializeTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['trendChart']) {
                chartInstances['trendChart'].destroy();
            }
            
            chartInstances['trendChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: '12 Month History',
                        data: [3.00, 3.05, 3.12, 3.15, 3.22, 3.25, 3.28, 3.30, 3.32, 3.31, 3.28, 3.25],
                        borderColor: '#00FF88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(2) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }

        function initializeManufacturerChart() {
            const ctx = document.getElementById('manufacturerChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['manufacturerChart']) {
                chartInstances['manufacturerChart'].destroy();
            }
            
            chartInstances['manufacturerChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Terex', 'Liebherr', 'Grove', 'Tadano', 'Manitowoc', 'Others'],
                    datasets: [{
                        data: [25, 20, 18, 15, 12, 10],
                        backgroundColor: [
                            '#00FF88',
                            '#FFB800',
                            '#FF4444',
                            '#4A90E2',
                            '#7B68EE',
                            '#888888'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#FFFFFF',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function initializeCapacityChart() {
            const ctx = document.getElementById('capacityChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['capacityChart']) {
                chartInstances['capacityChart'].destroy();
            }
            
            chartInstances['capacityChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-50T', '50-100T', '100-200T', '200-500T', '500-1000T', '1000T+'],
                    datasets: [{
                        label: 'Market Share',
                        data: [35, 28, 25, 40, 25, 15],
                        backgroundColor: '#00FF88'
                    }, {
                        label: 'Average Value ($M)',
                        data: [0.5, 1.2, 2.1, 3.8, 6.2, 12.5],
                        backgroundColor: '#FFB800',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFFFFF'
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }
        
        function initializeRentalComparisonChart(purchasePrice, monthlyRentalRate) {
            const ctx = document.getElementById('rentalComparisonChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (chartInstances['rentalComparisonChart']) {
                chartInstances['rentalComparisonChart'].destroy();
            }
            
            // Calculate cumulative costs over 10 years
            const years = [];
            const purchaseCosts = [];
            const rentalCosts = [];
            
            const annualOperatingCost = purchasePrice * 0.045; // 4.5% of value per year
            
            for (let i = 0; i <= 10; i++) {
                years.push(i === 0 ? 'Now' : `Year ${i}`);
                purchaseCosts.push(purchasePrice + (annualOperatingCost * i));
                rentalCosts.push(monthlyRentalRate * 12 * i);
            }
            
            chartInstances['rentalComparisonChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Purchase Total Cost',
                        data: purchaseCosts,
                        borderColor: '#00FF88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 3
                    }, {
                        label: 'Rental Total Cost',
                        data: rentalCosts,
                        borderColor: '#FFB800',
                        backgroundColor: 'rgba(255, 184, 0, 0.1)',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#FFFFFF',
                                font: {
                                    size: 14
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: '10-Year Cost Comparison: Purchase vs Rental',
                            color: '#00FF88',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888',
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    }
                }
            });
        }

        // Bulk upload functionality
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = '<div class="upload-text">Processing file...</div>';
            
            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCSV = fileName.endsWith('.csv');
            
            if (!isExcel && !isCSV) {
                uploadArea.innerHTML = '<div class="upload-icon">‚ùå</div><div class="upload-text">Error: Unsupported file format. Please upload .xlsx, .xls, or .csv</div>';
                return;
            }
            
            // Read file content
            const reader = new FileReader();
            
            if (isExcel) {
                // Handle Excel files
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            uploadArea.innerHTML = '<div class="upload-icon">‚ùå</div><div class="upload-text">Error: File is empty or invalid</div>';
                            return;
                        }
                        
                        await processBulkData(jsonData, uploadArea);
                        
                    } catch (error) {
                        console.error('Excel processing error:', error);
                        uploadArea.innerHTML = '<div class="upload-icon">‚ùå</div><div class="upload-text">Error processing Excel file: ' + error.message + '</div>';
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } else {
                // Handle CSV files
                reader.onload = async function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            uploadArea.innerHTML = '<div class="upload-icon">‚ùå</div><div class="upload-text">Error: File is empty or invalid</div>';
                            return;
                        }
                        
                        // Parse CSV to array format
                        const jsonData = lines.map(line => {
                            // Handle quoted values
                            const values = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            values.push(current.trim());
                            return values;
                        });
                        
                        await processBulkData(jsonData, uploadArea);
                        
                    } catch (error) {
                        console.error('CSV processing error:', error);
                        uploadArea.innerHTML = '<div class="upload-icon">‚ùå</div><div class="upload-text">Error processing CSV file: ' + error.message + '</div>';
                    }
                };
                reader.readAsText(file);
            }
        }
        
        async function processBulkData(jsonData, uploadArea) {
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            // Check subscription limits before processing
            const token = localStorage.getItem('access_token');
            let remainingValuations = dataRows.length; // Default: process all
            let limitReached = false;
            
            try {
                const limitResponse = await fetch('/api/v1/payments/subscription-info', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (limitResponse.ok) {
                    const limitData = await limitResponse.json();
                    remainingValuations = limitData.valuations_remaining;
                    
                    console.log(`Subscription limits: ${limitData.valuations_used}/${limitData.valuations_limit} used, ${remainingValuations} remaining`);
                    
                    // If user has fewer remaining valuations than cranes to process
                    if (remainingValuations < dataRows.length) {
                        limitReached = true;
                        
                        // Show warning toast
                        const warningToast = document.createElement('div');
                        warningToast.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #FFB800;
                            color: #000;
                            padding: 16px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            z-index: 10000;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            max-width: 400px;
                        `;
                        
                        if (remainingValuations === 0) {
                            warningToast.innerHTML = `
                                ‚ö†Ô∏è Valuation limit reached!<br>
                                <span style="font-size: 14px; font-weight: 400;">You have used all ${limitData.valuations_limit} valuations for this month. Please upgrade your plan to continue.</span>
                            `;
                        } else {
                            warningToast.innerHTML = `
                                ‚ö†Ô∏è Partial processing!<br>
                                <span style="font-size: 14px; font-weight: 400;">Only ${remainingValuations} of ${dataRows.length} cranes will be valued due to your subscription limit (${limitData.valuations_used}/${limitData.valuations_limit} used).</span>
                            `;
                        }
                        
                        document.body.appendChild(warningToast);
                        
                        // Auto-remove toast after 8 seconds
                        setTimeout(() => {
                            warningToast.remove();
                        }, 8000);
                    }
                }
            } catch (error) {
                console.error('Error checking subscription limits:', error);
                // Continue with processing if limit check fails
            }
            
            bulkData = [];
            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;
            const errors = [];
            
            // Process each crane
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                // Skip empty rows
                if (!row || row.length === 0 || row.every(cell => !cell)) continue;
                
                // Check if we've reached the subscription limit
                if (successCount >= remainingValuations) {
                    skippedCount++;
                    continue;
                }
                
                // Validate minimum required fields
                if (row.length < 5) {
                    errors.push(`Row ${i + 2}: Insufficient data (need at least Manufacturer, Model, Year, Capacity, Hours)`);
                    errorCount++;
                    continue;
                }
                
                try {
                    // Extract and validate data
                    const manufacturer = String(row[0] || '').trim();
                    const model = String(row[1] || '').trim();
                    const year = parseInt(row[2]) || new Date().getFullYear();
                    const capacity = parseInt(row[3]) || 0;
                    const hours = parseInt(row[4]) || 0;
                    const condition = String(row[5] || 'good').trim();
                    const boomLength = row[6] ? parseFloat(row[6]) : null;
                    const craneType = String(row[7] || 'All-Terrain Crane').trim();
                    const region = String(row[8] || 'North America').trim();
                    
                    // Validation
                    if (!manufacturer) {
                        errors.push(`Row ${i + 2}: Missing manufacturer`);
                        errorCount++;
                        continue;
                    }
                    if (!model) {
                        errors.push(`Row ${i + 2}: Missing model`);
                        errorCount++;
                        continue;
                    }
                    if (capacity <= 0) {
                        errors.push(`Row ${i + 2}: Invalid capacity (${capacity})`);
                        errorCount++;
                        continue;
                    }
                    if (year < 1950 || year > new Date().getFullYear() + 1) {
                        errors.push(`Row ${i + 2}: Invalid year (${year})`);
                        errorCount++;
                        continue;
                    }
                    
                    // ===== ENHANCED UNIFIED CALCULATION LOGIC =====
                    const currentYear = new Date().getFullYear();
                    const age = currentYear - year;
                    
                    // Step 1: Base capacity value
                    const baseCapacityValue = capacity * 5000;
                    
                    // Step 2: Manufacturer premium
                    const manufacturerFactors = {
                        'liebherr': 0.20,
                        'grove': 0.18,
                        'tadano': 0.18,
                        'terex': 0.15,
                        'manitowoc': 0.15,
                        'link-belt': 0.12
                    };
                    const manuLower = manufacturer.toLowerCase();
                    let manufacturerFactor = 0.10; // Default
                    for (const [key, value] of Object.entries(manufacturerFactors)) {
                        if (manuLower.includes(key)) {
                            manufacturerFactor = value;
                            break;
                        }
                    }
                    const manufacturerPremiumValue = baseCapacityValue * manufacturerFactor;
                    
                    // Step 3: Model premium (8% of base)
                    const modelPremiumValue = baseCapacityValue * 0.08;
                    
                    // Step 4: Total base value
                    const totalBaseValue = baseCapacityValue + manufacturerPremiumValue + modelPremiumValue;
                    
                    // Step 5: Age adjustment (5% per year)
                    const ageDepreciationValue = totalBaseValue * (age * 0.05);
                    
                    // Step 6: Hours adjustment
                    const averageHoursPerYear = 1500;
                    const expectedHours = age * averageHoursPerYear;
                    const excessHours = hours - expectedHours;
                    const hoursAdjustmentValue = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
                    
                    // Step 7: Regional adjustment
                    const regionalFactors = {
                        'North America': 1.04,
                        'Europe': 1.02,
                        'Asia Pacific': 0.98,
                        'Middle East': 1.01,
                        'Latin America': 0.96,
                        'Africa': 0.94
                    };
                    const regionalMultiplier = regionalFactors[region] || 1.0;
                    const regionalAdjustmentValue = totalBaseValue * (regionalMultiplier - 1.0);
                    
                    // Step 8: Market conditions (current trend: +3%)
                    const marketTrend = 0.03;
                    const marketConditionsValue = totalBaseValue * marketTrend;
                    
                    // Step 9: Condition score adjustment
                    const conditionFactors = {
                        'excellent': 0.05,
                        'good': 0.02,
                        'fair': -0.02,
                        'poor': -0.08
                    };
                    const conditionFactor = conditionFactors[condition.toLowerCase()] || 0;
                    const conditionAdjustmentValue = totalBaseValue * conditionFactor;
                    
                    // Step 10: Calculate total adjustments
                    const totalAdjustments = -ageDepreciationValue - hoursAdjustmentValue + regionalAdjustmentValue + marketConditionsValue + conditionAdjustmentValue;
                    
                    // Step 11: Final estimated value
                    const finalEstimatedValue = Math.round(totalBaseValue + totalAdjustments);
                    
                    // Step 12: Confidence score (70-95%)
                    const confidenceBase = 70;
                    const capacityBonus = Math.min(15, capacity / 100);
                    const ageBonus = Math.max(0, 10 - age);
                    const confidence = Math.min(95, confidenceBase + capacityBonus + ageBonus);
                    
                    // Step 13: Risk score
                    const riskScore = Math.max(1, Math.min(10, Math.round((age / 2) + (hours / 10000) - (confidence / 10))));
                    
                    // Step 14: Deal grade
                    let dealGrade = 'C';
                    if (confidence > 90 && age < 3) {
                        dealGrade = 'A+';
                    } else if (confidence > 85 && age < 5) {
                        dealGrade = 'A';
                    } else if (confidence > 80 && age < 8) {
                        dealGrade = 'B+';
                    } else if (confidence > 75) {
                        dealGrade = 'B';
                    } else if (confidence > 70) {
                        dealGrade = 'C+';
                    }
                    
                    // Store result with complete breakdown
                    bulkData.push({
                        crane: `${manufacturer} ${model}`,
                        manufacturer: manufacturer,
                        model: model,
                        year: year.toString(),
                        capacity: `${capacity}T`,
                        capacityNumeric: capacity,
                        hours: hours.toString(),
                        hoursNumeric: hours,
                        region: region,
                        condition: condition,
                        craneType: craneType,
                        estimatedValue: '$' + finalEstimatedValue.toLocaleString(),
                        estimatedValueNumeric: finalEstimatedValue,
                        confidence: `${Math.round(confidence)}%`,
                        confidenceNumeric: Math.round(confidence),
                        grade: dealGrade,
                        riskScore: riskScore,
                        boomLength: boomLength,
                        breakdown: {
                            baseCapacityValue: baseCapacityValue,
                            manufacturerPremium: manufacturerPremiumValue,
                            manufacturerFactor: manufacturerFactor,
                            modelPremium: modelPremiumValue,
                            totalBaseValue: totalBaseValue,
                            age: age,
                            ageDepreciation: ageDepreciationValue,
                            expectedHours: expectedHours,
                            excessHours: excessHours,
                            hoursAdjustment: hoursAdjustmentValue,
                            regionalMultiplier: regionalMultiplier,
                            regionalAdjustment: regionalAdjustmentValue,
                            marketConditions: marketConditionsValue,
                            conditionAdjustment: conditionAdjustmentValue,
                            totalAdjustments: totalAdjustments,
                            finalEstimatedValue: finalEstimatedValue
                        }
                    });
                    
                    // Track usage in backend
                    try {
                        await fetch('/api/v1/paywall/track-usage', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                action_type: 'valuation',
                                endpoint: '/api/v1/valuation/bulk',
                                crane_manufacturer: manufacturer,
                                crane_model: model,
                                crane_capacity: capacity
                            })
                        });
                    } catch (trackError) {
                        console.error('Error tracking usage:', trackError);
                        // Don't fail the valuation if tracking fails
                    }
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`Error processing row ${i + 2}:`, error);
                    errors.push(`Row ${i + 2}: ${error.message}`);
                    errorCount++;
                }
                
                // Update progress
                uploadArea.innerHTML = `<div class="upload-text">Processing... ${i + 1} of ${dataRows.length} rows</div>`;
            }
            
            // Display results
            if (bulkData.length > 0) {
                displayBulkResults();
                
                let statusMessage = `<div class="upload-icon">‚úÖ</div><div class="upload-text">Successfully processed ${successCount} crane${successCount !== 1 ? 's' : ''}`;
                if (errorCount > 0) {
                    statusMessage += ` (${errorCount} error${errorCount !== 1 ? 's' : ''})`;
                }
                if (skippedCount > 0) {
                    statusMessage += ` (${skippedCount} skipped due to limit)`;
                }
                statusMessage += '</div>';
                
                if (errors.length > 0 && errors.length <= 5) {
                    statusMessage += '<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; text-align: left; font-size: 0.9rem;">';
                    statusMessage += '<div style="color: #FFB800; font-weight: 600; margin-bottom: 0.5rem;">Errors:</div>';
                    errors.forEach(err => {
                        statusMessage += `<div style="color: #FF4444; margin-bottom: 0.25rem;">‚Ä¢ ${err}</div>`;
                    });
                    statusMessage += '</div>';
                } else if (errors.length > 5) {
                    statusMessage += `<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; color: #FFB800;">‚ö†Ô∏è ${errors.length} errors occurred. Check console for details.</div>`;
                    console.error('Bulk processing errors:', errors);
                }
                
                uploadArea.innerHTML = statusMessage;
            } else {
                let errorMessage = '<div class="upload-icon">‚ùå</div><div class="upload-text">No valid data found in file</div>';
                if (errors.length > 0) {
                    errorMessage += '<div style="margin-top: 1rem; padding: 1rem; background: #2A2A2A; border-radius: 4px; text-align: left; font-size: 0.9rem;">';
                    errorMessage += '<div style="color: #FFB800; font-weight: 600; margin-bottom: 0.5rem;">Errors:</div>';
                    errors.slice(0, 5).forEach(err => {
                        errorMessage += `<div style="color: #FF4444; margin-bottom: 0.25rem;">‚Ä¢ ${err}</div>`;
                    });
                    if (errors.length > 5) {
                        errorMessage += `<div style="color: #888; margin-top: 0.5rem;">... and ${errors.length - 5} more errors</div>`;
                    }
                    errorMessage += '</div>';
                }
                uploadArea.innerHTML = errorMessage;
            }
        }

        function displayBulkResults() {
            const resultsDiv = document.getElementById('bulkResults');
            const tableBody = document.getElementById('resultsTableBody');
            const summary = document.getElementById('resultsSummary');
            
            // Update summary
            summary.textContent = `${bulkData.length} cranes processed ‚Ä¢ ${bulkData.length} successful ‚Ä¢ 0 errors`;
            
            // Clear existing results
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = bulkData.slice(startIndex, endIndex);
            
            // Populate table
            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.crane}</td>
                    <td>${item.year}</td>
                    <td>${item.capacity}</td>
                    <td>${item.hours}</td>
                    <td>${item.region}</td>
                    <td>${item.estimatedValue}</td>
                    <td>${item.confidence}</td>
                    <td>${item.grade}</td>
                    <td>
                        <button class="action-btn view" onclick="viewReport(${startIndex + index})">üìä</button>
                        <button class="action-btn delete" onclick="deleteItem(${startIndex + index})">üóëÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination();
            
            // Show results
            resultsDiv.classList.add('show');
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(bulkData.length / itemsPerPage);
            
            pagination.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevBtn);
            
            // Page info
            const pageInfo = document.createElement('span');
            pageInfo.className = 'pagination-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            pagination.appendChild(pageInfo);
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextBtn);
        }

        function changePage(page) {
            const totalPages = Math.ceil(bulkData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayBulkResults();
        }

        function viewReport(index) {
            const item = bulkData[index];
            const modal = document.getElementById('reportModal');
            const modalBody = document.getElementById('modalBody');
            
            // Use stored breakdown data for accurate display
            const breakdown = item.breakdown;
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #00FF88; margin-bottom: 1rem;">${item.crane}</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div><strong>Manufacturer:</strong> ${item.manufacturer}</div>
                        <div><strong>Model:</strong> ${item.model}</div>
                        <div><strong>Year:</strong> ${item.year}</div>
                        <div><strong>Capacity:</strong> ${item.capacity}</div>
                        <div><strong>Hours:</strong> ${parseInt(item.hours).toLocaleString()}</div>
                        <div><strong>Region:</strong> ${item.region}</div>
                        <div><strong>Condition:</strong> ${item.condition || 'N/A'}</div>
                        <div><strong>Crane Type:</strong> ${item.craneType || 'N/A'}</div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #00FF88;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #00FF88; margin-bottom: 0.5rem;">${item.estimatedValue}</div>
                            <div style="color: #888; font-size: 1.1rem;">Final Estimated Value</div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #404040;">
                                <div style="display: flex; justify-content: space-around;">
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Confidence</div>
                                        <div style="color: #00FF88; font-weight: 600; font-size: 1.2rem;">${item.confidence}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Deal Grade</div>
                                        <div style="color: ${item.grade.startsWith('A') ? '#00FF88' : item.grade.startsWith('B') ? '#FFB800' : '#FF4444'}; font-weight: 700; font-size: 1.3rem;">${item.grade}</div>
                                    </div>
                                    <div>
                                        <div style="color: #888; font-size: 0.9rem;">Risk Score</div>
                                        <div style="color: ${item.riskScore < 25 ? '#00FF88' : item.riskScore < 45 ? '#FFB800' : '#FF4444'}; font-weight: 600; font-size: 1.2rem;">${item.riskScore}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #00FF88; margin-bottom: 1rem; text-transform: uppercase;">Base Value Calculation</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Capacity Base Price (${item.capacityNumeric}T √ó $5,000):</span>
                            <span style="color: #00FF88; font-weight: 600;">$${Math.round(breakdown.baseCapacityValue).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Manufacturer Premium (${item.manufacturer}):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.manufacturerPremium).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Model Premium (${item.model}):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.modelPremium).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 2px solid #00FF88; padding-top: 0.5rem; margin-top: 0.5rem; display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total Base Value:</span>
                            <span style="color: #00FF88; font-size: 1.1rem;">$${Math.round(breakdown.totalBaseValue).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #FFB800; margin-bottom: 1rem; text-transform: uppercase;">Adjustments</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Age Depreciation (${breakdown.age} years @ 5%/year):</span>
                            <span style="color: #FF4444; font-weight: 600;">-$${Math.round(breakdown.ageDepreciation).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Operating Hours (${parseInt(item.hours).toLocaleString()} hrs, expected ${breakdown.expectedHours.toLocaleString()}):</span>
                            <span style="color: ${breakdown.hoursAdjustment > 0 ? '#FF4444' : '#00FF88'}; font-weight: 600;">${breakdown.hoursAdjustment > 0 ? '-' : '+'}$${Math.round(Math.abs(breakdown.hoursAdjustment)).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Regional Factor (${item.region}):</span>
                            <span style="color: ${breakdown.regionalAdjustment >= 0 ? '#00FF88' : '#FF4444'}; font-weight: 600;">${breakdown.regionalAdjustment >= 0 ? '+' : ''}$${Math.round(breakdown.regionalAdjustment).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Market Conditions (current premium):</span>
                            <span style="color: #00FF88; font-weight: 600;">+$${Math.round(breakdown.marketConditions).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                            <span>Condition Score (${item.condition}):</span>
                            <span style="color: ${breakdown.conditionAdjustment >= 0 ? '#00FF88' : '#FF4444'}; font-weight: 600;">${breakdown.conditionAdjustment >= 0 ? '+' : ''}$${Math.round(breakdown.conditionAdjustment).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 2px solid #FFB800; padding-top: 0.5rem; margin-top: 0.5rem; display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total Adjustments:</span>
                            <span style="color: ${breakdown.totalAdjustments >= 0 ? '#00FF88' : '#FFB800'}; font-size: 1.1rem;">${breakdown.totalAdjustments >= 0 ? '+' : ''}$${Math.round(breakdown.totalAdjustments).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1A1A1A 0%, #2A2A2A 100%); padding: 1.5rem; border-radius: 8px; border: 2px solid #00FF88;">
                        <h4 style="color: #FFFFFF; margin-bottom: 1rem; text-transform: uppercase; text-align: center;">Final Valuation Summary</h4>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 1.1rem;">
                            <span>Base Value:</span>
                            <span style="font-weight: 600;">$${Math.round(breakdown.totalBaseValue).toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 1.1rem;">
                            <span>Total Adjustments:</span>
                            <span style="font-weight: 600;">${breakdown.totalAdjustments >= 0 ? '+' : ''}$${Math.round(breakdown.totalAdjustments).toLocaleString()}</span>
                        </div>
                        <div style="border-top: 3px solid #00FF88; padding-top: 1rem; margin-top: 1rem; display: flex; justify-content: space-between; font-size: 1.3rem;">
                            <span style="font-weight: 700;">ESTIMATED VALUE:</span>
                            <span style="color: #00FF88; font-weight: 800;">$${Math.round(breakdown.finalEstimatedValue).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div style="background: #1A1A1A; padding: 1rem; border-radius: 8px; margin-top: 1.5rem; border-left: 4px solid #00FF88;">
                        <p style="color: #888; font-size: 0.9rem; line-height: 1.6; margin: 0;">
                            <strong style="color: #00FF88;">Methodology:</strong> This valuation uses the same unified calculation engine as single valuations, ensuring consistency across all assessments. All adjustments are based on real-time market data and historical transaction analysis.
                        </p>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                bulkData.splice(index, 1);
                displayBulkResults();
            }
        }

        function closeModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        function downloadTemplate() {
            // Create enhanced CSV template with all fields
            const csvContent = "Manufacturer,Model,Year,Capacity,Hours,Condition,Boom Length (m),Crane Type,Region\n" +
                              "Terex,AC 500-2,2022,500,3700,excellent,60,All-Terrain Crane,North America\n" +
                              "Liebherr,LTM 1500-8.1,2021,500,4200,good,55,All-Terrain Crane,Europe\n" +
                              "Kobelco,CK1100G-2,2020,110,5000,good,45,Crawler Crane,Asia Pacific\n" +
                              "Grove,GMK5150L-1,2019,150,6200,fair,50,All-Terrain Crane,North America";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crane_valuation_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportResults() {
            if (!bulkData || bulkData.length === 0) {
                alert('No data available to export');
                return;
            }
            
            // Create comprehensive CSV with all calculation details
            const headers = [
                'Manufacturer', 'Model', 'Year', 'Capacity (T)', 'Hours', 'Condition', 
                'Boom Length (m)', 'Crane Type', 'Region',
                'Base Capacity Value', 'Manufacturer Premium', 'Model Premium', 'Total Base Value',
                'Age (years)', 'Age Adjustment', 'Expected Hours', 'Hours Adjustment',
                'Regional Adjustment', 'Market Conditions', 'Condition Score',
                'Total Adjustments', 'Final Estimated Value',
                'Confidence Score (%)', 'Risk Score', 'Deal Grade'
            ];
            
            const csvContent = [
                headers.join(','),
                ...bulkData.map(item => {
                    const b = item.breakdown;
                    return [
                        `"${item.manufacturer}"`,
                        `"${item.model}"`,
                        item.year,
                        item.capacityNumeric,
                        item.hoursNumeric,
                        `"${item.condition || 'N/A'}"`,
                        item.boomLength || 'N/A',
                        `"${item.craneType || 'N/A'}"`,
                        `"${item.region}"`,
                        Math.round(b.baseCapacityValue),
                        Math.round(b.manufacturerPremium),
                        Math.round(b.modelPremium),
                        Math.round(b.totalBaseValue),
                        b.age,
                        Math.round(b.ageAdjustment),
                        b.expectedHours,
                        Math.round(b.hoursAdjustment),
                        Math.round(b.regionalAdjustment),
                        Math.round(b.marketConditionsValue),
                        Math.round(b.conditionScoreValue),
                        Math.round(b.totalAdjustments),
                        Math.round(b.finalEstimatedValue),
                        item.confidenceNumeric,
                        item.riskScore,
                        item.grade
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crane_valuation_detailed_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            console.log(`Exported ${bulkData.length} crane valuations with full calculation breakdown`);
        }

        function generateReport() {
            if (!bulkData || bulkData.length === 0) {
                alert('No data available to generate report');
                return;
            }
            
            // Calculate summary statistics
            const totalCranes = bulkData.length;
            const totalValue = bulkData.reduce((sum, item) => {
                const value = parseFloat(item.estimatedValue.replace(/[$,]/g, ''));
                return sum + value;
            }, 0);
            const avgValue = totalValue / totalCranes;
            
            const gradeCount = {};
            bulkData.forEach(item => {
                gradeCount[item.grade] = (gradeCount[item.grade] || 0) + 1;
            });
            
            let reportHTML = `
                <div style="padding: 2rem; background: #1A1A1A; color: #FFFFFF;">
                    <h2 style="color: #00FF88; margin-bottom: 2rem;">üìä Bulk Valuation Report Summary</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #00FF88;">${totalCranes}</div>
                            <div style="color: #888; margin-top: 0.5rem;">Total Cranes Valued</div>
                        </div>
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #FFB800;">$${(totalValue / 1000000).toFixed(1)}M</div>
                            <div style="color: #888; margin-top: 0.5rem;">Total Portfolio Value</div>
                        </div>
                        <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 800; color: #4A90E2;">$${(avgValue / 1000000).toFixed(2)}M</div>
                            <div style="color: #888; margin-top: 0.5rem;">Average Value per Crane</div>
                        </div>
                    </div>
                    
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="color: #00FF88; margin-bottom: 1rem;">Grade Distribution</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            ${Object.keys(gradeCount).sort().map(grade => `
                                <div style="background: #1A1A1A; padding: 1rem; border-radius: 4px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${grade.startsWith('A') ? '#00FF88' : grade.startsWith('B') ? '#FFB800' : '#FF4444'};">${grade}</div>
                                    <div style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">${gradeCount[grade]} cranes (${((gradeCount[grade] / totalCranes) * 100).toFixed(1)}%)</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="window.print()" style="background: #00FF88; color: #000; padding: 1rem 2rem; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-right: 1rem;">üñ®Ô∏è PRINT REPORT</button>
                        <button onclick="exportResults()" style="background: #FFB800; color: #000; padding: 1rem 2rem; border: none; border-radius: 4px; font-weight: 700; cursor: pointer;">üì• EXPORT TO CSV</button>
                    </div>
                </div>
            `;
            
            // Create a new window for the report
            const reportWindow = window.open('', '_blank', 'width=900,height=700');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
                    <title>Bulk Valuation Report - ${new Date().toLocaleDateString()}</title>
                    <style>
        /* COMPREHENSIVE ANTI-FLICKERING CSS */
        * {
            transition: none !important;
            animation: none !important;
        }
        
        /* Prevent all visual updates that cause flickering */
        .metric-value, .chart-container, .data-card, .live-data, .market-data {
            transition: none !important;
            animation: none !important;
            transform: none !important;
        }
        
        /* Disable hover effects that might cause flickering */
        *:hover {
            transition: none !important;
        }
        
        /* Prevent layout shifts */
        .ticker-card, .metric-item, .dashboard-metric {
            min-height: 1.2em;
            overflow: hidden;
        }
                        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0A0A0A; }
                        @media print {
                            body { background: white; color: black; }
                            button { display: none; }
                        }
                    
/* Sample and Submit Button Styles */
.sample-btn {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    color: #ffffff;
    border: 1px solid #00ff88;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.sample-btn:hover {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    transform: translateY(-2px);
}
.submit-btn {
    background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
    color: #000000;
    border: none;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.submit-btn:hover {
    background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    transform: translateY(-2px);
}
</style>
                </head>
                <body>
    <!-- ============================================ -->
    <!-- AUTHENTICATION CHECK - Restrict to logged-in users -->
    <!-- ============================================ -->


                    ${reportHTML}
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        // API endpoint
        const API_BASE = window.location.origin + '/api';
        
        // Save Notes Function
        async function saveNote() {
            const noteText = document.getElementById('noteText')?.value;
            if (!noteText || !noteText.trim()) {
                alert('Please enter a note before saving');
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content: noteText,
                        timestamp: new Date().toISOString(),
                        category: 'valuation_terminal'
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Note saved successfully!');
                    document.getElementById('noteText').value = '';
                } else {
                    alert('‚ö†Ô∏è  Failed to save note. Please try again.');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('‚ùå Error saving note: ' + error.message);
            }
        }
        
        // Schedule Event Function
        async function scheduleEvent() {
            const eventTitle = document.getElementById('eventTitle')?.value;
            const eventDate = document.getElementById('eventDate')?.value;
            const eventTime = document.getElementById('eventTime')?.value;
            
            if (!eventTitle || !eventDate || !eventTime) {
                alert('Please fill in all event fields');
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: eventTitle,
                        date: eventDate,
                        time: eventTime,
                        timestamp: new Date().toISOString(),
                        source: 'valuation_terminal'
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Event scheduled successfully!');
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventDate').value = '';
                    document.getElementById('eventTime').value = '';
                } else {
                    alert('‚ö†Ô∏è  Failed to schedule event. Please try again.');
                }
            } catch (error) {
                console.error('Error scheduling event:', error);
                alert('‚ùå Error scheduling event: ' + error.message);
            }
        }
        
        // Unit Converter Function
        function performConversion() {
            const value = parseFloat(document.getElementById('converterInput')?.value);
            const conversionType = document.getElementById('converterType')?.value;
            
            if (isNaN(value) || !fromUnit || !toUnit) {
                alert('Please enter a valid value and select units');
                return;
            }
            
            // Conversion logic
            const conversions = {
                'tons_kg': 1000,
                'kg_tons': 0.001,
                'tons_lbs': 2204.62,
                'lbs_tons': 0.000453592,
                'ft_m': 0.3048,
                'm_ft': 3.28084,
                'usd_eur': 0.92,  // Example rate
                'eur_usd': 1.09   // Example rate
            };
            
            const rate = conversions[conversionType];
            
            if (rate && !isNaN(value)) {
                const result = value * rate;
                document.getElementById('converterResult').value = result.toFixed(2);
                console.log(`‚úÖ Converted ${value} to ${result.toFixed(2)} (${conversionType})`);
            } else if (isNaN(value)) {
                alert('‚ö†Ô∏è  Please enter a valid number');
            } else {
                alert('‚ö†Ô∏è  Conversion not supported');
            }
        }
        
        console.log('‚úÖ Backend integration for quick tools loaded');

        // Quick Actions Tools
        function saveNotes() {
            const notes = document.getElementById('notesInput').value;
            if (notes.trim()) {
                localStorage.setItem('valuationNotes', notes);
                alert('Notes saved successfully!');
            }
        }

        function scheduleEvent() {
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDescription').value;
            
            if (date && time && description) {
                alert(`Event scheduled: ${description} on ${date} at ${time}`);
                // Clear form
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventDescription').value = '';
            } else {
                alert('Please fill in all fields');
            }
        }

        function convertUnits() {
            const input = parseFloat(document.getElementById('converterInput').value);
            const type = document.getElementById('converterType').value;
            const result = document.getElementById('converterResult');
            
            if (isNaN(input)) {
                result.value = '';
                return;
            }
            
            let converted;
            switch (type) {
                case 'tons':
                    converted = input * 1000;
                    result.value = converted.toFixed(2) + ' kg';
                    break;
                case 'feet':
                    converted = input * 0.3048;
                    result.value = converted.toFixed(2) + ' m';
                    break;
                case 'pounds':
                    converted = input * 0.453592;
                    result.value = converted.toFixed(2) + ' kg';
                    break;
                case 'gallons':
                    converted = input * 3.78541;
                    result.value = converted.toFixed(2) + ' L';
                    break;
            }
        }

        // Load saved notes on page load
        document.addEventListener('DOMContentLoaded', function() {
        // ============================================================================
        // AUTO-PREFILL FUNCTIONALITY
        // ============================================================================
        
        // Event listener for manufacturer selection
        document.getElementById('manufacturer').addEventListener('change', function() {
            const manufacturer = this.value;
            updateModelOptions(manufacturer);
        });
        
        // Event listener for model selection
        document.getElementById('model').addEventListener('change', function() {
            const manufacturer = document.getElementById('manufacturer').value;
            const model = this.value;
            autofillCraneSpecs(manufacturer, model);
        });
        
        // Update model dropdown based on manufacturer selection
        function updateModelOptions(manufacturer) {
            const modelSelect = document.getElementById('model');
            
            if (!manufacturer || manufacturer === 'Select manufacturer') {
                // Reset to default
                modelSelect.innerHTML = '<option value="">Select model</option>';
                return;
            }
            
            const models = getModelsForManufacturer(manufacturer);
            
            if (models && models.length > 0) {
                // Populate model dropdown
                let options = '<option value="">Select model</option>';
                models.forEach(model => {
                    options += `<option value="${model}">${model}</option>`;
                });
                modelSelect.innerHTML = options;
            } else {
                // No models found, allow manual entry
                modelSelect.innerHTML = '<option value="">Enter model manually</option>';
            }
        }
        
        // Auto-fill crane specifications based on manufacturer and model
        function autofillCraneSpecs(manufacturer, model) {
            if (!manufacturer || !model) {
                return;
            }
            
            const specs = getCraneSpecifications(manufacturer, model);
            
            if (specs) {
                // Fill in the fields (but keep them editable)
                const capacityInput = document.getElementById('capacity');
                const craneTypeSelect = document.getElementById('craneType');
                const boomLengthInput = document.getElementById('boomLength');
                
                // Set capacity
                if (capacityInput && specs.capacity) {
                    capacityInput.value = specs.capacity;
                    // Add visual feedback
                    capacityInput.style.borderColor = '#00FF88';
                    setTimeout(() => { capacityInput.style.borderColor = ''; }, 2000);
                }
                
                // Set crane type
                if (craneTypeSelect && specs.craneType) {
                    craneTypeSelect.value = specs.craneType;
                    craneTypeSelect.style.borderColor = '#00FF88';
                    setTimeout(() => { craneTypeSelect.style.borderColor = ''; }, 2000);
                }
                
                // Set boom length
                if (boomLengthInput && specs.boomLength) {
                    boomLengthInput.value = specs.boomLength;
                    boomLengthInput.style.borderColor = '#00FF88';
                    setTimeout(() => { boomLengthInput.style.borderColor = ''; }, 2000);
                }
                
                // Show notification
                showAutofillNotification(manufacturer, model);
            }
        }
        
        // Show notification that fields were auto-filled
        function showAutofillNotification(manufacturer, model) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #1A1A1A;
                border: 2px solid #00FF88;
                border-radius: 8px;
                padding: 15px 20px;
                color: #FFFFFF;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚úì</span>
                    <div>
                        <div style="font-weight: 600; color: #00FF88;">Auto-filled</div>
                        <div style="font-size: 12px; color: #888; margin-top: 3px;">
                            ${manufacturer} ${model} specifications loaded
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Add CSS animations for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

            const savedNotes = localStorage.getItem('valuationNotes');
            if (savedNotes) {
                document.getElementById('notesInput').value = savedNotes;
            }
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.match(/\.(xlsx|xls|csv)$/)) {
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: files } });
                } else {
                    alert('Please upload a valid Excel or CSV file');
                }
            }
        });
    </script>
    <script src="/js/auto-init-auth.js"></script>
    
    <!-- GPT Chatbot Connector -->
    <script src="/js/chatbot-connector.js"></script>
    <script src="js/api-client.js"></script>
    <script>

// ============================================================================
// GLOBAL FUNCTIONS FOR ONCLICK HANDLERS
console.log('GLOBAL FUNCTIONS BLOCK EXECUTING...');
// ============================================================================

// Direct valuation function for VALUE CRANE button

window.performDirectValuation = async function() {
    // üö® TEMPORARY: Paywall disabled for testing - RE-ENABLE BEFORE PRODUCTION!
    const PAYWALL_DISABLED = true; // Set to false to re-enable paywall
    
    // ========== PAYWALL ACCESS CHECK ==========
    const submitBtn = document.querySelector('button[onclick*="performDirectValuation"]') || 
                      document.querySelector('button[onclick*="performValuation"]') ||
                      document.getElementById('valuateBtn');
    
    if (submitBtn) {
        submitBtn.textContent = PAYWALL_DISABLED ? 'CALCULATING...' : 'CHECKING ACCESS...';
        submitBtn.disabled = true;
    }
    
    if (!PAYWALL_DISABLED) {
    try {
        const accessCheck = await checkPaywallAccess();
        
        if (!accessCheck.has_access) {
            console.log('‚ùå Access denied:', accessCheck.reason);
            if (submitBtn) {
                submitBtn.textContent = submitBtn.dataset.originalText || 'VALUE CRANE';
                submitBtn.disabled = false;
            }
            showPaywallOverlay(accessCheck.subscription_tier, accessCheck.reason);
            return;
        }
        
        console.log('‚úÖ Access granted');
        
        // Track usage
        const manufacturer = document.getElementById('manufacturer')?.value || '';
        const model = document.getElementById('model')?.value || '';
        const capacity = parseFloat(document.getElementById('capacity')?.value || 0);
        
        if (manufacturer && model && capacity) {
            const usageResult = await trackValuationUsage(manufacturer, model, capacity);
            
            if (!usageResult.allowed) {
                console.log('‚ùå Usage limit reached');
                if (submitBtn) {
                    submitBtn.textContent = submitBtn.dataset.originalText || 'VALUE CRANE';
                    submitBtn.disabled = false;
                }
                showPaywallOverlay(accessCheck.subscription_tier, 'limit_reached', usageResult.message);
                return;
            }
        }
        
        if (submitBtn) {
            submitBtn.textContent = 'CALCULATING...';
        }
    } catch (error) {
        console.error('‚ùå Paywall check failed:', error);
        if (submitBtn) {
            submitBtn.textContent = submitBtn.dataset.originalText || 'VALUE CRANE';
            submitBtn.disabled = false;
        }
        // SECURITY: Block access on error - do not allow bypass
        showPaywallOverlay('basic', 'error', 'Unable to verify subscription status. Please try again or contact support.');
        return; // CRITICAL: Stop execution
    }
    } // End of PAYWALL_DISABLED check
    // ========== END PAYWALL CHECK ==========

    console.log('Direct valuation triggered - COMPREHENSIVE VERSION');
    
    // Get form values
    const manufacturer = document.getElementById('manufacturer').value;
    const model = document.getElementById('model').value;
    const year = parseInt(document.getElementById('year').value);
    const capacity = parseFloat(document.getElementById('capacity').value);
    const hours = parseInt(document.getElementById('hours').value);
    const condition = document.getElementById('condition')?.value || 'good';
    const region = document.getElementById('region')?.value || 'North America';
    const boomLength = parseFloat(document.getElementById('boomLength')?.value || 0);
    
    if (!manufacturer || !model || !year || !capacity || !hours) {
        alert('Please fill in all required fields');
        return;
    }
    
    console.log('Performing calculation with:', {manufacturer, model, year, capacity, hours, condition, region});
    
    // ===== COMPREHENSIVE CALCULATION LOGIC =====
    const currentYear = new Date().getFullYear();
    const age = currentYear - year;
    
    // Step 1: Base capacity value
    const baseCapacityValue = capacity * 5000;
    
    // Step 2: Manufacturer premium
    const manufacturerFactors = {
        'liebherr': 0.20,
        'grove': 0.18,
        'tadano': 0.18,
        'terex': 0.15,
        'manitowoc': 0.15,
        'link-belt': 0.12
    };
    const manuLower = manufacturer.toLowerCase();
    let manufacturerFactor = 0.10; // Default
    for (const [key, value] of Object.entries(manufacturerFactors)) {
        if (manuLower.includes(key)) {
            manufacturerFactor = value;
            break;
        }
    }
    const manufacturerPremiumValue = baseCapacityValue * manufacturerFactor;
    
    // Step 3: Model premium (8% of base)
    const modelPremiumValue = baseCapacityValue * 0.08;
    
    // Step 4: Total base value
    const totalBaseValue = baseCapacityValue + manufacturerPremiumValue + modelPremiumValue;
    
    // Step 5: Age adjustment (5% per year)
    const ageDepreciationValue = totalBaseValue * (age * 0.05);
    
    // Step 6: Hours adjustment
    const averageHoursPerYear = 1500;
    const expectedHours = age * averageHoursPerYear;
    const excessHours = hours - expectedHours;
    const hoursAdjustmentValue = excessHours > 0 ? (totalBaseValue * 0.03) : 0;
    
    // Step 7: Regional adjustment
    const regionalFactors = {
        'North America': 1.04,
        'Europe': 1.02,
        'Asia Pacific': 0.98,
        'Middle East': 1.01,
        'Latin America': 0.96,
        'Africa': 0.94
    };
    const regionalMultiplier = regionalFactors[region] || 1.0;
    const regionalAdjustmentValue = totalBaseValue * (regionalMultiplier - 1.0);
    
    // Step 8: Market conditions (current trend: +3%)
    const marketTrend = 0.03;
    const marketConditionsValue = totalBaseValue * marketTrend;
    
    // Step 9: Condition score adjustment
    const conditionFactors = {
        'excellent': 0.05,
        'good': 0.02,
        'fair': -0.02,
        'poor': -0.08
    };
    const conditionFactor = conditionFactors[condition.toLowerCase()] || 0;
    const conditionAdjustmentValue = totalBaseValue * conditionFactor;
    
    // Step 10: Calculate total adjustments
    const totalAdjustments = -ageDepreciationValue - hoursAdjustmentValue + regionalAdjustmentValue + marketConditionsValue + conditionAdjustmentValue;
    
    // Step 11: Final estimated value
    const estimatedValue = Math.round(totalBaseValue + totalAdjustments);
    
    // Step 12: Confidence score (70-95%)
    const confidenceBase = 70;
    const capacityBonus = Math.min(15, capacity / 100);
    const ageBonus = Math.max(0, 10 - age);
    const confidence = Math.min(95, confidenceBase + capacityBonus + ageBonus);
    
    // Step 13: Value range (¬±5%)
    const valueRangeLow = Math.round(estimatedValue * 0.95);
    const valueRangeHigh = Math.round(estimatedValue * 1.05);
    
    // Step 14: Deal recommendation
    let dealRecommendation = 'Hold';
    if (confidence > 85 && age < 5) {
        dealRecommendation = 'Strong Buy';
    } else if (confidence > 75 && age < 8) {
        dealRecommendation = 'Buy';
    } else if (age > 15 || confidence < 65) {
        dealRecommendation = 'Caution';
    }
    
    console.log('Calculation complete:', {
        baseCapacityValue,
        manufacturerPremiumValue,
        modelPremiumValue,
        totalBaseValue,
        ageDepreciationValue,
        hoursAdjustmentValue,
        regionalAdjustmentValue,
        marketConditionsValue,
        conditionAdjustmentValue,
        totalAdjustments,
        estimatedValue,
        confidence
    });
    
    // ===== UPDATE ALL DISPLAY ELEMENTS =====
    
    // Top tile - Estimated Value
    const estimatedValueEl = document.getElementById('estimatedValue');
    if (estimatedValueEl) {
        estimatedValueEl.textContent = '$' + (estimatedValue / 1000000).toFixed(2) + 'M';
    }
    
    // Top tile - Confidence Score
    const confidenceScoreEl = document.getElementById('confidenceScore');
    if (confidenceScoreEl) {
        confidenceScoreEl.textContent = Math.round(confidence) + '%';
    }


    // ===== TOP TILE - ADDITIONAL ELEMENTS =====
    
    // Deal Grade
    let dealGrade = 'C';
    if (confidence > 90 && age < 3) {
        dealGrade = 'A+';
    } else if (confidence > 85 && age < 5) {
        dealGrade = 'A';
    } else if (confidence > 80 && age < 8) {
        dealGrade = 'B+';
    } else if (confidence > 75) {
        dealGrade = 'B';
    } else if (confidence > 70) {
        dealGrade = 'C+';
    }
    
    const dealGradeEl = document.getElementById('dealGrade');
    if (dealGradeEl) {
        dealGradeEl.textContent = dealGrade;
    }
    
    const dealRecommendationEl = document.getElementById('dealRecommendation');
    if (dealRecommendationEl) {
        dealRecommendationEl.textContent = dealRecommendation;
    }
    
    // Confidence Level
    let confidenceLevel = 'Moderate';
    if (confidence > 90) {
        confidenceLevel = 'Very High';
    } else if (confidence > 85) {
        confidenceLevel = 'High';
    } else if (confidence > 75) {
        confidenceLevel = 'Good';
    } else if (confidence < 70) {
        confidenceLevel = 'Low';
    }
    
    const confidenceLevelEl = document.getElementById('confidenceLevel');
    if (confidenceLevelEl) {
        confidenceLevelEl.textContent = confidenceLevel;
    }
    
    // Value Difference (compared to average market value)
    const averageMarketValue = capacity * 5500; // Slightly higher than base
    const valueDiff = estimatedValue - averageMarketValue;
    const valueDiffPercent = ((valueDiff / averageMarketValue) * 100).toFixed(1);
    
    const valueDifferenceEl = document.getElementById('valueDifference');
    if (valueDifferenceEl) {
        const sign = valueDiff >= 0 ? '+' : '';
        valueDifferenceEl.textContent = sign + valueDiffPercent + '% vs market avg';
        valueDifferenceEl.style.color = valueDiff >= 0 ? '#00FF88' : '#FF6B6B';
    }

    
    // ===== BOTTOM METRICS =====
    
    // Age Factor
    const ageFactor = Math.max(0, 1 - (age * 0.05));
    const ageFactorEl = document.getElementById('ageFactorValue');
    if (ageFactorEl) {
        ageFactorEl.textContent = (ageFactor * 100).toFixed(0) + '%';
    }
    
    // Condition
    const conditionScore = {
        'excellent': 95,
        'good': 85,
        'fair': 70,
        'poor': 50
    }[condition.toLowerCase()] || 75;
    const conditionValueEl = document.getElementById('conditionValue');
    if (conditionValueEl) {
        conditionValueEl.textContent = conditionScore + '/100';
    }
    
    // Market Demand
    const marketDemand = regionalMultiplier > 1.0 ? 'High' : regionalMultiplier === 1.0 ? 'Medium' : 'Low';
    const marketDemandEl = document.getElementById('marketDemandValue');
    if (marketDemandEl) {
        marketDemandEl.textContent = marketDemand;
    }
    
    // Risk Score
    const riskScore = Math.max(1, Math.min(10, Math.round((age / 2) + (hours / 10000) - (confidence / 10))));
    const riskScoreEl = document.getElementById('riskScoreValue');
    if (riskScoreEl) {
        riskScoreEl.textContent = riskScore + '/10';
    }
    
    // ===== FINANCIAL TAB - BASE VALUE CALCULATION =====
    
    // Capacity Base Price
    const capacityBasePriceEl = document.getElementById('capacityBasePrice');
    if (capacityBasePriceEl) {
        capacityBasePriceEl.textContent = '$' + baseCapacityValue.toLocaleString();
    }
    
    const capacityCalculationEl = document.getElementById('capacityCalculation');
    if (capacityCalculationEl) {
        capacityCalculationEl.textContent = capacity + ' tons √ó $5,000/ton base rate';
    }
    
    // Manufacturer Premium
    const manufacturerPremiumEl = document.getElementById('manufacturerPremium');
    if (manufacturerPremiumEl) {
        manufacturerPremiumEl.textContent = '+$' + manufacturerPremiumValue.toLocaleString();
    }
    
    const manufacturerPremiumDescEl = document.getElementById('manufacturerPremiumDesc');
    if (manufacturerPremiumDescEl) {
        manufacturerPremiumDescEl.textContent = manufacturer + ' premium factor: ' + (manufacturerFactor * 100).toFixed(0) + '%';
    }
    
    // Model Premium
    const modelPremiumEl = document.getElementById('modelPremium');
    if (modelPremiumEl) {
        modelPremiumEl.textContent = '+$' + modelPremiumValue.toLocaleString();
    }
    
    const modelPremiumDescEl = document.getElementById('modelPremiumDesc');
    if (modelPremiumDescEl) {
        modelPremiumDescEl.textContent = model + ' model premium: 8%';
    }
    
    // Subtotal Base Value
    const breakdownSubtotalBaseValueEl = document.getElementById('breakdownSubtotalBaseValue');
    if (breakdownSubtotalBaseValueEl) {
        breakdownSubtotalBaseValueEl.textContent = '$' + totalBaseValue.toLocaleString();
    }
    
    // ===== FINANCIAL TAB - ADJUSTMENTS =====
    
    // Age Depreciation
    const ageDepreciationEl = document.getElementById('ageDepreciation');
    if (ageDepreciationEl) {
        ageDepreciationEl.textContent = '-$' + ageDepreciationValue.toLocaleString();
    }
    
    const ageDepreciationDescEl = document.getElementById('ageDepreciationDesc');
    if (ageDepreciationDescEl) {
        ageDepreciationDescEl.textContent = year + ' model (' + age + ' years old) @ 5% per year';
    }
    
    // Operating Hours Adjustment
    const operatingHoursAdjEl = document.getElementById('operatingHoursAdj');
    if (operatingHoursAdjEl) {
        operatingHoursAdjEl.textContent = '-$' + hoursAdjustmentValue.toLocaleString();
    }
    
    const operatingHoursDescEl = document.getElementById('operatingHoursDesc');
    if (operatingHoursDescEl) {
        const hoursStatus = excessHours > 0 ? 'above average' : 'below average';
        operatingHoursDescEl.textContent = hours.toLocaleString() + ' hours (' + hoursStatus + ') @ -3%';
    }
    
    // Regional Factor
    const regionalFactorEl = document.getElementById('regionalFactor');
    if (regionalFactorEl) {
        const sign = regionalAdjustmentValue >= 0 ? '+' : '';
        regionalFactorEl.textContent = sign + '$' + Math.abs(regionalAdjustmentValue).toLocaleString();
    }
    
    const regionalFactorDescEl = document.getElementById('regionalFactorDesc');
    if (regionalFactorDescEl) {
        const regionalPercent = ((regionalMultiplier - 1.0) * 100).toFixed(0);
        const sign = regionalPercent >= 0 ? '+' : '';
        regionalFactorDescEl.textContent = region + ' premium: ' + sign + regionalPercent + '%';
    }
    
    // Market Conditions
    const marketConditionsEl = document.getElementById('marketConditions');
    if (marketConditionsEl) {
        marketConditionsEl.textContent = '+$' + marketConditionsValue.toLocaleString();
    }
    
    const marketConditionsDescEl = document.getElementById('marketConditionsDesc');
    if (marketConditionsDescEl) {
        marketConditionsDescEl.textContent = 'Current market trend: Strong (+3%)';
    }
    
    // Condition Score Adjustment
    const conditionScoreAdjEl = document.getElementById('conditionScoreAdj');
    if (conditionScoreAdjEl) {
        const sign = conditionAdjustmentValue >= 0 ? '+' : '';
        conditionScoreAdjEl.textContent = sign + '$' + Math.abs(conditionAdjustmentValue).toLocaleString();
    }
    
    const conditionScoreDescEl = document.getElementById('conditionScoreDesc');
    if (conditionScoreDescEl) {
        const conditionPercent = (conditionFactor * 100).toFixed(0);
        const sign = conditionPercent >= 0 ? '+' : '';
        conditionScoreDescEl.textContent = condition.charAt(0).toUpperCase() + condition.slice(1) + ' condition (' + conditionScore + '/100) @ ' + sign + conditionPercent + '%';
    }
    
    // Total Adjustments
    const breakdownTotalAdjustmentsEl = document.getElementById('breakdownTotalAdjustments');
    if (breakdownTotalAdjustmentsEl) {
        const sign = totalAdjustments >= 0 ? '+' : '';
        breakdownTotalAdjustmentsEl.textContent = sign + '$' + Math.abs(totalAdjustments).toLocaleString();
    }
    
    // ===== FINANCIAL TAB - FINAL SUMMARY =====
    
    const finalSummaryBaseValueEl = document.getElementById('finalSummaryBaseValue');
    if (finalSummaryBaseValueEl) {
        finalSummaryBaseValueEl.textContent = '$' + totalBaseValue.toLocaleString();
    }
    
    const finalSummaryTotalAdjustmentsEl = document.getElementById('finalSummaryTotalAdjustments');
    if (finalSummaryTotalAdjustmentsEl) {
        const sign = totalAdjustments >= 0 ? '+' : '';
        finalSummaryTotalAdjustmentsEl.textContent = sign + '$' + Math.abs(totalAdjustments).toLocaleString();
    }
    
    const finalSummaryEstimatedValueEl = document.getElementById('finalSummaryEstimatedValue');
    if (finalSummaryEstimatedValueEl) {
        finalSummaryEstimatedValueEl.textContent = '$' + estimatedValue.toLocaleString();
    }
    
    const finalSummaryConfidenceScoreEl = document.getElementById('finalSummaryConfidenceScore');
    if (finalSummaryConfidenceScoreEl) {
        finalSummaryConfidenceScoreEl.textContent = Math.round(confidence) + '%';
    }
    
    const finalSummaryValueRangeEl = document.getElementById('finalSummaryValueRange');
    if (finalSummaryValueRangeEl) {
        finalSummaryValueRangeEl.textContent = '$' + (valueRangeLow / 1000000).toFixed(2) + 'M - $' + (valueRangeHigh / 1000000).toFixed(2) + 'M';
    }
    
    const finalSummaryDealRecommendationEl = document.getElementById('finalSummaryDealRecommendation');
    if (finalSummaryDealRecommendationEl) {
        finalSummaryDealRecommendationEl.textContent = dealRecommendation;
    }
    
    // ===== RENTAL VS PURCHASE CALCULATIONS =====
    
    // Calculate rental rates based on estimated value
    const monthlyBareRental = Math.round((estimatedValue * 0.015) / 100) * 100; // 1.5% of value per month
    const monthlyOperatedRental = Math.round((estimatedValue * 0.025) / 100) * 100; // 2.5% of value per month
    const dailyBareRental = Math.round(monthlyBareRental / 22);
    const dailyOperatedRental = Math.round(monthlyOperatedRental / 22);
    
    // Update rental rates
    const bareRentalMonthlyEl = document.getElementById('bareRentalMonthly');
    if (bareRentalMonthlyEl) {
        bareRentalMonthlyEl.textContent = '$' + monthlyBareRental.toLocaleString();
    }
    
    const bareRentalDailyEl = document.getElementById('bareRentalDaily');
    if (bareRentalDailyEl) {
        bareRentalDailyEl.textContent = '$' + dailyBareRental.toLocaleString();
    }
    
    const operatedRentalMonthlyEl = document.getElementById('operatedRentalMonthly');
    if (operatedRentalMonthlyEl) {
        operatedRentalMonthlyEl.textContent = '$' + monthlyOperatedRental.toLocaleString();
    }
    
    const operatedRentalDailyEl = document.getElementById('operatedRentalDaily');
    if (operatedRentalDailyEl) {
        operatedRentalDailyEl.textContent = '$' + dailyOperatedRental.toLocaleString();
    }
    
    // Calculate break-even analysis
    const purchaseCost = estimatedValue;
    const maintenancePerMonth = Math.round(capacity * 50); // $50 per ton per month
    const insurancePerMonth = Math.round(estimatedValue * 0.0005); // 0.05% per month
    const storagePerMonth = 500; // Fixed storage cost
    const totalMonthlyOwnership = maintenancePerMonth + insurancePerMonth + storagePerMonth;
    
    const breakEvenMonths = Math.round(purchaseCost / (monthlyBareRental - totalMonthlyOwnership));
    
    const breakEvenEl = document.getElementById('breakEvenMonths');
    if (breakEvenEl) {
        breakEvenEl.textContent = breakEvenMonths + ' months';
    }
    
    const totalOwnershipCostEl = document.getElementById('totalOwnershipCost');
    if (totalOwnershipCostEl) {
        totalOwnershipCostEl.textContent = '$' + totalMonthlyOwnership.toLocaleString() + '/mo';
    }
    

    // ===== RENTAL SECTION - ADDITIONAL DISPLAYS =====
    
    // Update bare rental displays
    const bareMonthlyDisplayEl = document.getElementById('bareMonthlyDisplay');
    if (bareMonthlyDisplayEl) {
        bareMonthlyDisplayEl.textContent = '$' + monthlyBareRental.toLocaleString();
    }
    
    const bareAnnualDisplayEl = document.getElementById('bareAnnualDisplay');
    if (bareAnnualDisplayEl) {
        const annualBare = monthlyBareRental * 12;
        bareAnnualDisplayEl.textContent = '$' + annualBare.toLocaleString() + '/year';
    }
    
    // Update operated rental displays
    const operatedMonthlyDisplayEl = document.getElementById('operatedMonthlyDisplay');
    if (operatedMonthlyDisplayEl) {
        operatedMonthlyDisplayEl.textContent = '$' + monthlyOperatedRental.toLocaleString();
    }
    
    const operatedAnnualDisplayEl = document.getElementById('operatedAnnualDisplay');
    if (operatedAnnualDisplayEl) {
        const annualOperated = monthlyOperatedRental * 12;
        operatedAnnualDisplayEl.textContent = '$' + annualOperated.toLocaleString() + '/year';
    }
    
    // Update utilization scenarios
    const utilizationScenariosDisplayEl = document.getElementById('utilizationScenariosDisplay');
    if (utilizationScenariosDisplayEl) {
        const scenarios = [
            { util: 50, rate: monthlyBareRental / 0.5 },
            { util: 70, rate: monthlyBareRental / 0.7 },
            { util: 85, rate: monthlyBareRental / 0.85 },
            { util: 95, rate: monthlyBareRental / 0.95 }
        ];
        
        utilizationScenariosDisplayEl.innerHTML = scenarios.map(s => `
            <div>
                <div style="color: #888;">${s.util}% Util</div>
                <div style="color: #FFF; font-weight: 600;">$${Math.round(s.rate).toLocaleString()}/mo</div>
            </div>
        `).join('');
    }
    
    // Populate 5-year cost comparison table
    const rentalVsPurchaseBodyEl = document.getElementById('rentalVsPurchaseBody');
    if (rentalVsPurchaseBodyEl) {
        const fiveYearRentalBare = monthlyBareRental * 12 * 5;
        const fiveYearRentalOperated = monthlyOperatedRental * 12 * 5;
        
        const maintenanceCost = estimatedValue * 0.03 * 5; // 3% per year
        const insuranceCost = estimatedValue * 0.015 * 5; // 1.5% per year
        const storageCost = 12000 * 5; // $12K per year
        const fiveYearOperating = maintenanceCost + insuranceCost + storageCost;
        const fiveYearPurchase = purchaseCost + fiveYearOperating;
        
        const depreciation = estimatedValue * 0.25; // 25% over 5 years
        const netPurchaseCost = fiveYearPurchase - (estimatedValue - depreciation);
        
        rentalVsPurchaseBodyEl.innerHTML = `
            <tr>
                <td><strong>Purchase</strong></td>
                <td style="color: #FF6B6B;">$${purchaseCost.toLocaleString()}</td>
                <td>$${Math.round(fiveYearOperating).toLocaleString()}</td>
                <td style="color: #FFB800; font-weight: 600;">$${Math.round(fiveYearPurchase).toLocaleString()}</td>
                <td><span style="background: ${netPurchaseCost < fiveYearRentalBare ? '#00FF88' : '#FFB800'}; color: #000; padding: 4px 12px; border-radius: 4px; font-weight: 600;">${netPurchaseCost < fiveYearRentalBare ? 'Buy' : 'Consider'}</span></td>
            </tr>
            <tr>
                <td><strong>Bare Rental</strong></td>
                <td style="color: #00FF88;">$0</td>
                <td>$${fiveYearRentalBare.toLocaleString()}</td>
                <td style="color: #FFB800; font-weight: 600;">$${fiveYearRentalBare.toLocaleString()}</td>
                <td><span style="background: ${fiveYearRentalBare < netPurchaseCost ? '#00FF88' : '#FFB800'}; color: #000; padding: 4px 12px; border-radius: 4px; font-weight: 600;">${fiveYearRentalBare < netPurchaseCost ? 'Rent' : 'Consider'}</span></td>
            </tr>
            <tr>
                <td><strong>Operated Rental</strong></td>
                <td style="color: #00FF88;">$0</td>
                <td>$${fiveYearRentalOperated.toLocaleString()}</td>
                <td style="color: #FFB800; font-weight: 600;">$${fiveYearRentalOperated.toLocaleString()}</td>
                <td><span style="background: #FF6B6B; color: #FFF; padding: 4px 12px; border-radius: 4px; font-weight: 600;">Expensive</span></td>
            </tr>
            <tr style="border-top: 2px solid #00FF88;">
                <td colspan="4"><strong>Break-Even Point (Purchase vs Bare Rental)</strong></td>
                <td style="color: #00FF88; font-weight: 600;">${breakEvenMonths} months</td>
            </tr>
        `;
    }
    
    // Update rental comparison chart
    updateRentalComparisonChart(monthlyBareRental, monthlyOperatedRental, totalMonthlyOwnership);


    // ===== UPDATE COMPARABLES TABLE =====
    console.log('üîç Updating comparables table...');
    const craneType = document.getElementById('craneType')?.value || 'All-Terrain Crane';
    console.log('üìä Calling getRelevantComparables with:', craneType, capacity);
    const comparables = getRelevantComparables(craneType, capacity);
    console.log('‚úÖ Got comparables:', comparables.length);
    
    const comparablesTableBody = document.getElementById('comparablesTableBody');
    if (comparablesTableBody) {
        comparablesTableBody.innerHTML = '';
        
        if (comparables && comparables.length > 0) {
            console.log('üìù Populating', comparables.length, 'comparables into table');
            comparables.forEach(comp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${comp.equipment}</td>
                    <td>${craneType}</td>
                    <td>${comp.year}</td>
                    <td>${comp.capacity}T</td>
                    <td>${comp.hours.toLocaleString()}</td>
                    <td>$${comp.price.toLocaleString()}</td>
                    <td>$${Math.round(comp.price / comp.capacity).toLocaleString()}</td>
                    <td style="color: ${comp.trend.startsWith('+') ? '#00FF88' : '#FF4444'};">${comp.trend}</td>
                    <td>${comp.location}</td>
                `;
                comparablesTableBody.appendChild(row);
            });
            console.log('‚úÖ Comparables table populated');
        } else {
            console.log('‚ö†Ô∏è  No comparables found');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="9" style="text-align: center; color: #888;">
                    No comparable sales data available for this crane class and capacity range.
                </td>
            `;
            comparablesTableBody.appendChild(row);
        }
    } else {
        console.error('‚ùå comparablesTableBody element not found');
    }

    // Show results section
    const resultsSection = document.getElementById('valuationResults');
    if (resultsSection) {
        resultsSection.classList.add('show');
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    console.log('All sections updated successfully');
};


// Tab switching function
window.switchTab = function(tab, element) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    }
    
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    const tabElement = document.getElementById(tab + 'Tab');
    if (tabElement) {
        tabElement.classList.add('active');
    }
};

// Download CSV template
window.downloadTemplate = function() {
    const csvContent = "Manufacturer,Model,Year,Capacity (Tons),Operating Hours,Mileage,Crane Type,Boom Length (meters),Region,Jib Included,Jib Length (ft),Asking Price\nLiebherr,LTM 1500-8.1,2020,500,5000,25000,All-Terrain Crane,275,North America,No,0,3500000\nGrove,GMK6400,2019,400,6000,30000,All-Terrain Crane,197,Europe,Yes - Standard Jib,100,2800000\nTadano,ATF 220G-5,2021,220,3000,15000,All-Terrain Crane,197,Asia Pacific,No,0,1500000";
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'crane_valuation_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    console.log('Template downloaded');
};

// Process bulk CSV file
window.processBulkFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Processing:', file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const results = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const values = line.split(',');
            if (values.length < 11) continue;
            
            const year = parseInt(values[2]);
            const capacity = parseFloat(values[3]);
            const hours = parseInt(values[4]);
            
            const baseValue = capacity * 10000;
            const age = 2025 - year;
            const ageDepr = Math.max(0, 1 - (age * 0.08));
            const hoursDepr = Math.max(0, 1 - (hours / 100000));
            const estValue = Math.round(baseValue * ageDepr * hoursDepr);
            const conf = Math.min(95, 70 + (capacity / 100));
            
            results.push({
                crane: values[0] + ' ' + values[1],
                year: year,
                capacity: capacity,
                hours: hours,
                region: values[8],
                estimatedValue: estValue,
                confidence: Math.round(conf),
                grade: estValue > 2000000 ? 'A' : estValue > 1000000 ? 'B' : 'C'
            });
        }
        
        displayBulkResults(results);
    };
    
    reader.readAsText(file);
};

window.exportResults = function() {
    alert('Export functionality will be implemented');
};

window.generateReport = function() {
    alert('Report generation will be implemented');
};

// ============================================================================
// END OF GLOBAL FUNCTIONS
// ============================================================================

    // ============================================================================
    // CRANE SPECIFICATIONS DATABASE - AUTO-PREFILL
    // ============================================================================
    // Comprehensive Crane Specifications Database
// Auto-prefill data for manufacturer and model combinations


function updateManufacturerCounts() {
    const manufacturerSelect = document.getElementById("manufacturer");
    console.log("üîç updateManufacturerCounts called, select element:", manufacturerSelect);
    if (!manufacturerSelect) {
        console.warn("‚ö†Ô∏è  Manufacturer select element not found");
        return;
    }
    
    let updated = 0;
    Array.from(manufacturerSelect.options).forEach(option => {
        if (option.value && window.manufacturerModels[option.value]) {
            const count = window.manufacturerModels[option.value].length;
            option.textContent = option.value + " (" + count + " models)";
            updated++;
        }
    });
    console.log(`‚úÖ Updated ${updated} manufacturer options with model counts`);
}


// Function to get crane specifications
function getCraneSpecifications(manufacturer, model) {
    if (!manufacturer || !model) {
        return null;
    }
    
    // Try exact match first
    if (craneDatabase[manufacturer] && craneDatabase[manufacturer][model]) {
        return craneDatabase[manufacturer][model];
    }
    
    // Try case-insensitive match
    for (const [mfr, models] of Object.entries(window.manufacturerModels)) {
        if (mfr.toLowerCase() === manufacturer.toLowerCase()) {
            for (const [mdl, specs] of Object.entries(models)) {
                if (mdl.toLowerCase() === model.toLowerCase()) {
                    return specs;
                }
            }
        }
    }
    
    return null;
}

// Function to get all models for a manufacturer
function getModelsForManufacturer(manufacturer) {
    if (!manufacturer) {
        return [];
    }
    
    // Use crane database instead of hardcoded manufacturerModels
    if (window.craneDatabase && window.craneDatabase[manufacturer]) {
        return window.craneDatabase[manufacturer].map(crane => crane.model);
    }
    
    // Try case-insensitive match
    if (window.craneDatabase) {
        for (const [mfr, cranes] of Object.entries(window.craneDatabase)) {
            if (mfr.toLowerCase() === manufacturer.toLowerCase()) {
                return cranes.map(crane => crane.model);
            }
        }
    }
    
    // Fallback to old manufacturerModels if database not available
    if (window.manufacturerModels && window.manufacturerModels[manufacturer]) {
        return window.manufacturerModels[manufacturer];
    }
    
    // Try case-insensitive match on fallback
    if (window.manufacturerModels) {
        for (const [mfr, models] of Object.entries(window.manufacturerModels)) {
            if (mfr.toLowerCase() === manufacturer.toLowerCase()) {
                return models;
            }
        }
    }
    
    return [];
}

// Export for use in HTML
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { craneDatabase, getCraneSpecifications, getModelsForManufacturer };
}


    </script>
    

<script>

// Inline crane database for immediate availability
window.manufacturerModels = {};
window.craneDatabase = {};

window.manufacturerModels['Liebherr'] = ["LTM 1025", "LTM 1030-2.1", "LTM 1040-2.1", "LTM 1050-3.1", "LTM 1060-3.1", "LTM 1070-4.2", "LTM 1080-2", "LTM 1090-4.2", "LTM 1100-5.2", "LTM 1110-5.1", "LTM 1120-4.1", "LTM 1130-5.1", "LTM 1160-5.2", "LTM 1200-5.1", "LTM 1220-5.2", "LTM 1230-5.1", "LTM 1250-6.1", "LTM 1300-6.2", "LTM 1350-6.1", "LTM 1400-7.1", "LTM 1450-8.1", "LTM 1500-8.1", "LTM 1650-8.1", "LTM 1750-9.1", "LTM 11200-9.1", "LTC 1045-3.1", "LTC 1050-3.1", "LRT 1090-2.1", "LRT 1100-2.1", "LTR 1040", "LTR 1060", "LTR 1100", "LTR 1220", "LR 1100", "LR 1160", "LR 1200", "LR 1250", "LR 1280", "LR 1300.1 SX", "LR 1350/1", "LR 1400/2", "LR 1500", "LR 1600/2", "LR 1700-1.0", "LR 1750/2", "LR 1800-1.0", "LR 11350", "LR 13000", "LG 1750"];
window.craneDatabase['Liebherr'] = [{"model": "LTM 1025", "capacity": 25, "type": "All-Terrain Crane", "boomLength": 30}, {"model": "LTM 1030-2.1", "capacity": 30, "type": "All-Terrain Crane", "boomLength": 35}, {"model": "LTM 1040-2.1", "capacity": 40, "type": "All-Terrain Crane", "boomLength": 35}, {"model": "LTM 1050-3.1", "capacity": 50, "type": "All-Terrain Crane", "boomLength": 40}, {"model": "LTM 1060-3.1", "capacity": 60, "type": "All-Terrain Crane", "boomLength": 48}, {"model": "LTM 1070-4.2", "capacity": 70, "type": "All-Terrain Crane", "boomLength": 50}, {"model": "LTM 1080-2", "capacity": 80, "type": "All-Terrain Crane", "boomLength": 50}, {"model": "LTM 1090-4.2", "capacity": 90, "type": "All-Terrain Crane", "boomLength": 52}, {"model": "LTM 1100-5.2", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 52}, {"model": "LTM 1110-5.1", "capacity": 110, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1120-4.1", "capacity": 120, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1130-5.1", "capacity": 130, "type": "All-Terrain Crane", "boomLength": 60}, {"model": "LTM 1160-5.2", "capacity": 160, "type": "All-Terrain Crane", "boomLength": 62}, {"model": "LTM 1200-5.1", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 72}, {"model": "LTM 1220-5.2", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1230-5.1", "capacity": 230, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1250-6.1", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 72}, {"model": "LTM 1300-6.2", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 78}, {"model": "LTM 1350-6.1", "capacity": 350, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1400-7.1", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1450-8.1", "capacity": 450, "type": "All-Terrain Crane", "boomLength": 85}, {"model": "LTM 1500-8.1", "capacity": 500, "type": "All-Terrain Crane", "boomLength": 84}, {"model": "LTM 1650-8.1", "capacity": 650, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTM 1750-9.1", "capacity": 750, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTM 11200-9.1", "capacity": 1200, "type": "All-Terrain Crane", "boomLength": 100}, {"model": "LTC 1045-3.1", "capacity": 45, "type": "City Crane", "boomLength": 36}, {"model": "LTC 1050-3.1", "capacity": 50, "type": "City Crane", "boomLength": 30}, {"model": "LRT 1090-2.1", "capacity": 90, "type": "Rough Terrain Crane", "boomLength": 50}, {"model": "LRT 1100-2.1", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 52}, {"model": "LTR 1040", "capacity": 40, "type": "Telescopic Crawler Crane", "boomLength": 40}, {"model": "LTR 1060", "capacity": 60, "type": "Telescopic Crawler Crane", "boomLength": 48}, {"model": "LTR 1100", "capacity": 100, "type": "Telescopic Crawler Crane", "boomLength": 52}, {"model": "LTR 1220", "capacity": 220, "type": "Telescopic Crawler Crane", "boomLength": 60}, {"model": "LR 1100", "capacity": 100, "type": "Crawler Crane", "boomLength": 78}, {"model": "LR 1160", "capacity": 160, "type": "Crawler Crane", "boomLength": 81}, {"model": "LR 1200", "capacity": 200, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1250", "capacity": 250, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1280", "capacity": 280, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1300.1 SX", "capacity": 300, "type": "Crawler Crane", "boomLength": 102}, {"model": "LR 1350/1", "capacity": 350, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1400/2", "capacity": 400, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1500", "capacity": 500, "type": "Crawler Crane", "boomLength": 126}, {"model": "LR 1600/2", "capacity": 600, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1700-1.0", "capacity": 700, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1750/2", "capacity": 750, "type": "Crawler Crane", "boomLength": 147}, {"model": "LR 1800-1.0", "capacity": 800, "type": "Crawler Crane", "boomLength": 168}, {"model": "LR 11350", "capacity": 1350, "type": "Crawler Crane", "boomLength": 198}, {"model": "LR 13000", "capacity": 3000, "type": "Crawler Crane", "boomLength": 246}, {"model": "LG 1750", "capacity": 750, "type": "Gantry Crane", "boomLength": 120}];

window.manufacturerModels['Tadano'] = ["GR-550XL", "GR-1000XLL", "TR-250M", "AR-2000M", "GR-750XL", "ATF 110G-5", "TR-500XL", "GR-1600XL", "GR-300EX", "ATF 400G-6", "TR-800M", "GR-1000XL", "AR-5500M", "GR-350XL", "GR-500EX", "ATF 200G-5", "GR-700EX", "TR-600XL", "GR-750EX", "ATF 180G-5", "TR-100M", "GR-1450EX", "ATF 90G-4", "GR-150XL", "TR-350M", "ATF 70G-4", "GR-900XL", "ATF 220G-5", "TR-600M", "GR-1200XL", "ATF 150G-5", "GR-600XL", "TR-80M", "ATF 60G-3", "GR-1300XL", "TR-350XL", "GR-800EX", "AR-5000M", "GR-250N", "ATF 130G-5", "GR-800XL", "TR-300M", "GR-200EX", "ATF 100G-4", "GR-700XL", "TR-550M", "GR-100EX", "GR-600EX", "TR-300XL", "GR-200XL"];
window.craneDatabase['Tadano'] = [{"model": "GR-550XL", "capacity": 55, "type": "Rough Terrain Crane", "boomLength": 113}, {"model": "GR-1000XLL", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 167}, {"model": "TR-250M", "capacity": 25, "type": "Truck-Mounted Crane", "boomLength": 98}, {"model": "AR-2000M", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "GR-750XL", "capacity": 75, "type": "Rough Terrain Crane", "boomLength": 141}, {"model": "ATF 110G-5", "capacity": 120, "type": "All-Terrain Crane", "boomLength": 171}, {"model": "TR-500XL", "capacity": 50, "type": "Truck-Mounted Crane", "boomLength": 138}, {"model": "GR-1600XL", "capacity": 160, "type": "Rough Terrain Crane", "boomLength": 200}, {"model": "GR-300EX", "capacity": 30, "type": "Rough Terrain Crane", "boomLength": 102}, {"model": "ATF 400G-6", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "TR-800M", "capacity": 80, "type": "Truck-Mounted Crane", "boomLength": 145}, {"model": "GR-1000XL", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 154}, {"model": "AR-5500M", "capacity": 550, "type": "All-Terrain Crane", "boomLength": 275}, {"model": "GR-350XL", "capacity": 35, "type": "Rough Terrain Crane", "boomLength": 101}, {"model": "GR-500EX", "capacity": 50, "type": "Rough Terrain Crane", "boomLength": 141}, {"model": "ATF 200G-5", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "GR-700EX", "capacity": 70, "type": "Rough Terrain Crane", "boomLength": 147}, {"model": "TR-600XL", "capacity": 60, "type": "Truck-Mounted Crane", "boomLength": 150}, {"model": "GR-750EX", "capacity": 75, "type": "Rough Terrain Crane", "boomLength": 147}, {"model": "ATF 180G-5", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "TR-100M", "capacity": 10, "type": "Truck-Mounted Crane", "boomLength": 65}, {"model": "GR-1450EX", "capacity": 145, "type": "Rough Terrain Crane", "boomLength": 200}, {"model": "ATF 90G-4", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 154}, {"model": "GR-150XL", "capacity": 15, "type": "Rough Terrain Crane", "boomLength": 79}, {"model": "TR-350M", "capacity": 35, "type": "Truck-Mounted Crane", "boomLength": 110}, {"model": "ATF 70G-4", "capacity": 75, "type": "All-Terrain Crane", "boomLength": 164}, {"model": "GR-900XL", "capacity": 90, "type": "Rough Terrain Crane", "boomLength": 154}, {"model": "ATF 220G-5", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 223}, {"model": "TR-600M", "capacity": 60, "type": "Truck-Mounted Crane", "boomLength": 141}, {"model": "GR-1200XL", "capacity": 120, "type": "Rough Terrain Crane", "boomLength": 184}, {"model": "ATF 150G-5", "capacity": 165, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "GR-600XL", "capacity": 60, "type": "Rough Terrain Crane", "boomLength": 138}, {"model": "TR-80M", "capacity": 8, "type": "Truck-Mounted Crane", "boomLength": 62}, {"model": "ATF 60G-3", "capacity": 70, "type": "All-Terrain Crane", "boomLength": 142}, {"model": "GR-1300XL", "capacity": 130, "type": "Rough Terrain Crane", "boomLength": 184}, {"model": "TR-350XL", "capacity": 35, "type": "Truck-Mounted Crane", "boomLength": 110}, {"model": "GR-800EX", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 144}, {"model": "AR-5000M", "capacity": 500, "type": "All-Terrain Crane", "boomLength": 260}, {"model": "GR-250N", "capacity": 25, "type": "Rough Terrain Crane", "boomLength": 95}, {"model": "ATF 130G-5", "capacity": 150, "type": "All-Terrain Crane", "boomLength": 197}, {"model": "GR-800XL", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 154}, {"model": "TR-300M", "capacity": 30, "type": "Truck-Mounted Crane", "boomLength": 105}, {"model": "GR-200EX", "capacity": 20, "type": "Rough Terrain Crane", "boomLength": 82}, {"model": "ATF 100G-4", "capacity": 110, "type": "All-Terrain Crane", "boomLength": 164}, {"model": "GR-700XL", "capacity": 70, "type": "Rough Terrain Crane", "boomLength": 147}, {"model": "TR-550M", "capacity": 55, "type": "Truck-Mounted Crane", "boomLength": 130}, {"model": "GR-100EX", "capacity": 10, "type": "Rough Terrain Crane", "boomLength": 72}, {"model": "GR-600EX", "capacity": 60, "type": "Rough Terrain Crane", "boomLength": 141}, {"model": "TR-300XL", "capacity": 30, "type": "Truck-Mounted Crane", "boomLength": 105}, {"model": "GR-200XL", "capacity": 20, "type": "Rough Terrain Crane", "boomLength": 79}];

window.manufacturerModels['Grove'] = ["GMK5250L", "GMK5150L", "GMK5200", "GMK6300L", "GMK6400", "GMK7450", "RT540E", "RT550E", "RT555E", "RT560E", "RT765E-2", "RT770E", "RT775E", "RT780E", "RT890E", "RT9130E-2", "GRT8100", "GRT8120", "GRT655", "GRT880", "GMK3050-2", "GMK3060", "GMK4080-1", "GMK4100L-1", "GMK5130-2"];
window.craneDatabase['Grove'] = [{"model": "GMK5250L", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 200}, {"model": "GMK5150L", "capacity": 150, "type": "All-Terrain Crane", "boomLength": 180}, {"model": "GMK5200", "capacity": 200, "type": "All-Terrain Crane", "boomLength": 190}, {"model": "GMK6300L", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 220}, {"model": "GMK6400", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 240}, {"model": "GMK7450", "capacity": 450, "type": "All-Terrain Crane", "boomLength": 260}, {"model": "RT540E", "capacity": 40, "type": "Rough Terrain Crane", "boomLength": 110}, {"model": "RT550E", "capacity": 50, "type": "Rough Terrain Crane", "boomLength": 120}, {"model": "RT555E", "capacity": 55, "type": "Rough Terrain Crane", "boomLength": 125}, {"model": "RT560E", "capacity": 60, "type": "Rough Terrain Crane", "boomLength": 130}, {"model": "RT765E-2", "capacity": 65, "type": "Rough Terrain Crane", "boomLength": 135}, {"model": "RT770E", "capacity": 70, "type": "Rough Terrain Crane", "boomLength": 140}, {"model": "RT775E", "capacity": 75, "type": "Rough Terrain Crane", "boomLength": 145}, {"model": "RT780E", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 150}, {"model": "RT890E", "capacity": 90, "type": "Rough Terrain Crane", "boomLength": 155}, {"model": "RT9130E-2", "capacity": 130, "type": "Rough Terrain Crane", "boomLength": 175}, {"model": "GRT8100", "capacity": 100, "type": "Rough Terrain Crane", "boomLength": 160}, {"model": "GRT8120", "capacity": 120, "type": "Rough Terrain Crane", "boomLength": 170}, {"model": "GRT655", "capacity": 55, "type": "Rough Terrain Crane", "boomLength": 125}, {"model": "GRT880", "capacity": 80, "type": "Rough Terrain Crane", "boomLength": 150}, {"model": "GMK3050-2", "capacity": 50, "type": "All-Terrain Crane", "boomLength": 130}, {"model": "GMK3060", "capacity": 60, "type": "All-Terrain Crane", "boomLength": 140}, {"model": "GMK4080-1", "capacity": 80, "type": "All-Terrain Crane", "boomLength": 150}, {"model": "GMK4100L-1", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 160}, {"model": "GMK5130-2", "capacity": 130, "type": "All-Terrain Crane", "boomLength": 170}];

window.manufacturerModels['Manitowoc'] = ["18000", "MLC300", "MLC650", "MLC100-1", "MLC165", "999", "2250", "4100W", "4600S", "16000", "21000", "31000", "MLC100", "MLC150", "MLC200"];
window.craneDatabase['Manitowoc'] = [{"model": "18000", "capacity": 550, "type": "Crawler Crane", "boomLength": 320}, {"model": "MLC300", "capacity": 300, "type": "Crawler Crane", "boomLength": 220}, {"model": "MLC650", "capacity": 650, "type": "Crawler Crane", "boomLength": 350}, {"model": "MLC100-1", "capacity": 100, "type": "Crawler Crane", "boomLength": 180}, {"model": "MLC165", "capacity": 165, "type": "Crawler Crane", "boomLength": 200}, {"model": "999", "capacity": 275, "type": "Crawler Crane", "boomLength": 240}, {"model": "2250", "capacity": 300, "type": "Crawler Crane", "boomLength": 260}, {"model": "4100W", "capacity": 230, "type": "Crawler Crane", "boomLength": 210}, {"model": "4600S", "capacity": 250, "type": "Crawler Crane", "boomLength": 230}, {"model": "16000", "capacity": 440, "type": "Crawler Crane", "boomLength": 300}, {"model": "21000", "capacity": 600, "type": "Crawler Crane", "boomLength": 360}, {"model": "31000", "capacity": 880, "type": "Crawler Crane", "boomLength": 420}, {"model": "MLC100", "capacity": 100, "type": "Crawler Crane", "boomLength": 175}, {"model": "MLC150", "capacity": 150, "type": "Crawler Crane", "boomLength": 190}, {"model": "MLC200", "capacity": 200, "type": "Crawler Crane", "boomLength": 210}];

window.manufacturerModels['Sany'] = ["SCC8500", "SCC4000E", "SCC6500A", "SCC1000A", "SCC2500A", "SAC1800", "SAC2200", "SAC3000", "SAC4000", "STC250", "STC500", "STC750"];
window.craneDatabase['Sany'] = [{"model": "SCC8500", "capacity": 850, "type": "Crawler Crane", "boomLength": 440}, {"model": "SCC4000E", "capacity": 400, "type": "Crawler Crane", "boomLength": 300}, {"model": "SCC6500A", "capacity": 650, "type": "Crawler Crane", "boomLength": 380}, {"model": "SCC1000A", "capacity": 100, "type": "Crawler Crane", "boomLength": 180}, {"model": "SCC2500A", "capacity": 250, "type": "Crawler Crane", "boomLength": 240}, {"model": "SAC1800", "capacity": 180, "type": "All-Terrain Crane", "boomLength": 190}, {"model": "SAC2200", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 210}, {"model": "SAC3000", "capacity": 300, "type": "All-Terrain Crane", "boomLength": 230}, {"model": "SAC4000", "capacity": 400, "type": "All-Terrain Crane", "boomLength": 250}, {"model": "STC250", "capacity": 25, "type": "Truck-Mounted Crane", "boomLength": 100}, {"model": "STC500", "capacity": 50, "type": "Truck-Mounted Crane", "boomLength": 130}, {"model": "STC750", "capacity": 75, "type": "Truck-Mounted Crane", "boomLength": 150}];

window.manufacturerModels['Kobelco'] = ["CK1600G", "CKE1350G", "BMS800", "CK2500", "CK2750G-2", "CK1100G", "CK1600", "CKE2500G-2", "CKE4000", "CK800", "CK800G", "CK2500-2", "CKE900", "7250", "7065", "7080", "7150", "7250S", "7300", "CKE1800", "CKE2500", "CK2750G", "CKE800", "CKE2500-2", "CKE1500", "CK1100G-2", "CKE900G", "7055", "7065G", "CKE1800G"];
window.craneDatabase['Kobelco'] = [{"model": "CK1600G","capacity": 160,"type": "Crawler Crane","boomLength": 250,"year": 2013,"weight": 175},{"model": "CKE1350G","capacity": 150,"type": "Crawler Crane","boomLength": 246,"year": 2010,"weight": 165},{"model": "BMS800","capacity": 80,"type": "Crawler Crane","boomLength": 180,"year": 1982,"weight": 92,"legacy": true},{"model": "CK2500","capacity": 250,"type": "Crawler Crane","boomLength": 300,"year": 2001,"weight": 200},{"model": "CK2750G-2","capacity": 275,"type": "Crawler Crane","boomLength": 292,"year": 2017,"weight": 210},{"model": "CK1100G","capacity": 110,"type": "Crawler Crane","boomLength": 200,"year": 2012,"weight": 115},{"model": "CK1600","capacity": 160,"type": "Crawler Crane","boomLength": 250,"year": 2003,"weight": 174},{"model": "CKE2500G-2","capacity": 275,"type": "Crawler Crane","boomLength": 295,"year": 2018,"weight": 210},{"model": "CKE4000","capacity": 400,"type": "Crawler Crane","boomLength": 344,"year": 2020,"weight": 355},{"model": "CK800","capacity": 80,"type": "Crawler Crane","boomLength": 190,"year": 1998,"weight": 95,"legacy": true},{"model": "CK800G","capacity": 80,"type": "Crawler Crane","boomLength": 200,"year": 2011,"weight": 98},{"model": "CK2500-2","capacity": 250,"type": "Crawler Crane","boomLength": 300,"year": 2006,"weight": 202},{"model": "CKE900","capacity": 90,"type": "Crawler Crane","boomLength": 164,"year": 2000,"weight": 100,"legacy": true},{"model": "7250","capacity": 250,"type": "Crawler Crane","boomLength": 305,"year": 1995,"weight": 200,"legacy": true},{"model": "7065","capacity": 65,"type": "Crawler Crane","boomLength": 150,"year": 1987,"weight": 76,"legacy": true},{"model": "7080","capacity": 80,"type": "Crawler Crane","boomLength": 170,"year": 1989,"weight": 82,"legacy": true},{"model": "7150","capacity": 150,"type": "Crawler Crane","boomLength": 215,"year": 1993,"weight": 160,"legacy": true},{"model": "7250S","capacity": 250,"type": "Crawler Crane","boomLength": 305,"year": 1997,"weight": 205,"legacy": true},{"model": "7300","capacity": 300,"type": "Crawler Crane","boomLength": 344,"year": 2000,"weight": 220,"legacy": true},{"model": "CKE1800","capacity": 180,"type": "Crawler Crane","boomLength": 265,"year": 2005,"weight": 180},{"model": "CKE2500","capacity": 275,"type": "Crawler Crane","boomLength": 295,"year": 2007,"weight": 205},{"model": "CK2750G","capacity": 275,"type": "Crawler Crane","boomLength": 292,"year": 2013,"weight": 208},{"model": "CKE800","capacity": 80,"type": "Crawler Crane","boomLength": 180,"year": 2004,"weight": 92},{"model": "CKE2500-2","capacity": 250,"type": "Crawler Crane","boomLength": 295,"year": 2010,"weight": 202},{"model": "CKE1500","capacity": 150,"type": "Crawler Crane","boomLength": 246,"year": 2006,"weight": 160},{"model": "CK1100G-2","capacity": 110,"type": "Crawler Crane","boomLength": 200,"year": 2016,"weight": 116},{"model": "CKE900G","capacity": 90,"type": "Crawler Crane","boomLength": 170,"year": 2012,"weight": 100},{"model": "7055","capacity": 55,"type": "Crawler Crane","boomLength": 135,"year": 1980,"weight": 68,"legacy": true},{"model": "7065G","capacity": 65,"type": "Crawler Crane","boomLength": 150,"year": 1998,"weight": 78},{"model": "CKE1800G","capacity": 180,"type": "Crawler Crane","boomLength": 265,"year": 2012,"weight": 182}];

window.manufacturerModels['Link-Belt'] = ["HTC-8675", "HTC-86100", "HTC-3140", "HTC-86110", "HTC-86155", "HTC-8640", "HTC-8670", "RTC-80100", "RTC-80130", "RTC-8090", "RTC-8030", "RTC-80160", "RTC-8050", "RTC-8050II", "ATC-3210", "ATC-3275", "ATC-3250", "RTC-8065", "RTC-80110", "TCC-750", "TCC-1100", "TCC-1400", "TCC-2500", "HTT-8675", "HTT-8690", "TCC-750B", "RTC-80105", "ATC-3200", "TCC-1100B", "RTC-80130 Series II", "TCC-1600", "HTC-8670 II", "RTC-8065 Series II", "TCC-800", "TCC-1200", "HTT-86110", "RTC-8090 Series II", "HTC-86110 Series II", "TCC-2000"];
window.craneDatabase['Link-Belt'] = [{"model": "HTC-8675", "capacity": 75, "type": "Truck Crane", "boomLength": 127, "year": 2006, "weight": 92}, {"model": "HTC-86100", "capacity": 100, "type": "Truck Crane", "boomLength": 140, "year": 2008, "weight": 107}, {"model": "HTC-3140", "capacity": 140, "type": "Truck Crane", "boomLength": 195, "year": 2010, "weight": 132}, {"model": "HTC-86110", "capacity": 110, "type": "Truck Crane", "boomLength": 164, "year": 2012, "weight": 112}, {"model": "HTC-86155", "capacity": 155, "type": "Truck Crane", "boomLength": 200, "year": 2019, "weight": 138}, {"model": "HTC-8640", "capacity": 40, "type": "Truck Crane", "boomLength": 105, "year": 1985, "weight": 41, "legacy": true}, {"model": "HTC-8670", "capacity": 70, "type": "Truck Crane", "boomLength": 127, "year": 2003, "weight": 88, "legacy": true}, {"model": "RTC-80100", "capacity": 100, "type": "Rough Terrain", "boomLength": 150, "year": 2011, "weight": 97}, {"model": "RTC-80130", "capacity": 130, "type": "Rough Terrain", "boomLength": 162, "year": 2017, "weight": 118}, {"model": "RTC-8090", "capacity": 90, "type": "Rough Terrain", "boomLength": 140, "year": 2008, "weight": 84}, {"model": "RTC-8030", "capacity": 30, "type": "Rough Terrain", "boomLength": 94, "year": 2000, "weight": 33, "legacy": true}, {"model": "RTC-80160", "capacity": 160, "type": "Rough Terrain", "boomLength": 195, "year": 2020, "weight": 140}, {"model": "RTC-8050", "capacity": 50, "type": "Rough Terrain", "boomLength": 110, "year": 2005, "weight": 50}, {"model": "RTC-8050II", "capacity": 50, "type": "Rough Terrain", "boomLength": 110, "year": 2013, "weight": 51}, {"model": "ATC-3210", "capacity": 210, "type": "All Terrain", "boomLength": 197, "year": 2010, "weight": 145}, {"model": "ATC-3275", "capacity": 275, "type": "All Terrain", "boomLength": 223, "year": 2017, "weight": 178}, {"model": "ATC-3250", "capacity": 250, "type": "All Terrain", "boomLength": 197, "year": 2014, "weight": 165}, {"model": "RTC-8065", "capacity": 65, "type": "Rough Terrain", "boomLength": 115, "year": 2006, "weight": 63}, {"model": "RTC-80110", "capacity": 110, "type": "Rough Terrain", "boomLength": 150, "year": 2012, "weight": 105}, {"model": "TCC-750", "capacity": 75, "type": "Telescope Crawler", "boomLength": 115, "year": 2008, "weight": 85}, {"model": "TCC-1100", "capacity": 110, "type": "Telescope Crawler", "boomLength": 150, "year": 2015, "weight": 115}, {"model": "TCC-1400", "capacity": 140, "type": "Telescope Crawler", "boomLength": 195, "year": 2020, "weight": 130}, {"model": "TCC-2500", "capacity": 250, "type": "Telescope Crawler", "boomLength": 223, "year": 2018, "weight": 190}, {"model": "HTT-8675", "capacity": 75, "type": "Truck Crane", "boomLength": 127, "year": 1998, "weight": 92, "legacy": true}, {"model": "HTT-8690", "capacity": 90, "type": "Truck Crane", "boomLength": 140, "year": 2002, "weight": 100, "legacy": true}, {"model": "TCC-750B", "capacity": 75, "type": "Telescope Crawler", "boomLength": 115, "year": 2012, "weight": 86}, {"model": "RTC-80105", "capacity": 105, "type": "Rough Terrain", "boomLength": 150, "year": 2015, "weight": 101}, {"model": "ATC-3200", "capacity": 200, "type": "All Terrain", "boomLength": 197, "year": 2009, "weight": 150}, {"model": "TCC-1100B", "capacity": 110, "type": "Telescope Crawler", "boomLength": 150, "year": 2018, "weight": 118}, {"model": "RTC-80130 Series II", "capacity": 130, "type": "Rough Terrain", "boomLength": 162, "year": 2022, "weight": 119}, {"model": "TCC-1600", "capacity": 160, "type": "Telescope Crawler", "boomLength": 200, "year": 2023, "weight": 150}, {"model": "HTC-8670 II", "capacity": 70, "type": "Truck Crane", "boomLength": 127, "year": 2006, "weight": 88}, {"model": "RTC-8065 Series II", "capacity": 65, "type": "Rough Terrain", "boomLength": 115, "year": 2014, "weight": 63}, {"model": "TCC-800", "capacity": 80, "type": "Telescope Crawler", "boomLength": 120, "year": 2016, "weight": 88}, {"model": "TCC-1200", "capacity": 120, "type": "Telescope Crawler", "boomLength": 160, "year": 2019, "weight": 125}, {"model": "HTT-86110", "capacity": 110, "type": "Truck Crane", "boomLength": 164, "year": 2010, "weight": 112}, {"model": "RTC-8090 Series II", "capacity": 90, "type": "Rough Terrain", "boomLength": 140, "year": 2015, "weight": 85}, {"model": "HTC-86110 Series II", "capacity": 110, "type": "Truck Crane", "boomLength": 164, "year": 2015, "weight": 113}, {"model": "TCC-2000", "capacity": 200, "type": "Telescope Crawler", "boomLength": 210, "year": 2022, "weight": 170}];

window.manufacturerModels['Terex'] = ["AC 100/4L", "Demag AC 100-4L", "AC 250-1"];
window.craneDatabase['Terex'] = [{"model": "AC 100/4L", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 140}, {"model": "Demag AC 100-4L", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 140}, {"model": "AC 250-1", "capacity": 250, "type": "All-Terrain Crane", "boomLength": 200}];

window.manufacturerModels['Zoomlion'] = ["QY70V", "QY100V"];
window.craneDatabase['Zoomlion'] = [{"model": "QY70V", "capacity": 70, "type": "All-Terrain Crane", "boomLength": 128}, {"model": "QY100V", "capacity": 100, "type": "All-Terrain Crane", "boomLength": 150}];

window.manufacturerModels['Caterpillar'] = ["CAT 320"];
window.craneDatabase['Caterpillar'] = [{"model": "CAT 320", "capacity": 180, "type": "Crawler Crane", "boomLength": 172}];

window.manufacturerModels['Demag'] = ["AC 220-5"];
window.craneDatabase['Demag'] = [{"model": "AC 220-5", "capacity": 220, "type": "All-Terrain Crane", "boomLength": 188}];


// Initialize manufacturer counts
document.addEventListener('DOMContentLoaded', function() {
    console.log("‚úÖ Inline crane database loaded");
    console.log("Total manufacturers:", Object.keys(window.manufacturerModels).length);
    updateManufacturerCounts();
});


// Comprehensive Crane Specifications Database
// REMOVED DUPLICATE: const craneDatabase = {
// REMOVED DUPLICATE:         "Liebherr": [
// REMOVED DUPLICATE:             {model: 'LTM 1025', capacity: 102, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1030-2.1', capacity: 103, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1040-2.1', capacity: 104, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1050-3.1', capacity: 105, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1060-3.1', capacity: 106, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1070-4.2', capacity: 107, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1080-2', capacity: 108, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1090-4.2', capacity: 109, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1100-5.2', capacity: 110, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1110-5.1', capacity: 111, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1120-4.1', capacity: 112, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1130-5.1', capacity: 113, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1160-5.2', capacity: 116, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1200-5.1', capacity: 120, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1220-5.2', capacity: 122, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1230-5.1', capacity: 123, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1250-6.1', capacity: 125, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1300-6.2', capacity: 130, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1350-6.1', capacity: 135, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1400-7.1', capacity: 140, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1450-8.1', capacity: 145, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1500-8.1', capacity: 150, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1650-8.1', capacity: 165, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 1750-9.1', capacity: 175, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTM 11200-9.1', capacity: 112, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTC 1045-3.1', capacity: 104, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTC 1050-3.1', capacity: 105, type: 'All-Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LRT 1090-2.1', capacity: 109, type: 'Rough Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LRT 1100-2.1', capacity: 110, type: 'Rough Terrain Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTR 1040', capacity: 104, type: 'Telescopic Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTR 1060', capacity: 106, type: 'Telescopic Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTR 1100', capacity: 110, type: 'Telescopic Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LTR 1220', capacity: 122, type: 'Telescopic Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1100', capacity: 110, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1160', capacity: 116, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1200', capacity: 120, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1250', capacity: 125, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1280', capacity: 128, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1300.1 SX', capacity: 130, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1350/1', capacity: 135, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1400/2', capacity: 140, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1500', capacity: 150, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1600/2', capacity: 160, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1700-1.0', capacity: 170, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1750/2', capacity: 175, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 1800-1.0', capacity: 180, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 11350', capacity: 113, type: 'Crawler Crane', boomLength: 60},
// REMOVED DUPLICATE:             {model: 'LR 13000', capacity: 130, type: 'Crawler Crane', boomLength: 60}
// REMOVED DUPLICATE:         ],
// REMOVED DUPLICATE:     "Tadano": [
// REMOVED DUPLICATE:         { model: "ATF 400G-6", capacity: 400, type: "All-Terrain Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "ATF 220G-5", capacity: 220, type: "All-Terrain Crane", boomLength: 217 },
// REMOVED DUPLICATE:         { model: "ATF 130G-5", capacity: 130, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "ATF 110G-5", capacity: 110, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "ATF 90G-4", capacity: 90, type: "All-Terrain Crane", boomLength: 164 },
// REMOVED DUPLICATE:         { model: "ATF 70G-4", capacity: 70, type: "All-Terrain Crane", boomLength: 164 },
// REMOVED DUPLICATE:         { model: "CC 2800-1", capacity: 660, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "CC 3800-1", capacity: 715, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "GR-1000XL", capacity: 100, type: "Rough Terrain Crane", boomLength: 154 },
// REMOVED DUPLICATE:         { model: "GR-750XL", capacity: 75, type: "Rough Terrain Crane", boomLength: 141 },
// REMOVED DUPLICATE:         { model: "GR-600XL", capacity: 60, type: "Rough Terrain Crane", boomLength: 128 },
// REMOVED DUPLICATE:         { model: "GR-550XL", capacity: 55, type: "Rough Terrain Crane", boomLength: 128 },
// REMOVED DUPLICATE:         { model: "GR-500XL", capacity: 50, type: "Rough Terrain Crane", boomLength: 118 },
// REMOVED DUPLICATE:         { model: "GR-300XL", capacity: 30, type: "Rough Terrain Crane", boomLength: 105 },
// REMOVED DUPLICATE:         { model: "GR-250XL", capacity: 25, type: "Rough Terrain Crane", boomLength: 92 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Grove": [
// REMOVED DUPLICATE:         { model: "GMK7450", capacity: 450, type: "All-Terrain Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "GMK6400", capacity: 400, type: "All-Terrain Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "GMK6300L", capacity: 350, type: "All-Terrain Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "GMK5250L", capacity: 300, type: "All-Terrain Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "GMK5220", capacity: 220, type: "All-Terrain Crane", boomLength: 217 },
// REMOVED DUPLICATE:         { model: "GMK5150L", capacity: 150, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "GMK4100L-1", capacity: 100, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "GMK3060L", capacity: 60, type: "All-Terrain Crane", boomLength: 164 },
// REMOVED DUPLICATE:         { model: "GRT8100", capacity: 100, type: "Rough Terrain Crane", boomLength: 154 },
// REMOVED DUPLICATE:         { model: "GRT880", capacity: 80, type: "Rough Terrain Crane", boomLength: 141 },
// REMOVED DUPLICATE:         { model: "RT890E", capacity: 90, type: "Rough Terrain Crane", boomLength: 154 },
// REMOVED DUPLICATE:         { model: "RT765E-2", capacity: 65, type: "Rough Terrain Crane", boomLength: 128 },
// REMOVED DUPLICATE:         { model: "RT540E", capacity: 40, type: "Rough Terrain Crane", boomLength: 105 },
// REMOVED DUPLICATE:         { model: "GHC75", capacity: 75, type: "Truck-Mounted Crane", boomLength: 141 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Terex": [
// REMOVED DUPLICATE:         { model: "AC 1000-9", capacity: 1200, type: "All-Terrain Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "AC 700-9", capacity: 700, type: "All-Terrain Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "AC 500-2", capacity: 500, type: "All-Terrain Crane", boomLength: 275 },
// REMOVED DUPLICATE:         { model: "AC 350-6", capacity: 350, type: "All-Terrain Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "AC 250-1", capacity: 250, type: "All-Terrain Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "AC 200-1", capacity: 200, type: "All-Terrain Crane", boomLength: 213 },
// REMOVED DUPLICATE:         { model: "AC 100-4L", capacity: 100, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "CC 8800-1", capacity: 1600, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "CC 6800", capacity: 1250, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "HC 275", capacity: 275, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "RT 780", capacity: 80, type: "Rough Terrain Crane", boomLength: 141 },
// REMOVED DUPLICATE:         { model: "RT 670", capacity: 70, type: "Rough Terrain Crane", boomLength: 128 },
// REMOVED DUPLICATE:         { model: "RT 555", capacity: 55, type: "Rough Terrain Crane", boomLength: 118 },
// REMOVED DUPLICATE:         { model: "RT 345XL", capacity: 45, type: "Rough Terrain Crane", boomLength: 105 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Manitowoc": [
// REMOVED DUPLICATE:         { model: "31000", capacity: 2535, type: "Crawler Crane", boomLength: 820 },
// REMOVED DUPLICATE:         { model: "21000", capacity: 1323, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "18000", capacity: 1000, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "16000", capacity: 750, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "14000", capacity: 600, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "MLC650", capacity: 650, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "MLC300", capacity: 300, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "999", capacity: 275, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "888", capacity: 230, type: "Crawler Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "777", capacity: 200, type: "Crawler Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "2250", capacity: 300, type: "Crawler Crane", boomLength: 328 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Kobelco": [
// REMOVED DUPLICATE:         { model: "CK3300G-2", capacity: 330, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "CK2750G-2", capacity: 275, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "CK2500G-2", capacity: 250, type: "Crawler Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "CK1100G-2", capacity: 110, type: "Crawler Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "CK1000G-3", capacity: 100, type: "Crawler Crane", boomLength: 213 },
// REMOVED DUPLICATE:         { model: "CK850G-2", capacity: 85, type: "Crawler Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "SL6000G", capacity: 600, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "7250", capacity: 250, type: "Crawler Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "7200", capacity: 200, type: "Crawler Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "7150", capacity: 150, type: "Crawler Crane", boomLength: 230 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Link-Belt": [
// REMOVED DUPLICATE:         { model: "348 HSL", capacity: 300, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "298 HSL", capacity: 250, type: "Crawler Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "238 HSL", capacity: 200, type: "Crawler Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "218 HSL", capacity: 150, type: "Crawler Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "TCC-1400", capacity: 140, type: "Telescopic Crawler Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "TCC-1200", capacity: 120, type: "Telescopic Crawler Crane", boomLength: 213 },
// REMOVED DUPLICATE:         { model: "RTC-8090 II", capacity: 90, type: "Rough Terrain Crane", boomLength: 154 },
// REMOVED DUPLICATE:         { model: "RTC-8080 II", capacity: 80, type: "Rough Terrain Crane", boomLength: 141 },
// REMOVED DUPLICATE:         { model: "RTC-8065 II", capacity: 65, type: "Rough Terrain Crane", boomLength: 128 },
// REMOVED DUPLICATE:         { model: "RTC-8050 II", capacity: 50, type: "Rough Terrain Crane", boomLength: 118 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Sany": [
// REMOVED DUPLICATE:         { model: "SCC40000A", capacity: 4000, type: "Crawler Crane", boomLength: 984 },
// REMOVED DUPLICATE:         { model: "SCC25000TM", capacity: 2500, type: "Crawler Crane", boomLength: 820 },
// REMOVED DUPLICATE:         { model: "SCC16000TM", capacity: 1600, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "SCC10000TM", capacity: 1000, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "SCC8500", capacity: 850, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "SCC6500A", capacity: 650, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "SAC6000", capacity: 600, type: "All-Terrain Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "SAC3000", capacity: 300, type: "All-Terrain Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "SAC1500", capacity: 150, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "SAC800", capacity: 80, type: "All-Terrain Crane", boomLength: 164 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "XCMG": [
// REMOVED DUPLICATE:         { model: "XGC88000", capacity: 4000, type: "Crawler Crane", boomLength: 984 },
// REMOVED DUPLICATE:         { model: "XGC55000", capacity: 2500, type: "Crawler Crane", boomLength: 820 },
// REMOVED DUPLICATE:         { model: "XGC28000", capacity: 1250, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "XGC16000A", capacity: 1600, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "XGC12000", capacity: 1200, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "XGC8000", capacity: 800, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "XCA1600", capacity: 1600, type: "All-Terrain Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "XCA800", capacity: 800, type: "All-Terrain Crane", boomLength: 295 },
// REMOVED DUPLICATE:         { model: "XCA400", capacity: 400, type: "All-Terrain Crane", boomLength: 262 },
// REMOVED DUPLICATE:         { model: "XCA220", capacity: 220, type: "All-Terrain Crane", boomLength: 217 }
// REMOVED DUPLICATE:     ],
// REMOVED DUPLICATE:     "Zoomlion": [
// REMOVED DUPLICATE:         { model: "ZCC33000", capacity: 3300, type: "Crawler Crane", boomLength: 820 },
// REMOVED DUPLICATE:         { model: "ZCC26000", capacity: 2600, type: "Crawler Crane", boomLength: 820 },
// REMOVED DUPLICATE:         { model: "ZCC13200", capacity: 1320, type: "Crawler Crane", boomLength: 656 },
// REMOVED DUPLICATE:         { model: "ZCC9800", capacity: 980, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "ZCC8800", capacity: 880, type: "Crawler Crane", boomLength: 492 },
// REMOVED DUPLICATE:         { model: "ZCC3200NP", capacity: 320, type: "Crawler Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "ZAT6000", capacity: 600, type: "All-Terrain Crane", boomLength: 328 },
// REMOVED DUPLICATE:         { model: "ZAT3000", capacity: 300, type: "All-Terrain Crane", boomLength: 230 },
// REMOVED DUPLICATE:         { model: "ZAT1200", capacity: 120, type: "All-Terrain Crane", boomLength: 197 },
// REMOVED DUPLICATE:         { model: "ZAT800", capacity: 80, type: "All-Terrain Crane", boomLength: 164 }
// REMOVED DUPLICATE:     ]
// REMOVED DUPLICATE: };

// Auto-prefill functionality
function populateModelDropdown(manufacturer) {
    const modelSelect = Array.from(document.querySelectorAll('select')).find(s => {
        const label = s.previousElementSibling;
        return label && label.textContent && label.textContent.toLowerCase().includes('model');
    });
    
    if (!modelSelect) {
        console.error('Model select element not found');
        return;
    }

    // Clear existing options
    modelSelect.innerHTML = '<option value="">Select Model</option>';

    // Get models for selected manufacturer
    // First try manufacturerModels (has all 48+ models), fallback to craneDatabase
    let modelNames = [];
    if (typeof manufacturerModels !== 'undefined' && manufacturerModels[manufacturer]) {
        modelNames = manufacturerModels[manufacturer];
    } else if (craneDatabase[manufacturer]) {
        modelNames = craneDatabase[manufacturer].map(c => c.model);
    }
    
    // Add model options
    modelNames.forEach(modelName => {
        const option = document.createElement('option');
        option.value = modelName;
        option.textContent = modelName;
        // Try to get additional data from craneDatabase if available
        const craneData = craneDatabase[manufacturer]?.find(c => c.model === modelName);
        if (craneData) {
            option.dataset.capacity = craneData.capacity;
            option.dataset.type = craneData.type;
            option.dataset.boomLength = craneData.boomLength;
        }
        modelSelect.appendChild(option);
    });

    console.log(`Populated ${modelNames.length} models for ${manufacturer}`);
}

function autofillCraneSpecs(model, manufacturer) {
    const models = craneDatabase[manufacturer] || [];
    const craneData = models.find(c => c.model === model);
    
    if (!craneData) {
        console.log('Crane data not found for:', model);
        return;
    }

    // Find and fill capacity field
    const capacityInput = Array.from(document.querySelectorAll('input[type="text"], input[type="number"]')).find(input => {
        const label = input.closest('div')?.querySelector('label');
        return label && label.textContent && label.textContent.toLowerCase().includes('capacity');
    });
    
    if (capacityInput) {
        capacityInput.value = craneData.capacity;
        capacityInput.style.border = '2px solid #00ff88';
        setTimeout(() => capacityInput.style.border = '', 2000);
    }

    // Find and fill crane type dropdown
    const craneTypeSelect = Array.from(document.querySelectorAll('select')).find(s => {
        const label = s.previousElementSibling;
        return label && label.textContent && label.textContent.toLowerCase().includes('crane type');
    });
    
    if (craneTypeSelect) {
        const options = Array.from(craneTypeSelect.options);
        const matchingOption = options.find(opt => opt.textContent.includes(craneData.type));
        if (matchingOption) {
            craneTypeSelect.value = matchingOption.value;
            craneTypeSelect.style.border = '2px solid #00ff88';
            setTimeout(() => craneTypeSelect.style.border = '', 2000);
        }
    }

    // Find and fill boom length field
    const boomInput = Array.from(document.querySelectorAll('input[type="text"], input[type="number"]')).find(input => {
        const label = input.closest('div')?.querySelector('label');
        return label && label.textContent && label.textContent.toLowerCase().includes('boom');
    });
    
    if (boomInput) {
        boomInput.value = craneData.boomLength;
        boomInput.style.border = '2px solid #00ff88';
        setTimeout(() => boomInput.style.border = '', 2000);
    }

    // Show notification
    showToast(`${manufacturer} ${model} specifications loaded`);
    
    console.log('Auto-filled:', craneData);
}

function showToast(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        color: #000;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Find manufacturer select
    const manufacturerSelect = Array.from(document.querySelectorAll('select')).find(s => {
        const label = s.previousElementSibling;
        return label && label.textContent && label.textContent.toLowerCase().includes('manufacturer');
    });

    if (manufacturerSelect) {
        manufacturerSelect.addEventListener('change', function() {
            const manufacturer = this.value;
            if (manufacturer && manufacturer !== 'Select Manufacturer') {
                populateModelDropdown(manufacturer);
            }
        });
    }

    // Find model select
    const modelSelect = Array.from(document.querySelectorAll('select')).find(s => {
        const label = s.previousElementSibling;
        return label && label.textContent && label.textContent.toLowerCase().includes('model');
    });

    if (modelSelect) {
        modelSelect.addEventListener('change', function() {
            const model = this.value;
            const manufacturerSelect = Array.from(document.querySelectorAll('select')).find(s => {
                const label = s.previousElementSibling;
                return label && label.textContent && label.textContent.toLowerCase().includes('manufacturer');
            });
            const manufacturer = manufacturerSelect ? manufacturerSelect.value : '';
            
            if (model && model !== 'Select Model' && manufacturer) {
                autofillCraneSpecs(model, manufacturer);
            }
        });
    }

    console.log('Auto-prefill functionality initialized');
});


// Update rental comparison chart
function updateRentalComparisonChart(bareRental, operatedRental, ownershipCost) {
    const ctx = document.getElementById('rentalComparisonChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (window.rentalChart) {
        window.rentalChart.destroy();
    }
    
    const months = [1, 6, 12, 24, 36, 48, 60];
    const bareRentalCosts = months.map(m => bareRental * m);
    const operatedRentalCosts = months.map(m => operatedRental * m);
    const ownershipCosts = months.map(m => ownershipCost * m);
    
    window.rentalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months.map(m => m + ' mo'),
            datasets: [
                {
                    label: 'Bare Rental',
                    data: bareRentalCosts,
                    borderColor: '#00FF88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    borderWidth: 3,
                    tension: 0.4
                },
                {
                    label: 'Operated Rental',
                    data: operatedRentalCosts,
                    borderColor: '#FFB800',
                    backgroundColor: 'rgba(255, 184, 0, 0.1)',
                    borderWidth: 3,
                    tension: 0.4
                },
                {
                    label: 'Ownership Cost',
                    data: ownershipCosts,
                    borderColor: '#00A8FF',
                    backgroundColor: 'rgba(0, 168, 255, 0.1)',
                    borderWidth: 3,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#FFFFFF',
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#00FF88',
                    bodyColor: '#FFFFFF',
                    borderColor: '#00FF88',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#888888',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#888888',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'K';
                        }
                    }
                }
            }
        }
    });
}

</script>


    <!-- ============================================ -->
    <!-- BACKEND INTEGRATION FOR QUICK TOOLS -->
    <!-- ============================================ -->
    <script>
        // API endpoint
        // Duplicate removed: const API_BASE = window.location.origin + '/api';
        
        // Save Notes Function
        async function saveNote() {
            const noteText = document.getElementById('noteText')?.value;
            if (!noteText || !noteText.trim()) {
                alert('Please enter a note before saving');
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content: noteText,
                        timestamp: new Date().toISOString(),
                        category: 'valuation_terminal'
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Note saved successfully!');
                    document.getElementById('noteText').value = '';
                } else {
                    alert('‚ö†Ô∏è  Failed to save note. Please try again.');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                alert('‚ùå Error saving note: ' + error.message);
            }
        }
        
        // Schedule Event Function
        async function scheduleEvent() {
            const eventTitle = document.getElementById('eventTitle')?.value;
            const eventDate = document.getElementById('eventDate')?.value;
            const eventTime = document.getElementById('eventTime')?.value;
            
            if (!eventTitle || !eventDate || !eventTime) {
                alert('Please fill in all event fields');
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: eventTitle,
                        date: eventDate,
                        time: eventTime,
                        timestamp: new Date().toISOString(),
                        source: 'valuation_terminal'
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Event scheduled successfully!');
                    document.getElementById('eventTitle').value = '';
                    document.getElementById('eventDate').value = '';
                    document.getElementById('eventTime').value = '';
                } else {
                    alert('‚ö†Ô∏è  Failed to schedule event. Please try again.');
                }
            } catch (error) {
                console.error('Error scheduling event:', error);
                alert('‚ùå Error scheduling event: ' + error.message);
            }
        }
        
        // Unit Converter Function
        function performConversion() {
            const value = parseFloat(document.getElementById('converterInput')?.value);
            const conversionType = document.getElementById('converterType')?.value;
            
            if (isNaN(value) || !fromUnit || !toUnit) {
                alert('Please enter a valid value and select units');
                return;
            }
            
            // Conversion logic
            const conversions = {
                'tons_kg': 1000,
                'kg_tons': 0.001,
                'tons_lbs': 2204.62,
                'lbs_tons': 0.000453592,
                'ft_m': 0.3048,
                'm_ft': 3.28084,
                'usd_eur': 0.92,  // Example rate
                'eur_usd': 1.09   // Example rate
            };
            
            const rate = conversions[conversionType];
            
            if (rate && !isNaN(value)) {
                const result = value * rate;
                document.getElementById('converterResult').value = result.toFixed(2);
                console.log(`‚úÖ Converted ${value} to ${result.toFixed(2)} (${conversionType})`);
            } else if (isNaN(value)) {
                alert('‚ö†Ô∏è  Please enter a valid number');
            } else {
                alert('‚ö†Ô∏è  Conversion not supported');
            }
        }
        
        console.log('‚úÖ Backend integration for quick tools loaded');
    </script>


<!-- ========== CRANE INTELLIGENCE PAYWALL SYSTEM ========== -->
<div id="paywallOverlay" class="ci-paywall-overlay" style="display: none;">
    <div class="ci-paywall-container">
        <button class="ci-paywall-close" onclick="closePaywall()" aria-label="Close">&times;</button>
        
        <div class="ci-paywall-header">
            <div class="ci-paywall-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h2 class="ci-paywall-title">UPGRADE REQUIRED</h2>
            <p class="ci-paywall-subtitle" id="paywallMessage">Access professional crane valuation intelligence</p>
        </div>
        
        <!-- Billing Toggle -->
        <div class="ci-billing-toggle">
            <button class="ci-billing-btn active" data-billing="monthly" onclick="switchBilling('monthly')">
                MONTHLY
            </button>
            <button class="ci-billing-btn" data-billing="yearly" onclick="switchBilling('yearly')">
                YEARLY
                <span class="ci-discount-badge">SAVE 10%</span>
            </button>
        </div>
        
        <div id="paywallUsageInfo" class="ci-usage-alert" style="display: none;">
            <div class="ci-usage-icon">‚ö†</div>
            <div class="ci-usage-content">
                <h3>MONTHLY LIMIT REACHED</h3>
                <p id="usageCount" class="ci-usage-count"></p>
                <p class="ci-usage-message">Upgrade to continue accessing valuation data</p>
            </div>
        </div>
        
        <div class="ci-plans-grid" id="paywallPlans">
            <!-- Plans dynamically loaded -->
        </div>
        
        <div class="ci-paywall-footer">
            <p class="ci-footer-text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Secure payment processing ‚Ä¢ Cancel anytime
            </p>
        </div>
    </div>
</div>

<!-- Stripe Payment Modal -->
<div id="stripePaymentModal" class="ci-stripe-modal" style="display: none;">
    <div class="ci-stripe-container">
        <button class="ci-stripe-close" onclick="closeStripeModal()" aria-label="Close">&times;</button>
        
        <div class="ci-stripe-header">
            <h2>COMPLETE SUBSCRIPTION</h2>
            <div class="ci-plan-summary">
                <div class="ci-summary-row">
                    <span class="ci-summary-label">Plan</span>
                    <span class="ci-summary-value" id="selectedPlanName"></span>
                </div>
                <div class="ci-summary-row">
                    <span class="ci-summary-label">Billing</span>
                    <span class="ci-summary-value">Monthly</span>
                </div>
                <div class="ci-summary-row ci-summary-total">
                    <span class="ci-summary-label">Total</span>
                    <span class="ci-summary-value" id="selectedPlanPrice"></span>
                </div>
            </div>
        </div>
        
        <div class="ci-stripe-body">
            <!-- Billing Cycle Selection -->
            <div class="ci-billing-selection">
                <label class="ci-stripe-label">BILLING CYCLE</label>
                <div class="ci-billing-options">
                    <label class="ci-radio-option">
                        <input type="radio" name="billing_cycle" value="monthly" checked onchange="updateStripeBilling('monthly')">
                        <span class="ci-radio-label">
                            <span class="ci-radio-title">Monthly</span>
                            <span class="ci-radio-price" id="monthlyPrice">$2,499/month</span>
                        </span>
                    </label>
                    <label class="ci-radio-option ci-recommended">
                        <input type="radio" name="billing_cycle" value="yearly" onchange="updateStripeBilling('yearly')">
                        <span class="ci-radio-label">
                            <span class="ci-radio-title">Yearly <span class="ci-save-badge">SAVE 10%</span></span>
                            <span class="ci-radio-price" id="yearlyPrice">$2,249/month</span>
                        </span>
                        <span class="ci-yearly-total">Billed $26,988 annually</span>
                    </label>
                </div>
            </div>
            
            <!-- Payment Method Selection -->
            <div class="ci-payment-section">
                <label class="ci-stripe-label">PAYMENT METHOD</label>
                <div id="payment-element" class="ci-payment-element" style="min-height: 100px; padding: 20px; background: #2A2A2A; border-radius: 4px; margin-bottom: 15px;">
                    <div id="payment-loading" style="text-align: center; color: #00FF88;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00FF88" stroke-width="2" style="animation: spin 1s linear infinite;">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        <p style="margin-top: 10px; font-size: 14px;">Loading payment methods...</p>
                    </div>
                </div>
                <style>
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                </style>
                <div id="payment-errors" class="ci-payment-errors"></div>
            </div>
            
            <!-- Cardholder Name -->
            <div class="ci-input-group">
                <label class="ci-stripe-label">CARDHOLDER NAME</label>
                <input type="text" id="cardholderName" class="ci-input-field" placeholder="John Doe" required>
            </div>
            
            <!-- Email for Receipt -->
            <div class="ci-input-group">
                <label class="ci-stripe-label">EMAIL FOR RECEIPT</label>
                <input type="email" id="receiptEmail" class="ci-input-field" placeholder="john@company.com" required>
            </div>
        </div>
        
        <div class="ci-stripe-footer">
            <button id="submitPayment" class="ci-btn-pay">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                PROCESS PAYMENT
            </button>
            <button onclick="closeStripeModal()" class="ci-btn-cancel">CANCEL</button>
            <p class="ci-security-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                </svg>
                Powered by Stripe ‚Ä¢ PCI DSS Level 1 Certified
            </p>
        </div>
    </div>
</div>

<style>
/* ========== CRANE INTELLIGENCE PAYWALL STYLES ========== */
/* Brand Colors */
:root {
    --ci-black: #0F0F0F;
    --ci-dark-1: #1A1A1A;
    --ci-dark-2: #2A2A2A;
    --ci-dark-3: #404040;
    --ci-green: #00FF88;
    --ci-green-dark: #00CC6A;
    --ci-white: #FFFFFF;
    --ci-gray: #888888;
    --ci-red: #FF4444;
}

/* Paywall Overlay */
.ci-paywall-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 15, 15, 0.97);
    backdrop-filter: blur(12px);
    z-index: 999999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: ciOverlayFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
    overflow-y: auto;
}

@keyframes ciOverlayFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(12px);
    }
}

.ci-paywall-container {
    background: var(--ci-dark-1);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    max-width: 1400px;
    width: 100%;
    max-height: 95vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: ciContainerSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes ciContainerSlideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ci-paywall-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    color: var(--ci-gray);
    width: 40px;
    height: 40px;
    border-radius: 2px;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.ci-paywall-close:hover {
    background: var(--ci-dark-3);
    color: var(--ci-white);
    border-color: var(--ci-green);
}

.ci-paywall-header {
    text-align: center;
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--ci-dark-3);
}

.ci-billing-toggle {
    display: flex;
    gap: 12px;
    justify-content: center;
    padding: 20px 40px;
    background: var(--ci-dark-2);
    border-bottom: 1px solid var(--ci-dark-3);
}

.ci-billing-btn {
    flex: 1;
    max-width: 200px;
    background: var(--ci-dark-1);
    border: 1px solid var(--ci-dark-3);
    color: var(--ci-gray);
    padding: 12px 24px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1.5px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.ci-billing-btn.active {
    background: var(--ci-green);
    color: var(--ci-black);
    border-color: var(--ci-green);
}

.ci-billing-btn:hover:not(.active) {
    border-color: var(--ci-green);
    color: var(--ci-white);
}

.ci-discount-badge {
    display: inline-block;
    background: var(--ci-green);
    color: var(--ci-black);
    padding: 2px 6px;
    font-size: 9px;
    border-radius: 2px;
    margin-left: 6px;
    font-weight: 700;
}

.ci-billing-btn.active .ci-discount-badge {
    background: var(--ci-black);
    color: var(--ci-green);
}

.ci-paywall-icon {
    color: var(--ci-green);
    margin-bottom: 20px;
    display: inline-block;
}

.ci-paywall-title {
    font-size: 32px;
    font-weight: 700;
    color: var(--ci-white);
    margin: 0 0 12px 0;
    letter-spacing: 2px;
    font-family: 'Courier New', monospace;
}

.ci-paywall-subtitle {
    font-size: 16px;
    color: var(--ci-gray);
    margin: 0;
    font-weight: 400;
}

.ci-usage-alert {
    margin: 30px 40px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid var(--ci-red);
    border-radius: 4px;
    padding: 20px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
}

.ci-usage-icon {
    font-size: 24px;
    color: var(--ci-red);
    flex-shrink: 0;
}

.ci-usage-content h3 {
    font-size: 14px;
    font-weight: 700;
    color: var(--ci-red);
    margin: 0 0 8px 0;
    letter-spacing: 1px;
}

.ci-usage-content p {
    font-size: 13px;
    color: var(--ci-gray);
    margin: 4px 0;
}

.ci-usage-count {
    font-size: 18px;
    color: var(--ci-white);
    font-weight: 600;
}

.ci-plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    padding: 40px;
}

.ci-plan-card {
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    padding: 32px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.ci-plan-card:hover {
    border-color: var(--ci-green);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 255, 136, 0.15);
}

.ci-plan-card.ci-popular {
    border-color: var(--ci-green);
    background: linear-gradient(135deg, var(--ci-dark-2) 0%, rgba(0, 255, 136, 0.05) 100%);
}

.ci-plan-card.ci-popular::before {
    content: 'RECOMMENDED';
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    background: var(--ci-green);
    color: var(--ci-black);
    padding: 6px 12px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-align: center;
    border-radius: 4px 4px 0 0;
}

.ci-plan-name {
    font-size: 12px;
    font-weight: 700;
    color: var(--ci-gray);
    margin: 0 0 12px 0;
    letter-spacing: 2px;
}

.ci-plan-card.ci-popular .ci-plan-name {
    margin-top: 24px;
}

.ci-plan-price {
    font-size: 36px;
    font-weight: 700;
    color: var(--ci-white);
    margin: 0 0 8px 0;
    font-family: 'Courier New', monospace;
}

.ci-plan-period {
    font-size: 13px;
    color: var(--ci-gray);
    margin: 0 0 24px 0;
}

.ci-plan-features {
    list-style: none;
    padding: 0;
    margin: 0 0 32px 0;
}

.ci-plan-features li {
    padding: 10px 0;
    color: var(--ci-gray);
    font-size: 13px;
    border-bottom: 1px solid var(--ci-dark-3);
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.ci-plan-features li:last-child {
    border-bottom: none;
}

.ci-plan-features li::before {
    content: '‚úì';
    color: var(--ci-green);
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
}

.ci-btn-upgrade {
    width: 100%;
    background: var(--ci-green);
    color: var(--ci-black);
    border: none;
    padding: 14px 24px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
}

.ci-btn-upgrade:hover {
    background: var(--ci-green-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
}

.ci-btn-upgrade:active {
    transform: translateY(0);
}

.ci-paywall-footer {
    text-align: center;
    padding: 24px 40px 40px;
    border-top: 1px solid var(--ci-dark-3);
}

.ci-footer-text {
    font-size: 12px;
    color: var(--ci-gray);
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Stripe Modal */
.ci-stripe-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: ciOverlayFadeIn 0.3s;
}

.ci-stripe-container {
    background: var(--ci-dark-1);
    border: 1px solid var(--ci-green);
    border-radius: 4px;
    max-width: 540px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
}

.ci-stripe-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: transparent;
    border: none;
    color: var(--ci-gray);
    font-size: 24px;
    cursor: pointer;
    transition: color 0.2s;
}

.ci-stripe-close:hover {
    color: var(--ci-white);
}

.ci-stripe-header {
    padding: 32px 32px 24px;
    border-bottom: 1px solid var(--ci-dark-3);
}

.ci-stripe-header h2 {
    font-size: 20px;
    font-weight: 700;
    color: var(--ci-white);
    margin: 0 0 20px 0;
    letter-spacing: 2px;
    font-family: 'Courier New', monospace;
}

.ci-plan-summary {
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    padding: 16px;
}

.ci-summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 13px;
}

.ci-summary-label {
    color: var(--ci-gray);
}

.ci-summary-value {
    color: var(--ci-white);
    font-weight: 600;
}

.ci-summary-total {
    border-top: 1px solid var(--ci-dark-3);
    margin-top: 8px;
    padding-top: 12px;
    font-size: 16px;
}

.ci-summary-total .ci-summary-value {
    color: var(--ci-green);
}

.ci-stripe-body {
    padding: 24px 32px;
}

.ci-stripe-label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: var(--ci-gray);
    margin-bottom: 8px;
    letter-spacing: 1px;
}

.ci-card-element {
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    padding: 16px;
    transition: border-color 0.2s;
}

.ci-card-element:focus-within {
    border-color: var(--ci-green);
}

.ci-card-errors {
    color: var(--ci-red);
    font-size: 12px;
    margin-top: 12px;
    min-height: 20px;
}

.ci-stripe-footer {
    padding: 24px 32px 32px;
    text-align: center;
}

.ci-btn-pay {
    width: 100%;
    background: var(--ci-green);
    color: var(--ci-black);
    border: none;
    padding: 16px 24px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.ci-btn-pay:hover {
    background: var(--ci-green-dark);
}

.ci-btn-pay:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.ci-btn-cancel {
    width: 100%;
    background: transparent;
    color: var(--ci-gray);
    border: 1px solid var(--ci-dark-3);
    padding: 12px 24px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 16px;
}

.ci-btn-cancel:hover {
    border-color: var(--ci-gray);
    color: var(--ci-white);
}

.ci-security-badge {
    font-size: 11px;
    color: var(--ci-gray);
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

/* Responsive */
@media (max-width: 768px) {
    .ci-plans-grid {
        grid-template-columns: 1fr;
        padding: 24px;
    }
    
    .ci-paywall-header {
        padding: 40px 24px 24px;
    }
    
    .ci-paywall-title {
        font-size: 24px;
    }
}

.ci-billing-selection {
    margin-bottom: 24px;
}

.ci-billing-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 8px;
}

.ci-radio-option {
    display: flex;
    align-items: flex-start;
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.ci-radio-option:hover {
    border-color: var(--ci-green);
}

.ci-radio-option input[type="radio"] {
    margin-right: 12px;
    margin-top: 2px;
    accent-color: var(--ci-green);
    cursor: pointer;
}

.ci-radio-option input[type="radio"]:checked ~ .ci-radio-label {
    color: var(--ci-white);
}

.ci-radio-label {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--ci-gray);
    transition: color 0.2s;
}

.ci-radio-title {
    font-size: 14px;
    font-weight: 600;
}

.ci-radio-price {
    font-size: 16px;
    font-weight: 700;
    color: var(--ci-white);
}

.ci-save-badge {
    display: inline-block;
    background: var(--ci-green);
    color: var(--ci-black);
    padding: 2px 6px;
    font-size: 9px;
    border-radius: 2px;
    margin-left: 6px;
    font-weight: 700;
    vertical-align: middle;
}

.ci-yearly-total {
    position: absolute;
    bottom: 8px;
    right: 16px;
    font-size: 11px;
    color: var(--ci-gray);
}

.ci-card-section {
    margin-bottom: 20px;
}

.ci-input-group {
    margin-bottom: 20px;
}

.ci-input-field {
    width: 100%;
    background: var(--ci-dark-2);
    border: 1px solid var(--ci-dark-3);
    border-radius: 4px;
    padding: 14px 16px;
    color: var(--ci-white);
    font-size: 14px;
    transition: border-color 0.2s;
    margin-top: 8px;
}

.ci-input-field:focus {
    outline: none;
    border-color: var(--ci-green);
}

.ci-input-field::placeholder {
    color: var(--ci-gray);
}
.ci-plan-savings {
    color: var(--ci-green);
    font-size: 12px;
    font-weight: 600;
    margin: -8px 0 16px 0;
}

</style>
<!-- ========== END PAYWALL SYSTEM ========== -->


<script>
// ========== CRANE INTELLIGENCE PAYWALL SYSTEM ==========
let stripe = null;
let elements = null;
let paymentElement = null;
let selectedPlan = null;

async function initializeStripe() {
    try {
        // Wait for Stripe.js to load
        if (typeof Stripe === 'undefined') {
            console.log('‚è≥ Waiting for Stripe.js to load...');
            await new Promise(resolve => {
                const checkStripe = setInterval(() => {
                    if (typeof Stripe !== 'undefined') {
                        clearInterval(checkStripe);
                        resolve();
                    }
                }, 100);
            });
        }
        
        const response = await fetch('/api/v1/config/public');
        const config = await response.json();
        if (config.stripe_publishable_key) {
            stripe = Stripe(config.stripe_publishable_key);
            console.log('‚úÖ Stripe initialized with key:', config.stripe_publishable_key.substring(0, 20) + '...');
        } else {
            console.error('‚ùå No Stripe publishable key found in config');
        }
    } catch (error) {
        console.error('‚ùå Stripe initialization failed:', error);
    }
}

window.checkPaywallAccess = async function() {
    try {
        const token = localStorage.getItem('access_token') || localStorage.getItem('crane_auth_token');
        if (!token) {
            return {
                has_access: false,
                subscription_tier: 'basic',
                reason: 'not_logged_in'
            };
        }

        const response = await fetch('/api/v1/paywall/check-access', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            return {
                has_access: false,
                subscription_tier: 'basic',
                reason: 'api_error'
            };
        }

        return await response.json();
    } catch (error) {
        console.error('Access check failed:', error);
        return {
            has_access: false,
            subscription_tier: 'basic',
            reason: 'api_error'
        };
    }
}

let currentBilling = 'monthly';
let planPrices = {};

window.showPaywallOverlay = async function(tier, reason, message) {
    // Don't show paywall if payment was just completed
    if (window.paymentJustCompleted) {
        console.log('‚úÖ Skipping paywall display - payment just completed');
        return;
    }
    
    const overlay = document.getElementById('paywallOverlay');
    const messageEl = document.getElementById('paywallMessage');
    const usageInfo = document.getElementById('paywallUsageInfo');
    
    if (message) {
        messageEl.textContent = message;
    } else if (reason === 'limit_reached') {
        messageEl.textContent = 'Monthly valuation limit reached';
        if (usageInfo) usageInfo.style.display = 'flex';
    } else {
        messageEl.textContent = 'Access professional crane valuation intelligence';
    }
    
    try {
        const response = await fetch('/api/v1/payments/plans');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const plans = await response.json();
        console.log('‚úÖ Plans loaded:', plans);
        
        // Store plan prices for billing toggle
        plans.forEach(plan => {
            planPrices[plan.id] = {
                monthly: plan.price,
                yearly: plan.yearly_price || Math.round(plan.price * 12 * 0.9) // Use API yearly_price
            };
        });
        
        renderPlans(plans, currentBilling);
    } catch (error) {
        console.error('‚ùå Failed to load plans:', error);
        // Show error message to user
        document.getElementById('paywallPlans').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #FF4444;">
                <p>‚ùå Failed to load subscription plans</p>
                <p style="font-size: 14px; color: #B0B0B0; margin-top: 8px;">${error.message}</p>
                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #00FF85; color: #000; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button>
            </div>
        `;
    }
    
    overlay.style.display = 'flex';
}

function renderPlans(plans, billing) {
    document.getElementById('paywallPlans').innerHTML = plans.map(plan => {
        const monthlyPrice = plan.price;
        // Use yearly_price from API response
        const yearlyPrice = plan.yearly_price || Math.round(monthlyPrice * 12 * 0.9);
        const displayPrice = billing === 'yearly' ? yearlyPrice : monthlyPrice;
        const priceDisplay = plan.id === 'enterprise' ? 'Custom' : `$${(displayPrice / 100).toLocaleString()}`;
        const billingPeriod = billing === 'yearly' ? '/year' : '/month';
        // Calculate savings: (monthly √ó 12) - yearly_price
        const monthlyAnnual = monthlyPrice * 12;
        const savingsAmount = billing === 'yearly' && plan.id !== 'enterprise' ? monthlyAnnual - yearlyPrice : 0;
        
        return `
            <div class="ci-plan-card ${plan.popular ? 'ci-popular' : ''}">
                <h3 class="ci-plan-name">${plan.name.toUpperCase()}</h3>
                <div class="ci-plan-price">${priceDisplay}</div>
                <p class="ci-plan-period">${billing === 'yearly' ? 'per year' : 'per month'}</p>
                ${savingsAmount > 0 ? `<p class="ci-plan-savings">Save $${(savingsAmount / 100).toLocaleString()}/year</p>` : ''}
                <ul class="ci-plan-features">
                    ${plan.features.map(f => `<li>${f}</li>`).join('')}
                </ul>
                <button class="ci-btn-upgrade" onclick="selectPlan('${plan.id}', '${plan.name}', '${priceDisplay}', ${displayPrice}, '${billing}')">
                    ${plan.contact_sales ? 'CONTACT SALES' : 'UPGRADE NOW'}
                </button>
            </div>
        `;
    }).join('');
}

window.switchBilling = function(billing) {
    currentBilling = billing;
    
    // Update button states
    document.querySelectorAll('.ci-billing-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.billing === billing);
    });
    
    // Re-render plans with new pricing
    fetch('/api/v1/payments/plans')
        .then(r => r.json())
        .then(plans => renderPlans(plans, billing))
        .catch(console.error);
}

function closePaywall() {
    document.getElementById('paywallOverlay').style.display = 'none';
}

function selectPlan(id, name, price, amount, billing) {
    if (id === 'enterprise') {
        window.location.href = '/contact-sales';
        return;
    }
    
    const yearlyAmount = planPrices[id]?.yearly || Math.round(amount * 12 * 0.9);
    const currentBillingCycle = billing || 'monthly';
    const totalAmount = currentBillingCycle === 'yearly' ? yearlyAmount : amount;
    
    selectedPlan = { 
        id, 
        name, 
        price, 
        amount,
        billing: currentBillingCycle,
        yearlyAmount,
        totalAmount
    };
    
    document.getElementById('selectedPlanName').textContent = name;
    document.getElementById('selectedPlanPrice').textContent = `$${(amount / 100).toLocaleString()}/month`;
    
    // Set billing radio buttons
    document.querySelector('input[name="billing_cycle"][value="monthly"]').checked = billing === 'monthly';
    document.querySelector('input[name="billing_cycle"][value="yearly"]').checked = billing === 'yearly';
    
    // Update prices in modal
    updateStripeBilling(billing || 'monthly');
    
    // Pre-fill email from localStorage
    const userEmail = localStorage.getItem('user_email') || '';
    if (userEmail) {
        document.getElementById('receiptEmail').value = userEmail;
    }
    
    document.getElementById('stripePaymentModal').style.display = 'flex';
    
    // Initialize Payment Element after modal is shown
    // Using requestAnimationFrame to avoid anti-flickering blocking
    requestAnimationFrame(async () => {
        if (!stripe) {
            console.log('‚è≥ Stripe not ready, waiting...');
            await initializeStripe();
        }
        
        if (stripe && !paymentElement) {
            console.log('üí≥ Creating Payment Element for amount:', selectedPlan.totalAmount, 'cents');
            // Create Payment Element (supports cards, bank transfers, PayPal, etc.)
            elements = stripe.elements({
                mode: 'payment',
                amount: selectedPlan.totalAmount, // Already in cents from API
                currency: 'usd',
                appearance: {
                    theme: 'night',
                    variables: {
                        colorPrimary: '#00FF88',
                        colorBackground: '#1A1A1A',
                        colorText: '#FFFFFF',
                        colorDanger: '#FF4444',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                        borderRadius: '4px'
                    }
                }
            });
        
        paymentElement = elements.create('payment', {
            layout: {
                type: 'tabs',
                defaultCollapsed: false
            },
            paymentMethodOrder: ['card', 'us_bank_account', 'paypal'],
            wallets: {
                applePay: 'auto',
                googlePay: 'auto'
            }
        });
        
        // Clear loading indicator
        const loadingDiv = document.getElementById('payment-loading');
        if (loadingDiv) loadingDiv.remove();
        
        paymentElement.mount('#payment-element').then(() => {
            console.log('‚úÖ Payment Element mounted successfully');
            alert('‚úÖ Payment methods loaded successfully!');
        }).catch((error) => {
            console.error('‚ùå Payment Element mount failed:', error);
            const displayError = document.getElementById('payment-errors');
            if (displayError) {
                displayError.textContent = 'Failed to load payment form. Please refresh and try again.';
            }
        });
        
        paymentElement.on('change', (event) => {
            const displayError = document.getElementById('payment-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        } else if (!stripe) {
            console.error('‚ùå Stripe not initialized');
            alert('‚ùå Stripe not initialized. Check console for details.');
            const displayError = document.getElementById('payment-errors');
            const loadingDiv = document.getElementById('payment-loading');
            if (loadingDiv) {
                loadingDiv.innerHTML = '<p style="color: #FF4444; font-size: 14px;">‚ùå Payment system not ready. Please refresh the page.</p>';
            }
            if (displayError) {
                displayError.textContent = 'Payment system not ready. Please refresh the page.';
            }
        }
    }); // Using requestAnimationFrame
}

function updateStripeBilling(billing) {
    if (!selectedPlan) return;
    
    const monthlyAmount = selectedPlan.amount;
    // Get yearly price from planPrices stored earlier
    const yearlyTotal = planPrices[selectedPlan.id]?.yearly || Math.round(monthlyAmount * 12 * 0.9);
    
    document.getElementById('monthlyPrice').textContent = `$${(monthlyAmount / 100).toLocaleString()}/month`;
    document.getElementById('yearlyPrice').textContent = `$${(yearlyTotal / 100).toLocaleString()} /year`;
    document.querySelector('.ci-yearly-total').textContent = `Billed annually`;
    
    // Update total in summary
    const totalAmount = billing === 'yearly' ? yearlyTotal : monthlyAmount;
    const totalDisplay = billing === 'yearly' ? `$${(yearlyTotal / 100).toLocaleString()} /year` : `$${(monthlyAmount / 100).toLocaleString()} /month`;
    document.getElementById('selectedPlanPrice').textContent = totalDisplay;
    
    selectedPlan.billing = billing;
    selectedPlan.totalAmount = totalAmount;
}

function closeStripeModal() {
    document.getElementById('stripePaymentModal').style.display = 'none';
}

async function trackValuationUsage(manufacturer, model, capacity) {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/v1/paywall/track-usage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                action_type: 'valuation',
                endpoint: '/api/v1/crane-valuation',
                crane_manufacturer: manufacturer,
                crane_model: model,
                crane_capacity: capacity
            })
        });
        return await response.json();
    } catch (error) {
        console.error('Usage tracking failed:', error);
        return { allowed: true };
    }
}

// Download receipt as PDF
window.downloadReceipt = async function(transactionId, planName, amount, date, billingCycle) {
    try {
        console.log('Downloading receipt PDF...');
        
        // Get user email from localStorage
        const userEmail = localStorage.getItem('user_email') || 'customer@example.com';
        
        // Call backend API to generate PDF
        const response = await fetch('/api/v1/payments/generate-receipt-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({
                transaction_id: transactionId,
                plan_name: planName,
                amount: parseFloat(amount),
                date: date,
                billing_cycle: billingCycle,
                customer_email: userEmail
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crane-intelligence-receipt-${transactionId.substring(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            console.log('‚úÖ Receipt downloaded successfully');
        } else {
            console.error('Failed to generate receipt PDF');
            alert('Failed to generate receipt. Please contact support.');
        }
    } catch (error) {
        console.error('Error downloading receipt:', error);
        alert('Failed to download receipt. Please try again later.');
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeStripe();
    
    const submitPaymentBtn = document.getElementById('submitPayment');
    if (submitPaymentBtn) {
        submitPaymentBtn.addEventListener('click', async function() {
            if (!selectedPlan || !stripe || !paymentElement) return;
            
            submitPaymentBtn.disabled = true;
            submitPaymentBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> PROCESSING...';
            
            // Add timeout protection to prevent stuck button
            const paymentTimeout = setTimeout(() => {
                console.error('‚è±Ô∏è Payment timeout - resetting button');
                submitPaymentBtn.disabled = false;
                submitPaymentBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> PROCESS PAYMENT';
                alert('‚è±Ô∏è Payment is taking longer than expected. Please try again or contact support.');
            }, 60000); // 60 second timeout
            
            let paymentSucceeded = false;
            
            try {
                // *** CRITICAL: Call elements.submit() FIRST, before any asynchronous work ***
                // This must be done immediately when the user clicks pay, per Stripe requirements
                console.log('üìù Step 1: Calling elements.submit() (before any async work)...');
                const { error: submitError } = await elements.submit();
                if (submitError) {
                    console.error('‚ùå Form validation error:', submitError);
                    throw submitError;
                }
                console.log('‚úÖ Step 1 complete: Form validated and submitted');
                
                const token = localStorage.getItem('access_token');
                console.log('üí≥ Step 2: Processing payment for plan:', selectedPlan.name, 'Amount:', selectedPlan.totalAmount);
                console.log('üîë Using token:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');
                
                const response = await fetch('/api/v1/payments/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plan_id: selectedPlan.id,
                        amount: selectedPlan.totalAmount
                    })
                });
                
                console.log('üì° Backend response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå Backend error:', errorData);
                    throw new Error(errorData.error || errorData.message || `Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Payment intent created:', data);
                const { client_secret } = data;
                
                if (!client_secret) {
                    throw new Error('No client secret received from server');
                }
                
                // Step 3: Confirm the payment with Stripe (elements.submit was already called in Step 1)
                console.log('üí≥ Step 3: Calling stripe.confirmPayment()...');
                const { error } = await stripe.confirmPayment({
                    elements,
                    clientSecret: client_secret,
                    confirmParams: {
                        return_url: window.location.origin + '/payment-success.html',
                    },
                    redirect: 'if_required' // Don't redirect, handle in-page
                });
                
                console.log('üìä Stripe confirmPayment completed:', { error });
                
                if (error) {
                    console.error('‚ùå Payment confirmation error:', error);
                    const errorDiv = document.getElementById('payment-errors');
                    if (errorDiv) errorDiv.textContent = error.message;
                    submitPaymentBtn.disabled = false;
                    submitPaymentBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> PROCESS PAYMENT';
                } else {
                    // Payment succeeded! Now confirm on backend and update subscription
                    console.log('‚úÖ Payment confirmed by Stripe, updating backend...');
                    paymentSucceeded = true;
                    
                    try {
                        const confirmResponse = await fetch('/api/v1/payments/confirm-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                payment_intent_id: data.payment_intent_id
                            })
                        });
                        
                        if (confirmResponse.ok) {
                            const confirmData = await confirmResponse.json();
                            console.log('‚úÖ Backend updated:', confirmData);
                            
                            // Show success modal
                            const successModal = document.createElement('div');
                            successModal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0, 0, 0, 0.9);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 100000;
                            `;
                            
                            const receiptDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                            const receiptTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            const transactionId = confirmData.payment_intent_id || 'N/A';
                            const billingCycle = selectedPlan.billing || 'monthly';
                            const nextBillingDate = new Date(Date.now() + (billingCycle === 'yearly' ? 365 : 30) * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                            
                            successModal.innerHTML = `
                                <div style="background: #1A1A1A; border: 2px solid #00FF85; border-radius: 12px; padding: 40px; max-width: 600px; text-align: center;">
                                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                                    <h2 style="font-size: 28px; font-weight: 700; color: #00FF85; margin-bottom: 12px;">Payment Successful!</h2>
                                    <p style="font-size: 16px; color: #B0B0B0; margin-bottom: 24px;">
                                        Your subscription has been upgraded to <strong style="color: #FFFFFF;">${confirmData.new_tier}</strong>
                                    </p>
                                    
                                    <!-- Receipt Details -->
                                    <div style="background: #0F0F0F; border: 1px solid #2A2A2A; border-radius: 8px; padding: 24px; margin-bottom: 24px; text-align: left;">
                                        <h3 style="font-size: 18px; font-weight: 600; color: #FFFFFF; margin-bottom: 16px; text-align: center;">Receipt Details</h3>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #2A2A2A;">
                                            <span style="color: #B0B0B0;">Receipt Number:</span>
                                            <span style="color: #FFFFFF; font-weight: 600; font-family: monospace; font-size: 12px;">${transactionId.substring(0, 20)}...</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <span style="color: #B0B0B0;">Date:</span>
                                            <span style="color: #FFFFFF; font-weight: 600;">${receiptDate} at ${receiptTime}</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <span style="color: #B0B0B0;">Plan:</span>
                                            <span style="color: #FFFFFF; font-weight: 600;">${selectedPlan.name}</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <span style="color: #B0B0B0;">Billing Cycle:</span>
                                            <span style="color: #FFFFFF; font-weight: 600; text-transform: capitalize;">${billingCycle}</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #2A2A2A;">
                                            <span style="color: #B0B0B0;">Amount Paid:</span>
                                            <span style="color: #00FF85; font-weight: 700; font-size: 18px;">$${(selectedPlan.totalAmount / 100).toFixed(2)}</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                            <span style="color: #B0B0B0;">Payment Method:</span>
                                            <span style="color: #FFFFFF; font-weight: 600;">Card ending in ****</span>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #B0B0B0;">Next Billing Date:</span>
                                            <span style="color: #FFFFFF; font-weight: 600;">${nextBillingDate}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                        <button onclick="downloadReceipt('${transactionId}', '${selectedPlan.name}', '${(selectedPlan.totalAmount / 100).toFixed(2)}', '${receiptDate}', '${billingCycle}')" style="flex: 1; background: #2A2A2A; color: #00FF85; border: 1px solid #00FF85; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                            üìÑ Download PDF Receipt
                                        </button>
                                    </div>
                                    
                                    <button onclick="location.reload()" style="background: #00FF85; color: #000000; border: none; padding: 12px 32px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;">
                                        Continue to Dashboard
                                    </button>
                                    
                                    <p style="font-size: 12px; color: #666; margin-top: 16px;">A confirmation email has been sent to your registered email address.</p>
                                </div>
                            `;
                            
                            document.body.appendChild(successModal);
                            
                            // Clear the timeout since payment succeeded
                            clearTimeout(paymentTimeout);
                            
                            // Close the payment modal
                            const paymentModal = document.getElementById('stripePaymentModal');
                            if (paymentModal) {
                                paymentModal.style.display = 'none';
                                console.log('‚úÖ Payment modal closed');
                            } else {
                                console.error('‚ùå Payment modal not found with ID: stripePaymentModal');
                            }
                            
                            // Hide the paywall overlay and prevent it from showing again
                            const paywallOverlay = document.getElementById('paywallOverlay');
                            if (paywallOverlay) {
                                paywallOverlay.style.display = 'none';
                                // Set a flag to prevent paywall from showing again
                                window.paymentJustCompleted = true;
                                console.log('‚úÖ Paywall hidden, payment completed flag set');
                            }
                            
                            // Refresh the header to show updated subscription tier
                            if (typeof window.updateHeaderUI === 'function') {
                                console.log('üîÑ Refreshing header with updated tier...');
                                setTimeout(() => {
                                    window.updateHeaderUI(true);
                                }, 500);
                            }
                        } else {
                            console.error('‚ùå Backend confirmation failed');
                            alert('‚úÖ Payment successful! Please refresh the page.');
                            location.reload();
                        }
                    } catch (confirmError) {
                        console.error('‚ùå Error confirming payment on backend:', confirmError);
                        alert('‚úÖ Payment successful! Please refresh the page.');
                        location.reload();
                    }
                }
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                console.error('‚ùå Error stack:', error.stack);
                const errorDiv = document.getElementById('payment-errors');
                if (errorDiv) {
                    errorDiv.textContent = error.message || 'Payment failed. Please try again.';
                }
                alert('‚ùå Payment failed: ' + (error.message || 'Please try again'));
            } finally {
                // ALWAYS clear timeout and reset button if payment didn't succeed
                clearTimeout(paymentTimeout);
                if (!paymentSucceeded) {
                    console.log('üîÑ Resetting button (payment did not succeed)');
                    submitPaymentBtn.disabled = false;
                    submitPaymentBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> PROCESS PAYMENT';
                }
            }
        });
    }
});
// ========== END PAYWALL SYSTEM ==========
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Crane Intelligence - Admin Panel</title>
    <link rel="stylesheet" href="../css/uniform-design.css">
    <link rel="stylesheet" href="css/admin-dashboard.css?v=11">
    <link rel="stylesheet" href="css/dashboard-components.css?v=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="../images/logos/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="../images/logos/crane-intelligence-logo-white.svg" alt="Crane Intelligence" class="logo-img">
            </div>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div class="sidebar-menu">
            <!-- Dashboard -->
            <div class="menu-item active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            
            <!-- User Management -->
            <div class="menu-group">
                <div class="menu-group-header">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-subitems">
                    <div class="menu-item" data-page="users">
                        <i class="fas fa-user"></i>
                        <span>All Users</span>
                    </div>
                    <div class="menu-item" data-page="webapp-user-management">
                        <i class="fas fa-users-cog"></i>
                        <span>Webapp Users</span>
                    </div>
                    <div class="menu-item" data-page="user-roles">
                        <i class="fas fa-user-shield"></i>
                        <span>User Roles</span>
                    </div>
                    <div class="menu-item" data-page="subscriptions">
                        <i class="fas fa-credit-card"></i>
                        <span>Subscriptions</span>
                    </div>
                </div>
            </div>
            
            <!-- Content Management -->
            <div class="menu-group">
                <div class="menu-group-header">
                    <i class="fas fa-cogs"></i>
                    <span>Content Management</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-subitems">
                    <div class="menu-item" data-page="crane-listings">
                        <i class="fas fa-list"></i>
                        <span>Crane Listings</span>
                    </div>
                    <div class="menu-item" data-page="market-data">
                        <i class="fas fa-chart-line"></i>
                        <span>Market Data</span>
                    </div>
                    <div class="menu-item" data-page="reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </div>
                </div>
            </div>
            
            <!-- Analytics -->
            <div class="menu-group">
                <div class="menu-group-header">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-subitems">
                    <div class="menu-item" data-page="usage-stats">
                        <i class="fas fa-chart-pie"></i>
                        <span>Usage Statistics</span>
                    </div>
                    <div class="menu-item" data-page="revenue">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Revenue Analytics</span>
                    </div>
                    <div class="menu-item" data-page="performance">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>System Performance</span>
                    </div>
                </div>
            </div>
            
            <!-- System Management -->
            <div class="menu-group">
                <div class="menu-group-header">
                    <i class="fas fa-server"></i>
                    <span>System Management</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-subitems">
                    <div class="menu-item" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>System Settings</span>
                    </div>
                    <div class="menu-item" data-page="logs">
                        <i class="fas fa-file-alt"></i>
                        <span>System Logs</span>
                    </div>
                    <div class="menu-item" data-page="backups">
                        <i class="fas fa-database"></i>
                        <span>Backups</span>
                    </div>
                </div>
            </div>
            
            <!-- Support -->
            <div class="menu-group">
                <div class="menu-group-header">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-subitems">
                    <div class="menu-item" data-page="tickets">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Support Tickets</span>
                    </div>
                    <div class="menu-item" data-page="notifications">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info" id="userInfoDropdown">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="currentUser">Admin User</span>
                    <span class="user-role" id="currentRole">Super Admin</span>
                </div>
                <div class="user-dropdown-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <!-- User Dropdown Menu -->
            <div class="user-dropdown-menu" id="userDropdownMenu">
                <div class="dropdown-item" data-action="profile">
                    <i class="fas fa-user"></i>
                    <span>User Profile</span>
                </div>
                <div class="dropdown-item" data-action="role">
                    <i class="fas fa-user-shield"></i>
                    <span>Role Definition</span>
                </div>
                <div class="dropdown-item" data-action="access">
                    <i class="fas fa-key"></i>
                    <span>Access Details</span>
                </div>
                <div class="dropdown-item" data-action="chat">
                    <i class="fas fa-comments"></i>
                    <span>Chat Options</span>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <input type="text" placeholder="Search..." id="globalSearch">
                    <i class="fas fa-search"></i>
                </div>
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">3</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content" id="pageContent">
            <!-- Dashboard content will be loaded here -->
            <div id="dashboardContent">
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="totalUsers">0</h3>
                            <p class="stat-label">Total Users</p>
                            <span class="stat-change positive">+12%</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="totalReports">0</h3>
                            <p class="stat-label">Reports Generated</p>
                            <span class="stat-change positive">+8%</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="totalRevenue">$0</h3>
                            <p class="stat-label">Revenue</p>
                            <span class="stat-change positive">+15%</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="systemUptime">99.9%</h3>
                            <p class="stat-label">System Uptime</p>
                            <span class="stat-change positive">+0.1%</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Recent Activity</h3>
                            <button class="btn btn-sm btn-outline">View All</button>
                        </div>
                        <div class="card-content">
                            <div class="activity-list" id="recentActivity">
                                <!-- Activity items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>System Status</h3>
                            <span class="status-indicator online">Online</span>
                        </div>
                        <div class="card-content">
                            <div class="status-grid">
                                <div class="status-item">
                                    <span class="status-label">API Server</span>
                                    <span class="status-value online">Running</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Database</span>
                                    <span class="status-value online">Connected</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">File Storage</span>
                                    <span class="status-value online">Available</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Email Service</span>
                                    <span class="status-value online">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Quick Actions</h3>
                    </div>
                    <div class="card-content">
                        <div class="quick-actions">
                            <button class="quick-action-btn" data-action="create-user">
                                <i class="fas fa-user-plus"></i>
                                <span>Add User</span>
                            </button>
                            <button class="quick-action-btn" data-action="generate-report">
                                <i class="fas fa-file-alt"></i>
                                <span>Generate Report</span>
                            </button>
                            <button class="quick-action-btn" data-action="system-settings">
                                <i class="fas fa-cog"></i>
                                <span>System Settings</span>
                            </button>
                            <button class="quick-action-btn" data-action="backup-data">
                                <i class="fas fa-database"></i>
                                <span>Backup Data</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/admin-api.js"></script>
    <script>
        // Simple admin panel initialization
        class AdminPanel {
            constructor() {
                this.apiBaseUrl = 'http://localhost:8004/api/v1';
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.checkExistingAuth();
            }
            
            setupEventListeners() {
                // Add event listeners for menu items
                const menuItems = document.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.dataset.page;
                        if (page) {
                            this.navigateToPage(page);
                        }
                    });
                });
                
                // Add event listeners for menu group headers (dropdowns)
                const menuGroupHeaders = document.querySelectorAll('.menu-group-header');
                console.log('Found menu group headers:', menuGroupHeaders.length);
                menuGroupHeaders.forEach((header, index) => {
                    console.log(`Setting up header ${index}:`, header.textContent.trim());
                    header.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Header clicked:', header.textContent.trim());
                        this.toggleMenuGroup(header);
                    });
                });
                
                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
                
                // Quick action buttons
                const quickActionBtns = document.querySelectorAll('.quick-action-btn');
                quickActionBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const action = btn.dataset.action;
                        this.handleQuickAction(action);
                    });
                });
                
                // User dropdown functionality
                const userInfoDropdown = document.getElementById('userInfoDropdown');
                const userDropdownMenu = document.getElementById('userDropdownMenu');
                if (userInfoDropdown && userDropdownMenu) {
                    userInfoDropdown.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.toggleUserDropdown();
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userInfoDropdown.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                            this.closeUserDropdown();
                        }
                    });
                    
                    // Handle dropdown item clicks
                    const dropdownItems = document.querySelectorAll('.dropdown-item');
                    dropdownItems.forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const action = item.dataset.action;
                            this.handleUserDropdownAction(action);
                        });
                    });
                }
            }
            
            checkExistingAuth() {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    this.validateToken(token);
                } else {
                    this.redirectToLogin();
                }
            }
            
            async validateToken(token) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/auth/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        if (userData.success && userData.data) {
                            this.currentUser = userData.data.user;
                            this.updateUserInfo(userData.data.user);
                            this.loadDashboardData();
                        } else {
                            this.redirectToLogin();
                        }
                    } else {
                        this.redirectToLogin();
                    }
                } catch (error) {
                    console.error('Token validation failed:', error);
                    this.redirectToLogin();
                }
            }
            
            updateUserInfo(userData) {
                const currentUserElement = document.getElementById('currentUser');
                const currentRoleElement = document.getElementById('currentRole');
                
                if (currentUserElement) {
                    currentUserElement.textContent = userData.full_name || userData.email;
                }
                
                if (currentRoleElement) {
                    currentRoleElement.textContent = userData.user_role || 'Admin';
                }
            }
            
            async loadDashboardData() {
                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch(`${this.apiBaseUrl}/admin/dashboard/stats`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const stats = await response.json();
                        this.updateStats({
                            totalUsers: stats.users?.total || 0,
                            totalReports: stats.reports?.total || 0,
                            totalRevenue: stats.revenue?.total || 0,
                            systemUptime: stats.system?.uptime || 99.9
                        });
                    } else {
                        // Fallback to mock data
                        this.updateStats({
                            totalUsers: 3,
                            totalReports: 3421,
                            totalRevenue: 45680,
                            systemUptime: 99.9
                        });
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    // Fallback to mock data
                    this.updateStats({
                        totalUsers: 3,
                        totalReports: 3421,
                        totalRevenue: 45680,
                        systemUptime: 99.9
                    });
                }
            }
            
            updateStats(stats) {
                const totalUsers = document.getElementById('totalUsers');
                const totalReports = document.getElementById('totalReports');
                const totalRevenue = document.getElementById('totalRevenue');
                const systemUptime = document.getElementById('systemUptime');

                if (totalUsers) totalUsers.textContent = stats.totalUsers.toLocaleString();
                if (totalReports) totalReports.textContent = stats.totalReports.toLocaleString();
                if (totalRevenue) totalRevenue.textContent = `$${stats.totalRevenue.toLocaleString()}`;
                if (systemUptime) systemUptime.textContent = `${stats.systemUptime}%`;
            }
            
            navigateToPage(page) {
                // Remove active class from all menu items
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Add active class to current menu item
                const currentMenuItem = document.querySelector(`[data-page="${page}"]`);
                if (currentMenuItem) {
                    currentMenuItem.classList.add('active');
                }

                // Special handling for dashboard - don't load a separate page
                if (page === 'dashboard') {
                    this.loadDashboardContent();
                    return;
                }

                // Load the page content
                this.loadPageContent(page);
            }
            
            async loadPageContent(page) {
                try {
                    const mainContent = document.getElementById('mainContent');
                    if (!mainContent) return;
                    
                    // Show loading state
                    mainContent.innerHTML = `
                        <div class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Loading ${this.getPageTitle(page)}...</p>
                        </div>
                    `;
                    
                    // Load the page
                    const response = await fetch(`pages/${page}.html`);
                    if (response.ok) {
                        const html = await response.text();
                        mainContent.innerHTML = html;
                    } else {
                        // Fallback to dashboard if page not found
                        this.loadDashboardContent();
                    }
                } catch (error) {
                    console.error('Error loading page:', error);
                    // Fallback to dashboard
                    this.loadDashboardContent();
                }
            }
            
            loadDashboardContent() {
                const mainContent = document.getElementById('mainContent');
                if (!mainContent) return;
                
                mainContent.innerHTML = `
                    <!-- Top Header -->
                    <header class="top-header">
                        <div class="header-left">
                            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 id="pageTitle">Real-Time Dashboard</h1>
                        </div>
                        <div class="header-right">
                            <div class="dashboard-controls">
                                <button class="btn btn-sm btn-primary" onclick="this.refreshDashboard()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="this.exportDashboard()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                            <div class="notification-bell">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge" id="notificationCount">3</span>
                            </div>
                        </div>
                    </header>

                    <!-- Dashboard Content -->
                    <div class="page-content">
                        <!-- Real-Time Metrics -->
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>Total Users</h3>
                                    <div class="metric-trend positive">
                                        <i class="fas fa-arrow-up"></i> +12%
                                    </div>
                                </div>
                                <div class="metric-value" id="totalUsers">-</div>
                                <div class="metric-subtitle">Active this month</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>Monthly Revenue</h3>
                                    <div class="metric-trend positive">
                                        <i class="fas fa-arrow-up"></i> +8.5%
                                    </div>
                                </div>
                                <div class="metric-value" id="monthlyRevenue">-</div>
                                <div class="metric-subtitle">Current month</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>System Uptime</h3>
                                    <div class="metric-trend stable">
                                        <i class="fas fa-check"></i> 99.9%
                                    </div>
                                </div>
                                <div class="metric-value" id="systemUptime">-</div>
                                <div class="metric-subtitle">Last 30 days</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>Active Sessions</h3>
                                    <div class="metric-trend positive">
                                        <i class="fas fa-arrow-up"></i> +15%
                                    </div>
                                </div>
                                <div class="metric-value" id="activeSessions">-</div>
                                <div class="metric-subtitle">Currently online</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>Response Time</h3>
                                    <div class="metric-trend stable">
                                        <i class="fas fa-check"></i> 45ms
                                    </div>
                                </div>
                                <div class="metric-value" id="responseTime">-</div>
                                <div class="metric-subtitle">Average API response</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-header">
                                    <h3>Error Rate</h3>
                                    <div class="metric-trend negative">
                                        <i class="fas fa-arrow-down"></i> 0.1%
                                    </div>
                                </div>
                                <div class="metric-value" id="errorRate">-</div>
                                <div class="metric-subtitle">Last 24 hours</div>
                            </div>
                        </div>
                        
                        <!-- Performance Charts -->
                        <div class="charts-grid">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3>User Growth Trend</h3>
                                    <div class="chart-controls">
                                        <select id="userGrowthPeriod">
                                            <option value="7d">Last 7 days</option>
                                            <option value="30d" selected>Last 30 days</option>
                                            <option value="90d">Last 90 days</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="userGrowthChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3>Revenue Analytics</h3>
                                    <div class="chart-controls">
                                        <select id="revenuePeriod">
                                            <option value="7d">Last 7 days</option>
                                            <option value="30d" selected>Last 30 days</option>
                                            <option value="90d">Last 90 days</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Health Monitoring -->
                        <div class="health-monitoring">
                            <div class="health-card">
                                <div class="health-header">
                                    <h3>System Health</h3>
                                    <div class="health-status" id="systemStatus">
                                        <span class="status-indicator healthy"></span>
                                        <span>All Systems Operational</span>
                                    </div>
                                </div>
                                <div class="health-metrics">
                                    <div class="health-metric">
                                        <div class="metric-label">CPU Usage</div>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: 45%" id="cpuUsage"></div>
                                        </div>
                                        <div class="metric-value">45%</div>
                                    </div>
                                    <div class="health-metric">
                                        <div class="metric-label">Memory Usage</div>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: 62%" id="memoryUsage"></div>
                                        </div>
                                        <div class="metric-value">62%</div>
                                    </div>
                                    <div class="health-metric">
                                        <div class="metric-label">Storage Usage</div>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: 38%" id="storageUsage"></div>
                                        </div>
                                        <div class="metric-value">38%</div>
                                    </div>
                                    <div class="health-metric">
                                        <div class="metric-label">Network I/O</div>
                                        <div class="metric-bar">
                                            <div class="metric-fill" style="width: 28%" id="networkUsage"></div>
                                        </div>
                                        <div class="metric-value">28%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="health-card">
                                <div class="health-header">
                                    <h3>Database Performance</h3>
                                    <div class="health-status">
                                        <span class="status-indicator healthy"></span>
                                        <span>Optimal Performance</span>
                                    </div>
                                </div>
                                <div class="health-metrics">
                                    <div class="health-metric">
                                        <div class="metric-label">Query Response Time</div>
                                        <div class="metric-value">12ms</div>
                                    </div>
                                    <div class="health-metric">
                                        <div class="metric-label">Active Connections</div>
                                        <div class="metric-value">8/100</div>
                                    </div>
                                    <div class="health-metric">
                                        <div class="metric-label">Cache Hit Rate</div>
                                        <div class="metric-value">94.2%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Activity Feed -->
                        <div class="activity-feed">
                            <div class="activity-header">
                                <h3>Live Activity Feed</h3>
                                <div class="activity-controls">
                                    <button class="btn btn-sm" onclick="this.toggleActivityFeed()">
                                        <i class="fas fa-pause" id="activityToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="activity-list" id="activityList">
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>New user registered:</strong> john.doe@example.com</p>
                                        <span class="activity-time">2 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>Report generated:</strong> Market Analysis Q1 2024</p>
                                        <span class="activity-time">15 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div class="activity-content">
                                        <p><strong>System update:</strong> Database optimization completed</p>
                                        <span class="activity-time">1 hour ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="quick-actions-section">
                            <h3>Quick Actions</h3>
                            <div class="quick-actions-grid">
                                <button class="quick-action-btn" onclick="this.navigateToPage('users')">
                                    <i class="fas fa-users"></i>
                                    <span>Manage Users</span>
                                </button>
                                <button class="quick-action-btn" onclick="this.navigateToPage('content-management')">
                                    <i class="fas fa-file-alt"></i>
                                    <span>Content Management</span>
                                </button>
                                <button class="quick-action-btn" onclick="this.navigateToPage('analytics')">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>View Analytics</span>
                                </button>
                                <button class="quick-action-btn" onclick="this.navigateToPage('settings')">
                                    <i class="fas fa-cog"></i>
                                    <span>System Settings</span>
                                </button>
                                <button class="quick-action-btn" onclick="this.navigateToPage('reports')">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Generate Reports</span>
                                </button>
                                <button class="quick-action-btn" onclick="this.navigateToPage('logs')">
                                    <i class="fas fa-list-alt"></i>
                                    <span>View Logs</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load real-time data
                this.loadRealTimeMetrics();
                this.initializeCharts();
                this.startLiveUpdates();
            }
            
            getPageTitle(page) {
                const titles = {
                    dashboard: 'Dashboard',
                    users: 'User Management',
                    'webapp-user-management': 'Webapp User Management',
                    'user-roles': 'User Roles',
                    subscriptions: 'Subscriptions',
                    'content-management': 'Content Management',
                    analytics: 'Analytics',
                    'system-management': 'System Management',
                    support: 'Support',
                    'user-profile': 'User Profile',
                    'role-definition': 'Role Definition',
                    'access-details': 'Access Details',
                    'chat-options': 'Chat Options',
                    cranes: 'Crane Management',
                    reports: 'Reports',
                    settings: 'Settings',
                    logs: 'System Logs'
                };
                return titles[page] || 'Page';
            }
            
            logout() {
                localStorage.removeItem('admin_token');
                this.redirectToLogin();
            }
            
            redirectToLogin() {
                window.location.href = 'login.html';
            }
            
            // Real-time dashboard functions
            async loadRealTimeMetrics() {
                try {
                    const token = localStorage.getItem('admin_token');
                    if (!token) {
                        this.loadMockMetrics();
                        return;
                    }

                    const response = await fetch('http://localhost:8004/api/v1/admin/dashboard/stats', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateMetrics(data);
                    } else {
                        this.loadMockMetrics();
                    }
                } catch (error) {
                    console.error('Error loading metrics:', error);
                    this.loadMockMetrics();
                }
            }
            
            loadMockMetrics() {
                // Mock data for demonstration
                const metrics = {
                    total_users: 1234,
                    monthly_revenue: 45678,
                    system_uptime: 99.9,
                    active_sessions: 89,
                    response_time: 45,
                    error_rate: 0.1
                };
                this.updateMetrics(metrics);
            }
            
            updateMetrics(data) {
                document.getElementById('totalUsers').textContent = data.total_users || data.totalUsers || '1,234';
                document.getElementById('monthlyRevenue').textContent = `$${(data.monthly_revenue || data.monthlyRevenue || 45678).toLocaleString()}`;
                document.getElementById('systemUptime').textContent = `${data.system_uptime || data.systemUptime || 99.9}%`;
                document.getElementById('activeSessions').textContent = data.active_sessions || data.activeSessions || '89';
                document.getElementById('responseTime').textContent = `${data.response_time || data.responseTime || 45}ms`;
                document.getElementById('errorRate').textContent = `${data.error_rate || data.errorRate || 0.1}%`;
            }
            
            initializeCharts() {
                // Initialize Chart.js charts
                this.initializeUserGrowthChart();
                this.initializeRevenueChart();
            }
            
            initializeUserGrowthChart() {
                const ctx = document.getElementById('userGrowthChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'New Users',
                            data: [120, 150, 180, 200],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            initializeRevenueChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'Revenue',
                            data: [12000, 15000, 18000, 20000],
                            backgroundColor: '#10B981',
                            borderColor: '#059669',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            startLiveUpdates() {
                // Update metrics every 30 seconds
                setInterval(() => {
                    this.loadRealTimeMetrics();
                }, 30000);
                
                // Update activity feed every 10 seconds
                setInterval(() => {
                    this.updateActivityFeed();
                }, 10000);
            }
            
            updateActivityFeed() {
                // Add new activity items to the feed
                const activityList = document.getElementById('activityList');
                if (!activityList) return;
                
                const activities = [
                    'New user login detected',
                    'Report generation completed',
                    'Database backup successful',
                    'System performance check passed',
                    'New subscription activated'
                ];
                
                const icons = ['fa-user', 'fa-file-alt', 'fa-database', 'fa-check-circle', 'fa-credit-card'];
                
                const randomActivity = activities[Math.floor(Math.random() * activities.length)];
                const randomIcon = icons[Math.floor(Math.random() * icons.length)];
                
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-icon">
                        <i class="fas ${randomIcon}"></i>
                    </div>
                    <div class="activity-content">
                        <p><strong>${randomActivity}</strong></p>
                        <span class="activity-time">Just now</span>
                    </div>
                `;
                
                activityList.insertBefore(activityItem, activityList.firstChild);
                
                // Keep only last 10 activities
                while (activityList.children.length > 10) {
                    activityList.removeChild(activityList.lastChild);
                }
            }
            
            refreshDashboard() {
                this.loadRealTimeMetrics();
                this.updateActivityFeed();
            }
            
            exportDashboard() {
                // Export dashboard data as CSV
                const data = {
                    totalUsers: document.getElementById('totalUsers').textContent,
                    monthlyRevenue: document.getElementById('monthlyRevenue').textContent,
                    systemUptime: document.getElementById('systemUptime').textContent,
                    activeSessions: document.getElementById('activeSessions').textContent,
                    responseTime: document.getElementById('responseTime').textContent,
                    errorRate: document.getElementById('errorRate').textContent
                };
                
                const csv = `Metric,Value\nTotal Users,${data.totalUsers}\nMonthly Revenue,${data.monthlyRevenue}\nSystem Uptime,${data.systemUptime}\nActive Sessions,${data.activeSessions}\nResponse Time,${data.responseTime}\nError Rate,${data.errorRate}`;
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dashboard-metrics.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
            
            toggleActivityFeed() {
                const icon = document.getElementById('activityToggleIcon');
                if (icon.classList.contains('fa-pause')) {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    // Pause updates
                } else {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    // Resume updates
                }
            }
            
            toggleMenuGroup(header) {
                const menuGroup = header.parentElement;
                const subitems = menuGroup.querySelector('.menu-subitems');
                const chevron = header.querySelector('i:last-child');
                
                console.log('Toggling menu group:', header.textContent.trim());
                console.log('Subitems found:', subitems);
                console.log('Chevron found:', chevron);
                
                if (subitems) {
                    // Close all other dropdowns first
                    document.querySelectorAll('.menu-subitems.active').forEach(item => {
                        if (item !== subitems) {
                            item.classList.remove('active');
                        }
                    });
                    
                    // Toggle current dropdown
                    subitems.classList.toggle('active');
                    
                    // Toggle chevron rotation
                    if (chevron) {
                        chevron.classList.toggle('rotated');
                    }
                    
                    // Reset other chevrons
                    document.querySelectorAll('.menu-group-header i:last-child.rotated').forEach(icon => {
                        if (icon !== chevron) {
                            icon.classList.remove('rotated');
                        }
                    });
                }
            }
            
            handleQuickAction(action) {
                switch(action) {
                    case 'create-user':
                        this.navigateToPage('users');
                        break;
                    case 'generate-report':
                        this.navigateToPage('reports');
                        break;
                    case 'system-settings':
                        this.navigateToPage('settings');
                        break;
                    case 'backup-data':
                        this.navigateToPage('backups');
                        break;
                    default:
                        console.log('Quick action:', action);
                }
            }
            
            toggleUserDropdown() {
                const userInfoDropdown = document.getElementById('userInfoDropdown');
                const userDropdownMenu = document.getElementById('userDropdownMenu');
                
                if (userInfoDropdown && userDropdownMenu) {
                    const isActive = userInfoDropdown.classList.contains('active');
                    
                    if (isActive) {
                        this.closeUserDropdown();
                    } else {
                        this.openUserDropdown();
                    }
                }
            }
            
            openUserDropdown() {
                const userInfoDropdown = document.getElementById('userInfoDropdown');
                const userDropdownMenu = document.getElementById('userDropdownMenu');
                
                if (userInfoDropdown && userDropdownMenu) {
                    userInfoDropdown.classList.add('active');
                    userDropdownMenu.classList.add('active');
                }
            }
            
            closeUserDropdown() {
                const userInfoDropdown = document.getElementById('userInfoDropdown');
                const userDropdownMenu = document.getElementById('userDropdownMenu');
                
                if (userInfoDropdown && userDropdownMenu) {
                    userInfoDropdown.classList.remove('active');
                    userDropdownMenu.classList.remove('active');
                }
            }
            
            handleUserDropdownAction(action) {
                this.closeUserDropdown();
                
                switch(action) {
                    case 'profile':
                        this.navigateToPage('user-profile');
                        break;
                    case 'role':
                        this.navigateToPage('role-definition');
                        break;
                    case 'access':
                        this.navigateToPage('access-details');
                        break;
                    case 'chat':
                        this.navigateToPage('chat-options');
                        break;
                    default:
                        console.log('User dropdown action:', action);
                }
            }
        }
        
        // Initialize admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Add a small delay to ensure all elements are rendered
            setTimeout(() => {
                new AdminPanel();
            }, 100);
        });
    </script>
</body>
</html>
